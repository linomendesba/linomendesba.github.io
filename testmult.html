<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetStat Multi-Liga - Seletores Independentes</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: Arial, sans-serif; background: #0f1218; color: #e0e0e0; margin: 0; padding: 20px; }
        h4 { color: #4fc3f7; margin: 30px 0 10px; }
        .seletor-container {
            display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;
            background: #1e222b; padding: 12px; border-radius: 8px;
        }
        .seletor-item { display: flex; flex-direction: column; min-width: 140px; }
        .seletor-item label { font-size: 0.85em; margin-bottom: 4px; color: #aaa; }
        select, input[type="checkbox"] + label { background: #2c303b; color: white; border: 1px solid #444; padding: 6px 10px; border-radius: 4px; }
        table.tabela-liga { width: 100%; border-collapse: collapse; margin-bottom: 40px; font-size: 0.9em; }
        th, td { padding: 8px; text-align: center; border: 1px solid #333; }
        th { background: #1e222b; }
        .minute-header { cursor: pointer; }
        .porcentagem-verde { background: #018b06 !important; color: white; }
        .porcentagem-branca { background: #444; color: white; }
        .placar { cursor: pointer; position: relative; }
        .placar:hover .tooltip { display: block; }
        .tooltip {
            display: none; position: absolute; background: #222; color: white; padding: 8px; border-radius: 4px;
            z-index: 10; top: -40px; left: 50%; transform: translateX(-50%); white-space: nowrap; min-width: 180px;
        }
        .placar-selecionado span { background: #7e57c2; color: white; padding: 2px 6px; border-radius: 3px; }
        .odd-selecionada { border: 2px solid #ff9800 !important; background: rgba(255,152,0,0.2); }
        .time-nome-selecionado { background: #4caf50; color: white; padding: 2px 4px; border-radius: 3px; }
        #loading { text-align: center; margin: 40px; }
        .spinner { border: 4px solid #444; border-top: 4px solid #4fc3f7; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="header"></div>

<!-- COPA DO MUNDO -->
<h4>Copa do Mundo</h4>
<div class="seletor-container" data-liga="Copa">
    <div class="seletor-item">
        <label>Horas</label>
        <select class="seletorHoras">
            <option value="3">3 horas</option>
            <option value="6">6 horas</option>
            <option value="12" selected>12 horas</option>
            <option value="24">24 horas</option>
            <option value="48">48 horas</option>
            <option value="72">72 horas</option>
        </select>
    </div>
    <div class="seletor-item">
        <label>Mercado</label>
        <select class="seletorResultado">
            <option value="ambasMarcam" selected>Ambas Sim</option>
            <option value="ambasNaoMarcam">Ambas N√£o</option>
            <option value="casaVence">Casa vence</option>
            <option value="foraVence">Fora vence</option>
            <option value="empate">Empate</option>
            <option value="over1.5">Over 1.5</option>
            <option value="under1.5">Under 1.5</option>
            <option value="over2.5">Over 2.5</option>
            <option value="under2.5">Under 2.5</option>
            <option value="over3.5">Over 3.5</option>
            <option value="under3.5">Under 3.5</option>
            <option value="over5">Over 5+</option>
            <option value="exato0">Exato 0</option>
            <option value="exato1">Exato 1</option>
            <option value="exato2">Exato 2</option>
            <option value="exato3">Exato 3</option>
            <option value="exato4">Exato 4</option>
        </select>
    </div>
    <div class="seletor-item">
        <label>Resultado</label>
        <select class="seletorTipoPlacar">
            <option value="ft" selected>FT</option>
            <option value="ht">HT</option>
        </select>
    </div>
    <div class="seletor-item">
        <label>Ver Times</label>
        <select class="mostrarTimes">
            <option value="nao" selected>N√£o</option>
            <option value="sim">Sim</option>
        </select>
    </div>
    <div class="seletor-item">
        <label>Ver HT</label>
        <select class="mostrarHT">
            <option value="nao" selected>N√£o</option>
            <option value="sim">Sim</option>
        </select>
    </div>
    <div class="seletor-item">
        <label>Ver Odds</label>
        <select class="mostrarOdds">
            <option value="nao">N√£o</option>
            <option value="sim" selected>Sim</option>
        </select>
    </div>
    <div class="seletor-item">
        <div id="statsCopa">
            <span id="totalGolsCopa">Gols: 0</span> | 
            <span id="mediaGolsCopa">M√©dia/h: 0.0</span> | 
            <span id="greenCopa">Green: 0%</span>
        </div>
    </div>
</div>

<table id="tabelaResultadosCopa" class="tabela-liga">
    <thead>
        <tr id="linhaPercentualCopa"><th>üìä</th></tr>
        <tr id="linhaTotalGolsCopa"><th>‚öΩ</th></tr>
        <tr id="linhaAcertosMercadoCopa"><th>‚úîÔ∏è</th></tr>
        <tr>
            <th>‚è∞</th>
            <!-- minutos Copa -->
            <th class="minute-header">1</th><th class="minute-header">4</th><th class="minute-header">7</th><th class="minute-header">10</th>
            <th class="minute-header">13</th><th class="minute-header">16</th><th class="minute-header">19</th><th class="minute-header">22</th>
            <th class="minute-header">25</th><th class="minute-header">28</th><th class="minute-header">31</th><th class="minute-header">34</th>
            <th class="minute-header">37</th><th class="minute-header">40</th><th class="minute-header">43</th><th class="minute-header">46</th>
            <th class="minute-header">49</th><th class="minute-header">52</th><th class="minute-header">55</th><th class="minute-header">58</th>
            <th>‚öΩÔ∏è</th><th>‚úîÔ∏è</th><th>üìä</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Repetir a estrutura para Euro, Super e Premier com seus respectivos minutosFixos -->

<!-- EURO -->
<h4>Euro Cup</h4>
<div class="seletor-container" data-liga="Euro"> <!-- seletores id√™nticos, mas com classes diferentes ou data-liga --> ... </div>
<table id="tabelaResultadosEuro" class="tabela-liga"> ... minutos da Euro ... </table>

<!-- SUPER -->
<h4>Super Liga</h4>
<div class="seletor-container" data-liga="Super"> ... </div>
<table id="tabelaResultadosSuper" class="tabela-liga"> ... minutos da Super ... </table>

<!-- PREMIER -->
<h4>Premier League</h4>
<div class="seletor-container" data-liga="Premier"> ... </div>
<table id="tabelaResultadosPremier" class="tabela-liga"> ... minutos da Premier ... </table>

<div id="loading"><div class="spinner"></div></div>

<script>
// Configura√ß√£o das ligas
const ligas = [
    {
        nome: "Copa",
        minutosFixos: [1,4,7,10,13,16,19,22,25,28,31,34,37,40,43,46,49,52,55,58],
        tabelaId: "tabelaResultadosCopa",
        rota: "https://betstat.site/resultados/bet365/Copa",
        rotaProximos: "https://betstat.site/proximos/bet365/Copa"
    },
    {
        nome: "Euro",
        minutosFixos: [2,5,8,11,14,17,20,23,26,29,32,35,38,41,44,47,50,53,56,59],
        tabelaId: "tabelaResultadosEuro",
        rota: "https://betstat.site/resultados/bet365/Euro",
        rotaProximos: "https://betstat.site/proximos/bet365/Euro"
    },
    {
        nome: "Super",
        minutosFixos: [1,4,7,10,13,16,19,22,25,28,31,34,37,40,43,46,49,52,55,58],
        tabelaId: "tabelaResultadosSuper",
        rota: "https://betstat.site/resultados/bet365/Super",
        rotaProximos: "https://betstat.site/proximos/bet365/Super"
    },
    {
        nome: "Premier",
        minutosFixos: [0,3,6,9,12,15,18,21,24,27,30,33,36,39,42,45,48,51,54,57],
        tabelaId: "tabelaResultadosPremier",
        rota: "https://betstat.site/resultados/bet365/Premier",
        rotaProximos: "https://betstat.site/proximos/bet365/Premier"
    }
];

// Estado global simplificado (sem multi-sele√ß√£o avan√ßada por enquanto)
const Estado = {
    selecoes: {}, // { "Copa": { horas: "12", resultado: "ambasMarcam", ... } }
    carregar(liga) {
        const key = `selecoes_${liga}`;
        this.selecoes[liga] = JSON.parse(localStorage.getItem(key)) || {
            horas: "12", resultado: "ambasMarcam", tipoPlacar: "ft",
            mostrarTimes: "nao", mostrarHT: "nao", mostrarOdds: "sim"
        };
    },
    salvar(liga) {
        const key = `selecoes_${liga}`;
        localStorage.setItem(key, JSON.stringify(this.selecoes[liga]));
    }
};

// Fun√ß√£o principal de renderiza√ß√£o por liga
async function atualizarLiga(liga) {
    const container = document.querySelector(`.seletor-container[data-liga="${liga.nome}"]`);
    if (!container) return;

    Estado.carregar(liga.nome);

    const selHoras     = container.querySelector(".seletorHoras");
    const selResultado = container.querySelector(".seletorResultado");
    const selTipo      = container.querySelector(".seletorTipoPlacar");
    const selTimes     = container.querySelector(".mostrarTimes");
    const selHT        = container.querySelector(".mostrarHT");
    const selOdds      = container.querySelector(".mostrarOdds");

    // Aplicar valores salvos
    selHoras.value     = Estado.selecoes[liga.nome].horas;
    selResultado.value = Estado.selecoes[liga.nome].resultado;
    selTipo.value      = Estado.selecoes[liga.nome].tipoPlacar;
    selTimes.value     = Estado.selecoes[liga.nome].mostrarTimes;
    selHT.value        = Estado.selecoes[liga.nome].mostrarHT;
    selOdds.value      = Estado.selecoes[liga.nome].mostrarOdds;

    // Listeners
    const atualizar = () => {
        Estado.selecoes[liga.nome] = {
            horas: selHoras.value,
            resultado: selResultado.value,
            tipoPlacar: selTipo.value,
            mostrarTimes: selTimes.value,
            mostrarHT: selHT.value,
            mostrarOdds: selOdds.value
        };
        Estado.salvar(liga.nome);
        carregarDadosLiga(liga);
    };

    selHoras.addEventListener("change", atualizar);
    selResultado.addEventListener("change", atualizar);
    selTipo.addEventListener("change", atualizar);
    selTimes.addEventListener("change", atualizar);
    selHT.addEventListener("change", atualizar);
    selOdds.addEventListener("change", atualizar);

    // Primeira carga
    carregarDadosLiga(liga);
}

async function carregarDadosLiga(liga) {
    try {
        const [resResultados, resProximos] = await Promise.all([
            fetch(liga.rota),
            fetch(liga.rotaProximos)
        ]);

        const dados     = await resResultados.json();
        const proximos  = await resProximos.json();

        criarTabelaLiga(liga, dados, proximos);
    } catch (err) {
        console.error(`Erro ao carregar ${liga.nome}:`, err);
    }
}

// ‚îÄ‚îÄ‚îÄ CRIA√á√ÉO DA TABELA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function criarTabela(dados, oddsData, proximosJogos) {
  // Garante que o painel (indicator + stats) existe no DOM antes de qualquer render
  criarOuObterPainel();

  const tabela = document.getElementById("tabelaResultados");
  const tabelaBody = tabela.querySelector("tbody");
  let thead = tabela.querySelector("thead");
  if (!thead) { thead = document.createElement("thead"); tabela.insertBefore(thead, tabelaBody); }
  thead.innerHTML = "";

  const trPercentual    = Object.assign(document.createElement("tr"), { id: "linhaPercentual",    innerHTML: "<th></th><th>üìä</th>" });
  const trTotalGols     = Object.assign(document.createElement("tr"), { id: "linhaTotalGols",     innerHTML: "<th></th><th>‚öΩ</th>" });
  const trAcertosMercado = Object.assign(document.createElement("tr"), { id: "linhaAcertosMercado", innerHTML: "<th></th><th>‚úÖ</th>" });
  thead.append(trPercentual, trTotalGols, trAcertosMercado);

  const trMinutos = document.createElement("tr");
  const thSel = Object.assign(document.createElement("th"), { className: "selector-header" });
  thSel.style.width = "30px";
  trMinutos.appendChild(thSel);
  trMinutos.appendChild(Object.assign(document.createElement("th"), { textContent: "üïê" }));
  minutosFixos.forEach((m, i) => {
    const th = document.createElement("th");
    th.className = "minute-header";
    th.textContent = m;
    // Quadrant border: every 5 columns (after col 4, 9, 14, 19)
    if (i > 0 && i % 5 === 0) th.classList.add("quadrant-border");
    if (Estado.colunasSelecionadas.includes(m)) th.classList.add("coluna-selecionada");
    th.addEventListener("click", () => toggleColuna(m));
    trMinutos.appendChild(th);
  });
  ["‚öΩ","‚úÖ","üìà"].forEach(t => trMinutos.appendChild(Object.assign(document.createElement("th"), { textContent: t })));
  thead.appendChild(trMinutos);

  tabelaBody.innerHTML = "";

  // Controles
  const seletorHoras       = document.querySelector("#seletorHoras");
  const seletorResultado   = document.querySelector("#seletorResultado");
  const seletorTipoPlacar  = document.querySelector("#seletorTipoPlacar");
  const mostrarTimesSelect = document.querySelector("#mostrarTimes");
  const mostrarHTSelect    = document.querySelector("#mostrarHT");
  const mostrarOddsSelect  = document.querySelector("#mostrarOdds");

  if (!seletorHoras || !seletorResultado || !seletorTipoPlacar || !mostrarTimesSelect || !mostrarHTSelect || !mostrarOddsSelect) {
    showErrorMessage("Erro interno: Seletores do formul√°rio n√£o encontrados.");
    return;
  }

  const mostrarTimes     = mostrarTimesSelect.value === "sim";
  const mostrarOdds      = mostrarOddsSelect.value  === "sim";
  const mostrarHT        = mostrarHTSelect.value    === "sim";
  const horasSelecionadas = parseInt(seletorHoras.value) || 12;
  const selecaoResultado  = seletorResultado.value;
  const tipoPlacar        = seletorTipoPlacar.value;

  const oddsIndex = indexarOdds(oddsData);

  dados.sort((a, b) => {
    const dA = new Date(`${getDateStr(a.data)}T${a.hora.toString().padStart(2,"0")}:${a.minuto.toString().padStart(2,"0")}:00`).getTime();
    const dB = new Date(`${getDateStr(b.data)}T${b.hora.toString().padStart(2,"0")}:${b.minuto.toString().padStart(2,"0")}:00`).getTime();
    return dB - dA;
  });

  const proximosComHoras = proximosJogos.map(jogo => {
    const [h, m] = jogo.time.split(":").map(Number);
    const closest = minutosFixos.reduce((prev, curr) =>
      Math.abs(curr - m) < Math.abs(prev - m) ? curr : prev
    );
    return { ...jogo, date: new Date(jogo.start_time), hora: h, minuto: closest, team_visitante: jogo.team_visit };
  }).sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

  // Coleta horas √∫nicas
  const todasHorasSet = new Set();
  proximosComHoras.forEach(jogo => {
    const dataStr = jogo.captured_date ? jogo.captured_date.split("/").reverse().join("-") : jogo.date.toISOString().split("T")[0];
    const ts = new Date(`${dataStr}T${jogo.hora.toString().padStart(2,"0")}:00:00`).getTime();
    todasHorasSet.add(JSON.stringify({ hora: jogo.hora, timestamp: ts, data: dataStr }));
  });
  dados.forEach(dado => {
    const ds = getDateStr(dado.data);
    const ts = new Date(`${ds}T${dado.hora.toString().padStart(2,"0")}:00:00`).getTime();
    todasHorasSet.add(JSON.stringify({ hora: dado.hora, timestamp: ts, data: ds }));
  });

  const horasUnicas = Array.from(todasHorasSet)
    .map(s => JSON.parse(s))
    .sort((a,b) => b.timestamp - a.timestamp)
    .slice(0, horasSelecionadas);

  const mapeamentoChaveLinha = {};

  horasUnicas.forEach(item => {
    const chave = `${item.data}-${item.hora}`;
    const tr = document.createElement("tr");
    tr.setAttribute("data-chave", chave);

    const tdSel = document.createElement("td");
    const cb    = document.createElement("input");
    cb.type = "checkbox"; cb.className = "row-selector";
    cb.checked = Estado.selectedChaves.includes(chave);
    cb.addEventListener("change", function() {
      if (this.checked) { if (!Estado.selectedChaves.includes(chave)) Estado.selectedChaves.push(chave); }
      else { Estado.selectedChaves = Estado.selectedChaves.filter(c => c !== chave); }
      Estado.salvar(); updateSelectedRows();
    });
    tdSel.appendChild(cb); tr.appendChild(tdSel);
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: item.hora.toString().padStart(2,"0") }));
    minutosFixos.forEach((m, i) => {
      const td = document.createElement("td");
      if (i > 0 && i % 5 === 0) td.classList.add("quadrant-border");
      if (Estado.colunasSelecionadas.includes(m)) td.classList.add("coluna-selecionada");
      tr.appendChild(td);
    });
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: "0" }));
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: "0" }));
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: "0%" }));
    tabelaBody.appendChild(tr);
    mapeamentoChaveLinha[chave] = tr;
  });

  // Handlers de clique
  function extrairPlacar(placarEl) {
    // Extracts only the score text, ignoring team name spans
    const textoEl = placarEl.querySelector(".placar-texto");
    if (!textoEl) return placarEl.textContent.trim();
    return Array.from(textoEl.querySelectorAll("span"))
      .filter(s => !s.classList.contains("time-casa") && !s.classList.contains("time-fora"))
      .map(s => s.textContent.trim())
      .join(" ")
      .trim();
  }

  function handlePlacarClick(e) {
    if (e.target.classList.contains("time-casa") || e.target.classList.contains("time-fora")) return;
    const txt = extrairPlacar(e.currentTarget);
    Estado.toggleSelecao("placarSelecionados", txt);
    aplicarHighlights();
  }
  function handleTimeClick(e) {
    if (!mostrarTimes) return;
    const val = e.target.getAttribute("data-full-time");
    if (!val) return;
    Estado.toggleSelecao("timesSelecionados", val);
    aplicarHighlights();
  }
  function handleOddClick(e) {
    e.stopPropagation();
    Estado.toggleSelecao("oddsSelecionadas", e.currentTarget.textContent.trim());
    aplicarHighlights();
  }

  // Dados passados
  const totalGolsPorColuna    = Array(minutosFixos.length).fill(0);
  const totalAcertosPorColuna = Array(minutosFixos.length).fill(0);
  const processedMatches      = new Set();

  // Stats por sele√ß√£o: Map< valor -> { green, red, cor, label } >
  const statsPlacar = new Map();
  const statsTime   = new Map();
  const statsOdd    = new Map();
  Estado.placarSelecionados.forEach((val, i) => {
    statsPlacar.set(val, { green: 0, red: 0, cor: CORES_PLACAR[i % CORES_PLACAR.length], label: "Placar", tipo: "placar" });
  });
  Estado.timesSelecionados.forEach((val, i) => {
    statsTime.set(val, { green: 0, red: 0, cor: CORES_TIME[i % CORES_TIME.length], label: "Time", tipo: "time" });
  });
  Estado.oddsSelecionadas.forEach((val, i) => {
    statsOdd.set(val, { green: 0, red: 0, cor: CORES_ODD[i % CORES_ODD.length], label: "Odd", tipo: "odd" });
  });

  dados.forEach(dado => {
    const ds    = getDateStr(dado.data);
    const chave = `${ds}-${dado.hora}`;
    const linha = mapeamentoChaveLinha[chave];
    const minNorm = minutosFixos.reduce((p, c) => Math.abs(c - dado.minuto) < Math.abs(p - dado.minuto) ? c : p);
    const mk = `${dado.time_a}|${dado.time_b}|${chave}|${minNorm}`;

    if (!linha || processedMatches.has(mk)) return;
    const idx = minutosFixos.indexOf(minNorm);
    if (idx === -1) return;
    const cel = linha.children[2 + idx];
    if (cel.querySelector(".placar")) return;

    const placar = document.createElement("div");
    placar.className = "placar";
    placar.setAttribute("data-time-a", dado.time_a);
    placar.setAttribute("data-time-b", dado.time_b);

    const placarFT = dado.ft, placarHT = dado.ht;
    const primary   = tipoPlacar === "ft" ? placarFT : placarHT;
    const secondary = tipoPlacar === "ft" ? placarHT : placarFT;

    const placarTexto = document.createElement("div");
    placarTexto.className = "placar-texto";
    if (mostrarTimes) {
      const tA = abbreviateTeamName(dado.time_a), tB = abbreviateTeamName(dado.time_b);
      let html = `<span class="time-casa" style="cursor:pointer" data-full-time="${dado.time_a}">${tA}</span>`;
      html += `<span>${primary}</span>`;
      if (mostrarHT) html += `<span>(${secondary})</span>`;
      html += `<span class="time-fora" style="cursor:pointer" data-full-time="${dado.time_b}">${tB}</span>`;
      placarTexto.innerHTML = html;
    } else {
      placarTexto.innerHTML = `<span>${primary}</span>${mostrarHT ? `<span>(${secondary})</span>` : ""}`;
    }
    placar.appendChild(placarTexto);

    const oddsMatch = findOddsNoIndex(oddsIndex, dado);
    if (mostrarOdds) {
      const ov  = getOddValue(oddsMatch, selecaoResultado);
      const oel = document.createElement("div");
      oel.className = "odds"; oel.textContent = `@${ov}`;
      oel.addEventListener("click", handleOddClick);
      placar.appendChild(oel);
    }

    placar.addEventListener("click", handlePlacarClick);
    if (mostrarTimes) {
      placar.querySelector(".time-casa")?.addEventListener("click", handleTimeClick);
      placar.querySelector(".time-fora")?.addEventListener("click", handleTimeClick);
    }

    const oddTip = getOddValue(oddsMatch, selecaoResultado);
    const tooltip = document.createElement("span");
    tooltip.className = "tooltip";
    tooltip.innerHTML = `
      <span class="times">${dado.time_a} vs ${dado.time_b}</span>
      <span class="placares">${placarFT} <span class="placarHT">(${placarHT})</span></span>
      ${oddTip && oddTip !== "N/A" ? `<span class="odd-tooltip">@${oddTip}</span>` : ""}
    `;
    placar.appendChild(tooltip);
    cel.appendChild(placar);
    processedMatches.add(mk);

    // Highlights iniciais - placar highlight on score spans
    const _scoreText = extrairPlacarFromEl(placar);
    for (const val of Estado.placarSelecionados) {
      if (_scoreText.includes(val)) {
        const cor = Estado.getCorSelecao(Estado.placarSelecionados, val, "placar");
        placarTexto.querySelectorAll("span").forEach(span => {
          if (!span.classList.contains("time-casa") && !span.classList.contains("time-fora")) {
            span.style.setProperty("--sel-color", cor.bg);
            span.classList.add("placar-score-selecionado");
          }
        });
        break;
      }
    }
    // Time name highlight (applied to each span individually)
    [".time-casa", ".time-fora"].forEach(sel => {
      const span = placar.querySelector(sel);
      if (!span) return;
      const fullTime = span.getAttribute("data-full-time");
      for (const val of Estado.timesSelecionados) {
        if (fullTime === val) {
          const cor = Estado.getCorSelecao(Estado.timesSelecionados, val, "time");
          span.style.setProperty("--sel-color", cor.bg);
          span.classList.add("time-nome-selecionado");
          break;
        }
      }
    });
    if (mostrarOdds) {
      const oel = placar.querySelector(".odds");
      if (oel) {
        for (const val of Estado.oddsSelecionadas) {
          if (oel.textContent.trim() === val) {
            oel.style.setProperty("--sel-color", Estado.getCorSelecao(Estado.oddsSelecionadas, val, "odd").bg);
            oel.classList.add("odd-selecionada"); break;
          }
        }
      }
    }

    // Acertos
    const placarAtual = tipoPlacar === "ft" ? placarFT : placarHT;
    const [rA, rB] = placarAtual.split(" x ").map(n => parseInt(n) || 0);
    const tg = rA + rB;
    let acerto = false;
    if      (selecaoResultado === "ambasMarcam")    acerto = rA > 0 && rB > 0;
    else if (selecaoResultado === "ambasNaoMarcam") acerto = rA === 0 || rB === 0;
    else if (selecaoResultado === "over1.5")        acerto = tg > 1.5;
    else if (selecaoResultado === "under1.5")       acerto = tg <= 1.5;
    else if (selecaoResultado === "over2.5")        acerto = tg > 2.5;
    else if (selecaoResultado === "under2.5")       acerto = tg <= 2.5;
    else if (selecaoResultado === "over3.5")        acerto = tg > 3.5;
    else if (selecaoResultado === "under3.5")       acerto = tg <= 3.5;
    else if (selecaoResultado === "over5")          acerto = tg >= 5;
    else if (selecaoResultado === "casaVence")      acerto = rA > rB;
    else if (selecaoResultado === "foraVence")      acerto = rB > rA;
    else if (selecaoResultado === "empate")         acerto = rA === rB;
    else if (selecaoResultado === "exato0")         acerto = tg === 0;
    else if (selecaoResultado === "exato1")         acerto = tg === 1;
    else if (selecaoResultado === "exato2")         acerto = tg === 2;
    else if (selecaoResultado === "exato3")         acerto = tg === 3;
    else if (selecaoResultado === "exato4")         acerto = tg === 4;

    cel.style.backgroundColor = acerto ? "#018b06" : "#be0e02";
    if (acerto) {
      linha.children[linha.children.length - 2].textContent =
        parseInt(linha.children[linha.children.length - 2].textContent) + 1;
      totalAcertosPorColuna[idx]++;
    }
    const tgCel = linha.children[linha.children.length - 3];
    tgCel.textContent = parseInt(tgCel.textContent) + tg;
    totalGolsPorColuna[idx] += tg;

    // Acumula stats por sele√ß√£o
    if (!mostrarTimes) {
      const textoP = placarTexto.textContent.trim();
      for (const val of Estado.placarSelecionados) {
        if (textoP.includes(val)) {
          const s = statsPlacar.get(val);
          if (s) { acerto ? s.green++ : s.red++; }
          break;
        }
      }
    }
    if (mostrarTimes) {
      for (const val of Estado.timesSelecionados) {
        if (dado.time_a === val || dado.time_b === val) {
          const s = statsTime.get(val);
          if (s) { acerto ? s.green++ : s.red++; }
          break;
        }
      }
    }
    if (mostrarOdds) {
      const oel = placar.querySelector(".odds");
      if (oel) {
        const oddTxt = oel.textContent.trim();
        for (const val of Estado.oddsSelecionadas) {
          if (oddTxt === val) {
            const s = statsOdd.get(val);
            if (s) { acerto ? s.green++ : s.red++; }
            break;
          }
        }
      }
    }
  });

  // Pr√≥ximos jogos
  proximosComHoras.forEach(jogo => {
    const dataStr = jogo.captured_date ? jogo.captured_date.split("/").reverse().join("-") : jogo.date.toISOString().split("T")[0];
    const chave   = `${dataStr}-${jogo.hora}`;
    const linha   = mapeamentoChaveLinha[chave];
    const mk      = `${jogo.team_home}|${jogo.team_visit}|${chave}|${jogo.minuto}`;

    if (!linha || jogo.minuto === null || processedMatches.has(mk)) return;

    const jaTemResultado = dados.some(d => {
      const dd = getDateStr(d.data);
      return normalizeString(d.time_a) === normalizeString(jogo.team_home) &&
             normalizeString(d.time_b) === normalizeString(jogo.team_visit) &&
             dd === dataStr && d.hora === jogo.hora && d.minuto === jogo.minuto;
    });
    if (jaTemResultado) return;

    const idx = minutosFixos.indexOf(jogo.minuto);
    if (idx === -1) return;
    const cel = linha.children[2 + idx];
    if (cel.querySelector(".placar")) return;

    const placar = document.createElement("div");
    placar.className = "placar placar-futuro";
    placar.setAttribute("data-time-a", jogo.team_home);
    placar.setAttribute("data-time-b", jogo.team_visit);

    const tA = abbreviateTeamName(jogo.team_home);
    const tB = abbreviateTeamName(jogo.team_visit);
    const placarTexto = document.createElement("div");
    placarTexto.className = "placar-texto";
    if (mostrarTimes) {
      placarTexto.innerHTML = `
        <span class="time-casa" style="cursor:pointer" data-full-time="${jogo.team_home}">${tA}</span><br>
        <span class="time-fora" style="cursor:pointer" data-full-time="${jogo.team_visit}">${tB}</span>
      `;
    } else {
      placarTexto.innerHTML = `${tA}<br>${tB}`;
    }
    placar.appendChild(placarTexto);

    const oddsProximo   = findOddsProximoNoIndex(oddsIndex, jogo);
    const oddValProximo = getOddValue(oddsProximo, selecaoResultado);
    if (oddValProximo && oddValProximo !== "N/A") {
      placar.appendChild(Object.assign(document.createElement("div"), {
        className: "placar-futuro-odd", textContent: `@${oddValProximo}`
      }));
    }

    placar.addEventListener("click", handlePlacarClick);
    if (mostrarTimes) {
      placar.querySelector(".time-casa")?.addEventListener("click", handleTimeClick);
      placar.querySelector(".time-fora")?.addEventListener("click", handleTimeClick);
    }

    const tooltip = document.createElement("span");
    tooltip.className = "tooltip";
    tooltip.innerHTML = `
      <span class="times">${jogo.team_home} vs ${jogo.team_visit}</span>
      ${oddValProximo && oddValProximo !== "N/A" ? `<span class="odd-tooltip">@${oddValProximo}</span>` : ""}
    `;
    placar.appendChild(tooltip);
    cel.appendChild(placar);
    processedMatches.add(mk);

    // Time name highlight for future matches
    [".time-casa", ".time-fora"].forEach(sel => {
      const span = placar.querySelector(sel);
      if (!span) return;
      const fullTime = span.getAttribute("data-full-time");
      for (const val of Estado.timesSelecionados) {
        if (fullTime === val) {
          const cor = Estado.getCorSelecao(Estado.timesSelecionados, val, "time");
          span.style.setProperty("--sel-color", cor.bg);
          span.classList.add("time-nome-selecionado");
          break;
        }
      }
    });
  });

  // Footer totais
  totalGolsPorColuna.forEach(t =>
    trTotalGols.appendChild(Object.assign(document.createElement("td"), { className: "total-goals", textContent: t }))
  );
  totalAcertosPorColuna.forEach(t =>
    trAcertosMercado.appendChild(Object.assign(document.createElement("td"), { className: "market-hits", textContent: t }))
  );
  for (let i = 0; i < 3; i++) {
    trTotalGols.appendChild(document.createElement("td"));
    trAcertosMercado.appendChild(document.createElement("td"));
  }

  // % por linha
  const todasLinhas = Array.from(tabelaBody.querySelectorAll("tr"));
  todasLinhas.forEach(row => {
    const total = Array.from(row.cells).slice(2,-3)
      .filter(c => c.querySelector(".placar") && !c.querySelector(".placar-futuro")).length;
    const acertos = parseInt(row.children[row.children.length - 2].textContent);
    const pct = total > 0 ? Math.floor((acertos / total) * 100) : 0;
    const pctCell = row.children[row.children.length - 1];
    pctCell.textContent = `${pct}%`;
    const _thresh = getThreshold(selecaoResultado);
    pctCell.classList.toggle("porcentagem-verde", pct >= _thresh);
    pctCell.classList.toggle("porcentagem-branca", pct < _thresh);
  });

  // % por coluna
  const totMercadoCol = Array(minutosFixos.length).fill(0);
  todasLinhas.forEach(row => {
    Array.from(row.cells).slice(2,-3).forEach((c, i) => {
      if (c.querySelector(".placar") && !c.querySelector(".placar-futuro")) totMercadoCol[i]++;
    });
  });
  totMercadoCol.forEach((tot, i) => {
    const pct = tot > 0 ? Math.floor((totalAcertosPorColuna[i] / tot) * 100) : 0;
    const cell = document.createElement("td");
    cell.textContent = `${pct}%`;
    const _threshCol = getThreshold(selecaoResultado);
    cell.classList.toggle("porcentagem-verde", pct >= _threshCol);
    cell.classList.toggle("porcentagem-branca", pct < _threshCol);
    trPercentual.appendChild(cell);
  });
  for (let i = 0; i < 3; i++) trPercentual.appendChild(document.createElement("td"));

  document.querySelectorAll("#tabelaResultados thead tr:last-child th.minute-header")
    .forEach(th => { th.style.backgroundColor = "#2c303b"; });

  const stats = calculateGoalStats(todasLinhas);
  document.getElementById("totalGols").textContent     = `‚öΩ Gols: ${stats.totalGols}`;
  document.getElementById("mediaGolsHora").textContent = `üìä M√©dias: ${stats.mediaGolsHora}`;

  // Monta mapa unificado de stats para exibi√ß√£o (placar + time + odd)
  const statsUnificado = new Map();
  statsPlacar.forEach((v, k) => statsUnificado.set(k, v));
  statsTime.forEach((v, k)   => statsUnificado.set(k, v));
  statsOdd.forEach((v, k)    => statsUnificado.set(k, v));

  criarOuObterPainel(); // garante que o DOM do painel existe antes de atualizar
  aplicarHighlights();  // internamente chama computeStatsFromDOM() lendo o DOM final
  updateSelectedRows();
  aplicarColunaHighlights();
  atualizarColunaStats();
}

// ‚îÄ‚îÄ‚îÄ BUSCA COM DIFF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function buscarDados() {
  hideErrorMessage();
  // Recarrega chaves selecionadas para a liga atual e detecta troca de liga
  const ligaAnterior = Estado._ultimaLigaRenderizada;
  const ligaAtual = typeof LIGA_ATUAL !== "undefined" ? LIGA_ATUAL : "default";
  Estado.recarregarChaves();
  if (ligaAnterior !== ligaAtual) {
    // Liga mudou: for√ßa re-render completo e atualiza badge
    Estado.forcarRerender();
    Estado._ultimaLigaRenderizada = ligaAtual;
  }
  let dados = [], oddsData = [], proximosJogos = [];

  try {
    const r = await fetch(ROTAS_API.resultados(LIGA_ATUAL));
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    dados = await r.json();
  } catch (e) {
    console.error("Erro resultados:", e);
    showErrorMessage(`Erro ao carregar resultados: ${e.message}`);
  }

  try { oddsData = await fetchOdds(); }
  catch (e) { showErrorMessage(`Erro odds: ${e.message}. Sem odds.`); }

  try { proximosJogos = await fetchProximosJogos(); }
  catch (e) { showErrorMessage(`Erro pr√≥ximos jogos: ${e.message}. Sem jogos futuros.`); }

  if (dados.length === 0 && proximosJogos.length === 0) {
    showErrorMessage("Nenhum dado dispon√≠vel. Verifique a conex√£o com o servidor.");
    return;
  }

  if (!Estado.dadosMudaram(dados, oddsData, proximosJogos)) {
    console.log("Dados inalterados, re-render ignorado.");
    computeStatsFromDOM();
    updateSelectedRows(); // garante exibi√ß√£o das linhas selecionadas ao voltar de outra liga
    aplicarColunaHighlights();
    atualizarColunaStats();
    return;
  }

  criarTabela(dados, oddsData, proximosJogos);
}

buscarDados();

// Debounced interval: only fires next cycle after current fetch completes
let _buscando = false;
setInterval(async () => {
  if (_buscando) return;
  _buscando = true;
  try { await buscarDados(); }
  finally { _buscando = false; }
}, 5000);

// ‚îÄ‚îÄ‚îÄ LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _seletorHoras       = document.querySelector("#seletorHoras");
const _seletorResultado   = document.querySelector("#seletorResultado");
const _seletorTipoPlacar  = document.querySelector("#seletorTipoPlacar");
const _mostrarTimesSelect = document.querySelector("#mostrarTimes");
const _mostrarHTSelect    = document.querySelector("#mostrarHT");
const _mostrarOddsSelect  = document.querySelector("#mostrarOdds");

if (_seletorHoras)      _seletorHoras.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });
if (_seletorResultado)  _seletorResultado.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });
if (_seletorTipoPlacar) _seletorTipoPlacar.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });

if (_mostrarTimesSelect) {
  _mostrarTimesSelect.addEventListener("change", () => {
    if (_mostrarTimesSelect.value !== "sim") {
      Estado.limparSelecoes(["timesSelecionados"]);
      showToast("Sele√ß√µes de time limpas");
    }
    Estado.forcarRerender();
    buscarDados();
  });
}

if (_mostrarHTSelect) _mostrarHTSelect.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });

if (_mostrarOddsSelect) {
  _mostrarOddsSelect.addEventListener("change", () => {
    if (_mostrarOddsSelect.value !== "sim") {
      Estado.limparSelecoes(["oddsSelecionadas"]);
      showToast("Sele√ß√µes de odd limpas");
    }
    Estado.forcarRerender();
    buscarDados();
  });
}

// Inicializar todas as ligas
ligas.forEach(liga => atualizarLiga(liga));

// Atualiza√ß√£o autom√°tica a cada 10 segundos
setInterval(() => {
    ligas.forEach(liga => carregarDadosLiga(liga));
}, 10000);

// Header
fetch('header.html')
    .then(r => r.text())
    .then(html => document.getElementById('header').innerHTML = html);
</script>

</body>
</html>