<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>BetStat Multi-Liga</title>
        <link rel="stylesheet" href="style.css" />
    <!-- Adicione estilos CSS necessÃ¡rios aqui ou link para arquivo externo -->
    <style>
        /* Inclua os estilos do cÃ³digo novo aqui, como .placar, .tooltip, etc. */
        /* Por brevidade, assuma que os estilos do novo cÃ³digo estÃ£o incluÃ­dos. */
        /* Adicione tambÃ©m os estilos injetados via JS no novo cÃ³digo. */
    </style>
</head>
<body>

<div id="header"></div>

<div class="seletor-container">
    <div class="seletor-mostrar-times">
        <select id="mostrarTimes">
            <option value="nao" selected>Ver Times: NÃ£o</option>
            <option value="sim">Ver Times: Sim</option>
        </select>
    </div>

    <div class="seletor-mostrar-ht">
        <select id="mostrarHT">
            <option value="nao" selected>Ver HT: NÃ£o</option>
            <option value="sim">Ver HT: Sim</option>
        </select>
    </div>

    <div class="seletor-horas">
        <select id="seletorHoras">
            <option value="3">Horas: 3</option>
            <option value="6" selected>Horas: 6</option>
            <option value="12">Horas: 12</option>
            <option value="24">Horas: 24</option>
            <option value="48">Horas: 48</option>
            <option value="72">Horas: 72</option>
        </select>
    </div>

    <div class="seletor-resultado">
        <select id="seletorResultado">
            <option value="ambasMarcam" selected>Ambas Sim</option>
            <option value="ambasNaoMarcam">Ambas NÃ£o</option>
            <option value="casaVence">Casa vence</option>
            <option value="foraVence">Fora vence</option>
            <option value="empate">Empate</option>
            <option value="over1.5">Over 1.5</option>
            <option value="under1.5">Under 1.5</option>
            <option value="over2.5">Over 2.5</option>
            <option value="under2.5">Under 2.5</option>
            <option value="over3.5">Over 3.5</option>
            <option value="under3.5">Under 3.5</option>
            <option value="over5">Over 5+</option>
            <option value="exato0">Exato 0</option>
            <option value="exato1">Exato 1</option>
            <option value="exato2">Exato 2</option>
            <option value="exato3">Exato 3</option>
            <option value="exato4">Exato 4</option>
        </select>
    </div>

    <div class="seletor-ver-odds">
        <select id="mostrarOdds">
            <option value="nao">Ver Odds: NÃ£o</option>
            <option value="sim" selected>Ver Odds: Sim</option>
        </select>
    </div>

    <div class="seletor-tipo-placar">
        <select id="seletorTipoPlacar">
            <option value="ft" selected>Resultado: FT</option>
            <option value="ht">Resultado: HT</option>
        </select>
    </div>

    <div id="resultDisplay">
        <div id="totalGols">0</div>
        <div id="mediaGolsHora">0</div>
    </div>

    <div id="resultDisplay">
        <div id="greenPercentage">Greens: 0%</div>
        <div id="redPercentage">Reds: 0%</div>
    </div>
</div>

<!-- Copa Section -->
<h4>Copa do Mundo</h4>
<div class="chart-container">
    <canvas id="CopaChart" width="1080" height="300"></canvas>
</div>
<table id="tabelaResultadosCopa" class="tabela-liga">
    <thead>
        <tr id="linhaPercentualCopa" class="linha-percentual">
            <th>ğŸ“Š</th>
        </tr>
        <tr id="linhaTotalGolsCopa">
            <th>âš½</th>
        </tr>
        <tr id="linhaAcertosMercadoCopa">
            <th>âœ”ï¸</th>
        </tr>
        <tr>
            <th>â°</th>
            <th class="minute-header">1</th>
            <th class="minute-header">4</th>
            <th class="minute-header">7</th>
            <th class="minute-header">10</th>
            <th class="minute-header">13</th>
            <th class="minute-header">16</th>
            <th class="minute-header">19</th>
            <th class="minute-header">22</th>
            <th class="minute-header">25</th>
            <th class="minute-header">28</th>
            <th class="minute-header">31</th>
            <th class="minute-header">34</th>
            <th class="minute-header">37</th>
            <th class="minute-header">40</th>
            <th class="minute-header">43</th>
            <th class="minute-header">46</th>
            <th class="minute-header">49</th>
            <th class="minute-header">52</th>
            <th class="minute-header">55</th>
            <th class="minute-header">58</th>
            <th>âš½ï¸</th>
            <th>âœ”ï¸</th>
            <th>ğŸ“Š</th>
        </tr>
    </thead>
    <tbody></tbody>
    <tfoot></tfoot>
</table>

<!-- Euro Section -->
<h4>Euro Cup</h4>
<div class="chart-container">
    <canvas id="EuroChart" width="1080" height="300"></canvas>
</div>
<table id="tabelaResultadosEuro" class="tabela-liga">
    <thead>
        <tr id="linhaPercentualEuro" class="linha-percentual">
            <th>ğŸ“Š</th>
        </tr>
        <tr id="linhaTotalGolsEuro">
            <th>âš½</th>
        </tr>
        <tr id="linhaAcertosMercadoEuro">
            <th>âœ”ï¸</th>
        </tr>
        <tr>
            <th>â°</th>
            <th class="minute-header">2</th>
            <th class="minute-header">5</th>
            <th class="minute-header">8</th>
            <th class="minute-header">11</th>
            <th class="minute-header">14</th>
            <th class="minute-header">17</th>
            <th class="minute-header">20</th>
            <th class="minute-header">23</th>
            <th class="minute-header">26</th>
            <th class="minute-header">29</th>
            <th class="minute-header">32</th>
            <th class="minute-header">35</th>
            <th class="minute-header">38</th>
            <th class="minute-header">41</th>
            <th class="minute-header">44</th>
            <th class="minute-header">47</th>
            <th class="minute-header">50</th>
            <th class="minute-header">53</th>
            <th class="minute-header">56</th>
            <th class="minute-header">59</th>
            <th>âš½ï¸</th>
            <th>âœ”ï¸</th>
            <th>ğŸ“Š</th>
        </tr>
    </thead>
    <tbody></tbody>
    <tfoot></tfoot>
</table>

<!-- Super Section -->
<h4>Super Liga</h4>
<div class="chart-container">
    <canvas id="SuperChart" width="1080" height="300"></canvas>
</div>
<table id="tabelaResultadosSuper" class="tabela-liga">
    <thead>
        <tr id="linhaPercentualSuper" class="linha-percentual">
            <th>ğŸ“Š</th>
        </tr>
        <tr id="linhaTotalGolsSuper">
            <th>âš½</th>
        </tr>
        <tr id="linhaAcertosMercadoSuper">
            <th>âœ”ï¸</th>
        </tr>
        <tr>
            <th>â°</th>
            <th class="minute-header">1</th>
            <th class="minute-header">4</th>
            <th class="minute-header">7</th>
            <th class="minute-header">10</th>
            <th class="minute-header">13</th>
            <th class="minute-header">16</th>
            <th class="minute-header">19</th>
            <th class="minute-header">22</th>
            <th class="minute-header">25</th>
            <th class="minute-header">28</th>
            <th class="minute-header">31</th>
            <th class="minute-header">34</th>
            <th class="minute-header">37</th>
            <th class="minute-header">40</th>
            <th class="minute-header">43</th>
            <th class="minute-header">46</th>
            <th class="minute-header">49</th>
            <th class="minute-header">52</th>
            <th class="minute-header">55</th>
            <th class="minute-header">58</th>
            <th>âš½ï¸</th>
            <th>âœ”ï¸</th>
            <th>ğŸ“Š</th>
        </tr>
    </thead>
    <tbody></tbody>
    <tfoot></tfoot>
</table>

<!-- Premier Section -->
<h4>Premier League</h4>
<div class="chart-container">
    <canvas id="PremierChart" width="1080" height="300"></canvas>
</div>
<table id="tabelaResultadosPremier" class="tabela-liga">
    <thead>
        <tr id="linhaPercentualPremier" class="linha-percentual">
            <th>ğŸ“Š</th>
        </tr>
        <tr id="linhaTotalGolsPremier">
            <th>âš½</th>
        </tr>
        <tr id="linhaAcertosMercadoPremier">
            <th>âœ”ï¸</th>
        </tr>
        <tr>
            <th>â°</th>
            <th class="minute-header">0</th>
            <th class="minute-header">3</th>
            <th class="minute-header">6</th>
            <th class="minute-header">9</th>
            <th class="minute-header">12</th>
            <th class="minute-header">15</th>
            <th class="minute-header">18</th>
            <th class="minute-header">21</th>
            <th class="minute-header">24</th>
            <th class="minute-header">27</th>
            <th class="minute-header">30</th>
            <th class="minute-header">33</th>
            <th class="minute-header">36</th>
            <th class="minute-header">39</th>
            <th class="minute-header">42</th>
            <th class="minute-header">45</th>
            <th class="minute-header">48</th>
            <th class="minute-header">51</th>
            <th class="minute-header">54</th>
            <th class="minute-header">57</th>
            <th>âš½ï¸</th>
            <th>âœ”ï¸</th>
            <th>ğŸ“Š</th>
        </tr>
    </thead>
    <tbody></tbody>
    <tfoot></tfoot>
</table>

<div class="control-panel">
    <div>
        <label for="pointsSelector"></label>
        <select id="pointsSelector">
            <option value="20">1 Hora</option>
            <!-- ... outras opÃ§Ãµes ... -->
        </select>
    </div>
    <div>
        <label for="averageSelector"></label>
        <select id="averageSelector">
            <option value="19">Base 20</option>
            <!-- ... outras opÃ§Ãµes ... -->
        </select>
    </div>
    <div class="checkbox-container">
        <input type="checkbox" id="fibonacciToggle">
        <label for="fibonacciToggle">Ativar Fibonacci</label>
    </div>
    <div class="checkbox-container">
        <input type="checkbox" id="movingAveragesToggle">
        <label for="movingAveragesToggle">Ativar MÃ©dias MÃ³veis</label>
    </div>
</div>

<div id="errorMessage" class="error-message" style="display: none;"></div>

<div id="loading">
    <div class="spinner"></div>
</div>

<script>
    // League configurations (from old, adapted for new)
    const ligas = [
        {
            nome: "Copa",
            rota: "https://betstat.site/resultados/bet365/Copa",
            rotaProximos: "https://betstat.site/proximos/bet365/Copa",
            rotaOdds: "https://betstat.site/odds/bet365/Copa", // Assumido, ajuste se necessÃ¡rio
            minutosFixos: [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34, 37, 40, 43, 46, 49, 52, 55, 58],
            tabelaId: "tabelaResultadosCopa",
            linhaPercentualId: "linhaPercentualCopa",
            linhaTotalGolsId: "linhaTotalGolsCopa",
            linhaAcertosMercadoId: "linhaAcertosMercadoCopa",
            chartId: "CopaChart"
        },
        {
            nome: "Euro",
            rota: "https://betstat.site/resultados/bet365/Euro",
            rotaProximos: "https://betstat.site/proximos/bet365/Euro",
            rotaOdds: "https://betstat.site/odds/bet365/Euro",
            minutosFixos: [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59],
            tabelaId: "tabelaResultadosEuro",
            linhaPercentualId: "linhaPercentualEuro",
            linhaTotalGolsId: "linhaTotalGolsEuro",
            linhaAcertosMercadoId: "linhaAcertosMercadoEuro",
            chartId: "EuroChart"
        },
        {
            nome: "Super",
            rota: "https://betstat.site/resultados/bet365/Super",
            rotaProximos: "https://betstat.site/proximos/bet365/Super",
            rotaOdds: "https://betstat.site/odds/bet365/Super",
            minutosFixos: [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34, 37, 40, 43, 46, 49, 52, 55, 58],
            tabelaId: "tabelaResultadosSuper",
            linhaPercentualId: "linhaPercentualSuper",
            linhaTotalGolsId: "linhaTotalGolsSuper",
            linhaAcertosMercadoId: "linhaAcertosMercadoSuper",
            chartId: "SuperChart"
        },
        {
            nome: "Premier",
            rota: "https://betstat.site/resultados/bet365/Premier",
            rotaProximos: "https://betstat.site/proximos/bet365/Premier",
            rotaOdds: "https://betstat.site/odds/bet365/Premier",
            minutosFixos: [0, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57],
            tabelaId: "tabelaResultadosPremier",
            linhaPercentualId: "linhaPercentualPremier",
            linhaTotalGolsId: "linhaTotalGolsPremier",
            linhaAcertosMercadoId: "linhaAcertosMercadoPremier",
            chartId: "PremierChart"
        }
    ];

    // Inclua aqui o cÃ³digo JS completo do "tabela nova.txt", adaptado para multi-liga.
    // Por exemplo, modifique criarTabela para aceitar 'liga' como parÃ¢metro e usar liga.tabelaId, liga.minutosFixos, etc.
    // Adapte buscarDados para buscarDadosLiga(liga), fetch para liga.rota, liga.rotaProximos, liga.rotaOdds.
    // Para estado, defina LIGA_ATUAL = liga.nome antes de chamar Estado.recarregarChaves() e criarTabela.
    // Para o loop principal: ligas.forEach(async (liga) => await buscarDadosLiga(liga));
    // Para interval: setInterval(() => Promise.all(ligas.map(buscarDadosLiga)), 10000);
    // Inclua todas as funÃ§Ãµes como Estado, showToast, etc.

    // Exemplo de adaptaÃ§Ã£o (preencha com o cÃ³digo completo):
    let LIGA_ATUAL;

    // MÃ©dia esperada por hora (20 jogos/hora) â†’ threshold para verde
// Fonte: tabela "MÃ©dia de Mercados por Hora"
const MERCADO_THRESHOLD = {
  ambasMarcam:    Math.round((9  / 20) * 100), // 45%
  ambasNaoMarcam: Math.round((11 / 20) * 100), // 55%
  casaVence:      Math.round((8  / 20) * 100), // 40%
  foraVence:      Math.round((7  / 20) * 100), // 35%
  empate:         Math.round((5  / 20) * 100), // 25%
  "over1.5":      Math.round((14 / 20) * 100), // 70%
  "under1.5":     Math.round((6  / 20) * 100), // 30%
  "over2.5":      Math.round((8  / 20) * 100), // 40%
  "under2.5":     Math.round((12 / 20) * 100), // 60%
  "over3.5":      Math.round((4  / 20) * 100), // 20%
  "under3.5":     Math.round((16 / 20) * 100), // 80%
  over5:          Math.round((2  / 20) * 100), // 10%
  exato0:         10,
  exato1:         20,
  exato2:         20,
  exato3:         15,
  exato4:         10,
};

function getThreshold(mercado) {
  return MERCADO_THRESHOLD[mercado] ?? 50;
}

// â”€â”€â”€ CORES PARA MULTI-SELEÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Paletas independentes por tipo â€” sem verde nem vermelho, mÃ¡ximo contraste entre itens
const CORES_PLACAR = [
  "#A855F7", // roxo vibrante
  "#F59E0B", // Ã¢mbar
  "#3B82F6", // azul
  "#EC4899", // rosa choque
  "#06B6D4", // ciano
  "#F97316", // laranja
];

const CORES_TIME = [
  "#FACC15", // amarelo forte
  "#818CF8", // Ã­ndigo claro
  "#34D399", // esmeralda  â€” OK: nÃ£o Ã© o verde-cÃ©lula (#018b06)
  "#FB7185", // coral      â€” OK: nÃ£o Ã© o vermelho-cÃ©lula (#be0e02)
  "#A78BFA", // lilÃ¡s
  "#22D3EE", // azul turquesa
];

const CORES_ODD = [
  "#F472B6", // rosa claro
  "#FDE68A", // amarelo pastel
  "#93C5FD", // azul claro
  "#6EE7B7", // menta       â€” OK: nÃ£o Ã© o verde-cÃ©lula
  "#FCA5A1", // salmÃ£o      â€” OK: nÃ£o Ã© o vermelho-cÃ©lula
  "#C4B5FD", // lavanda
];

// MantÃ©m compatibilidade com getCorSelecao genÃ©rico (usa CORES_PLACAR como fallback)
const CORES_SELECAO = CORES_PLACAR.map(bg => ({ bg }));

// â”€â”€â”€ ESTADO CENTRALIZADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Estado = {
  placarSelecionados: [],
  timesSelecionados:  [],
  oddsSelecionadas:   [],
  selectedChaves:     [],
  _ultimoHashDados:       null,
  _ultimoHashOdds:        null,
  _ultimoHashProximos:    null,
  _ultimaLigaRenderizada: null,
  colunasSelecionadas:    [],

  _chavesKey() {
    return `selectedChaves_${typeof LIGA_ATUAL !== "undefined" ? LIGA_ATUAL : "default"}`;
  },

  _colunasKey() {
    return `colunasSelecionadas_${typeof LIGA_ATUAL !== "undefined" ? LIGA_ATUAL : "default"}`;
  },

  carregar() {
    this.placarSelecionados = JSON.parse(localStorage.getItem("placarSelecionados")) || [];
    this.timesSelecionados  = JSON.parse(localStorage.getItem("timesSelecionados"))  || [];
    this.oddsSelecionadas   = JSON.parse(localStorage.getItem("oddsSelecionadas"))   || [];
    this.selectedChaves      = JSON.parse(localStorage.getItem(this._chavesKey()))    || [];
    this.colunasSelecionadas = JSON.parse(localStorage.getItem(this._colunasKey()))   || [];
    // Migra chaves legadas se existirem
    const lP = localStorage.getItem("placarSelecionado");
    const lT = localStorage.getItem("timeSelecionado");
    const lO = localStorage.getItem("oddSelecionada");
    if (lP && !this.placarSelecionados.includes(lP)) this.placarSelecionados.push(lP);
    if (lT && !this.timesSelecionados.includes(lT))  this.timesSelecionados.push(lT);
    if (lO && !this.oddsSelecionadas.includes(lO))   this.oddsSelecionadas.push(lO);
    localStorage.removeItem("placarSelecionado");
    localStorage.removeItem("timeSelecionado");
    localStorage.removeItem("oddSelecionada");
  },

  salvar() {
    localStorage.setItem("placarSelecionados", JSON.stringify(this.placarSelecionados));
    localStorage.setItem("timesSelecionados",  JSON.stringify(this.timesSelecionados));
    localStorage.setItem("oddsSelecionadas",   JSON.stringify(this.oddsSelecionadas));
    localStorage.setItem(this._chavesKey(),    JSON.stringify(this.selectedChaves));
    localStorage.setItem(this._colunasKey(),  JSON.stringify(this.colunasSelecionadas));
  },

  // Recarrega selectedChaves para a liga atual (chamado ao trocar de liga)
  recarregarChaves() {
    this.selectedChaves      = JSON.parse(localStorage.getItem(this._chavesKey()))  || [];
    this.colunasSelecionadas = JSON.parse(localStorage.getItem(this._colunasKey())) || [];
  },

  toggleSelecao(chave, valor) {
    const lista = this[chave];
    const idx = lista.indexOf(valor);
    if (idx !== -1) {
      lista.splice(idx, 1);
    } else {
      if (lista.length >= 6) lista.shift();
      lista.push(valor);
    }
    this.salvar();
    atualizarIndicadorSelecao();
  },

  limparSelecoes(tipos) {
    tipos.forEach(t => { this[t].length = 0; });
    this.salvar();
    atualizarIndicadorSelecao();
  },

  getCorSelecao(lista, valor, tipo) {
    const idx = lista.indexOf(valor);
    if (idx === -1) return null;
    let paleta;
    if (tipo === "time")  paleta = CORES_TIME;
    else if (tipo === "odd") paleta = CORES_ODD;
    else paleta = CORES_PLACAR;
    return { bg: paleta[idx % paleta.length] };
  },

  hashDados(dados) {
    if (!dados || dados.length === 0) return "vazio";
    // Include last item too so new entries at the end are detected
    const first = dados[0];
    const last  = dados[dados.length - 1];
    const keyFn = d => d?.id || d?.match_id || d?.ft || JSON.stringify(d).length;
    return `${dados.length}_${keyFn(first)}_${keyFn(last)}`;
  },

  dadosMudaram(dados, odds, proximos) {
    const hD = this.hashDados(dados);
    const hO = this.hashDados(odds);
    const hP = this.hashDados(proximos);
    if (hD !== this._ultimoHashDados || hO !== this._ultimoHashOdds || hP !== this._ultimoHashProximos) {
      this._ultimoHashDados    = hD;
      this._ultimoHashOdds     = hO;
      this._ultimoHashProximos = hP;
      return true;
    }
    return false;
  },

  forcarRerender() {
    this._ultimoHashDados = null;
  },
};

Estado.carregar();

// â”€â”€â”€ INJEÃ‡ÃƒO DE ESTILOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function injectStyles() {
  if (document.getElementById("multi-select-styles")) return;
  const style = document.createElement("style");
  style.id = "multi-select-styles";
  style.textContent = `
    .placar-selecionado { /* controlled via .placar-score-selecionado on inner spans */ }
    .time-selecionado   { /* controlled via .time-nome-selecionado on the span */ }
    .odd-selecionada    { border: 3px solid var(--sel-color, #A855F7) !important; outline: none !important; color: var(--sel-color, #A855F7) !important; }
    .time-nome-selecionado {
      background-color: var(--sel-color, #A855F7) !important;
      color: #000 !important;
      border-radius: 3px;
      padding: 0 2px;
      font-weight: bold;
    }
    .placar-score-selecionado {
      background-color: var(--sel-color, #A855F7) !important;
      color: #000 !important;
      border-radius: 3px;
      padding: 0 3px;
      font-weight: bold;
    }
    .placar-futuro-odd  { font-size: 0.7em; opacity: 0.85; margin-top: 2px; color: #f0c040; font-weight: bold; }

    /* â”€â”€ SeleÃ§Ã£o de colunas â”€â”€ */
    .minute-header { cursor: pointer; user-select: none; transition: background 0.15s; }
    .minute-header:hover { filter: brightness(1.3); }

    /* Quando hÃ¡ seleÃ§Ã£o ativa: escurece colunas NÃƒO selecionadas */
    #tabelaResultados.tem-coluna-selecionada td:not(.coluna-selecionada) {
      filter: brightness(0.45);
    }
    #tabelaResultados.tem-coluna-selecionada th.minute-header:not(.coluna-selecionada) {
      filter: brightness(0.45);
    }
    /* Colunas selecionadas ficam normais + header levemente destacado */
    #tabelaResultados.tem-coluna-selecionada td.coluna-selecionada { filter: none; }
    #tabelaResultados.tem-coluna-selecionada th.coluna-selecionada {
      filter: none;
      background: rgba(255,255,255,0.15) !important;
    }
    /* CÃ©lulas que nunca devem ser escurecidas (hora, checkbox, totais) */
    #tabelaResultados.tem-coluna-selecionada td:first-child,
    #tabelaResultados.tem-coluna-selecionada td:nth-child(2),
    #tabelaResultados.tem-coluna-selecionada td:nth-last-child(1),
    #tabelaResultados.tem-coluna-selecionada td:nth-last-child(2),
    #tabelaResultados.tem-coluna-selecionada td:nth-last-child(3) {
      filter: none;
    }

    /* â”€â”€ Stats de colunas selecionadas â”€â”€ */
    #coluna-stats {
      display: flex; flex-wrap: wrap; gap: 5px;
      padding: 5px 8px; margin-bottom: 4px;
    }
    #coluna-stats:empty { display: none; }
    .col-stat-tag {
      display: inline-flex; align-items: center; gap: 4px;
      background: rgba(255,255,255,0.08); border-radius: 8px;
      padding: 3px 10px; font-size: 0.76em; white-space: nowrap; color: #fff;
    }
    .col-stat-tag .col-min { font-weight: bold; color: #ccc; }
    .col-stat-tag .col-g { color: #4cff55; font-weight: bold; }
    .col-stat-tag .col-r { color: #ff5555; font-weight: bold; }
    .col-stat-tag .col-pct { padding: 1px 6px; border-radius: 8px; font-weight: bold; color: #fff; margin-left: 2px; }
    .col-stat-verde  { background: #018b06; }
    .col-stat-branca { background: #555; }
    .col-stat-tag .col-remove { cursor: pointer; opacity: 0.6; margin-left: 2px; }
    .col-stat-tag .col-remove:hover { opacity: 1; }

    /* â”€â”€ Divisores de quadrante (a cada 5 colunas) â”€â”€ */
    td.quadrant-border, th.quadrant-border {
      border-left: 2px solid rgba(255,255,255,0.35) !important;
    }
    .odd-tooltip        { color: #f0c040; font-weight: bold; margin-top: 3px; display: block; }

    #selecao-indicator {
      display: flex; flex-wrap: wrap; gap: 6px;
      padding: 6px 8px; margin-bottom: 6px;
    }
    #selecao-indicator:empty { display: none; }
    .sel-tag {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 2px 8px; border-radius: 12px;
      font-size: 0.75em; font-weight: bold; color: #fff;
      border: 2px solid rgba(255,255,255,0.25); white-space: nowrap;
    }
    .sel-tag .sel-remove { cursor: pointer; opacity: 0.8; padding: 0 1px; }
    .sel-tag .sel-remove:hover { opacity: 1; }

    #toast-container {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      z-index: 9999; pointer-events: none;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
    }
    .toast {
      background: #333; color: #fff; padding: 8px 18px;
      border-radius: 20px; font-size: 0.82em; opacity: 0;
      animation: toastIn 0.25s ease forwards, toastOut 0.3s ease 1.8s forwards;
    }
    @keyframes toastIn  { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    @keyframes toastOut { from { opacity:1; } to { opacity:0; } }

    #painel-selecao {
      display: flex; align-items: flex-start; justify-content: space-between;
      gap: 12px; margin-bottom: 6px; flex-wrap: wrap;
    }

    #selecao-indicator { margin-bottom: 0; flex: 1; min-width: 0; flex-wrap: wrap; }
    #stats-selecao {
      display: flex; flex-direction: row; flex-wrap: wrap;
      gap: 4px; flex-shrink: 0; justify-content: flex-end; align-items: flex-start;
    }
    .stat-row {
      display: flex; align-items: center; gap: 5px;
      background: rgba(255,255,255,0.06); border-radius: 8px;
      padding: 3px 10px; font-size: 0.76em; white-space: nowrap;
    }
    .stat-color-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .stat-label { font-weight: bold; color: #fff; max-width: 140px; overflow: hidden; text-overflow: ellipsis; }
    .stat-sep { color: rgba(255,255,255,0.25); margin: 0 1px; }
    .stat-total { color: #ccc; font-weight: bold; }
    .stat-count-green { color: #4cff55; font-weight: bold; }
    .stat-count-red   { color: #ff5555; font-weight: bold; }
    .stat-pct { margin-left: 3px; padding: 1px 7px; border-radius: 10px; font-weight: bold; color: #fff; font-size: 0.9em; }
    .stat-pct-verde  { background: #018b06; }
    .stat-pct-branca { background: #555; }
  `;
  document.head.appendChild(style);

  const tc = document.createElement("div");
  tc.id = "toast-container";
  document.body.appendChild(tc);
})();

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const container = document.getElementById("toast-container");
  if (!container) return;
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 2200);
}

// â”€â”€â”€ INDICADOR DE SELEÃ‡Ã•ES ATIVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function criarOuObterPainel() {
  let painel = document.getElementById("painel-selecao");
  if (!painel) {
    painel = document.createElement("div");
    painel.id = "painel-selecao";

    const indicator = document.createElement("div");
    indicator.id = "selecao-indicator";
    painel.appendChild(indicator);

    const stats = document.createElement("div");
    stats.id = "stats-selecao";
    painel.appendChild(stats);

    const tabela = document.getElementById("tabelaResultados");
    if (tabela) {
      const selCont = document.getElementById("selectedRowsContainer");
      const anchor = selCont || tabela;
      anchor.parentNode.insertBefore(painel, anchor);
    }
  }

  return painel;
}

function criarOuObterIndicador() {
  criarOuObterPainel();
  return document.getElementById("selecao-indicator");
}

function criarOuObterStats() {
  criarOuObterPainel();
  return document.getElementById("stats-selecao");
}

// statsMap: Map< valor -> { green, red, cor } >
function atualizarStatsSelecao(statsMap) {
  const el = criarOuObterStats();
  if (!el) { console.warn("stats-selecao nÃ£o encontrado"); return; }
  el.innerHTML = "";

  const temItems = statsMap && [...statsMap.values()].some(v => (v.green + v.red) > 0);
  el.style.display = temItems ? "flex" : "none";
  if (!temItems) return;

  statsMap.forEach(({ green, red, cor, label, tipo }, valor) => {
    const total = green + red;
    if (total === 0) return;

    const row = document.createElement("div");
    row.className = "stat-row";

    const dot = document.createElement("span");
    dot.className = "stat-color-dot";
    dot.style.background = cor;

    const lbl = document.createElement("span");
    lbl.className = "stat-label";
    lbl.title = valor;
    lbl.textContent = label ? `${label}: ${valor}` : valor;

    const sep0 = document.createElement("span");
    sep0.className = "stat-sep";
    sep0.textContent = "Â·";

    if (tipo === "placar") {
      // Placar: sÃ³ mostra contagem de ocorrÃªncias (sem green/red de mercado)
      const totSpan = document.createElement("span");
      totSpan.className = "stat-total";
      totSpan.textContent = `${total}Ã—`;

      const info = document.createElement("span");
      info.style.cssText = "color:#aaa;font-size:0.85em";
      info.textContent = "ocorrÃªncias";

      row.append(dot, lbl, sep0, totSpan, info);
    } else {
      // Times e Odds: mostra total + green + red + %
      const pct = Math.round((green / total) * 100);

      const totSpan = document.createElement("span");
      totSpan.className = "stat-total";
      totSpan.textContent = `${total}Ã—`;

      const sep1 = document.createElement("span");
      sep1.className = "stat-sep";
      sep1.textContent = "/";

      const gSpan = document.createElement("span");
      gSpan.className = "stat-count-green";
      gSpan.textContent = `${green}âœ”`;

      const sep2 = document.createElement("span");
      sep2.className = "stat-sep";
      sep2.textContent = "/";

      const rSpan = document.createElement("span");
      rSpan.className = "stat-count-red";
      rSpan.textContent = `${red}âœ˜`;

      const pctSpan = document.createElement("span");
      const _threshStat = getThreshold(document.querySelector("#seletorResultado")?.value || "");
      pctSpan.className = `stat-pct ${pct >= _threshStat ? "stat-pct-verde" : "stat-pct-branca"}`;
      pctSpan.textContent = `${pct}%`;

      row.append(dot, lbl, sep0, totSpan, sep1, gSpan, sep2, rSpan, pctSpan);
    }

    el.appendChild(row);
  });
}

function atualizarIndicadorSelecao() {
  const el = criarOuObterIndicador();
  el.innerHTML = "";

  // Limpa stats tambÃ©m se nada selecionado
  const temSelecoes = Estado.placarSelecionados.length + Estado.timesSelecionados.length + Estado.oddsSelecionadas.length;
  if (temSelecoes === 0) {
    const statsEl = criarOuObterStats();
    if (statsEl) statsEl.innerHTML = "";
  }

  const grupos = [
    { lista: Estado.placarSelecionados, chave: "placarSelecionados", prefixo: "Placar", paleta: CORES_PLACAR },
    { lista: Estado.timesSelecionados,  chave: "timesSelecionados",  prefixo: "Time",   paleta: CORES_TIME  },
    { lista: Estado.oddsSelecionadas,   chave: "oddsSelecionadas",   prefixo: "Odd",    paleta: CORES_ODD   },
  ];

  grupos.forEach(({ lista, chave, prefixo, paleta }) => {
    lista.forEach((valor, idx) => {
      const cor = { bg: paleta[idx % paleta.length] };
      const tag = document.createElement("span");
      tag.className = "sel-tag";
      tag.style.background = cor.bg;
      tag.innerHTML = `${prefixo}: ${valor} <span class="sel-remove" title="Remover">âœ•</span>`;
      tag.querySelector(".sel-remove").addEventListener("click", () => {
        Estado.toggleSelecao(chave, valor);
        aplicarHighlights();
      });
      el.appendChild(tag);
    });
  });
}

// â”€â”€â”€ COMPUTA STATS LENDO O DOM (chamado apÃ³s seleÃ§Ã£o do usuÃ¡rio) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeStatsFromDOM() {
  const mostrarTimes = document.querySelector("#mostrarTimes")?.value === "sim";
  const mostrarOdds  = document.querySelector("#mostrarOdds")?.value  === "sim";

  // Inicializa mapas zerados
  const statsPlacar = new Map();
  const statsTime   = new Map();
  const statsOdd    = new Map();
  Estado.placarSelecionados.forEach((val, i) => {
    statsPlacar.set(val, { green: 0, red: 0, cor: CORES_PLACAR[i % CORES_PLACAR.length], label: "Placar", tipo: "placar" });
  });
  Estado.timesSelecionados.forEach((val, i) => {
    statsTime.set(val, { green: 0, red: 0, cor: CORES_TIME[i % CORES_TIME.length], label: "Time", tipo: "time" });
  });
  Estado.oddsSelecionadas.forEach((val, i) => {
    statsOdd.set(val, { green: 0, red: 0, cor: CORES_ODD[i % CORES_ODD.length], label: "Odd", tipo: "odd" });
  });

  // LÃª cada cÃ©lula da tabela (ignora futuros)
  document.querySelectorAll("#tabelaResultados tbody td").forEach(cel => {
    const placarEl = cel.querySelector(".placar:not(.placar-futuro)");
    if (!placarEl) return;

    const isGreen = cel.style.backgroundColor === "rgb(1, 139, 6)";   // #018b06
    const isRed   = cel.style.backgroundColor === "rgb(190, 14, 2)";  // #be0e02
    if (!isGreen && !isRed) return; // cÃ©lula sem cor = sem resultado processado

    const acerto = isGreen;
    const textoP = extrairPlacarFromEl(placarEl);
    const timeA  = placarEl.getAttribute("data-time-a");
    const timeB  = placarEl.getAttribute("data-time-b");
    const oddEl  = placarEl.querySelector(".odds");
    const oddTxt = oddEl ? oddEl.textContent.trim() : "";

    if (!mostrarTimes) {
      for (const val of Estado.placarSelecionados) {
        if (textoP.includes(val)) {
          const s = statsPlacar.get(val);
          if (s) { acerto ? s.green++ : s.red++; }
          break;
        }
      }
    }
    // Time stats: match against data-full-time on individual name spans
    const timeSpans = placarEl.querySelectorAll(".time-casa, .time-fora");
    const timeNames = Array.from(timeSpans).map(s => s.getAttribute("data-full-time")).filter(Boolean);
    if (timeNames.length === 0) {
      // fallback to data attributes on card
      timeNames.push(timeA, timeB);
    }
    for (const val of Estado.timesSelecionados) {
      if (timeNames.includes(val)) {
        const s = statsTime.get(val);
        if (s) { acerto ? s.green++ : s.red++; }
        break;
      }
    }
    if (mostrarOdds && oddTxt) {
      for (const val of Estado.oddsSelecionadas) {
        if (oddTxt === val) {
          const s = statsOdd.get(val);
          if (s) { acerto ? s.green++ : s.red++; }
          break;
        }
      }
    }
  });

  const statsUnificado = new Map();
  statsPlacar.forEach((v, k) => statsUnificado.set(k, v));
  statsTime.forEach((v, k)   => statsUnificado.set(k, v));
  statsOdd.forEach((v, k)    => statsUnificado.set(k, v));

  criarOuObterPainel();
  atualizarStatsSelecao(statsUnificado);
}

// â”€â”€â”€ SELEÃ‡ÃƒO DE COLUNAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleColuna(minuto) {
  const lista = Estado.colunasSelecionadas;
  const idx = lista.indexOf(minuto);
  if (idx !== -1) lista.splice(idx, 1);
  else lista.push(minuto);
  Estado.salvar();
  aplicarColunaHighlights();
  atualizarColunaStats();
}

function aplicarColunaHighlights() {
  const tabela = document.getElementById("tabelaResultados");
  const temSel = Estado.colunasSelecionadas.length > 0;

  // Classe no <table> controla o escurecimento via CSS
  if (tabela) tabela.classList.toggle("tem-coluna-selecionada", temSel);

  // Marca headers
  document.querySelectorAll(".minute-header").forEach(th => {
    const min = parseInt(th.textContent.trim());
    th.classList.toggle("coluna-selecionada", Estado.colunasSelecionadas.includes(min));
  });

  // Marca e garante quadrant-border em todas as cÃ©lulas do tbody
  document.querySelectorAll("#tabelaResultados tbody tr").forEach(row => {
    Array.from(row.cells).forEach((cell, i) => {
      if (i < 2 || i >= 2 + minutosFixos.length) return;
      const colIdx = i - 2;
      const min = minutosFixos[colIdx];
      cell.classList.toggle("coluna-selecionada", Estado.colunasSelecionadas.includes(min));
      // Garante divisor de quadrante
      cell.classList.toggle("quadrant-border", colIdx > 0 && colIdx % 5 === 0);
    });
  });

  // Garante quadrant-border nos headers tambÃ©m
  document.querySelectorAll(".minute-header").forEach((th, i) => {
    th.classList.toggle("quadrant-border", i > 0 && i % 5 === 0);
  });
}

function atualizarColunaStats() {
  let el = document.getElementById("coluna-stats");
  if (!el) {
    el = document.createElement("div");
    el.id = "coluna-stats";
    const painel = document.getElementById("painel-selecao");
    if (painel) painel.insertAdjacentElement("afterend", el);
    else {
      const tabela = document.getElementById("tabelaResultados");
      if (tabela) tabela.parentNode.insertBefore(el, tabela);
    }
  }
  el.innerHTML = "";

  if (Estado.colunasSelecionadas.length === 0) return;

  // Soma TODAS as colunas selecionadas em um Ãºnico total
  let greenTotal = 0, redTotal = 0;
  const colOrdenadas = [...Estado.colunasSelecionadas]
    .sort((a, b) => minutosFixos.indexOf(a) - minutosFixos.indexOf(b));

  colOrdenadas.forEach(min => {
    const colIdx = minutosFixos.indexOf(min);
    if (colIdx === -1) return;
    document.querySelectorAll("#tabelaResultados tbody tr").forEach(row => {
      const cell = row.cells[2 + colIdx];
      if (!cell) return;
      const bg = cell.style.backgroundColor;
      if (bg === "rgb(1, 139, 6)")       greenTotal++;
      else if (bg === "rgb(190, 14, 2)") redTotal++;
    });
  });

  const total = greenTotal + redTotal;
  if (total === 0) return;

  const pct    = Math.round((greenTotal / total) * 100);
  const thresh = getThreshold(document.querySelector("#seletorResultado")?.value || "");
  const mins   = colOrdenadas.join(", ");

  const tag = document.createElement("div");
  tag.className = "col-stat-tag";
  tag.innerHTML = `
    <span class="col-min">min ${mins}</span>
    <span style="color:#aaa;font-size:0.85em">${total}Ã—</span>
    <span class="col-g">${greenTotal}âœ”</span>
    <span class="col-r">${redTotal}âœ˜</span>
    <span class="col-pct ${pct >= thresh ? "col-stat-verde" : "col-stat-branca"}">${pct}%</span>
    <span class="col-remove" title="Limpar seleÃ§Ã£o">âœ•</span>
  `;
  tag.querySelector(".col-remove").addEventListener("click", () => {
    Estado.colunasSelecionadas.length = 0;
    Estado.salvar();
    aplicarColunaHighlights();
    atualizarColunaStats();
  });
  el.appendChild(tag);
}

// â”€â”€â”€ HELPER GLOBAL: extrai sÃ³ o placar (sem nomes de times) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extrairPlacarFromEl(placarEl) {
  const textoEl = placarEl.querySelector(".placar-texto");
  if (!textoEl) return placarEl.textContent.trim();
  return Array.from(textoEl.querySelectorAll("span"))
    .filter(s => !s.classList.contains("time-casa") && !s.classList.contains("time-fora"))
    .map(s => s.textContent.trim())
    .filter(t => t.length > 0)
    .join(" ")
    .trim();
}

// â”€â”€â”€ HIGHLIGHTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function aplicarHighlights() {
  const mostrarTimes = document.querySelector("#mostrarTimes")?.value === "sim";
  const mostrarOdds  = document.querySelector("#mostrarOdds")?.value  === "sim";

  document.querySelectorAll(".placar").forEach(placar => {
    // Use only score text (no team names) for placar matching
    const texto = extrairPlacarFromEl(placar);
    const timeA = placar.getAttribute("data-time-a");
    const timeB = placar.getAttribute("data-time-b");

    // Reset all highlights
    placar.classList.remove("placar-selecionado");
    placar.style.removeProperty("--sel-color");

    // Reset placar score span highlights
    placar.querySelectorAll(".placar-score-selecionado").forEach(el => {
      el.classList.remove("placar-score-selecionado");
      el.style.removeProperty("--sel-color");
    });

    // Reset time name highlights
    placar.querySelectorAll(".time-casa, .time-fora").forEach(span => {
      span.classList.remove("time-nome-selecionado");
      span.style.removeProperty("--sel-color");
    });

    // Placar highlight on the score text spans inside .placar-texto
    for (const val of Estado.placarSelecionados) {
      if (texto.includes(val)) {
        const cor = Estado.getCorSelecao(Estado.placarSelecionados, val, "placar");
        // Apply highlight to all score spans (skip time-casa/time-fora spans)
        const placarTextoEl = placar.querySelector(".placar-texto");
        if (placarTextoEl) {
          placarTextoEl.querySelectorAll("span").forEach(span => {
            if (!span.classList.contains("time-casa") && !span.classList.contains("time-fora")) {
              span.style.setProperty("--sel-color", cor.bg);
              span.classList.add("placar-score-selecionado");
            }
          });
        }
        break;
      }
    }

    // Time highlight: color fill on the name span only
    if (Estado.timesSelecionados.length > 0) {
      [".time-casa", ".time-fora"].forEach(sel => {
        const span = placar.querySelector(sel);
        if (!span) return;
        const fullTime = span.getAttribute("data-full-time");
        for (const val of Estado.timesSelecionados) {
          if (fullTime === val) {
            const cor = Estado.getCorSelecao(Estado.timesSelecionados, val, "time");
            span.style.setProperty("--sel-color", cor.bg);
            span.classList.add("time-nome-selecionado");
            break;
          }
        }
      });
    }

    if (mostrarOdds) {
      const oddEl = placar.querySelector(".odds");
      if (oddEl) {
        oddEl.classList.remove("odd-selecionada");
        oddEl.style.removeProperty("--sel-color");
        for (const val of Estado.oddsSelecionadas) {
          if (oddEl.textContent.trim() === val) {
            const cor = Estado.getCorSelecao(Estado.oddsSelecionadas, val, "odd");
            oddEl.style.setProperty("--sel-color", cor.bg);
            oddEl.classList.add("odd-selecionada");
            break;
          }
        }
      }
    }
  });

  atualizarIndicadorSelecao();
  computeStatsFromDOM();
}

// â”€â”€â”€ UTILITÃRIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showErrorMessage(message) {
  const el = document.getElementById("errorMessage");
  if (!el) return;
  el.textContent = message;
  el.style.display = "block";
}

function hideErrorMessage() {
  const el = document.getElementById("errorMessage");
  if (!el) return;
  el.textContent = "";
  el.style.display = "none";
}

function normalizeString(str) {
  if (!str) return "";
  return str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function formatDateToDDMMYYYY(dateStr) {
  if (dateStr.includes("T")) {
    const date = new Date(dateStr);
    return `${date.getUTCDate().toString().padStart(2,"0")}/${(date.getUTCMonth()+1).toString().padStart(2,"0")}/${date.getUTCFullYear()}`;
  }
  const [d, m, y] = dateStr.split("/");
  return `${d.padStart(2,"0")}/${m.padStart(2,"0")}/${y}`;
}

function getDateStr(data) {
  if (data.includes("T")) return new Date(data).toISOString().split("T")[0];
  const [d, m, y] = data.split("/");
  return `${y}-${m}-${d}`;
}

function normalizarHorario(hora, minuto) {
  const closest = minutosFixos.reduce((prev, curr) =>
    Math.abs(curr - minuto) < Math.abs(prev - minuto) ? curr : prev
  );
  return `${hora.toString().padStart(2,"0")}:${closest.toString().padStart(2,"0")}`;
}

function normalizarHorarioStr(horarioStr) {
  if (!horarioStr) return horarioStr;
  const [h, m] = horarioStr.split(":").map(Number);
  return normalizarHorario(h, m);
}

function abbreviateTeamName(teamName) {
  if (!teamName) return "";
  const words = teamName.trim().split(" ");
  if (words.length > 1) {
    return words.map(w => w.charAt(0).toUpperCase()).join("") + words[words.length-1].slice(0,3).toLowerCase();
  }
  return teamName.length > 5 ? teamName.slice(0,5).toUpperCase() : teamName.toUpperCase();
}

function calculateGoalStats(todasLinhas) {
  const totalGols = todasLinhas.reduce(
    (acc, row) => acc + parseInt(row.children[row.children.length - 3].textContent || 0), 0
  );
  const media = todasLinhas.length > 0 ? (totalGols / todasLinhas.length).toFixed(2) : 0;
  return { totalGols, mediaGolsHora: media };
}

// â”€â”€â”€ INDEX DE ODDS (Map O(1)) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function indexarOdds(oddsData) {
  const teamMapping = { "peixe": "boca" };
  const map = new Map();

  oddsData.forEach(odd => {
    const casa      = normalizeString(teamMapping[odd.time_casa?.toLowerCase()] || odd.time_casa);
    const visitante = normalizeString(teamMapping[odd.time_visitante?.toLowerCase()] || odd.time_visitante);
    const horNorm   = normalizarHorarioStr(odd.horario);

    const set = (k) => { if (!map.has(k)) map.set(k, odd); };
    set(`${odd.data_captura}|${horNorm}|${casa}|${visitante}`); // chave completa
    set(`${horNorm}|${casa}|${visitante}`);                     // sem data
    set(`${horNorm}|${casa}`);                                  // fallback time A
    set(`${horNorm}|${visitante}`);                             // fallback time B
  });

  return map;
}

function findOddsNoIndex(oddsIndex, { data, hora, minuto, time_a, time_b }) {
  const teamMapping = { "peixe": "boca" };
  const tA  = normalizeString(teamMapping[time_a?.toLowerCase()] || time_a);
  const tB  = normalizeString(teamMapping[time_b?.toLowerCase()] || time_b);
  const dt  = formatDateToDDMMYYYY(data);
  const hor = normalizarHorario(hora, minuto);
  return (
    oddsIndex.get(`${dt}|${hor}|${tA}|${tB}`) ||
    oddsIndex.get(`${hor}|${tA}|${tB}`) ||
    oddsIndex.get(`${hor}|${tA}`) ||
    oddsIndex.get(`${hor}|${tB}`) ||
    null
  );
}

function findOddsProximoNoIndex(oddsIndex, { time, team_home, team_visit }) {
  const teamMapping = { "peixe": "boca" };
  const tA  = normalizeString(teamMapping[team_home?.toLowerCase()] || team_home);
  const tB  = normalizeString(teamMapping[team_visit?.toLowerCase()] || team_visit);
  const hor = normalizarHorarioStr(time);
  return (
    oddsIndex.get(`${hor}|${tA}|${tB}`) ||
    oddsIndex.get(`${hor}|${tA}`) ||
    oddsIndex.get(`${hor}|${tB}`) ||
    null
  );
}

function getOddValue(odds, resultado) {
  const oddMap = {
    ambasMarcam:    "odds_ambas_marcam_sim",
    ambasNaoMarcam: "odds_ambas_marcam_nao",
    casaVence:      "odds_casa_vence",
    foraVence:      "odds_visitante_vence",
    empate:         "odds_empate",
    "over1.5":      "odds_mais_1_5",
    "under1.5":     "odds_menos_1_5",
    "over2.5":      "odds_mais_2_5",
    "under2.5":     "odds_menos_2_5",
    "over3.5":      "odds_mais_3_5",
    "under3.5":     "odds_menos_3_5",
    over5:          "odds_mais_5_gols",
    exato0:         "odds_exato_0_gols",
    exato1:         "odds_exato_1_gol",
    exato2:         "odds_exato_2_gols",
    exato3:         "odds_exato_3_gols",
    exato4:         "odds_exato_4_gols",
  };
  return odds ? odds[oddMap[resultado]] || "N/A" : "N/A";
}

// â”€â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchOdds() {
  try {
    const r = await fetch(ROTAS_API.odds(LIGA_ATUAL));
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return await r.json();
  } catch (e) { console.error("Erro odds:", e); return []; }
}

async function fetchProximosJogos() {
  try {
    const r = await fetch(ROTAS_API.proximosJogos(LIGA_ATUAL));
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    const jogos = await r.json();
    return jogos.sort((a,b) => new Date(a.start_time) - new Date(b.start_time)).slice(0, 6);
  } catch (e) { console.error("Erro prÃ³ximos jogos:", e); return []; }
}

// â”€â”€â”€ SELECTED ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSelectedRows() {
  let sel = document.getElementById("selectedRowsContainer");
  const mainTable = document.getElementById("tabelaResultados");

  if (!sel && mainTable) {
    sel = document.createElement("table");
    sel.id = "selectedRowsContainer";
    sel.className = mainTable.className;
    sel.style.cssText = "width:100%;margin-bottom:10px";

    const thead = mainTable.querySelector("thead").cloneNode(true);
    const tr = thead.querySelector("tr");
    if (tr?.firstChild?.className === "selector-header") tr.removeChild(tr.firstChild);
    sel.appendChild(thead);
    sel.appendChild(document.createElement("tbody"));
    mainTable.parentNode.insertBefore(sel, mainTable);
  }
  if (!sel) return;

  if (Estado.selectedChaves.length === 0) { sel.style.display = "none"; return; }
  sel.style.display = "";
  const tbody = sel.querySelector("tbody");
  tbody.innerHTML = "";
  // Sort selected chaves chronologically (oldest at bottom = descending by timestamp)
  // chave format: "YYYY-MM-DD-HH"
  const chavesOrdenadas = [...Estado.selectedChaves].sort((a, b) => {
    // chave: "2025-08-21-14" -> date part + hour
    const partsA = a.split("-");
    const partsB = b.split("-");
    // last element is hour, rest is date
    const horaA = parseInt(partsA[partsA.length - 1]);
    const horaB = parseInt(partsB[partsB.length - 1]);
    const dateA = partsA.slice(0, -1).join("-");
    const dateB = partsB.slice(0, -1).join("-");
    const tsA = new Date(`${dateA}T${horaA.toString().padStart(2,"0")}:00:00`).getTime();
    const tsB = new Date(`${dateB}T${horaB.toString().padStart(2,"0")}:00:00`).getTime();
    return tsB - tsA; // newest first (top), oldest last (bottom)
  });

  chavesOrdenadas.forEach(chave => {
    const row = document.querySelector(`#tabelaResultados tbody tr[data-chave="${chave}"]`);
    if (!row) return;
    const clone = row.cloneNode(true);
    if (clone.firstChild?.className === "row-selector") clone.removeChild(clone.firstChild);
    tbody.appendChild(clone);
  });
}

// â”€â”€â”€ CRIAÃ‡ÃƒO DA TABELA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function criarTabela(dados, oddsData, proximosJogos) {
  // Garante que o painel (indicator + stats) existe no DOM antes de qualquer render
  criarOuObterPainel();

  const tabela = document.getElementById("tabelaResultados");
  const tabelaBody = tabela.querySelector("tbody");
  let thead = tabela.querySelector("thead");
  if (!thead) { thead = document.createElement("thead"); tabela.insertBefore(thead, tabelaBody); }
  thead.innerHTML = "";

  const trPercentual    = Object.assign(document.createElement("tr"), { id: "linhaPercentual",    innerHTML: "<th></th><th>ğŸ“Š</th>" });
  const trTotalGols     = Object.assign(document.createElement("tr"), { id: "linhaTotalGols",     innerHTML: "<th></th><th>âš½</th>" });
  const trAcertosMercado = Object.assign(document.createElement("tr"), { id: "linhaAcertosMercado", innerHTML: "<th></th><th>âœ…</th>" });
  thead.append(trPercentual, trTotalGols, trAcertosMercado);

  const trMinutos = document.createElement("tr");
  const thSel = Object.assign(document.createElement("th"), { className: "selector-header" });
  thSel.style.width = "30px";
  trMinutos.appendChild(thSel);
  trMinutos.appendChild(Object.assign(document.createElement("th"), { textContent: "ğŸ•" }));
  minutosFixos.forEach((m, i) => {
    const th = document.createElement("th");
    th.className = "minute-header";
    th.textContent = m;
    // Quadrant border: every 5 columns (after col 4, 9, 14, 19)
    if (i > 0 && i % 5 === 0) th.classList.add("quadrant-border");
    if (Estado.colunasSelecionadas.includes(m)) th.classList.add("coluna-selecionada");
    th.addEventListener("click", () => toggleColuna(m));
    trMinutos.appendChild(th);
  });
  ["âš½","âœ…","ğŸ“ˆ"].forEach(t => trMinutos.appendChild(Object.assign(document.createElement("th"), { textContent: t })));
  thead.appendChild(trMinutos);

  tabelaBody.innerHTML = "";

  // Controles
  const seletorHoras       = document.querySelector("#seletorHoras");
  const seletorResultado   = document.querySelector("#seletorResultado");
  const seletorTipoPlacar  = document.querySelector("#seletorTipoPlacar");
  const mostrarTimesSelect = document.querySelector("#mostrarTimes");
  const mostrarHTSelect    = document.querySelector("#mostrarHT");
  const mostrarOddsSelect  = document.querySelector("#mostrarOdds");

  if (!seletorHoras || !seletorResultado || !seletorTipoPlacar || !mostrarTimesSelect || !mostrarHTSelect || !mostrarOddsSelect) {
    showErrorMessage("Erro interno: Seletores do formulÃ¡rio nÃ£o encontrados.");
    return;
  }

  const mostrarTimes     = mostrarTimesSelect.value === "sim";
  const mostrarOdds      = mostrarOddsSelect.value  === "sim";
  const mostrarHT        = mostrarHTSelect.value    === "sim";
  const horasSelecionadas = parseInt(seletorHoras.value) || 12;
  const selecaoResultado  = seletorResultado.value;
  const tipoPlacar        = seletorTipoPlacar.value;

  const oddsIndex = indexarOdds(oddsData);

  dados.sort((a, b) => {
    const dA = new Date(`${getDateStr(a.data)}T${a.hora.toString().padStart(2,"0")}:${a.minuto.toString().padStart(2,"0")}:00`).getTime();
    const dB = new Date(`${getDateStr(b.data)}T${b.hora.toString().padStart(2,"0")}:${b.minuto.toString().padStart(2,"0")}:00`).getTime();
    return dB - dA;
  });

  const proximosComHoras = proximosJogos.map(jogo => {
    const [h, m] = jogo.time.split(":").map(Number);
    const closest = minutosFixos.reduce((prev, curr) =>
      Math.abs(curr - m) < Math.abs(prev - m) ? curr : prev
    );
    return { ...jogo, date: new Date(jogo.start_time), hora: h, minuto: closest, team_visitante: jogo.team_visit };
  }).sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

  // Coleta horas Ãºnicas
  const todasHorasSet = new Set();
  proximosComHoras.forEach(jogo => {
    const dataStr = jogo.captured_date ? jogo.captured_date.split("/").reverse().join("-") : jogo.date.toISOString().split("T")[0];
    const ts = new Date(`${dataStr}T${jogo.hora.toString().padStart(2,"0")}:00:00`).getTime();
    todasHorasSet.add(JSON.stringify({ hora: jogo.hora, timestamp: ts, data: dataStr }));
  });
  dados.forEach(dado => {
    const ds = getDateStr(dado.data);
    const ts = new Date(`${ds}T${dado.hora.toString().padStart(2,"0")}:00:00`).getTime();
    todasHorasSet.add(JSON.stringify({ hora: dado.hora, timestamp: ts, data: ds }));
  });

  const horasUnicas = Array.from(todasHorasSet)
    .map(s => JSON.parse(s))
    .sort((a,b) => b.timestamp - a.timestamp)
    .slice(0, horasSelecionadas);

  const mapeamentoChaveLinha = {};

  horasUnicas.forEach(item => {
    const chave = `${item.data}-${item.hora}`;
    const tr = document.createElement("tr");
    tr.setAttribute("data-chave", chave);

    const tdSel = document.createElement("td");
    const cb    = document.createElement("input");
    cb.type = "checkbox"; cb.className = "row-selector";
    cb.checked = Estado.selectedChaves.includes(chave);
    cb.addEventListener("change", function() {
      if (this.checked) { if (!Estado.selectedChaves.includes(chave)) Estado.selectedChaves.push(chave); }
      else { Estado.selectedChaves = Estado.selectedChaves.filter(c => c !== chave); }
      Estado.salvar(); updateSelectedRows();
    });
    tdSel.appendChild(cb); tr.appendChild(tdSel);
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: item.hora.toString().padStart(2,"0") }));
    minutosFixos.forEach((m, i) => {
      const td = document.createElement("td");
      if (i > 0 && i % 5 === 0) td.classList.add("quadrant-border");
      if (Estado.colunasSelecionadas.includes(m)) td.classList.add("coluna-selecionada");
      tr.appendChild(td);
    });
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: "0" }));
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: "0" }));
    tr.appendChild(Object.assign(document.createElement("td"), { textContent: "0%" }));
    tabelaBody.appendChild(tr);
    mapeamentoChaveLinha[chave] = tr;
  });

  // Handlers de clique
  function extrairPlacar(placarEl) {
    // Extracts only the score text, ignoring team name spans
    const textoEl = placarEl.querySelector(".placar-texto");
    if (!textoEl) return placarEl.textContent.trim();
    return Array.from(textoEl.querySelectorAll("span"))
      .filter(s => !s.classList.contains("time-casa") && !s.classList.contains("time-fora"))
      .map(s => s.textContent.trim())
      .join(" ")
      .trim();
  }

  function handlePlacarClick(e) {
    if (e.target.classList.contains("time-casa") || e.target.classList.contains("time-fora")) return;
    const txt = extrairPlacar(e.currentTarget);
    Estado.toggleSelecao("placarSelecionados", txt);
    aplicarHighlights();
  }
  function handleTimeClick(e) {
    if (!mostrarTimes) return;
    const val = e.target.getAttribute("data-full-time");
    if (!val) return;
    Estado.toggleSelecao("timesSelecionados", val);
    aplicarHighlights();
  }
  function handleOddClick(e) {
    e.stopPropagation();
    Estado.toggleSelecao("oddsSelecionadas", e.currentTarget.textContent.trim());
    aplicarHighlights();
  }

  // Dados passados
  const totalGolsPorColuna    = Array(minutosFixos.length).fill(0);
  const totalAcertosPorColuna = Array(minutosFixos.length).fill(0);
  const processedMatches      = new Set();

  // Stats por seleÃ§Ã£o: Map< valor -> { green, red, cor, label } >
  const statsPlacar = new Map();
  const statsTime   = new Map();
  const statsOdd    = new Map();
  Estado.placarSelecionados.forEach((val, i) => {
    statsPlacar.set(val, { green: 0, red: 0, cor: CORES_PLACAR[i % CORES_PLACAR.length], label: "Placar", tipo: "placar" });
  });
  Estado.timesSelecionados.forEach((val, i) => {
    statsTime.set(val, { green: 0, red: 0, cor: CORES_TIME[i % CORES_TIME.length], label: "Time", tipo: "time" });
  });
  Estado.oddsSelecionadas.forEach((val, i) => {
    statsOdd.set(val, { green: 0, red: 0, cor: CORES_ODD[i % CORES_ODD.length], label: "Odd", tipo: "odd" });
  });

  dados.forEach(dado => {
    const ds    = getDateStr(dado.data);
    const chave = `${ds}-${dado.hora}`;
    const linha = mapeamentoChaveLinha[chave];
    const minNorm = minutosFixos.reduce((p, c) => Math.abs(c - dado.minuto) < Math.abs(p - dado.minuto) ? c : p);
    const mk = `${dado.time_a}|${dado.time_b}|${chave}|${minNorm}`;

    if (!linha || processedMatches.has(mk)) return;
    const idx = minutosFixos.indexOf(minNorm);
    if (idx === -1) return;
    const cel = linha.children[2 + idx];
    if (cel.querySelector(".placar")) return;

    const placar = document.createElement("div");
    placar.className = "placar";
    placar.setAttribute("data-time-a", dado.time_a);
    placar.setAttribute("data-time-b", dado.time_b);

    const placarFT = dado.ft, placarHT = dado.ht;
    const primary   = tipoPlacar === "ft" ? placarFT : placarHT;
    const secondary = tipoPlacar === "ft" ? placarHT : placarFT;

    const placarTexto = document.createElement("div");
    placarTexto.className = "placar-texto";
    if (mostrarTimes) {
      const tA = abbreviateTeamName(dado.time_a), tB = abbreviateTeamName(dado.time_b);
      let html = `<span class="time-casa" style="cursor:pointer" data-full-time="${dado.time_a}">${tA}</span>`;
      html += `<span>${primary}</span>`;
      if (mostrarHT) html += `<span>(${secondary})</span>`;
      html += `<span class="time-fora" style="cursor:pointer" data-full-time="${dado.time_b}">${tB}</span>`;
      placarTexto.innerHTML = html;
    } else {
      placarTexto.innerHTML = `<span>${primary}</span>${mostrarHT ? `<span>(${secondary})</span>` : ""}`;
    }
    placar.appendChild(placarTexto);

    const oddsMatch = findOddsNoIndex(oddsIndex, dado);
    if (mostrarOdds) {
      const ov  = getOddValue(oddsMatch, selecaoResultado);
      const oel = document.createElement("div");
      oel.className = "odds"; oel.textContent = `@${ov}`;
      oel.addEventListener("click", handleOddClick);
      placar.appendChild(oel);
    }

    placar.addEventListener("click", handlePlacarClick);
    if (mostrarTimes) {
      placar.querySelector(".time-casa")?.addEventListener("click", handleTimeClick);
      placar.querySelector(".time-fora")?.addEventListener("click", handleTimeClick);
    }

    const oddTip = getOddValue(oddsMatch, selecaoResultado);
    const tooltip = document.createElement("span");
    tooltip.className = "tooltip";
    tooltip.innerHTML = `
      <span class="times">${dado.time_a} vs ${dado.time_b}</span>
      <span class="placares">${placarFT} <span class="placarHT">(${placarHT})</span></span>
      ${oddTip && oddTip !== "N/A" ? `<span class="odd-tooltip">@${oddTip}</span>` : ""}
    `;
    placar.appendChild(tooltip);
    cel.appendChild(placar);
    processedMatches.add(mk);

    // Highlights iniciais - placar highlight on score spans
    const _scoreText = extrairPlacarFromEl(placar);
    for (const val of Estado.placarSelecionados) {
      if (_scoreText.includes(val)) {
        const cor = Estado.getCorSelecao(Estado.placarSelecionados, val, "placar");
        placarTexto.querySelectorAll("span").forEach(span => {
          if (!span.classList.contains("time-casa") && !span.classList.contains("time-fora")) {
            span.style.setProperty("--sel-color", cor.bg);
            span.classList.add("placar-score-selecionado");
          }
        });
        break;
      }
    }
    // Time name highlight (applied to each span individually)
    [".time-casa", ".time-fora"].forEach(sel => {
      const span = placar.querySelector(sel);
      if (!span) return;
      const fullTime = span.getAttribute("data-full-time");
      for (const val of Estado.timesSelecionados) {
        if (fullTime === val) {
          const cor = Estado.getCorSelecao(Estado.timesSelecionados, val, "time");
          span.style.setProperty("--sel-color", cor.bg);
          span.classList.add("time-nome-selecionado");
          break;
        }
      }
    });
    if (mostrarOdds) {
      const oel = placar.querySelector(".odds");
      if (oel) {
        for (const val of Estado.oddsSelecionadas) {
          if (oel.textContent.trim() === val) {
            oel.style.setProperty("--sel-color", Estado.getCorSelecao(Estado.oddsSelecionadas, val, "odd").bg);
            oel.classList.add("odd-selecionada"); break;
          }
        }
      }
    }

    // Acertos
    const placarAtual = tipoPlacar === "ft" ? placarFT : placarHT;
    const [rA, rB] = placarAtual.split(" x ").map(n => parseInt(n) || 0);
    const tg = rA + rB;
    let acerto = false;
    if      (selecaoResultado === "ambasMarcam")    acerto = rA > 0 && rB > 0;
    else if (selecaoResultado === "ambasNaoMarcam") acerto = rA === 0 || rB === 0;
    else if (selecaoResultado === "over1.5")        acerto = tg > 1.5;
    else if (selecaoResultado === "under1.5")       acerto = tg <= 1.5;
    else if (selecaoResultado === "over2.5")        acerto = tg > 2.5;
    else if (selecaoResultado === "under2.5")       acerto = tg <= 2.5;
    else if (selecaoResultado === "over3.5")        acerto = tg > 3.5;
    else if (selecaoResultado === "under3.5")       acerto = tg <= 3.5;
    else if (selecaoResultado === "over5")          acerto = tg >= 5;
    else if (selecaoResultado === "casaVence")      acerto = rA > rB;
    else if (selecaoResultado === "foraVence")      acerto = rB > rA;
    else if (selecaoResultado === "empate")         acerto = rA === rB;
    else if (selecaoResultado === "exato0")         acerto = tg === 0;
    else if (selecaoResultado === "exato1")         acerto = tg === 1;
    else if (selecaoResultado === "exato2")         acerto = tg === 2;
    else if (selecaoResultado === "exato3")         acerto = tg === 3;
    else if (selecaoResultado === "exato4")         acerto = tg === 4;

    cel.style.backgroundColor = acerto ? "#018b06" : "#be0e02";
    if (acerto) {
      linha.children[linha.children.length - 2].textContent =
        parseInt(linha.children[linha.children.length - 2].textContent) + 1;
      totalAcertosPorColuna[idx]++;
    }
    const tgCel = linha.children[linha.children.length - 3];
    tgCel.textContent = parseInt(tgCel.textContent) + tg;
    totalGolsPorColuna[idx] += tg;

    // Acumula stats por seleÃ§Ã£o
    if (!mostrarTimes) {
      const textoP = placarTexto.textContent.trim();
      for (const val of Estado.placarSelecionados) {
        if (textoP.includes(val)) {
          const s = statsPlacar.get(val);
          if (s) { acerto ? s.green++ : s.red++; }
          break;
        }
      }
    }
    if (mostrarTimes) {
      for (const val of Estado.timesSelecionados) {
        if (dado.time_a === val || dado.time_b === val) {
          const s = statsTime.get(val);
          if (s) { acerto ? s.green++ : s.red++; }
          break;
        }
      }
    }
    if (mostrarOdds) {
      const oel = placar.querySelector(".odds");
      if (oel) {
        const oddTxt = oel.textContent.trim();
        for (const val of Estado.oddsSelecionadas) {
          if (oddTxt === val) {
            const s = statsOdd.get(val);
            if (s) { acerto ? s.green++ : s.red++; }
            break;
          }
        }
      }
    }
  });

  // PrÃ³ximos jogos
  proximosComHoras.forEach(jogo => {
    const dataStr = jogo.captured_date ? jogo.captured_date.split("/").reverse().join("-") : jogo.date.toISOString().split("T")[0];
    const chave   = `${dataStr}-${jogo.hora}`;
    const linha   = mapeamentoChaveLinha[chave];
    const mk      = `${jogo.team_home}|${jogo.team_visit}|${chave}|${jogo.minuto}`;

    if (!linha || jogo.minuto === null || processedMatches.has(mk)) return;

    const jaTemResultado = dados.some(d => {
      const dd = getDateStr(d.data);
      return normalizeString(d.time_a) === normalizeString(jogo.team_home) &&
             normalizeString(d.time_b) === normalizeString(jogo.team_visit) &&
             dd === dataStr && d.hora === jogo.hora && d.minuto === jogo.minuto;
    });
    if (jaTemResultado) return;

    const idx = minutosFixos.indexOf(jogo.minuto);
    if (idx === -1) return;
    const cel = linha.children[2 + idx];
    if (cel.querySelector(".placar")) return;

    const placar = document.createElement("div");
    placar.className = "placar placar-futuro";
    placar.setAttribute("data-time-a", jogo.team_home);
    placar.setAttribute("data-time-b", jogo.team_visit);

    const tA = abbreviateTeamName(jogo.team_home);
    const tB = abbreviateTeamName(jogo.team_visit);
    const placarTexto = document.createElement("div");
    placarTexto.className = "placar-texto";
    if (mostrarTimes) {
      placarTexto.innerHTML = `
        <span class="time-casa" style="cursor:pointer" data-full-time="${jogo.team_home}">${tA}</span><br>
        <span class="time-fora" style="cursor:pointer" data-full-time="${jogo.team_visit}">${tB}</span>
      `;
    } else {
      placarTexto.innerHTML = `${tA}<br>${tB}`;
    }
    placar.appendChild(placarTexto);

    const oddsProximo   = findOddsProximoNoIndex(oddsIndex, jogo);
    const oddValProximo = getOddValue(oddsProximo, selecaoResultado);
    if (oddValProximo && oddValProximo !== "N/A") {
      placar.appendChild(Object.assign(document.createElement("div"), {
        className: "placar-futuro-odd", textContent: `@${oddValProximo}`
      }));
    }

    placar.addEventListener("click", handlePlacarClick);
    if (mostrarTimes) {
      placar.querySelector(".time-casa")?.addEventListener("click", handleTimeClick);
      placar.querySelector(".time-fora")?.addEventListener("click", handleTimeClick);
    }

    const tooltip = document.createElement("span");
    tooltip.className = "tooltip";
    tooltip.innerHTML = `
      <span class="times">${jogo.team_home} vs ${jogo.team_visit}</span>
      ${oddValProximo && oddValProximo !== "N/A" ? `<span class="odd-tooltip">@${oddValProximo}</span>` : ""}
    `;
    placar.appendChild(tooltip);
    cel.appendChild(placar);
    processedMatches.add(mk);

    // Time name highlight for future matches
    [".time-casa", ".time-fora"].forEach(sel => {
      const span = placar.querySelector(sel);
      if (!span) return;
      const fullTime = span.getAttribute("data-full-time");
      for (const val of Estado.timesSelecionados) {
        if (fullTime === val) {
          const cor = Estado.getCorSelecao(Estado.timesSelecionados, val, "time");
          span.style.setProperty("--sel-color", cor.bg);
          span.classList.add("time-nome-selecionado");
          break;
        }
      }
    });
  });

  // Footer totais
  totalGolsPorColuna.forEach(t =>
    trTotalGols.appendChild(Object.assign(document.createElement("td"), { className: "total-goals", textContent: t }))
  );
  totalAcertosPorColuna.forEach(t =>
    trAcertosMercado.appendChild(Object.assign(document.createElement("td"), { className: "market-hits", textContent: t }))
  );
  for (let i = 0; i < 3; i++) {
    trTotalGols.appendChild(document.createElement("td"));
    trAcertosMercado.appendChild(document.createElement("td"));
  }

  // % por linha
  const todasLinhas = Array.from(tabelaBody.querySelectorAll("tr"));
  todasLinhas.forEach(row => {
    const total = Array.from(row.cells).slice(2,-3)
      .filter(c => c.querySelector(".placar") && !c.querySelector(".placar-futuro")).length;
    const acertos = parseInt(row.children[row.children.length - 2].textContent);
    const pct = total > 0 ? Math.floor((acertos / total) * 100) : 0;
    const pctCell = row.children[row.children.length - 1];
    pctCell.textContent = `${pct}%`;
    const _thresh = getThreshold(selecaoResultado);
    pctCell.classList.toggle("porcentagem-verde", pct >= _thresh);
    pctCell.classList.toggle("porcentagem-branca", pct < _thresh);
  });

  // % por coluna
  const totMercadoCol = Array(minutosFixos.length).fill(0);
  todasLinhas.forEach(row => {
    Array.from(row.cells).slice(2,-3).forEach((c, i) => {
      if (c.querySelector(".placar") && !c.querySelector(".placar-futuro")) totMercadoCol[i]++;
    });
  });
  totMercadoCol.forEach((tot, i) => {
    const pct = tot > 0 ? Math.floor((totalAcertosPorColuna[i] / tot) * 100) : 0;
    const cell = document.createElement("td");
    cell.textContent = `${pct}%`;
    const _threshCol = getThreshold(selecaoResultado);
    cell.classList.toggle("porcentagem-verde", pct >= _threshCol);
    cell.classList.toggle("porcentagem-branca", pct < _threshCol);
    trPercentual.appendChild(cell);
  });
  for (let i = 0; i < 3; i++) trPercentual.appendChild(document.createElement("td"));

  document.querySelectorAll("#tabelaResultados thead tr:last-child th.minute-header")
    .forEach(th => { th.style.backgroundColor = "#2c303b"; });

  const stats = calculateGoalStats(todasLinhas);
  document.getElementById("totalGols").textContent     = `âš½ Gols: ${stats.totalGols}`;
  document.getElementById("mediaGolsHora").textContent = `ğŸ“Š MÃ©dias: ${stats.mediaGolsHora}`;

  // Monta mapa unificado de stats para exibiÃ§Ã£o (placar + time + odd)
  const statsUnificado = new Map();
  statsPlacar.forEach((v, k) => statsUnificado.set(k, v));
  statsTime.forEach((v, k)   => statsUnificado.set(k, v));
  statsOdd.forEach((v, k)    => statsUnificado.set(k, v));

  criarOuObterPainel(); // garante que o DOM do painel existe antes de atualizar
  aplicarHighlights();  // internamente chama computeStatsFromDOM() lendo o DOM final
  updateSelectedRows();
  aplicarColunaHighlights();
  atualizarColunaStats();
}

// â”€â”€â”€ BUSCA COM DIFF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buscarDados() {
  hideErrorMessage();
  // Recarrega chaves selecionadas para a liga atual e detecta troca de liga
  const ligaAnterior = Estado._ultimaLigaRenderizada;
  const ligaAtual = typeof LIGA_ATUAL !== "undefined" ? LIGA_ATUAL : "default";
  Estado.recarregarChaves();
  if (ligaAnterior !== ligaAtual) {
    // Liga mudou: forÃ§a re-render completo e atualiza badge
    Estado.forcarRerender();
    Estado._ultimaLigaRenderizada = ligaAtual;
  }
  let dados = [], oddsData = [], proximosJogos = [];

  try {
    const r = await fetch(ROTAS_API.resultados(LIGA_ATUAL));
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    dados = await r.json();
  } catch (e) {
    console.error("Erro resultados:", e);
    showErrorMessage(`Erro ao carregar resultados: ${e.message}`);
  }

  try { oddsData = await fetchOdds(); }
  catch (e) { showErrorMessage(`Erro odds: ${e.message}. Sem odds.`); }

  try { proximosJogos = await fetchProximosJogos(); }
  catch (e) { showErrorMessage(`Erro prÃ³ximos jogos: ${e.message}. Sem jogos futuros.`); }

  if (dados.length === 0 && proximosJogos.length === 0) {
    showErrorMessage("Nenhum dado disponÃ­vel. Verifique a conexÃ£o com o servidor.");
    return;
  }

  if (!Estado.dadosMudaram(dados, oddsData, proximosJogos)) {
    console.log("Dados inalterados, re-render ignorado.");
    computeStatsFromDOM();
    updateSelectedRows(); // garante exibiÃ§Ã£o das linhas selecionadas ao voltar de outra liga
    aplicarColunaHighlights();
    atualizarColunaStats();
    return;
  }

  criarTabela(dados, oddsData, proximosJogos);
}

buscarDados();

// Debounced interval: only fires next cycle after current fetch completes
let _buscando = false;
setInterval(async () => {
  if (_buscando) return;
  _buscando = true;
  try { await buscarDados(); }
  finally { _buscando = false; }
}, 5000);

// â”€â”€â”€ LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _seletorHoras       = document.querySelector("#seletorHoras");
const _seletorResultado   = document.querySelector("#seletorResultado");
const _seletorTipoPlacar  = document.querySelector("#seletorTipoPlacar");
const _mostrarTimesSelect = document.querySelector("#mostrarTimes");
const _mostrarHTSelect    = document.querySelector("#mostrarHT");
const _mostrarOddsSelect  = document.querySelector("#mostrarOdds");

if (_seletorHoras)      _seletorHoras.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });
if (_seletorResultado)  _seletorResultado.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });
if (_seletorTipoPlacar) _seletorTipoPlacar.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });

if (_mostrarTimesSelect) {
  _mostrarTimesSelect.addEventListener("change", () => {
    if (_mostrarTimesSelect.value !== "sim") {
      Estado.limparSelecoes(["timesSelecionados"]);
      showToast("SeleÃ§Ãµes de time limpas");
    }
    Estado.forcarRerender();
    buscarDados();
  });
}

if (_mostrarHTSelect) _mostrarHTSelect.addEventListener("change", () => { Estado.forcarRerender(); buscarDados(); });

if (_mostrarOddsSelect) {
  _mostrarOddsSelect.addEventListener("change", () => {
    if (_mostrarOddsSelect.value !== "sim") {
      Estado.limparSelecoes(["oddsSelecionadas"]);
      showToast("SeleÃ§Ãµes de odd limpas");
    }
    Estado.forcarRerender();
    buscarDados();
  });
}

    async function fetchOdds(liga) {
        // Implemente fetch para odds, assumindo rotaOdds
        const response = await fetch(liga.rotaOdds);
        return response.json();
    }

    async function fetchProximosJogos(liga) {
        const response = await fetch(liga.rotaProximos);
        return response.json();
    }

    async function buscarDadosLiga(liga) {
        LIGA_ATUAL = liga.nome;
        Estado.recarregarChaves();
        // ... fetch dados, odds, proximos
        // if (dadosMudaram) criarTabela(liga, dados, oddsData, proximosJogos)
    }

    // Inicial
    Promise.all(ligas.map(buscarDadosLiga));

    // AtualizaÃ§Ã£o
    setInterval(() => Promise.all(ligas.map(buscarDadosLiga)), 10000);

    // Carregar header
    fetch('header.html').then(response => response.text()).then(data => {
        document.getElementById('header').innerHTML = data;
    });

    // Outros scripts se necessÃ¡rio
</script>

<script src="disableChartAnimations.js"></script>
<script src="redirecionar.js"></script>

</body>
</html>