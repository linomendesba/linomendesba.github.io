<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Buscador</title>
    <script async="" src="padrao.js"></script>
    <style>
      :root {
        --primary-color: #2a2e35;
        --secondary-color: #3a3f47;
        --accent-color: #1fac89;
        --text-color: #e0e0e0;
        --table-header: #3a3f47;
        --cell-green: #1f8f3a;
        --cell-red: #b43232;
        --cell-grey: #5a5f67;
        --cell-neutral: #3a3f47;
        --cell-compact: 0; /* 0 = normal | 1 = compacto */
      }
      body {
        font-family: "Segoe UI", system-ui, sans-serif;
        background: #1c1f26;
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      h1,
      h2 {
        color: #1fac89;
        margin: 1.2rem 0;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .filters {
        background: #292d36;
        padding: 1.2rem;
        border-radius: 12px;
        margin-bottom: 1.2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        color: #1fad8b;
        font-size: 13px;
      }
      select,
      input[type="text"] {
        width: 100%;
        padding: 4px;
        border: 2px solid var(--secondary-color);
        border-radius: 8px;
        background: var(--primary-color);
        color: var(--text-color);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--primary-color);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        margin-bottom: 1.4rem;
      }
      th,
      td {
        padding: 1rem;
        text-align: center;
        vertical-align: top;
      }
      th {
        background: var(--table-header);
        color: var(--accent-color);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9em;
        letter-spacing: 0.4px;
        position: sticky;
        top: 0;
      }
      tr {
        border-bottom: 1px solid var(--secondary-color);
      }
      tr:last-child {
        border-bottom: none;
      }
      tr:hover {
        background: var(--secondary-color);
      }
      #status-atualizacao {
        background: #17856b;
        font-size: 12px;
        color: #292d36;
        padding: 0.6rem;
        border-radius: 8px;
        margin: 0.6rem 0;
        text-align: center;
        font-weight: bold;
        display: none;
      }

      .custom-button {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--secondary-color);
        border-radius: 8px;
        background: #17856b;
        color: var(--text-color);
        cursor: pointer;
      }
      .custom-button:hover {
        background-color:  #1fad8b;
      }

      /* mosaicos e faixa dos últimos */
      .mosaic,
      .recent-bar {
        display: inline-flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .recent-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: -2px 0 25px;
      }
      .recent-caption {
        font-size: 0.85rem;
        opacity: 0.8;
        margin-bottom: 15px;
      }

      .cell {
        min-width: 64px;
        min-height: 60px;
        padding: 6px 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        color: #fff;
        border-radius: 8px;
        user-select: none;
        flex-direction: column;
        line-height: 1.1;
      }
      .cell-green {
        background: var(--cell-green);
      }
      .cell-red {
        background: var(--cell-red);
      }
      .cell-grey {
        background: var(--cell-grey);
        color: #e5e5e5;
      }
      .cell-neutral {
        background: var(--cell-neutral);
      }
      .cell .time {
        font-size: 0.7rem;
        font-weight: 700;
        opacity: 0.85;
        white-space: nowrap;
      }
      .cell .team {
        font-size: 0.75rem;
        font-weight: 600;
        opacity: 0.95;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: 120px;
        overflow: hidden;
      }
      .cell .score {
        font-size: 0.9rem;
        font-weight: 800;
      }
      /* compacto opcional */
      @media (max-width: 900px), (min-width: 0px) {
        .cell {
          min-width: calc(64px - 16px * var(--cell-compact));
          min-height: calc(60px - 10px * var(--cell-compact));
        }
        .cell .team {
          font-size: calc(0.75rem - 0.1rem * var(--cell-compact));
        }
        .cell .score {
          font-size: calc(0.9rem - 0.1rem * var(--cell-compact));
        }
      }

      /* sort */
      .sortable {
        cursor: pointer;
      }
      .sortable:after {
        content: " ⟷";
        color: #aaa;
      }
      .sortable.asc:after {
        content: " ↑";
      }
      .sortable.desc:after {
        content: " ↓";
      }

      /* Destaque por padrão (só contorno/brilho) */
      .row-colored {
        --hit: #38bdf8;
        border-left: 6px solid var(--hit);
      }
      .row-active {
        outline: 2px solid var(--hit);
      }
      .cell-hit {
        position: relative;
      }
      .cell-hit::after {
        content: "";
        position: absolute;
        inset: -3px;
        border-radius: 10px;
        box-shadow: 0 0 0 3px var(--hit), 0 0 10px var(--hit);
        pointer-events: none;
      }
      /* Modo foco: escurece os não-selecionados */
      .recent-bar.focus .cell {
        opacity: 0.25;
        filter: grayscale(0.6);
      }
      .recent-bar.focus .cell.cell-focus {
        opacity: 1;
        filter: none;
      }
      .recent-bar.focus .cell.cell-focus.cell-hit::after {
        box-shadow: 0 0 0 3px var(--hit), 0 0 14px var(--hit);
      }

      @media (max-width: 768px) {
        .filters {
          grid-template-columns: 1fr;
        }
        .cell {
          min-width: 58px;
          font-size: 0.85rem;
        }
      }
    </style>
  
  
    
      
        
          Mercados
          <select id="mercado">
            <option value="ambasMarcam" selected>Ambas Sim</option>
            <option value="ambasNaoMarcam">Ambas Não</option>
            <option value="casaVence">Casa vence</option>
            <option value="foraVence">Fora vence</option>
            <option value="empate">Empate</option>
            <option value="over1.5">Over 1.5</option>
            <option value="under1.5">Under 1.5</option>
            <option value="over2.5">Over 2.5</option>
            <option value="under2.5">Under 2.5</option>
            <option value="over3.5">Over 3.5</option>
            <option value="under3.5">Under 3.5</option>
            <option value="over5">Over 5+</option>
          </select>
        
        
          Tipo de Padrão
          <select id="placar_jogos">
            <option value="1">1 jogo</option>
            <option value="2">2 jogos (sequencial)</option>
            <option value="3">3 jogos (sequencial)</option>
            <option value="1_pula_1">1 Pula 1</option>
            <option value="1_pula_1_pula_1">1 Pula 1 Pula 1</option>
            <option value="combinado" selected>Combinado (todos)</option>
          </select>
        
        
          Gales
          <select id="tiros">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        
        
          Horas
          <select id="linhas">
            <option value="60">3 Horas</option>
            <option value="120">6 Horas</option>
            <option value="240">12 Horas</option>
            <option value="480" selected>24 Horas</option>
            <option value="960">48 Horas</option>
            <option value="1440">72 Horas</option>
          </select>
        
        
          Intervalo (pular antes dos tiros)
          <select id="intervalo_jogos">
            <option value="mesma_linha" selected>Mesma Linha (1-10)</option>
            <option value="linha_acima">Linha Acima (21-30)</option>
            <option value="2_linhas_acima">2 Linhas Acima (41-50)</option>
            <option value="3_linhas_acima">3 Linhas Acima (61-70)</option>
          </select>
        
        
        
          Equipes (opcional)
          
        
        
        
          Composição do Padrão
          <select id="modo-padrao">
            <option value="todos" selected>Todas as opções</option>
            <option value="equipes">Somente equipes</option>
            <option value="mercados">Somente mercados</option>
            <option value="placares">Somente placares</option>
            <option value="placares_equipes">Placares e equipes</option>
            <option value="placares_mercados">Placares e mercados</option>
            <option value="equipes_mercados">Equipes e mercados</option>
          </select>
        
        
          Carregar Dados
          <button id="togglestats" onclick="iniciarAnalise()" class="custom-button">
            Carregar Dados
          </button>
        
        
          
            Auto-atualizar
            
          
        
        
          Próxima atualização em: 180 segundos
        
        
          
            Copa América
          
            Taça Glória Eterna
          
            Euro
          
            Campeonato Italiano
          
            Copa das Estrelas
          
            Brasileirao Betano
        
      
    
    
    <script>
      /* ===== Estado ===== */
      let gols,
        ambas_marcam = false,
        ambasnao = false,
        winType;
      let intervaloAtualizacao,
        contadorSegundos = 180;

      // const PALETA = ['#38bdf8','#22c55e','#f59e0b','#ef4444','#a78bfa','#14b8a6','#e879f9','#f97316','#84cc16','#06b6d4','#e11d48','#10b981'];

      const PALETA = [
        "#38bdf8", // azul claro
        "#22c55e", // verde
        "#f59e0b", // laranja/amarelo
        "#ef4444", // vermelho
        "#a78bfa", // lilás
        "#14b8a6", // turquesa
        "#e879f9", // rosa
        "#f97316", // laranja escuro
        "#84cc16", // verde limão
        "#06b6d4", // azul piscina
        "#e11d48", // vermelho rosado
        "#10b981", // verde esmeralda
        "#3b82f6", // azul médio
        "#f472b6", // rosa chiclete
        "#8b5cf6", // roxo vivo
      ];

      /* ★ Estado (equipes + modo de padrão) */
      let equipesFiltro = []; // nomes normalizados em minúsculas
      let modoPadrao = "todos"; // 'todos' | 'equipes' | 'mercados' | 'placares' | 'placares_equipes' | 'placares_mercados' | 'equipes_mercados'
      let incPlacares = true,
        incMercados = true,
        incEquipes = true;

      function aplicarModoPadrao() {
        incPlacares =
          modoPadrao === "placares" ||
          modoPadrao === "placares_equipes" ||
          modoPadrao === "placares_mercados" ||
          modoPadrao === "todos";
        incMercados =
          modoPadrao === "mercados" ||
          modoPadrao === "placares_mercados" ||
          modoPadrao === "equipes_mercados" ||
          modoPadrao === "todos";
        incEquipes =
          modoPadrao === "equipes" ||
          modoPadrao === "placares_equipes" ||
          modoPadrao === "equipes_mercados" ||
          modoPadrao === "todos";
      }

      /* ===== Util ===== */
      function tokensDoJogo(a, b, total, mandante, visitante) {
        const t = new Set();

        if (incPlacares) {
          // placar exato
          t.add(`${a}-${b}`);
        }

        if (incMercados) {
          // mercados principais
          t.add(a > 0 && b > 0 ? "ambas" : "ambasnao");
          t.add(total >= 3 ? "over2.5" : "under2.5");
          if (total < 2) t.add("under1.5");
          if (total >= 4) t.add("over3.5");
          if (total < 4) t.add("under3.5");
          if (total >= 6) t.add("over5");

          // 1x2
          if (a > b) t.add("casa");
          else if (a === b) t.add("empate");
          else t.add("fora");
        }

        if (incEquipes) {
          if (mandante) t.add(mandante.toLowerCase());
          if (visitante) t.add(visitante.toLowerCase());
        }
        return Array.from(t);
      }

      function iniciarAnalise() {
        carregarDados();
        if (intervaloAtualizacao) clearInterval(intervaloAtualizacao);
        if (document.getElementById("auto-atualizar").checked) {
          contadorSegundos = 180;
          atualizarContador();
          intervaloAtualizacao = setInterval(atualizarContador, 1000);
          document.getElementById("status-atualizacao").style.display = "block";
        } else
          document.getElementById("status-atualizacao").style.display = "none";
      }
      function atualizarContador() {
        contadorSegundos--;
        document.getElementById("contador").textContent = contadorSegundos;
        if (contadorSegundos <= 0) {
          contadorSegundos = 180;
          carregarDados();
        }
      }
      document
        .getElementById("auto-atualizar")
        .addEventListener("change", function () {
          if (this.checked) {
            if (!intervaloAtualizacao) {
              contadorSegundos = 180;
              atualizarContador();
              intervaloAtualizacao = setInterval(atualizarContador, 1000);
            }
            document.getElementById("status-atualizacao").style.display =
              "block";
          } else {
            if (intervaloAtualizacao) {
              clearInterval(intervaloAtualizacao);
              intervaloAtualizacao = null;
            }
            document.getElementById("status-atualizacao").style.display =
              "none";
          }
        });
      function definirMercado() {
        const m = document.getElementById("mercado").value;
        if (["casaVence", "empate", "foraVence"].includes(m)) {
          winType = m.replace("Vence", "").toLowerCase() || "empate";
          gols = undefined;
          ambas_marcam = false;
          ambasnao = false;
        } else {
          winType = undefined;
          ambas_marcam = m === "ambasMarcam";
          ambasnao = m === "ambasNaoMarcam";
          gols =
            m === "over5" ? 6 : m === "over3.5" ? 4 : m === "over2.5" ? 3 : 2;
        }
      }

      /* ★ ler/normalizar filtros de equipes + modo do padrão */
      function definirEquipesEModo() {
        // equipes (campo de texto)
        const raw = (document.getElementById("equipes").value || "").trim();
        equipesFiltro = raw
          ? raw
              .split(",")
              .map((s) => s.trim().toLowerCase())
              .filter(Boolean)
          : [];

        // modo do padrão (drop-down novo)
        const sel = document.getElementById("modo-padrao");
        modoPadrao = sel ? sel.value : "todos";
        aplicarModoPadrao();
      }

      function obterNomeLiga(a) {
        if (a.includes("Copa%20Am%C3%A9rica")) return "Copa América";
        if (a.includes("Ta%C3%A7a%20Gl%C3%B3ria%20eterna"))
          return "Taça Glória Eterna";
        if (a.includes("Euro")) return "Euro";
        if (a.includes("Campeonato%20Italiano")) return "Campeonato Italiano";
        if (a.includes("Copa%20das%20estrelas")) return "Copa das Estrelas";
        if (a.includes("Brasileir%C3%A3o%20Betano"))
          return "Brasileirao Betano";
        return a;
      }

      async function carregarDados() {
        definirMercado();
        definirEquipesEModo(); // ★ novo
        const tipoPadrao = document.getElementById("placar_jogos").value;
        const tiros = parseInt(document.getElementById("tiros").value);
        const numLinhas = parseInt(document.getElementById("linhas").value);

        const ligas = [];
        document
          .querySelectorAll('input[type="checkbox"]:checked')
          .forEach(
            (cb) => cb.value && cb.value !== "on" && ligas.push(cb.value)
          );
        if (ligas.length === 0) {
          alert("Por favor, selecione pelo menos uma liga.");
          return;
        }

        const pac = [];
        for (const arq of ligas) {
          try {
            const dados = await carregarArquivo(arq, numLinhas); // contém equipes (col3, col4) e horário (col0)
            let resultados;
            if (tipoPadrao === "combinado") {
              const tipos = ["2", "3", "1_pula_1", "1_pula_1_pula_1"];
              let todos = [];
              for (const t of tipos) {
                const r = analisarAutoPadroes(dados, t, tiros);
                r.forEach((x) => (x.tipo_padrao = t));
                todos = todos.concat(r);
              }
              todos.sort(
                (a, b) =>
                  parseFloat(b.percentual) - parseFloat(a.percentual) ||
                  b.ocorrencias - a.ocorrencias
              );
              resultados = todos.slice(0, 15);
            } else resultados = analisarAutoPadroes(dados, tipoPadrao, tiros);
            pac.push({ liga: obterNomeLiga(arq), resultados, dadosCru: dados });
          } catch (e) {
            console.error(e);
            alert(`Erro ao carregar ${arq}`);
          }
        }
        exibirResultados(pac, tipoPadrao === "combinado");

        const ts = document.createElement("div");
        ts.style.textAlign = "center";
        ts.style.color = "var(--accent-color)";
        ts.style.margin = "14px 0 26px";
        const ag = new Date();
        ts.textContent = `Última atualização: ${ag.toLocaleDateString()} ${ag.toLocaleTimeString()}`;
        document.getElementById("resultados").appendChild(ts);
      }

      async function carregarArquivo(arquivo, numLinhas) {
        const resp = await fetch(arquivo);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        let json = await resp.json();
        if (!Array.isArray(json)) json = [json]; // se for objeto único, wrap em array
        json.sort((a, b) => new Date(a.data) - new Date(b.data));
        const dados = json.slice(-numLinhas).map((item) => {
          const ft = (item.ft || "0 x 0").replace(/\s+/g, "").split("x");
          const a = parseInt(ft[0]) || 0;
          const b = parseInt(ft[1]) || 0;
          const mandante = (item.time_a || "").trim();
          const visitante = (item.time_b || "").trim();
          const horario = `${(item.hora || 0).toString().padStart(2, "0")}:${(
            item.minuto || 0
          )
            .toString()
            .padStart(2, "0")}`;
          return [a, b, a + b, mandante, visitante, horario];
        });
        return dados;
      }

      /* ★ verifica se janela tem alguma equipe filtrada */
      function janelaContemEquipe(jogos) {
        if (equipesFiltro.length === 0) return true;
        for (const j of jogos) {
          const m = (j[3] || "").toLowerCase(),
            v = (j[4] || "").toLowerCase();
          for (const alvo of equipesFiltro) {
            if (m.includes(alvo) || v.includes(alvo)) return true;
          }
        }
        return false;
      }

      function analisarAutoPadroes(dados, tipo, tiros) {
        const res = [];
        const { inicio, fim } = obterIntervalo();
        const offs = getOffsetsByTipo(tipo);
        const last = offs[offs.length - 1];
        for (let p = inicio; p <= fim; p++) {
          const comb = {},
            ex = {};
          const need = last + 1 + p + tiros;
          if (dados.length < need) continue;
          for (let i = 0; i <= dados.length - need; i++) {
            // ★ janela de jogos que compõem o padrão + tiros
            const jogosPadrao = offs.map((o) => dados[i + o]);
            const ini = i + last + 1 + p,
              fimA = ini + tiros;
            const jogosTiro = dados.slice(ini, Math.min(fimA, dados.length));

            // ★ filtro de equipes
            if (!janelaContemEquipe([...jogosPadrao, ...jogosTiro])) continue;

            const tok = [],
              plac = [];
            for (const o of offs) {
              const [a, b, t, mandante, visitante] = dados[i + o];
              tok.push(tokensDoJogo(a, b, t, mandante, visitante));
              plac.push(`${a}x${b}¦${mandante}¦${visitante}`); // guarda equipes para tooltip/mosaico
            }
            const combos = enumerateCombos(tok);
            let green = false;
            for (let j = ini; j < fimA && j < dados.length; j++) {
              const [a, b, sum] = dados[j];
              if (isGreenForSelectedMarket(a, b, sum)) {
                green = true;
                break;
              }
            }
            const placStr = plac.join(" | ");
            for (const seq of combos) {
              const key = seq.join(" | ");
              if (!comb[key]) {
                comb[key] = {
                  ocorrencias: 0,
                  greens: 0,
                  offsets: offs.slice(),
                };
                ex[key] = placStr;
              }
              comb[key].ocorrencias++;
              if (green) comb[key].greens++;
            }
          }
          for (const k in comb) {
            const st = comb[k];
            if (st.ocorrencias >= 3) {
              res.push({
                padrao: k,
                placares: ex[k],
                pular_jogos: p,
                offsets: st.offsets,
                ocorrencias: st.ocorrencias,
                greens: st.greens,
                percentual: ((st.greens / st.ocorrencias) * 100).toFixed(2),
              });
            }
          }
        }
        res.sort(
          (a, b) =>
            parseFloat(b.percentual) - parseFloat(a.percentual) ||
            b.ocorrencias - a.ocorrencias
        );
        return res.slice(0, 15);
      }
      function enumerateCombos(tok) {
        if (tok.length === 1) return tok[0].map((t) => [t]);
        if (tok.length === 2) {
          const out = [];
          for (const a of tok[0]) for (const b of tok[1]) out.push([a, b]);
          return out;
        }
        if (tok.length === 3) {
          const out = [];
          for (const a of tok[0])
            for (const b of tok[1]) for (const c of tok[2]) out.push([a, b, c]);
          return out;
        }
        const out = [],
          cur = [];
        (function rec(i) {
          if (i === tok.length) {
            out.push(cur.slice());
            return;
          }
          for (const t of tok[i]) {
            cur.push(t);
            rec(i + 1);
            cur.pop();
          }
        })(0);
        return out;
      }
      function obterIntervalo() {
        const v = document.getElementById("intervalo_jogos").value;
        if (v === "linha_acima") return { inicio: 21, fim: 30 };
        if (v === "2_linhas_acima") return { inicio: 41, fim: 50 };
        if (v === "3_linhas_acima") return { inicio: 61, fim: 70 };
        return { inicio: 1, fim: 10 };
      }
      function getOffsetsByTipo(t) {
        if (t === "1") return [0];
        if (t === "2") return [0, 1];
        if (t === "3") return [0, 1, 2];
        if (t === "1_pula_1") return [0, 2];
        if (t === "1_pula_1_pula_1") return [0, 2, 4];
        return [0, 1];
      }
      function isGreenForSelectedMarket(a, b, total) {
        if (winType)
          return (
            (winType === "casa" && a > b) ||
            (winType === "empate" && a === b) ||
            (winType === "fora" && a < b)
          );
        if (ambas_marcam) return a > 0 && b > 0;
        if (ambasnao) return !(a > 0 && b > 0);
        const m = document.getElementById("mercado").value;
        if (m === "under1.5") return total < 2;
        if (m === "under2.5") return total < 3;
        if (m === "under3.5") return total < 4;
        if (m === "over5") return total >= 6;
        return total >= (m === "over3.5" ? 4 : m === "over2.5" ? 3 : 2);
      }

      /* hits do padrão nos últimos N (retorna arrays de índices globais) */
      function findPatternHitsInLast(dados, padraoStr, offsets, lookback = 60) {
        const req = padraoStr.split(" | "),
          last = offsets[offsets.length - 1];
        const start = Math.max(0, dados.length - lookback - last),
          end = dados.length - last;
        const hits = [];
        for (let i = start; i < end; i++) {
          let ok = true;
          for (let k = 0; k < offsets.length; k++) {
            const [a, b, t, mandante, visitante] = dados[i + offsets[k]];
            if (!tokensDoJogo(a, b, t, mandante, visitante).includes(req[k])) {
              ok = false;
              break;
            }
          }
          // ★ respeita o filtro de equipes
          if (ok && equipesFiltro.length > 0) {
            const janela = offsets.map((o) => dados[i + o]);
            if (!janelaContemEquipe(janela)) ok = false;
          }
          if (ok) hits.push(offsets.map((o) => i + o));
        }
        return hits;
      }

      /* UI builders */
      function buildPatternMosaicHTML(padraoStr, offsets) {
        const tokens = padraoStr.split(" | "),
          last = offsets[offsets.length - 1];
        let k = 0;
        const cells = [];
        for (let i = 0; i <= last; i++) {
          if (offsets.includes(i)) {
            const token = tokens[k++] || "";
            cells.push(
              `${token}`
            );
          } else cells.push(`Pula`);
        }
        return `${cells.join("")}`;
      }
      function buildExampleMosaicHTML(placaresStr, offsets) {
        const s = placaresStr.split(" | "),
          last = offsets[offsets.length - 1];
        let k = 0;
        const cells = [];
        for (let i = 0; i <= last; i++) {
          if (offsets.includes(i)) {
            const packed = s[k++] || "";
            const [sc, mand, vis] = packed.split("¦"); // recupera equipes para tooltip
            const [a, b] = sc
              .replace(/\s+/g, "")
              .split(/x|-/i)
              .map((x) => parseInt(x) || 0);
            const green = isGreenForSelectedMarket(a, b, a + b);
            const tt = mand || vis ? `${mand || ""} x ${vis || ""}`.trim() : "";
            cells.push(`
        ${mand || ""}
        ${sc}
        ${vis || ""}
      `);
          } else cells.push(`Pula`);
        }
        return `${cells.join("")}`;
      }

      /* ★ Jogos passados (Últimos) com horário + nomes + placar */
      function buildRecentResultsBarHTML(
        dados,
        count = 60,
        indexColorMap = new Map()
      ) {
        const total = dados.length,
          start = Math.max(0, total - count),
          ultimos = dados.slice(start);
        // ultimos is oldest to newest
        // to display newest to oldest, reverse
        const reversed = [...ultimos].reverse();
        // now group by hour
        const groups = [];
        let currentHour = null;
        let currentGroup = [];
        reversed.forEach((item, localIdx) => {
          const globalIdx = total - 1 - localIdx; // since reversed, first is total-1, last is total-count
          const horario = item[5];
          const hour = horario ? horario.split(':')[0] : '??';
          if (hour !== currentHour) {
            if (currentGroup.length > 0) {
              groups.push({hour: currentHour, items: currentGroup});
            }
            currentHour = hour;
            currentGroup = [];
          }
          // add with global idx
          currentGroup.push({item, idx: globalIdx});
        });
        if (currentGroup.length > 0) {
          groups.push({hour: currentHour, items: currentGroup});
        }
        // now build HTML
        let html = '';
        groups.forEach(group => {
          const cells = group.items.map(({item, idx}) => {
            const [a, b, sum, mand, vis, horario] = item;
            const green = isGreenForSelectedMarket(a, b, sum);
            const hitColor = indexColorMap.get(idx);
            const title = `${horario ? horario + " — " : ""}${mand || ""} ${a}x${b} ${vis || ""}`.trim();
            const base = `
              ${horario || ""}
              ${mand || ""}
              ${a}x${b}
              ${vis || ""}
            `;
            if (hitColor) {
              return `
                ${base}
              `;
            }
            return `
              ${base}
            `;
          });
          html += `Hora ${group.hour}:00 (recente ➜ antigo) - ${group.items.length} resultados${cells.join('')}`;
        });
        return html;
      }

      /* sort */
      function attachSortingHandlers(tabela) {
        const ths = [...tabela.querySelectorAll("th")];
        const idxP = ths.findIndex((th) =>
          th.textContent.trim().toLowerCase().startsWith("pular")
        );
        const idxO = ths.findIndex((th) =>
          th.textContent.trim().toLowerCase().startsWith("ocorr")
        );
        [idxP, idxO].forEach((idx) => {
          if (idx >= 0) {
            const th = ths[idx];
            th.classList.add("sortable");
            th.addEventListener("click", () => {
              const dir = th.classList.contains("asc") ? "desc" : "asc";
              ths.forEach((x) => x.classList.remove("asc", "desc"));
              th.classList.add(dir);
              const rows = [...tabela.querySelectorAll("tr")].slice(1);
              rows.sort((A, B) => {
                const a = A.children[idx].textContent.trim(),
                  b = B.children[idx].textContent.trim();
                const na = parseFloat(a.replace("%", "")) || parseInt(a) || 0,
                  nb = parseFloat(b.replace("%", "")) || parseInt(b) || 0;
                return dir === "asc" ? na - nb : nb - na;
              });
              rows.forEach((r) => tabela.appendChild(r));
            });
          }
        });
      }

      /* render com clique para foco */
      function exibirResultados(conjuntos, combinado) {
        const root = document.getElementById("resultados");
        root.innerHTML = "";

        const m = document.getElementById("mercado").value;
        const info = document.createElement("div");
        //info.style.fontWeight = "bold";
        //info.style.marginBottom = "10px";
        //info.textContent =
          m === "ambasMarcam"
            ? "Mercado: Ambas Sim"
            : m === "ambasNaoMarcam"
            ? "Mercado: Ambas Não"
            : m === "under1.5"
            ? "Mercado: Under 1.5 (menos de 2 gols)"
            : m === "under2.5"
            ? "Mercado: Under 2.5 (menos de 3 gols)"
            : m === "under3.5"
            ? "Mercado: Under 3.5 (menos de 4 gols)"
            : m === "over5"
            ? "Mercado: Over 5 (6+ gols)"
            : m === "over3.5"
            ? "Mercado: Over 3.5 (4+ gols)"
            : m === "over2.5"
            ? "Mercado: Over 2.5 (3+ gols)"
            : m === "over1.5"
            ? "Mercado: Over 1.5 (2+ gols)"
            : m === "casaVence"
            ? "Mercado: Casa vence"
            : m === "empate"
            ? "Mercado: Empate"
            : m === "foraVence"
            ? "Mercado: Fora vence"
            : "";
        root.appendChild(info);

        const modo = document.getElementById("placar_jogos").value;
        const map = {
          mesma_linha: "Mesma Linha (1-10)",
          linha_acima: "Linha Acima (21-30)",
          "2_linhas_acima": "2 Linhas Acima (41-50)",
          "3_linhas_acima": "3 Linhas Acima (61-70)",
        };
        const info2 = document.createElement("div");
        info2.style.fontWeight = "bold";
        info2.style.marginBottom = "6px";
        //info2.textContent = `Modo: ${
        //  combinado ? "Combinado (todos)" : `Padrão ${modo}`
        //} | Intervalo: ${
        //  map[document.getElementById("intervalo_jogos").value]
        //}
        root.appendChild(info2);

        // ★ badge de filtro + composição
        if (equipesFiltro.length > 0) {
          const tag = document.createElement("div");
          tag.style.marginBottom = "14px";
          const comp =
            {
              todos: "placares, mercados e equipes",
              equipes: "apenas equipes",
              mercados: "apenas mercados",
              placares: "apenas placares",
              placares_equipes: "placares e equipes",
              placares_mercados: "placares e mercados",
              equipes_mercados: "equipes e mercados",
            }[modoPadrao] || "todas as opções";
          tag.innerHTML = `Filtro de equipes: ${equipesFiltro.join(
            ", "
          )} — composição do padrão: ${comp}`;
          root.appendChild(tag);
        }

        for (const { liga, resultados, dadosCru } of conjuntos) {
          // ---- mapa índice->cor (para contorno nos "Últimos 30")
          const indexColorMap = new Map();

          const h2 = document.createElement("h2");
          h2.textContent = liga;
          root.appendChild(h2);

          // Monta a tabela primeiro para descobrir hits e cores
          const tabela = document.createElement("table");
          tabela.innerHTML = `
      ${combinado ? "Tipo" : ""}
      Padrão (mosaico)
      Placares (mosaico exemplo)
      Pular Jogos
      Ocorrências
      Greens
      Percentual
    `;

          // Guardamos referências para ativar foco por linha
          const linhasInfo = []; // {tr, color, hitSet}

          resultados.forEach((r, i) => {
            const offsets = r.offsets?.length
              ? r.offsets
              : getOffsetsByTipo(r.tipo_padrao || modo);
            const color = PALETA[i % PALETA.length];

            // hits nos últimos 30 (lista de arrays de índices); agregamos em um Set
            const hits = findPatternHitsInLast(dadosCru, r.padrao, offsets, 60);
            const hitSet = new Set();
            hits.forEach((arr) =>
              arr.forEach((ix) => {
                if (!indexColorMap.has(ix)) indexColorMap.set(ix, color);
                hitSet.add(ix);
              })
            );

            const tr = document.createElement("tr");
            tr.className = "row-colored";
            tr.style.setProperty("--hit", color);

            const tipoTxt = combinado
              ? {
                  1: "1 posição",
                  2: "2 posições",
                  3: "3 posições",
                  "1_pula_1": "1 Pula 1",
                  "1_pula_1_pula_1": "1 Pula 1 Pula 1",
                }[r.tipo_padrao] ||
                r.tipo_padrao ||
                ""
              : null;

            tr.innerHTML = `
        ${combinado ? `${tipoTxt}` : ""}
        ${buildPatternMosaicHTML(r.padrao, offsets)}
        ${buildExampleMosaicHTML(r.placares, offsets)}
        ${r.pular_jogos}
        ${r.ocorrencias}
        ${r.greens}
        ${r.percentual}%
      `;
            tabela.appendChild(tr);
            linhasInfo.push({ tr, color, hitSet });
          });

          // Barra dos últimos 30 com data-idx + horário + nomes + placar
          const recent = document.createElement("div");
          recent.className = "recent-wrap";
          recent.innerHTML = buildRecentResultsBarHTML(
            dadosCru,
            60,
            indexColorMap
          );
          const recentBar = recent.querySelector(".recent-bar");
          root.appendChild(recent);

          // Clique nas linhas -> modo foco nesta liga
          let activeRow = null;
          function clearFocus() {
            if (!recentBar) return;
            recentBar.classList.remove("focus");
            recentBar.querySelectorAll(".cell").forEach((c) => {
              c.classList.remove("cell-focus");
            });
            if (activeRow) {
              activeRow.classList.remove("row-active");
              activeRow = null;
            }
          }
          linhasInfo.forEach(({ tr, color, hitSet }) => {
            tr.addEventListener("click", () => {
              if (activeRow === tr) {
                clearFocus();
                return;
              }
              if (activeRow) activeRow.classList.remove("row-active");
              activeRow = tr;
              tr.classList.add("row-active");

              recentBar.classList.add("focus");
              recentBar.querySelectorAll(".cell").forEach((c) => {
                const idx = parseInt(c.getAttribute("data-idx"));
                if (hitSet.has(idx)) {
                  c.classList.add("cell-focus");
                  c.classList.add("cell-hit");
                  c.style.setProperty("--hit", color);
                } else {
                  c.classList.remove("cell-focus");
                }
              });
            });
          });

          // clicar fora da tabela (na barra) limpa foco
          recentBar.addEventListener("click", (e) => {
            if (!e.target.closest(".cell-focus")) clearFocus();
          });

          root.appendChild(tabela);
          attachSortingHandlers(tabela);
        }
      }

      /* listeners iniciais */
      document.addEventListener("DOMContentLoaded", () => {
        const selModo = document.getElementById("modo-padrao");
        if (selModo) {
          selModo.addEventListener("change", () => {
            definirEquipesEModo();
            iniciarAnalise();
          });
        }
      });
    </script>
    
      <template shadowrootmode="open">&#x3C;style>
          #vimeo_tool {
            width: 100vw;
            height: 100vh;
            position: fixed;
            z-index: 9999;
            top: 0;
            background: rgba(0, 0, 0, 0.3);
            color: #3d3d3d;
            font-family: Source Han Sans;
            font-variation-settings: "opsz" auto;
            font-feature-settings: "kern" on;
            line-height: normal;
          }
<p>#vimeo_tool.isOption {
background: linear-gradient(#fff, rgba(100, 170, 228, 0.2));
}</p>
<p>.priceImg {
width: 372px;
z-index: 99;
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
}</p>
<p>.priceImg .get {
position: absolute;
left: 50%;
transform: translateX(-50%);
height: 28px;
border-radius: 4px;
background-color: rgba(13, 189, 189, 1);
color: rgba(255, 255, 255, 1);
font-size: 16px;
text-align: center;
font-family: Roboto;
cursor: pointer;
width: 67px;
bottom: 48px;
line-height: 28px;
}</p>
<p>.priceImg img {
width: 100%;
}</p>
<p>.priceImg .close {
position: absolute;
top: 5px;
right: 5px;
font-size: 18px;
cursor: pointer;
color: rgba(154, 154, 154, 1);
}</p>
<p>.pop {
position: fixed;
left: 50%;
top: 50%;
transform: translateX(-50%) translateY(-50%);
z-index: 9999999;
}</p>
<p>.notice {
width: 360px;
text-align: center;
margin-bottom: 20px;
}</p>
<p>.notice_in {
display: none;
height: 30px;
line-height: 30px;
background-color: #fbf6f6;
animation: fadenum 1s;
width: 470px;
margin: 0 auto 0 -40px;
}</p>
<p>.notice_in_svg {
float: left;
margin-left: 10px;
margin-top: 1px;
}</p>
<p>@keyframes fadenum {
0% {
transform: translateX(70px);
}
}</p>
<p>.dialog {
height: 560px;
width: 400px;
background-color: #fbf6f6;
padding-top: 0px;
}</p>
<p>.dialog_close {
margin-top: -102px;
margin-left: 380px;
position: absolute;
}</p>
<p>.dialog_in {
max-width: 320px;
flex: 1;
border: 1px solid #fd935a;
border-radius: 5px;
position: relative;
margin-right: 15px;
padding-top: 20px;
}</p>
<p>.dialog_in:last-child {
margin-right: 0;
}</p>
<p>.dialog_in span.discount {
color: #b36bf4;
position: absolute;
right: 0;
top: 0;
background: #f9dfcf;
padding: 6px 0 6px 6px;
border-radius: 0 4px 0 6px;
font-size: 13px;
}</p>
<p>:root {
--titleHeight: 55px;
}</p>
<p>.pro {
text-align: center;
height: var(--titleHeight);
line-height: var(--titleHeight);
color: #000;
font-weight: 450;
font-size: 28px;
}</p>
<p>.dialog_line {
border-bottom: 1px solid #ffc750;
margin: 0 auto;
width: 300px;
}</p>
<p>.fee {
display: block;
text-align: center;
height: var(--titleHeight);
line-height: var(--titleHeight);
}</p>
<p>.fee > span:nth-child(1) {
font-size: 34px;
color: #444444;
font-weight: 500;
font-family: Source Han Sans;
}</p>
<p>#newsvd_dialog_in.Yearly .fee > span:nth-child(1) {
color: #fd935a;
}</p>
<p>#newsvd_dialog_in.Yearly span.discount {
border-radius: 0 4px 0 100%;
width: 45px;
height: 45px;
text-align: center;
}</p>
<p>.fee > span:nth-child(2) {
color: #b6b5b5;
font-size: 14px;
}</p>
<p>.feature_list {
margin-left: 40px;
text-align: left;
}</p>
<p>.feature_list img.rightIcon {
margin-right: 7px;
}</p>
<p>.feature_list ul {
margin-left: -40px;
font-size: 14px;
}</p>
<p>.feature_list ul li svg {
margin-left: -10px;
margin-right: 0px;
height: 13px;
}</p>
<p>.feature_list ul li {
line-height: 30px;
text-indent: -15px;
list-style: none;
}</p>
<p>.feature_list ul li::marker {
color: #00c0be;
}</p>
<p>.dialog_get {
cursor: pointer;
border: none;
display: block;
border-radius: 5px;
background-color: #00c0be;
height: 30px;
width: 100px;
line-height: 30px;
margin: 10px auto 5px;
font-weight: 600;
color: white;
}</p>
<p>.newsvd_pro_sub {
border-radius: 999999px;
color: #fd935a;
box-sizing: border-box;
border: 1px solid #fd935a;
width: 80%;
text-align: center;
padding: 8px;
margin: 10px auto;
cursor: pointer;
font-weight: 500;
display: inline-block;
transition: all 0.4s;
font-size: 14px;
}</p>
<p>#newsvd_dialog_in.Yearly .newsvd_pro_sub {
background: linear-gradient(180deg, #f1c946 0%, #fd935a 100%);
color: #fff;
}</p>
<p>#newsvd_dialog_in.Yearly .newsvd_pro_sub:hover {
opacity: 0.9;
}</p>
<p>span.newsvd_pro_sub:hover {
background: #fd935a;
color: #fff;
}</p>
<p>.dialog_close {
height: 20px;
width: 20px;
border-radius: 4em;
}</p>
<p>.dialog_close:hover {
background-color: #00c0be;
}</p>
<p>.external_ffmpeg {
color: blue;
cursor: pointer;
text-decoration: underline;
}</p>
<p>#payment_popup {
position: fixed;
z-index: 100;
width: 100vw;
height: 100vh;
top: 0px;
background: rgba(0, 0, 0, 0.3);
}</p>
<p>.payment_content {
position: absolute;
left: 50%;
top: 50%;
transform: translateX(-50%) translateY(-50%);
z-index: 103;
height: 320px;
width: 410px;
background: #fff;
padding: 20px;
}</p>
<p>.payment_select {
padding: 20px 0 0 110px;
}</p>
<p>.payment_label {
line-height: 30px;
}</p>
<p>.original_price {
text-decoration: line-through;
color: red !important;
}</p>
<p>.chat_summary_block,
.newsvd_chat_summary_block {
display: none;
position: absolute;
width: 250px;
margin-left: 65px;
height: 85px;
text-align: center !important;
background: white;
}</p>
<p>.summary_new {
height: 18px;
width: 18px;
margin-right: -3px;
margin-left: -6px;
float: left;
border-radius: 3px;
}</p>
<p>.newsvd_summary_new {
height: 18px;
width: 18px;
margin-top: -4px;
margin-right: -3px;
margin-left: -5px;
float: left;
border-radius: 3px;
}</p>
<p>.timerInput {
font-size: 16px;
display: inline-block;
margin: 10px 7% 0 0;
}</p>
<p>.timeTip {
display: none;
position: absolute;
left: 23px;
border-radius: 5px;
width: 220px;
margin-top: -27px;
margin-left: -250px;
height: 20px;
font-size: 12px;
line-height: 20px;
text-align: center !important;
background: #0072e6;
color: white;
}</p>
<p>.timerInput p {
width: 77px;
height: 31px;
line-height: 31px;
border: 1px solid #9a999c;
border-radius: 4px;
color: #9a999c;
font-size: 14px;
text-align: center;
font-family: Roboto;
margin-top: 5px;
}</p>
<p>.spanTimer {
background: none;
outline: none;
padding: 0 !important;
width: 16px;
border: 0;
color: #9a999c !important;
}</p>
<p>.spanTimer:focus {
border: none;
}</p>
<p>.time_middle {
margin-left: -15px;
color: #9a999c;
}</p>
<p>.jump_to_chatGPT {
background: #0072e6 !important;
color: white;
outline: none;
font-size: 13px !important;
height: 27px !important;
width: 150px;
border-radius: 5px;
border: none;
margin-top: 10px !important;
cursor: pointer;
}</p>
<p>.summary_position {
display: inline-block;
position: relative;
margin-left: -10px;
top: 5px;
cursor: pointer;
}</p>
<p>.summary_position img {
height: 20px;
width: 20px;
}</p>
<p>.summary_position:hover:after {
position: absolute;
left: -30px;
top: -25px;
padding: 5px;
background-color: black;
border-radius: 5px;
color: #fff;
content: attr(labelTooltip);
white-space: nowrap;
z-index: 2;
width: 120px;
}</p>
<p>.summary_time_height {
height: 41px;
}</p>
<p>.other_options {
line-height: 20px !important;
}</p>
<p>.other_options_img {
height: 20px;
width: 20px;
float: right;
}</p>
<p>.newsvd_dialog {
background-color: #fff;
padding-top: 20px;
padding: 20px 34px;
position: relative;
height: auto;
border-radius: 6px;
box-shadow: 0 0 10px #0000004d;
width: 80vw;
max-width: 940px;
}</p>
<p>.newsvd_dialog_close {
height: 20px;
width: 20px;
border-radius: 4em;
right: 6px;
top: 4px;
position: absolute;
cursor: pointer;
}</p>
<p>.newsvd_dialog_close:hover {
background-color: #fd935a;
}</p>
<p>.top_pro_container {
text-align: center;
margin-bottom: 30px;
}</p>
<p>.top_pro {
font-size: 30px;
font-weight: 500;
margin-bottom: 5px;
color: #3d3d3d;
}</p>
<p>.top_pro_span {
font-size: 13px;
color: #9a999c;
}</p>
<p>.discountImg {
position: absolute;
width: 120px;
right: -60px;
top: -60px;
}</p>
<p>.perMon {
color: #a19f9f;
font-size: 15px;
text-align: center;
height: 18px;
line-height: 18px;
}</p>
<p>.hotTitle {
position: absolute;
width: 100%;
padding: 5px 0 5px 8px;
top: 0;
transform: translateY(-100%);
z-index: 0;
border-radius: 8px 8px 0 0;
opacity: 1;
background: rgba(179, 107, 244, 0.4);
font-size: 13px;
font-weight: 600;
color: #fd935a;
box-sizing: border-box;
text-align: left;
}</p>
<p>.cardLogo {
position: absolute;
top: 8px;
left: 9px;
font-size: 14px;
color: #3d3d3d;
}
.cardLogo img {
width: 14px;
vertical-align: middle;
margin-top: -3px;
}</p>
<p>/* 800px以下媒体查询 */
@media screen and (max-width: 800px) {
.newsvd_dialog {
width: 90vw;
}</p></template>div#pop {
top: 0;
padding-top: 0;
transform: translateX(-50%) translateY(0);
overflow: auto;
max-height: calc(100vh - 40px);
}
}
</style>