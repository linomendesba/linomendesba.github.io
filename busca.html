<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscador de Padrões</title>
  <script async src="padrao.js"></script>
  <style>
    :root {
      --primary-color: #1c1f26;
      --secondary-color: #2a2e35;
      --tertiary-color: #3a3f47;
      --accent-color: #1fac89;
      --accent-hover: #17967a;
      --text-color: #f8fafc;
      --text-muted: #cbd5e1;
      --border-color: #475569;
      --table-header: #2a2e35;
      --cell-green: #059669;
      --cell-red: #dc2626;
      --cell-grey: #64748b;
      --cell-neutral: #475569;
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--primary-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      line-height: 1.6;
    }

    .main-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2rem;
      background: var(--secondary-color);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }

    h1 {
      color: var(--accent-color);
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .filters-container {
      background: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .filters-header {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 500;
      color: var(--text-color);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    select, .custom-button {
      width: 100%;
      padding: 0.875rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--primary-color);
      color: var(--text-color);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    select:hover, select:focus,
    .custom-button:hover, .custom-button:focus {
      border-color: var(--accent-color);
      outline: none;
    }

    .custom-button {
      cursor: pointer;
      font-weight: 500;
      background: var(--accent-color);
      border: none;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .custom-button:hover {
      background: var(--accent-hover);
    }

    .auto-update-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--primary-color);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
    }

    .auto-update-section input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
    }

    #status-atualizacao {
      background: var(--tertiary-color);
      color: var(--accent-color);
      padding: 1rem;
      border-radius: var(--radius-sm);
      margin-top: 1rem;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--border-color);
      display: none;
    }

    .leagues-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--border-color);
    }

    .leagues-title {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .leagues-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .league-checkbox {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--primary-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .league-checkbox:hover {
      background: var(--tertiary-color);
      border-color: var(--accent-color);
    }

    .league-checkbox input[type="checkbox"] {
      width: 1.125rem;
      height: 1.125rem;
    }

    .results-container {
      margin-top: 2rem;
    }

    .market-info {
      background: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .market-info-title {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--accent-color);
      margin-bottom: 0.5rem;
    }

    .market-info-details {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .league-section {
      background: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      margin-bottom: 2.5rem;
      overflow: hidden;
    }

    .league-header {
      background: var(--tertiary-color);
      padding: 1.5rem 2rem;
      border-bottom: 2px solid var(--border-color);
    }

    .league-title {
      color: var(--accent-color);
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .recent-results-section {
      padding: 1.5rem 2rem;
      background: var(--primary-color);
      border-bottom: 1px solid var(--border-color);
    }

    .table-section {
      padding: 0;
      background: var(--secondary-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }

    th, td {
      padding: 1.25rem;
      text-align: left;
      vertical-align: middle;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background: var(--tertiary-color);
      color: var(--text-color);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.875rem;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover {
      background: rgba(31, 172, 137, 0.05);
    }

    .row-colored {
      border-left: 4px solid var(--accent-color);
    }

    .row-active {
      background: rgba(31, 172, 137, 0.1) !important;
      border: 1px solid var(--accent-color);
    }

    .mosaic, .recent-bar {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .recent-wrap {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .recent-caption {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      font-weight: 500;
    }

    .cell {
      min-width: 48px;
      min-height: 32px;
      padding: 8px 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: white;
      border-radius: var(--radius-sm);
      user-select: none;
      transition: all 0.2s ease;
    }

    .cell-green {
      background: var(--cell-green);
    }

    .cell-red {
      background: var(--cell-red);
    }

    .cell-grey {
      background: var(--cell-grey);
      color: #e2e8f0;
    }

    .cell-neutral {
      background: var(--cell-neutral);
    }

    .sortable {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
    }

    .sortable:hover {
      color: var(--accent-color);
    }

    .sortable:after {
      content: " ⟷";
      color: var(--text-muted);
      margin-left: 0.5rem;
    }

    .sortable.asc:after {
      content: " ↑";
      color: var(--accent-color);
    }

    .sortable.desc:after {
      content: " ↓";
      color: var(--accent-color);
    }

    .cell-hit {
      position: relative;
    }

    .cell-hit::after {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--accent-color);
      pointer-events: none;
    }

    .recent-bar.focus .cell {
      opacity: 0.3;
      filter: grayscale(0.6);
    }

    .recent-bar.focus .cell.cell-focus {
      opacity: 1;
      filter: none;
      transform: scale(1.05);
    }

    .timestamp {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin: 2rem 0;
      padding: 1rem;
      background: var(--primary-color);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 1rem;
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .leagues-grid {
        grid-template-columns: 1fr;
      }

      .cell {
        min-width: 44px;
        font-size: 0.8rem;
      }

      h1 {
        font-size: 2rem;
      }

      th, td {
        padding: 1rem 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .page-header {
        padding: 1.5rem;
      }

      .filters-container {
        padding: 1.5rem;
      }

      .league-header {
        padding: 1rem 1.5rem;
      }

      .recent-results-section,
      .table-section {
        padding: 1rem 1.5rem;
      }
    }
  </style>
</head>
<body>
<div class="main-container">


  <div class="filters-container">
    <div class="filters-header">Configurações</div>
    <div class="filters">
      <div class="filter-group">
        <label for="mercado">Mercado para o GREEN:</label>
        <select id="mercado">
          <option value="ambasMarcam" selected>Ambas Marcam</option>
          <option value="ambasNaoMarcam">Ambas Não Marcam</option>
          <option value="casaVence">Casa Vence</option>
          <option value="foraVence">Fora Vence</option>
          <option value="empate">Empate</option>
          <option value="over1.5">Over 1.5</option>
          <option value="under1.5">Under 1.5</option>
          <option value="over2.5">Over 2.5</option>
          <option value="under2.5">Under 2.5</option>
          <option value="over3.5">Over 3.5</option>
          <option value="under3.5">Under 3.5</option>
          <option value="over5">Over 5+</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="placar_jogos">Tipo de Padrão (auto):</label>
        <select id="placar_jogos">
          <option value="1">1 posição</option>
          <option value="2">2 posições (sequencial)</option>
          <option value="3">3 posições (sequencial)</option>
          <option value="1_pula_1">1 Pula 1</option>
          <option value="1_pula_1_pula_1">1 Pula 1 Pula 1</option>
          <option value="combinado" selected>Combinado (todos)</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="tiros">Tiros:</label>
        <select id="tiros">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="linhas">Número de Jogos (linhas):</label>
        <select id="linhas">
                    <option value="60">3 Horas</option>
                    <option value="120">6 Horas</option>
                    <option value="240">12 Horas</option>
                    <option value="480" selected>24 Horas</option>
                    <option value="960">48 Horas</option>
                    <option value="1440">72 Horas</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="intervalo_jogos">Intervalo (pular antes dos tiros):</label>
        <select id="intervalo_jogos">
          <option value="mesma_linha" selected>Mesma Linha (1-10)</option>
          <option value="linha_acima">Linha Acima (21-30)</option>
          <option value="2_linhas_acima">2 Linhas Acima (41-50)</option>
          <option value="3_linhas_acima">3 Linhas Acima (61-70)</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Carregar Dados</label>
        <button id="togglestats" onclick="iniciarAnalise()" class="custom-button">Carregar Dados</button>
      </div>
    </div>
    <div class="auto-update-section">
      <label for="auto-atualizar" style="display:flex;align-items:center;gap:.6rem; margin:0;">
        <span>Auto-atualizar a cada 3 minutos:</span>
        <input type="checkbox" id="auto-atualizar" checked>
      </label>
    </div>
    <div id="status-atualizacao">
      Próxima atualização em: <span id="contador">180</span> segundos
    </div>
    <div class="leagues-section">
      <div class="leagues-title">Selecione as Ligas</div>
      <div class="leagues-grid">
        <label class="league-checkbox"><input type="checkbox" value="https://betstat.site/resultados/Copa%20Am%C3%A9rica"> Copa América</label>
        <label class="league-checkbox"><input type="checkbox" value="https://betstat.site/resultados/Ta%C3%A7a%20Gl%C3%B3ria%20eterna"> Taça Glória Eterna</label>
        <label class="league-checkbox"><input type="checkbox" value="https://betstat.site/resultados/Euro"> Euro</label>
        <label class="league-checkbox"><input type="checkbox" value="https://betstat.site/resultados/Campeonato%20Italiano"> Campeonato Italiano</label>
        <label class="league-checkbox"><input type="checkbox" value="https://betstat.site/resultados/Copa%20das%20estrelas"> Copa das Estrelas</label>
        <label class="league-checkbox"><input type="checkbox" value="https://betstat.site/resultados/Brasileir%C3%A3o%20Betano"> Brasileirão Betano</label>

      </div>
    </div>
  </div>

  <div id="resultados" class="results-container"></div>
</div>

<script>
/* ===== Estado ===== */
let marketType = '', isPositive = true, threshold = 0;
let intervaloAtualizacao, contadorSegundos=180;

const PALETA = ['#38bdf8','#22c55e','#f59e0b','#ef4444','#a78bfa','#14b8a6','#e879f9','#f97316','#84cc16','#06b6d4','#e11d48','#10b981'];

/* ===== Util ===== */
function tokensDoJogo(a,b,total){
  const t=new Set();
  t.add(`${a}-${b}`);
  t.add(a>0&&b>0 ? 'ambasMarcam' : 'ambasNaoMarcam');
  t.add(total>=2 ? 'over1.5' : 'under1.5');
  t.add(total>=3 ? 'over2.5' : 'under2.5');
  t.add(total>=4 ? 'over3.5' : 'under3.5');
  t.add(total>=6 ? 'over5' : 'under5');
  t.add(a>b ? 'casaVence' : a<b ? 'foraVence' : 'empate');
  return Array.from(t);
}
function iniciarAnalise(){
  carregarDados();
  if(intervaloAtualizacao) clearInterval(intervaloAtualizacao);
  if(document.getElementById('auto-atualizar').checked){
    contadorSegundos=180; atualizarContador();
    intervaloAtualizacao=setInterval(atualizarContador,1000);
    document.getElementById('status-atualizacao').style.display='block';
  } else document.getElementById('status-atualizacao').style.display='none';
}
function atualizarContador(){
  contadorSegundos--; document.getElementById('contador').textContent=contadorSegundos;
  if(contadorSegundos<=0){ contadorSegundos=180; carregarDados(); }
}
document.getElementById('auto-atualizar').addEventListener('change',function(){
  if(this.checked){
    if(!intervaloAtualizacao){ contadorSegundos=180; atualizarContador(); intervaloAtualizacao=setInterval(atualizarContador,1000); }
    document.getElementById('status-atualizacao').style.display='block';
  }else{
    if(intervaloAtualizacao){ clearInterval(intervaloAtualizacao); intervaloAtualizacao=null; }
    document.getElementById('status-atualizacao').style.display='none';
  }
});
function definirMercado(){
  const m=document.getElementById('mercado').value;
  if(m.startsWith('over')){
    marketType='goals';
    isPositive=true;
    threshold = m==='over1.5' ? 2 : m==='over2.5'?3 : m==='over3.5'?4 : m==='over5'?6 : 0;
  }else if(m.startsWith('under')){
    marketType='goals';
    isPositive=false;
    threshold = m==='under1.5' ? 2 : m==='under2.5'?3 : m==='under3.5'?4 : 0;
  }else if(m==='ambasMarcam' || m==='ambasNaoMarcam'){
    marketType='ambas';
    isPositive = m==='ambasMarcam';
  }else if(m==='casaVence' || m==='foraVence' || m==='empate'){
    marketType='result';
  }else{
    marketType='';
  }
}
function obterNomeLiga(a){
  if(a.includes("Copa%20Am%C3%A9rica")) return "Copa América";
  if(a.includes("Ta%C3%A7a%20Gl%C3%B3ria%20eterna")) return "Taça Glória Eterna";
  if(a.includes("Euro")) return "Euro";
  if(a.includes("Campeonato%20Italiano")) return "Campeonato Italiano";
  if(a.includes("Copa%20das%20estrelas")) return "Copa das Estrelas";
  if(a.includes("British%20Derbies")) return "British Derbies";
  if(a.includes("Liga%20Espanhola")) return "Liga Espanhola";
  if(a.includes("Scudetto%20Italiano")) return "Scudetto Italiano";
  return a;
}

async function carregarDados(){
  definirMercado();
  const tipoPadrao=document.getElementById('placar_jogos').value;
  const tiros=parseInt(document.getElementById('tiros').value);
  const numLinhas=parseInt(document.getElementById('linhas').value);

  const ligas=[]; document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>cb.value&&cb.value!=="on"&&ligas.push(cb.value));
  if(ligas.length===0){ alert("Por favor, selecione pelo menos uma liga."); return; }

  const pac=[];
  for(const arq of ligas){
    try{
      const {dados, ligaName} = await carregarArquivo(arq,numLinhas);
      let resultados;
      if(tipoPadrao==='combinado'){
        const tipos=['2','3','1_pula_1','1_pula_1_pula_1']; let todos=[];
        for(const t of tipos){ const r=analisarAutoPadroes(dados,t,tiros); r.forEach(x=>x.tipo_padrao=t); todos=todos.concat(r); }
        todos.sort((a,b)=>parseFloat(b.percentual)-parseFloat(a.percentual)||b.ocorrencias-a.ocorrencias);
        resultados=todos.slice(0,15);
      }else resultados=analisarAutoPadroes(dados,tipoPadrao,tiros);
      pac.push({ liga: ligaName || obterNomeLiga(arq), resultados, dadosCru:dados });
    }catch(e){ console.error(e); alert(`Erro ao carregar ${arq}`); }
  }
  exibirResultados(pac, tipoPadrao==='combinado');

  const ts=document.createElement('div'); ts.className='timestamp';
  const ag=new Date(); ts.textContent=`Última atualização: ${ag.toLocaleDateString()} ${ag.toLocaleTimeString()}`;
  document.getElementById('resultados').appendChild(ts);
}
async function carregarArquivo(url,numLinhas){
  const resp=await fetch(`${url}?t=${Date.now()}`);
  if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const data=await resp.json();
  data.sort((a,b) => new Date(b.data) - new Date(a.data)); // descending for most recent first
  const recent = data.slice(0, numLinhas);
  const dados = recent.map(item => {
    const ftStr = item.ft ? item.ft.trim() : '0 x 0';
    const [aStr, bStr] = ftStr.split(' x ');
    const a = parseInt(aStr,10) || 0;
    const b = parseInt(bStr,10) || 0;
    return [a, b, a+b];
  });
  const ligaName = data[0] ? data[0].liga : null;
  return {dados, ligaName};
}
function analisarAutoPadroes(dados,tipo,tiros){
  const res=[]; const {inicio,fim}=obterIntervalo(); const offs=getOffsetsByTipo(tipo); const last=offs[offs.length-1];
  for(let p=inicio;p<=fim;p++){
    const comb={}, ex={}; const need=(last+1)+p+tiros; if(dados.length<need) continue;
    for(let i=0;i<=dados.length-need;i++){
      const tok=[], plac=[];
      for(const o of offs){ const [a,b,t]=dados[i+o]; tok.push(tokensDoJogo(a,b,t)); plac.push(`${a}x${b}`); }
      const combos=enumerateCombos(tok);
      const ini=i+last+1+p, fimA=ini+tiros; let green=false;
      for(let j=ini;j<fimA&&j<dados.length;j++){
        const [a,b,sum]=dados[j];
        if(isGreenForSelectedMarket(a,b,sum)){ green=true; break; }
      }
      const placStr=plac.join(' | ');
      for(const seq of combos){
        const key=seq.join(' | ');
        if(!comb[key]){ comb[key]={ocorrencias:0,greens:0,offsets:offs.slice()}; ex[key]=placStr; }
        comb[key].ocorrencias++; if(green) comb[key].greens++;
      }
    }
    for(const k in comb){
      const st=comb[k]; if(st.ocorrencias>=3){
        res.push({ padrao:k, placares:ex[k], pular_jogos:p, offsets:st.offsets, ocorrencias:st.ocorrencias, greens:st.greens, percentual:((st.greens/st.ocorrencias)*100).toFixed(2) });
      }
    }
  }
  res.sort((a,b)=>parseFloat(b.percentual)-parseFloat(a.percentual)||b.ocorrencias-a.ocorrencias);
  return res.slice(0,15);
}
function enumerateCombos(tok){
  if(tok.length===1) return tok[0].map(t=>[t]);
  if(tok.length===2){ const out=[]; for(const a of tok[0]) for(const b of tok[1]) out.push([a,b]); return out; }
  if(tok.length===3){ const out=[]; for(const a of tok[0]) for(const b of tok[1]) for(const c of tok[2]) out.push([a,b,c]); return out; }
  const out=[],cur=[];(function rec(i){ if(i===tok.length){ out.push(cur.slice()); return; } for(const t of tok[i]){ cur.push(t); rec(i+1); cur.pop(); } })(0); return out;
}
function obterIntervalo(){ const v=document.getElementById('intervalo_jogos').value;
  if(v==='linha_acima') return {inicio:21,fim:30};
  if(v==='2_linhas_acima') return {inicio:41,fim:50};
  if(v==='3_linhas_acima') return {inicio:61,fim:70};
  return {inicio:1,fim:10};
}
function getOffsetsByTipo(t){ if(t==='1')return[0]; if(t==='2')return[0,1]; if(t==='3')return[0,1,2]; if(t==='1_pula_1')return[0,2]; if(t==='1_pula_1_pula_1')return[0,2,4]; return[0,1]; }
function isGreenForSelectedMarket(a,b,sum){
  const m=document.getElementById('mercado').value;
  if(marketType==='goals'){
    if(isPositive) return sum >= threshold;
    else return sum < threshold;
  }else if(marketType==='ambas'){
    const both = a>0 && b>0;
    return isPositive ? both : !both;
  }else if(marketType==='result'){
    if(m==='casaVence') return a>b;
    if(m==='foraVence') return a<b;
    if(m==='empate') return a===b;
  }
  return false;
}
/* hits do padrão nos últimos N (retorna arrays de índices globais) */
function findPatternHitsInLast(dados, padraoStr, offsets, lookback=30){
  const req=padraoStr.split(' | '), last=offsets[offsets.length-1];
  const start=Math.max(0, dados.length - lookback - last), end=dados.length - last;
  const hits=[];
  for(let i=start;i<end;i++){
    let ok=true; for(let k=0;k<offsets.length;k++){ const [a,b,t]=dados[i+offsets[k]]; if(!tokensDoJogo(a,b,t).includes(req[k])){ ok=false; break; } }
    if(ok) hits.push(offsets.map(o=>i+o));
  }
  return hits;
}

/* UI builders */
function buildPatternMosaicHTML(padraoStr,offsets){
  const tokens=padraoStr.split(' | '), last=offsets[offsets.length-1]; let k=0; const cells=[];
  for(let i=0;i<=last;i++){ if(offsets.includes(i)) cells.push(`<span class="cell cell-neutral">`+(tokens[k++]||'')+`</span>`); else cells.push(`<span class="cell cell-grey">Pula</span>`); }
  return `<div class="mosaic">${cells.join('')}</div>`;
}
function buildExampleMosaicHTML(placaresStr,offsets){
  const s=placaresStr.split(' | '), last=offsets[offsets.length-1]; let k=0; const cells=[];
  for(let i=0;i<=last;i++){
    if(offsets.includes(i)){
      const sc=s[k++]||''; const [a,b]=(sc.replace(/\s+/g,'').split(/x|-/i).map(x=>parseInt(x)||0));
      const green=isGreenForSelectedMarket(a,b,a+b);
      cells.push(`<span class="cell ${green?'cell-green':'cell-red'}">${sc}</span>`);
    } else cells.push(`<span class="cell cell-grey">Pula</span>`);
  }
  return `<div class="mosaic">${cells.join('')}</div>`;
}
/* faixa dos últimos 30 – mantém verde/vermelho; aplica contorno/borda na cor do padrão e data-idx */
function buildRecentResultsBarHTML(dados, count=30, indexColorMap=new Map()){
  const total=dados.length, start=Math.max(0,total-count), ultimos=dados.slice(start);
  const cells=ultimos.map((item,i)=>{
    const idx=start+i, [a,b,sum]=item, green=isGreenForSelectedMarket(a,b,sum);
    const hitColor=indexColorMap.get(idx);
    if(hitColor){
      return `<span class="cell ${green?'cell-green':'cell-red'} cell-hit" data-idx="${idx}" style="--hit:${hitColor}">${a}x${b}</span>`;
    }
    return `<span class="cell ${green?'cell-green':'cell-red'}" data-idx="${idx}">${a}x${b}</span>`;
  });
  return `<div class="recent-caption">Últimos ${ultimos.length} resultados (antigo ➜ recente)</div><div class="recent-bar">${cells.join('')}</div>`;
}
/* sort */
function attachSortingHandlers(tabela){
  const ths=[...tabela.querySelectorAll('th')];
  const idxP=ths.findIndex(th=>th.textContent.trim().toLowerCase().startsWith('pular'));
  const idxO=ths.findIndex(th=>th.textContent.trim().toLowerCase().startsWith('ocorr'));
  [idxP,idxO].forEach(idx=>{
    if(idx>=0){
      const th=ths[idx]; th.classList.add('sortable');
      th.addEventListener('click',()=>{
        const dir=th.classList.contains('asc')?'desc':'asc';
        ths.forEach(x=>x.classList.remove('asc','desc')); th.classList.add(dir);
        const rows=[...tabela.querySelectorAll('tr')].slice(1);
        rows.sort((A,B)=>{
          const a=A.children[idx].textContent.trim(), b=B.children[idx].textContent.trim();
          const na=parseFloat(a.replace('%',''))||parseInt(a)||0, nb=parseFloat(b.replace('%',''))||parseInt(b)||0;
          return dir==='asc'? na-nb : nb-na;
        });
        rows.forEach(r=>tabela.appendChild(r));
      });
    }
  });
}

/* render com clique para foco */
function exibirResultados(conjuntos, combinado){
  const root=document.getElementById('resultados'); root.innerHTML='';

  const m=document.getElementById('mercado').value;
  const marketLabel = document.querySelector(`#mercado option[value="${m}"]`).textContent;
  const info=document.createElement('div'); info.className='market-info';
  info.innerHTML = `<div class="market-info-title">Mercado</div><div class="market-info-details">${marketLabel}</div>`;
  root.appendChild(info);

  const modo=document.getElementById('placar_jogos').value;
  const map={'mesma_linha':'Mesma Linha (1-10)','linha_acima':'Linha Acima (21-30)','2_linhas_acima':'2 Linhas Acima (41-50)','3_linhas_acima':'3 Linhas Acima (61-70)'};
  const info2=document.createElement('div'); info2.className='market-info';
  info2.innerHTML = `<div class="market-info-title">Configuração</div><div class="market-info-details">Modo: ${combinado?'Combinado (todos)':`Padrão ${modo}`} | Intervalo: ${map[document.getElementById('intervalo_jogos').value]}</div>`;
  root.appendChild(info2);

  for(const { liga, resultados, dadosCru } of conjuntos){
    const indexColorMap=new Map();

    const section = document.createElement('section');
    section.className = 'league-section';

    const header = document.createElement('div');
    header.className = 'league-header';
    const h2 = document.createElement('h2');
    h2.className = 'league-title';
    h2.textContent = liga;
    header.appendChild(h2);
    section.appendChild(header);

    const tabela=document.createElement('table');
    tabela.innerHTML=`<tr>
      ${combinado?'<th>Tipo</th>':''}
      <th>Padrão (mosaico)</th>
      <th>Placares (mosaico exemplo)</th>
      <th>Pular Jogos</th>
      <th>Ocorrências</th>
      <th>Greens</th>
      <th>Percentual</th>
    </tr>`;

    const linhasInfo=[];

    resultados.forEach((r, i)=>{
      const offsets=r.offsets?.length?r.offsets:getOffsetsByTipo(r.tipo_padrao||modo);
      const color = PALETA[i % PALETA.length];

      const hits=findPatternHitsInLast(dadosCru, r.padrao, offsets, 30);
      const hitSet=new Set(); hits.forEach(arr=>arr.forEach(ix=>{ if(!indexColorMap.has(ix)) indexColorMap.set(ix, color); hitSet.add(ix); }));

      const tr=document.createElement('tr');
      tr.className='row-colored'; tr.style.setProperty('--hit', color);

      const tipoTxt=combinado?({'1':'1 posição','2':'2 posições','3':'3 posições','1_pula_1':'1 Pula 1','1_pula_1_pula_1':'1 Pula 1 Pula 1'}[r.tipo_padrao]||r.tipo_padrao||''):null;

      tr.innerHTML=`
        ${combinado?`<td>${tipoTxt}</td>`:''}
        <td>${buildPatternMosaicHTML(r.padrao, offsets)}</td>
        <td>${buildExampleMosaicHTML(r.placares, offsets)}</td>
        <td>${r.pular_jogos}</td>
        <td>${r.ocorrencias}</td>
        <td>${r.greens}</td>
        <td>${r.percentual}%</td>
      `;
      tabela.appendChild(tr);
      linhasInfo.push({tr, color, hitSet});
    });

    const recentSection = document.createElement('div');
    recentSection.className = 'recent-results-section';
    const recent=document.createElement('div');
    recent.className='recent-wrap';
    recent.innerHTML = buildRecentResultsBarHTML(dadosCru, 30, indexColorMap);
    const recentBar = recent.querySelector('.recent-bar');
    recentSection.appendChild(recent);
    section.appendChild(recentSection);

    const tableSection = document.createElement('div');
    tableSection.className = 'table-section';
    tableSection.appendChild(tabela);
    section.appendChild(tableSection);

    let activeRow=null;
    function clearFocus(){
      if(!recentBar) return;
      recentBar.classList.remove('focus');
      recentBar.querySelectorAll('.cell').forEach(c=>{
        c.classList.remove('cell-focus');
      });
      if(activeRow){ activeRow.classList.remove('row-active'); activeRow=null; }
    }
    linhasInfo.forEach(({tr,color,hitSet})=>{
      tr.addEventListener('click', ()=>{
        if(activeRow===tr){ clearFocus(); return; }

        if(activeRow) activeRow.classList.remove('row-active');
        activeRow=tr; tr.classList.add('row-active');

        recentBar.classList.add('focus');
        recentBar.querySelectorAll('.cell').forEach(c=>{
          const idx=parseInt(c.getAttribute('data-idx'));
          if(hitSet.has(idx)){
            c.classList.add('cell-focus');
            c.classList.add('cell-hit');
            c.style.setProperty('--hit', color);
          }else{
            c.classList.remove('cell-focus');
          }
        });
      });
    });

    recentBar.addEventListener('click', (e)=>{
      if(!e.target.classList.contains('cell-focus')) clearFocus();
    });

    attachSortingHandlers(tabela);

    root.appendChild(section);
  }
}
</script>
</body>
</html>