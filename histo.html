);
            const marketKey = marketKeys[selectedMarket] || 'ambasSim';
            const marketLabel = keyToLabel[marketKey] || 'Ambas Sim';

            indicatorCharts[league].data.labels = processedChartData[league]?.labels || [];
            indicatorCharts[league].data.datasets[0].data = indicatorData.macdLine || [];
            indicatorCharts[league].data.datasets[1].data = indicatorData.emaSignal || [];
            indicatorCharts[league].data.datasets[2].data = indicatorData.histogram || [];
            indicatorCharts[league].data.datasets[2].backgroundColor = (indicatorData.histogram || []).map(val => val >= 0 ? 'rgba(0, 255, 0, 0.5)' : 'rgba(255, 0, 0, 0.5)');
            indicatorCharts[league].data.datasets[2].label = `Histograma MACD (${marketLabel})`;
            
            // Atualizar RSI
            if (showRSI) {
                if (indicatorCharts[league].data.datasets.length === 3) {
                    indicatorCharts[league].data.datasets.push({
                        label: 'RSI',
                        data: indicatorData.rsi || [],
                        borderColor: '#9C27B0',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        yAxisID: 'y-rsi',
                        fill: false
                    });
                } else {
                    indicatorCharts[league].data.datasets[3].data = indicatorData.rsi || [];
                }
                
                // Adicionar eixo Y do RSI se não existir
                if (!indicatorCharts[league].options.scales['y-rsi']) {
                    indicatorCharts[league].options.scales['y-rsi'] = {
                        type: 'linear',
                        position: 'right',
                        min: 0,
                        max: 100,
                        title: { 
                            display: true, 
                            text: 'RSI',
                            color: '#9C27B0',
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: { 
                            color: '#aaa',
                            callback: function(value) {
                                if (value === 30 || value === 70) {
                                    return value;
                                }
                                return value;
                            }
                        },
                        grid: { 
                            color: '#222',
                            drawBorder: true
                        }
                    };
                }
            } else {
                // Remover RSI se desativado
                if (indicatorCharts[league].data.datasets.length > 3) {
                    indicatorCharts[league].data.datasets.splice(3, 1);
                }
                if (indicatorCharts[league].options.scales['y-rsi']) {
                    delete indicatorCharts[league].options.scales['y-rsi'];
                }
            }

            indicatorCharts[league].options.scales['y-macd'].title.text = `MACD (${marketLabel})`;
            indicatorCharts[league].update('none');
            console.log(`Gráfico de indicadores atualizado para ${league} com mercado ${marketLabel}`);
        }

        function updateCharts() {
            const timestamp = new Date().getTime();
            const apiUrl = `${DATA_URL}?timestamp=${timestamp}`;
            console.log(`Buscando dados em: ${apiUrl}`);
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Dados recebidos:`, data);
                    const league = 'Copa';
                    const processedData = processApiData(data, league);
                    const indicatorCanvas = document.getElementById('Indicators');

                    if (!indicatorCanvas) {
                        console.error(`Canvas não encontrado: Indicators`);
                        return;
                    }

                    if (!indicatorCharts[league]) {
                        const indicatorCtx = indicatorCanvas.getContext('2d');
                        const indicatorData = getIndicatorData(league, selectedMarket);
                        indicatorCharts[league] = createIndicatorChart(indicatorCtx, processedData.labels, indicatorData, league);
                        if (!indicatorCharts[league]) {
                            console.error(`Falha ao criar gráfico de indicadores para ${league}`);
                            return;
                        }
                        console.log(`Gráfico criado para ${league}`);
                    } else {
                        updateIndicatorChart(league);
                        console.log(`Gráfico atualizado para ${league}`);
                    }
                })
                .catch(error => {
                    console.error(`Erro ao buscar dados:`, error);
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const marketSelector = document.getElementById('marketSelector');
            if (marketSelector) {
                marketSelector.addEventListener('change', function(event) {
                    selectedMarket = event.target.value;
                    console.log(`Mercado selecionado: ${selectedMarket}`);
                    leagues.forEach(league => {
                        updateIndicatorChart(league);
                    });
                });
            }

            const macdFastInput = document.getElementById('macdFast');
            if (macdFastInput) {
                macdFastInput.addEventListener('change', function(event) {
                    macdFast = parseInt(event.target.value, 10);
                    leagues.forEach(league => {
                        updateIndicatorChart(league);
                    });
                });
            }

            const macdSlowInput = document.getElementById('macdSlow');
            if (macdSlowInput) {
                macdSlowInput.addEventListener('change', function(event) {
                    macdSlow = parseInt(event.target.value, 10);
                    leagues.forEach(league => {
                        updateIndicatorChart(league);
                    });
                });
            }

            const macdSignalInput = document.getElementById('macdSignal');
            if (macdSignalInput) {
                macdSignalInput.addEventListener('change', function(event) {
                    macdSignal = parseInt(event.target.value, 10);
                    leagues.forEach(league => {
                        updateIndicatorChart(league);
                    });
                });
            }

            const rsiPeriodInput = document.getElementById('rsiPeriod');
            if (rsiPeriodInput) {
                rsiPeriodInput.addEventListener('change', function(event) {
                    rsiPeriod = parseInt(event.target.value, 10);
                    leagues.forEach(league => {
                        updateIndicatorChart(league);
                    });
                });
            }

            const showRSICheckbox = document.getElementById('showRSI');
            if (showRSICheckbox) {
                showRSICheckbox.addEventListener('change', function(event) {
                    showRSI = event.target.checked;
                    console.log(`RSI ${showRSI ? 'ativado' : 'desativado'}`);
                    leagues.forEach(league => {
                        updateIndicatorChart(league);
                    });
                });
            }

            const pointsSelector = document.getElementById('pointsSelector');
            if (pointsSelector) {
                pointsSelector.addEventListener('change', function(event) {
                    numPoints = parseInt(event.target.value, 10);
                    updateCharts();
                });
            }

            const averageSelector = document.getElementById('averageSelector');
            if (averageSelector) {
                averageSelector.addEventListener('change', function(event) {
                    averagePoints = parseInt(event.target.value, 10);
                    updateCharts();
                });
            }

            updateCharts();
        });

        setInterval(updateCharts, 3000);
    </script>
</body>
</html>