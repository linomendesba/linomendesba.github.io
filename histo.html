<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfico MACD e RSI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .histomacd-reset {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .histomacd-body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a;
            color: #fff;
            padding: 20px;
        }

        .histomacd-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .histomacd-title {
            text-align: center;
            margin-bottom: 20px;
            color: #00BFFF;
            font-size: 24px;
        }

        .histomacd-chart-container {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .histomacd-canvas { 
            width: 100% !important;
            height: auto !important;
        }

        .histomacd-controls {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .histomacd-controls-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .histomacd-control-group {
            display: flex;
            flex-direction: column;
            min-width: 140px;
        }

        .histomacd-control-label {
            color: #aaa;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .histomacd-select, .histomacd-input-number {
            background-color: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 13px;
            transition: all 0.3s ease;
            outline: none;
        }

        .histomacd-select:hover, .histomacd-input-number:hover {
            border-color: #00BFFF;
        }

        .histomacd-select:focus, .histomacd-input-number:focus {
            border-color: #00BFFF;
            box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.1);
        }

        .histomacd-checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background-color: #2a2a2a;
            border-radius: 4px;
            border: 1px solid #444;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .histomacd-checkbox-group:hover {
            border-color: #00BFFF;
            background-color: #333;
        }

        .histomacd-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #00BFFF;
        }

        .histomacd-checkbox-label {
            margin: 0;
            cursor: pointer;
            user-select: none;
            font-size: 13px;
            text-transform: none;
            color: #fff;
        }

        @media (max-width: 1200px) {
            .histomacd-controls-wrapper {
                justify-content: flex-start;
            }
            
            .histomacd-control-group {
                min-width: 120px;
            }
        }

        @media (max-width: 768px) {
            .histomacd-controls-wrapper {
                flex-direction: column;
                align-items: stretch;
            }

            .histomacd-control-group {
                min-width: 100%;
            }

            .histomacd-checkbox-group {
                min-width: 100%;
            }

            .histomacd-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body class="histomacd-body">
    <div class="histomacd-container">

        <div class="histomacd-chart-container">
            <canvas id="histomacdIndicators" class="histomacd-canvas" width="1080" height="300"></canvas>
        </div>

        <div class="histomacd-controls">
            <div class="histomacd-controls-wrapper">
                <div class="histomacd-control-group">
                    <label for="histomacdMarketSelector" class="histomacd-control-label">Mercado</label>
                    <select id="histomacdMarketSelector" class="histomacd-select">
                        <option value="ambasMarcam">Ambas Marcam</option>
                        <option value="ambasNaoMarcam">Ambas Não Marcam</option>
                        <option value="casaVence">Casa Vence</option>
                        <option value="foraVence">Fora Vence</option>
                        <option value="empate">Empate</option>
                        <option value="over1.5">Over 1.5</option>
                        <option value="under1.5">Under 1.5</option>
                        <option value="over2.5">Over 2.5</option>
                        <option value="under2.5">Under 2.5</option>
                        <option value="over3.5">Over 3.5</option>
                        <option value="under3.5">Under 3.5</option>
                        <option value="over5">Over 5+</option>
                        <option value="exato0">0 Gol Exato</option>
                        <option value="exato1">1 Gol Exato</option>
                        <option value="exato2">2 Gols Exatos</option>
                        <option value="exato3">3 Gols Exatos</option>
                        <option value="exato4">4 Gols Exatos</option>
                    </select>
                </div>

                <div class="histomacd-control-group">
                    <label for="histomacdPointsSelector" class="histomacd-control-label">Período</label>
                    <select id="histomacdPointsSelector" class="histomacd-select">
                        <option value="20">1 Hora</option>
                        <option value="40">2 Horas</option>
                        <option value="60">3 Horas</option>
                        <option value="80">4 Horas</option>
                        <option value="100">5 Horas</option>
                        <option value="120">6 Horas</option>
                        <option value="140">7 Horas</option>
                        <option value="160">8 Horas</option>
                        <option value="180">9 Horas</option>
                        <option value="200">10 Horas</option>
                        <option value="220">11 Horas</option>
                        <option value="240">12 Horas</option>
                        <option value="480">24 Horas</option>
                        <option value="960">48 Horas</option>
                        <option value="1440">72 Horas</option>
                    </select>
                </div>

                <div class="histomacd-control-group">
                    <label for="histomacdAverageSelector" class="histomacd-control-label">Média</label>
                    <input type="number" id="histomacdAverageSelector" class="histomacd-input-number" value="19" min="1" max="100">
                </div>

                <div class="histomacd-control-group">
                    <label for="histomacdMacdFast" class="histomacd-control-label">MACD Rápido</label>
                    <input type="number" id="histomacdMacdFast" class="histomacd-input-number" value="12" min="1" max="50">
                </div>

                <div class="histomacd-control-group">
                    <label for="histomacdMacdSlow" class="histomacd-control-label">MACD Lento</label>
                    <input type="number" id="histomacdMacdSlow" class="histomacd-input-number" value="26" min="1" max="100">
                </div>

                <div class="histomacd-control-group">
                    <label for="histomacdMacdSignal" class="histomacd-control-label">MACD Sinal</label>
                    <input type="number" id="histomacdMacdSignal" class="histomacd-input-number" value="9" min="1" max="50">
                </div>

                <div class="histomacd-control-group">
                    <label for="histomacdRsiPeriod" class="histomacd-control-label">Período RSI</label>
                    <input type="number" id="histomacdRsiPeriod" class="histomacd-input-number" value="14" min="1" max="50">
                </div>

                <div class="histomacd-control-group">
                    <div class="histomacd-checkbox-group">
                        <input type="checkbox" id="histomacdShowRSI" class="histomacd-checkbox" checked>
                        <label for="histomacdShowRSI" class="histomacd-checkbox-label">Exibir RSI</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const HISTOMACD_DATA_URL = 'https://betstat.site/resultados/Ta%C3%A7a%20Gl%C3%B3ria%20Eterna';

        function histomacdSaveSettings() {
            const settings = {
                selectedMarket: histomacdSelectedMarket,
                numPoints: histomacdNumPoints,
                averagePoints: histomacdAveragePoints,
                macdFast: histomacdMacdFast,
                macdSlow: histomacdMacdSlow,
                macdSignal: histomacdMacdSignal,
                rsiPeriod: histomacdRsiPeriod,
                showRSI: histomacdShowRSI
            };
            localStorage.setItem('histomacdChartSettings', JSON.stringify(settings));
        }

        function histomacdLoadSettings() {
            const saved = localStorage.getItem('histomacdChartSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                histomacdSelectedMarket = settings.selectedMarket || 'ambasMarcam';
                histomacdNumPoints = settings.numPoints || 20;
                histomacdAveragePoints = settings.averagePoints || 19;
                histomacdMacdFast = settings.macdFast || 12;
                histomacdMacdSlow = settings.macdSlow || 26;
                histomacdMacdSignal = settings.macdSignal || 9;
                histomacdRsiPeriod = settings.rsiPeriod || 14;
                histomacdShowRSI = settings.showRSI !== undefined ? settings.showRSI : true;

                document.getElementById('histomacdMarketSelector').value = histomacdSelectedMarket;
                document.getElementById('histomacdPointsSelector').value = histomacdNumPoints;
                document.getElementById('histomacdAverageSelector').value = histomacdAveragePoints;
                document.getElementById('histomacdMacdFast').value = histomacdMacdFast;
                document.getElementById('histomacdMacdSlow').value = histomacdMacdSlow;
                document.getElementById('histomacdMacdSignal').value = histomacdMacdSignal;
                document.getElementById('histomacdRsiPeriod').value = histomacdRsiPeriod;
                document.getElementById('histomacdShowRSI').checked = histomacdShowRSI;
            }
        }

        let histomacdNumPoints = 20;
        let histomacdAveragePoints = 19;
        const histomacdLeagues = ['Copa'];
        let histomacdChartData = {};
        let histomacdProcessedChartData = {};
        let histomacdMacdFast = 12;
        let histomacdMacdSlow = 26;
        let histomacdMacdSignal = 9;
        let histomacdRsiPeriod = 14;
        let histomacdShowRSI = true;
        let histomacdIndicatorCharts = {};
        let histomacdSelectedMarket = 'ambasMarcam';

        const histomacdMarketKeys = {
            ambasMarcam: 'ambasSim',
            ambasNaoMarcam: 'ambasNao',
            casaVence: 'casaVence',
            foraVence: 'foraVence',
            empate: 'empate',
            'over1.5': 'over15',
            'under1.5': 'under15',
            'over2.5': 'over25',
            'under2.5': 'under25',
            'over3.5': 'over35',
            'under3.5': 'under35',
            over5: 'over45',
            exato0: 'gol0',
            exato1: 'gol1',
            exato2: 'gol2',
            exato3: 'gol3',
            exato4: 'gol4'
        };

        const histomacdLabelToKey = {
            'Gols FT': 'golsFT',
            'Casa Vence': 'casaVence',
            'Empate': 'empate',
            'Fora Vence': 'foraVence',
            'Ambas Sim': 'ambasSim',
            'Ambas Não': 'ambasNao',
            'Over 1.5': 'over15',
            'Over 2.5': 'over25',
            'Over 3.5': 'over35',
            'Under 1.5': 'under15',
            'Under 2.5': 'under25',
            'Under 3.5': 'under35',
            'Over 5+': 'over45',
            '0 Gol Exato': 'gol0',
            '1 Gol Exato': 'gol1',
            '2 Gols Exatos': 'gol2',
            '3 Gols Exatos': 'gol3',
            '4 Gols Exatos': 'gol4',
            '5+ Gols': 'gol5'
        };

        const histomacdKeyToLabel = {};
        Object.entries(histomacdLabelToKey).forEach(([label, key]) => {
            histomacdKeyToLabel[key] = label;
        });

        function histomacdFillGaps(data) {
            let filled = [...data];
            let last = null;
            for (let i = 0; i < filled.length; i++) {
                if (filled[i] !== null && filled[i] !== undefined) {
                    last = filled[i];
                } else if (last !== null) {
                    filled[i] = last;
                }
            }
            if (last === null) {
                for (let i = filled.length - 1; i >= 0; i--) {
                    if (filled[i] !== null && filled[i] !== undefined) {
                        last = filled[i];
                    } else if (last !== null) {
                        filled[i] = last;
                    }
                }
            } else {
                for (let i = 0; i < filled.length; i++) {
                    if (filled[i] === null || filled[i] === undefined) filled[i] = last;
                    else break;
                }
            }
            return filled;
        }

        function histomacdFillInitial(array) {
            let first = array.find(v => v !== null && v !== undefined);
            if (first !== undefined) {
                for (let i = 0; i < array.length; i++) {
                    if (array[i] === null || array[i] === undefined) array[i] = first;
                    else break;
                }
            }
            return array;
        }

        function histomacdCalculateEMA(data, period) {
            const k = 2 / (period + 1);
            let ema = new Array(data.length).fill(null);
            let sum = 0;
            let count = 0;
            for (let i = 0; i < data.length; i++) {
                if (data[i] === null || data[i] === undefined) continue;
                sum += data[i];
                count++;
                if (count >= 1) {
                    ema[i] = sum / count;
                    if (count >= period) break;
                }
            }
            for (let i = 0; i < data.length; i++) {
                if (ema[i] !== null) {
                    for (let j = i + 1; j < data.length; j++) {
                        if (data[j] !== null && data[j] !== undefined) {
                            ema[j] = (data[j] * k) + (ema[j - 1] * (1 - k));
                        } else {
                            ema[j] = ema[j - 1];
                        }
                    }
                    break;
                }
            }
            return histomacdFillInitial(ema);
        }

        function histomacdCalculateMACD(data, fast, slow, signal) {
            const emaFast = histomacdCalculateEMA(data, fast);
            const emaSlow = histomacdCalculateEMA(data, slow);
            let macdLine = data.map((d, i) => (emaFast[i] !== null && emaSlow[i] !== null ? emaFast[i] - emaSlow[i] : null));
            macdLine = histomacdFillInitial(macdLine);
            const emaSignal = histomacdCalculateEMA(macdLine, signal);
            let histogram = data.map((d, i) => (macdLine[i] !== null && emaSignal[i] !== null ? macdLine[i] - emaSignal[i] : null));
            histogram = histomacdFillInitial(histogram);
            return { macdLine, emaSignal, histogram };
        }

        function histomacdCalculateRSI(data, period) {
            let rsi = new Array(data.length).fill(null);
            let gains = [];
            let losses = [];

            for (let i = 1; i < data.length; i++) {
                if (data[i] === null || data[i - 1] === null) continue;
                
                const change = data[i] - data[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);

                if (gains.length >= period) {
                    const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                    
                    if (avgLoss === 0) {
                        rsi[i] = 100;
                    } else {
                        const rs = avgGain / avgLoss;
                        rsi[i] = 100 - (100 / (1 + rs));
                    }
                }
            }

            return histomacdFillInitial(rsi);
        }

        function histomacdProcessApiData(data, league) {
            if (!data || !Array.isArray(data)) {
                console.error(`Dados inválidos para ${league}:`, data);
                return { labels: [] };
            }

            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(a.data);
                const dateB = new Date(b.data);
                if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                if (a.hora !== b.hora) return a.hora - b.hora;
                return a.minuto - b.minuto;
            });

            const extra = 50;
            const slicedData = sortedData.slice(- (histomacdNumPoints + histomacdAveragePoints + extra));
            histomacdChartData[league] = slicedData;

            let labels = [];
            let ambasSim = [];
            let ambasNao = [];
            let casaVence = [];
            let empate = [];
            let foraVence = [];
            let over15 = [];
            let over25 = [];
            let over35 = [];
            let under15 = [];
            let under25 = [];
            let under35 = [];
            let over45 = [];
            let gol0 = [];
            let gol1 = [];
            let gol2 = [];
            let gol3 = [];
            let gol4 = [];

            function hasGap(prevMatch, currMatch) {
                const prevTime = new Date(prevMatch.data + 'T' + prevMatch.hora + ':' + prevMatch.minuto + ':00');
                const currTime = new Date(currMatch.data + 'T' + currMatch.hora + ':' + currMatch.minuto + ':00');
                const diffMinutes = (currTime - prevTime) / (1000 * 60);
                return diffMinutes > 1;
            }

            for (let i = histomacdAveragePoints; i < slicedData.length; i++) {
                let ambasSimSum = 0;
                let ambasNaoSum = 0;
                let casaVenceSum = 0;
                let empateSum = 0;
                let foraVenceSum = 0;
                let over15Sum = 0;
                let over25Sum = 0;
                let over35Sum = 0;
                let under15Sum = 0;
                let under25Sum = 0;
                let under35Sum = 0;
                let over45Sum = 0;
                let gol0Sum = 0;
                let gol1Sum = 0;
                let gol2Sum = 0;
                let gol3Sum = 0;
                let gol4Sum = 0;
                let validMatches = 0;

                for (let j = Math.max(0, i - histomacdAveragePoints); j <= i; j++) {
                    const match = slicedData[j];
                    let ftScoreParts = [0, 0];
                    if (match.ft && match.ft.includes(' x ')) {
                        ftScoreParts = match.ft.split(' x ').map(num => parseInt(num, 10));
                    }

                    const totalGolsFT = ftScoreParts[0] + ftScoreParts[1];

                    ambasSimSum += ftScoreParts[0] > 0 && ftScoreParts[1] > 0 ? 1 : 0;
                    ambasNaoSum += ftScoreParts[0] === 0 || ftScoreParts[1] === 0 ? 1 : 0;
                    casaVenceSum += ftScoreParts[0] > ftScoreParts[1] ? 1 : 0;
                    empateSum += ftScoreParts[0] === ftScoreParts[1] ? 1 : 0;
                    foraVenceSum += ftScoreParts[0] < ftScoreParts[1] ? 1 : 0;
                    over15Sum += totalGolsFT > 1.5 ? 1 : 0;
                    over25Sum += totalGolsFT > 2.5 ? 1 : 0;
                    over35Sum += totalGolsFT > 3.5 ? 1 : 0;
                    under15Sum += totalGolsFT < 1.5 ? 1 : 0;
                    under25Sum += totalGolsFT < 2.5 ? 1 : 0;
                    under35Sum += totalGolsFT < 3.5 ? 1 : 0;
                    over45Sum += totalGolsFT > 4.5 ? 1 : 0;
                    gol0Sum += totalGolsFT === 0 ? 1 : 0;
                    gol1Sum += totalGolsFT === 1 ? 1 : 0;
                    gol2Sum += totalGolsFT === 2 ? 1 : 0;
                    gol3Sum += totalGolsFT === 3 ? 1 : 0;
                    gol4Sum += totalGolsFT === 4 ? 1 : 0;
                    validMatches++;
                }

                const match = slicedData[i];

                if (i > histomacdAveragePoints && hasGap(slicedData[i - 1], match)) {
                    labels.push('');
                    ambasSim.push(null);
                    ambasNao.push(null);
                    casaVence.push(null);
                    empate.push(null);
                    foraVence.push(null);
                    over15.push(null);
                    over25.push(null);
                    over35.push(null);
                    under15.push(null);
                    under25.push(null);
                    under35.push(null);
                    over45.push(null);
                    gol0.push(null);
                    gol1.push(null);
                    gol2.push(null);
                    gol3.push(null);
                    gol4.push(null);
                }

                labels.push(`${match.hora}:${match.minuto.toString().padStart(2, '0')}`);

                const avg = validMatches || 1;

                ambasSim.push(ambasSimSum / avg * 100);
                ambasNao.push(ambasNaoSum / avg * 100);
                casaVence.push(casaVenceSum / avg * 100);
                empate.push(empateSum / avg * 100);
                foraVence.push(foraVenceSum / avg * 100);
                over15.push(over15Sum / avg * 100);
                over25.push(over25Sum / avg * 100);
                over35.push(over35Sum / avg * 100);
                under15.push(under15Sum / avg * 100);
                under25.push(under25Sum / avg * 100);
                under35.push(under35Sum / avg * 100);
                over45.push(over45Sum / avg * 100);
                gol0.push(gol0Sum / avg * 100);
                gol1.push(gol1Sum / avg * 100);
                gol2.push(gol2Sum / avg * 100);
                gol3.push(gol3Sum / avg * 100);
                gol4.push(gol4Sum / avg * 100);
            }

            const result = { 
                labels, ambasSim, ambasNao, casaVence, empate, foraVence,
                over15, over25, over35, under15, under25, under35, over45,
                gol0, gol1, gol2, gol3, gol4
            };

            histomacdProcessedChartData[league] = result;
            histomacdChartData[league] = slicedData.slice(extra);

            const start = result.labels.length - histomacdNumPoints;
            if (start > 0) {
                for (let key in result) {
                    if (Array.isArray(result[key])) {
                        result[key] = result[key].slice(start);
                    }
                }
            }

            return result;
        }

        function histomacdGetIndicatorData(league, market) {
            if (!histomacdProcessedChartData[league]) {
                console.warn(`Dados processados não disponíveis para ${league}`);
                return { macdLine: [], emaSignal: [], histogram: [], rsi: [] };
            }

            const marketKey = histomacdMarketKeys[market] || 'ambasSim';
            const data = histomacdProcessedChartData[league][marketKey] || [];
            const filledData = histomacdFillGaps(data);
            const macd = histomacdCalculateMACD(filledData, histomacdMacdFast, histomacdMacdSlow, histomacdMacdSignal);
            const rsi = histomacdCalculateRSI(filledData, histomacdRsiPeriod);

            return { ...macd, rsi };
        }

        function histomacdCreateIndicatorChart(ctx, labels, indicatorData, league) {
            if (!ctx) {
                console.error(`Contexto do canvas para indicadores de ${league} é inválido`);
                return null;
            }

            const marketKey = histomacdMarketKeys[histomacdSelectedMarket] || 'ambasSim';
            const marketLabel = histomacdKeyToLabel[marketKey] || 'Ambas Sim';
            
            const datasets = [
                {
                    label: 'Linha MACD',
                    data: indicatorData.macdLine || [],
                    borderColor: '#00BFFF',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y-macd',
                    fill: false
                },
                {
                    label: 'Sinal MACD',
                    data: indicatorData.emaSignal || [],
                    borderColor: '#FFA500',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y-macd',
                    fill: false
                },
                {
                    label: `Histograma MACD (${marketLabel})`,
                    data: indicatorData.histogram || [],
                    type: 'bar',
                    backgroundColor: (indicatorData.histogram || []).map(val => val >= 0 ? 'rgba(0, 255, 0, 0.5)' : 'rgba(255, 0, 0, 0.5)'),
                    yAxisID: 'y-macd'
                }
            ];

            if (histomacdShowRSI) {
                datasets.push({
                    label: 'RSI',
                    data: indicatorData.rsi || [],
                    borderColor: '#9C27B0',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y-rsi',
                    fill: false
                });
            }

            const scales = {
                x: {
                    ticks: { 
                        color: '#aaa',
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { color: '#222' }
                },
                'y-macd': {
                    type: 'linear',
                    position: 'left',
                    title: { 
                        display: true, 
                        text: `MACD (${marketLabel})`,
                        color: '#00BFFF',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: { color: '#aaa' },
                    grid: { color: '#222' }
                }
            };

            if (histomacdShowRSI) {
                scales['y-rsi'] = {
                    type: 'linear',
                    position: 'right',
                    min: 0,
                    max: 100,
                    title: { 
                        display: true, 
                        text: 'RSI',
                        color: '#9C27B0',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: { 
                        color: '#aaa',
                        callback: function(value) {
                            if (value === 30 || value === 70) {
                                return value;
                            }
                            return value;
                        }
                    },
                    grid: { 
                        color: '#222',
                        drawBorder: true
                    }
                };
            }

            try {
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels || [],
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: scales,
                        plugins: {
                            legend: { 
                                display: true,
                                labels: { 
                                    color: '#fff',
                                    padding: 10,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                titleColor: '#00BFFF',
                                bodyColor: '#fff',
                                borderColor: '#00BFFF',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return 'Horário: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2);
                                            if (context.dataset.yAxisID === 'y-rsi') {
                                                if (context.parsed.y > 70) {
                                                    label += ' (Sobrecompra)';
                                                } else if (context.parsed.y < 30) {
                                                    label += ' (Sobrevenda)';
                                                }
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`Erro ao criar gráfico de indicadores para ${league}:`, error);
                return null;
            }
        }

        function histomacdUpdateIndicatorChart(league) {
            if (!histomacdIndicatorCharts[league]) {
                console.warn(`Gráfico de indicadores não inicializado para ${league}`);
                return;
            }

            const indicatorData = histomacdGetIndicatorData(league, histomacdSelectedMarket);
            const marketKey = histomacdMarketKeys[histomacdSelectedMarket] || 'ambasSim';
            const marketLabel = histomacdKeyToLabel[marketKey] || 'Ambas Sim';

            histomacdIndicatorCharts[league].data.labels = histomacdProcessedChartData[league]?.labels || [];
            histomacdIndicatorCharts[league].data.datasets[0].data = indicatorData.macdLine || [];
            histomacdIndicatorCharts[league].data.datasets[1].data = indicatorData.emaSignal || [];
            histomacdIndicatorCharts[league].data.datasets[2].data = indicatorData.histogram || [];
            histomacdIndicatorCharts[league].data.datasets[2].backgroundColor = (indicatorData.histogram || []).map(val => val >= 0 ? 'rgba(0, 255, 0, 0.5)' : 'rgba(255, 0, 0, 0.5)');
            histomacdIndicatorCharts[league].data.datasets[2].label = `Histograma MACD (${marketLabel})`;
            
            if (histomacdShowRSI) {
                if (histomacdIndicatorCharts[league].data.datasets.length === 3) {
                    histomacdIndicatorCharts[league].data.datasets.push({
                        label: 'RSI',
                        data: indicatorData.rsi || [],
                        borderColor: '#9C27B0',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        yAxisID: 'y-rsi',
                        fill: false
                    });
                } else {
                    histomacdIndicatorCharts[league].data.datasets[3].data = indicatorData.rsi || [];
                }
                
                if (!histomacdIndicatorCharts[league].options.scales['y-rsi']) {
                    histomacdIndicatorCharts[league].options.scales['y-rsi'] = {
                        type: 'linear',
                        position: 'right',
                        min: 0,
                        max: 100,
                        title: { 
                            display: true, 
                            text: 'RSI',
                            color: '#9C27B0',
                            font: { size: 12, weight: 'bold' }
                        },
                        ticks: { 
                            color: '#aaa',
                            callback: function(value) {
                                if (value === 30 || value === 70) {
                                    return value;
                                }
                                return value;
                            }
                        },
                        grid: { 
                            color: '#222',
                            drawBorder: true
                        }
                    };
                }
            } else {
                if (histomacdIndicatorCharts[league].data.datasets.length > 3) {
                    histomacdIndicatorCharts[league].data.datasets.splice(3, 1);
                }
                if (histomacdIndicatorCharts[league].options.scales['y-rsi']) {
                    delete histomacdIndicatorCharts[league].options.scales['y-rsi'];
                }
            }

            histomacdIndicatorCharts[league].options.scales['y-macd'].title.text = `MACD (${marketLabel})`;
            histomacdIndicatorCharts[league].update('none');
            console.log(`Gráfico de indicadores atualizado para ${league} com mercado ${marketLabel}`);
        }

        function histomacdUpdateCharts() {
            const timestamp = new Date().getTime();
            const apiUrl = `${HISTOMACD_DATA_URL}?timestamp=${timestamp}`;
            console.log(`Buscando dados em: ${apiUrl}`);
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Dados recebidos:`, data);
                    const league = 'Copa';
                    const processedData = histomacdProcessApiData(data, league);
                    const indicatorCanvas = document.getElementById('histomacdIndicators');

                    if (!indicatorCanvas) {
                        console.error(`Canvas não encontrado: histomacdIndicators`);
                        return;
                    }

                    if (!histomacdIndicatorCharts[league]) {
                        const indicatorCtx = indicatorCanvas.getContext('2d');
                        const indicatorData = histomacdGetIndicatorData(league, histomacdSelectedMarket);
                        histomacdIndicatorCharts[league] = histomacdCreateIndicatorChart(indicatorCtx, processedData.labels, indicatorData, league);
                        if (!histomacdIndicatorCharts[league]) {
                            console.error(`Falha ao criar gráfico de indicadores para ${league}`);
                            return;
                        }
                        console.log(`Gráfico criado para ${league}`);
                    } else {
                        histomacdUpdateIndicatorChart(league);
                        console.log(`Gráfico atualizado para ${league}`);
                    }
                })
                .catch(error => {
                    console.error(`Erro ao buscar dados:`, error);
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            histomacdLoadSettings();

            const marketSelector = document.getElementById('histomacdMarketSelector');
            if (marketSelector) {
                marketSelector.addEventListener('change', function(event) {
                    histomacdSelectedMarket = event.target.value;
                    histomacdSaveSettings();
                    console.log(`Mercado selecionado: ${histomacdSelectedMarket}`);
                    histomacdLeagues.forEach(league => {
                        histomacdUpdateIndicatorChart(league);
                    });
                });
            }

            const macdFastInput = document.getElementById('histomacdMacdFast');
            if (macdFastInput) {
                macdFastInput.addEventListener('change', function(event) {
                    histomacdMacdFast = parseInt(event.target.value, 10);
                    histomacdSaveSettings();
                    histomacdLeagues.forEach(league => {
                        histomacdUpdateIndicatorChart(league);
                    });
                });
            }

            const macdSlowInput = document.getElementById('histomacdMacdSlow');
            if (macdSlowInput) {
                macdSlowInput.addEventListener('change', function(event) {
                    histomacdMacdSlow = parseInt(event.target.value, 10);
                    histomacdSaveSettings();
                    histomacdLeagues.forEach(league => {
                        histomacdUpdateIndicatorChart(league);
                    });
                });
            }

            const macdSignalInput = document.getElementById('histomacdMacdSignal');
            if (macdSignalInput) {
                macdSignalInput.addEventListener('change', function(event) {
                    histomacdMacdSignal = parseInt(event.target.value, 10);
                    histomacdSaveSettings();
                    histomacdLeagues.forEach(league => {
                        histomacdUpdateIndicatorChart(league);
                    });
                });
            }

            const rsiPeriodInput = document.getElementById('histomacdRsiPeriod');
            if (rsiPeriodInput) {
                rsiPeriodInput.addEventListener('change', function(event) {
                    histomacdRsiPeriod = parseInt(event.target.value, 10);
                    histomacdSaveSettings();
                    histomacdLeagues.forEach(league => {
                        histomacdUpdateIndicatorChart(league);
                    });
                });
            }

            const showRSICheckbox = document.getElementById('histomacdShowRSI');
            if (showRSICheckbox) {
                showRSICheckbox.addEventListener('change', function(event) {
                    histomacdShowRSI = event.target.checked;
                    histomacdSaveSettings();
                    console.log(`RSI ${histomacdShowRSI ? 'ativado' : 'desativado'}`);
                    histomacdLeagues.forEach(league => {
                        histomacdUpdateIndicatorChart(league);
                    });
                });
            }

            const pointsSelector = document.getElementById('histomacdPointsSelector');
            if (pointsSelector) {
                pointsSelector.addEventListener('change', function(event) {
                    histomacdNumPoints = parseInt(event.target.value, 10);
                    histomacdSaveSettings();
                    histomacdUpdateCharts();
                });
            }

            const averageSelector = document.getElementById('histomacdAverageSelector');
            if (averageSelector) {
                averageSelector.addEventListener('change', function(event) {
                    histomacdAveragePoints = parseInt(event.target.value, 10);
                    histomacdSaveSettings();
                    histomacdUpdateCharts();
                });
            }

            histomacdUpdateCharts();
        });

        setInterval(histomacdUpdateCharts, 3000);
    </script>
</body>
</html>