<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BetStat - Candlestick</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Roboto", Arial, sans-serif;
            margin: 30px;
            background-color: #0a0e1a;
            color: #ffffff;
        }

        h1 {
            color: #1fad8b;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .control-panel {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        label {
            color: #1fad8b;
            margin-right: 5px;
        }

        select {
            padding: 8px 12px;
            background-color: #1c1f26;
            color: #e0e0e0;
            border: 1px solid #1fad8b;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .chart-container {
            background-color: #1c1f26;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .chart-container h2 {
            color: #1fad8b;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        canvas {
            border-radius: 4px;
        }

        .accordion {
            margin-bottom: 10px;
        }

        .accordion-header {
            background-color: #1c1f26;
            color: #1fad8b;
            padding: 12px;
            cursor: pointer;
            border: 1px solid #1fad8b;
            border-radius: 4px;
            font-size: 18px;
            text-align: center;
            transition: background-color 0.3s;
        }

        .accordion-header:hover {
            background-color: #2a2d36;
        }

        .accordion-content {
            display: none;
            padding: 10px;
        }

        .accordion-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>BetStat - Análise Candlestick</h1>

    <div class="control-panel">
        <div>
            <label for="pointsSelector">Quantidade de Jogos:</label>
            <select id="pointsSelector">
                <option value="20">20 Jogos</option>
                <option value="40">40 Jogos</option>
                <option value="60">60 Jogos</option>
                <option value="80">80 Jogos</option>
                <option value="100">100 Jogos</option>
                <option value="120">120 Jogos</option>
            </select>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header">Copa América</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Copa América</h2>
                <canvas id="copaamericaChart"></canvas>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header">Taça Glória Eterna</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Taça Glória Eterna</h2>
                <canvas id="tacagloriaChart"></canvas>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header">Euro</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Euro</h2>
                <canvas id="euroChart"></canvas>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header">Campeonato Italiano</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Campeonato Italiano</h2>
                <canvas id="campeonatoitalianoChart"></canvas>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header">Copa das Estrelas</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Copa das Estrelas</h2>
                <canvas id="copaestrelasChart"></canvas>
            </div>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header">Brasileirão Betano</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Brasileirão Betano</h2>
                <canvas id="brasileiraoChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let numPoints = 20;
        const leagues = ['CopaAmerica', 'TacaGloria', 'Euro', 'CampeonatoItaliano', 'CopaEstrelas', 'brasileirao'];
        const chartInstances = {};
        let chartData = {};

        function processApiData(data, league) {
            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(a.data);
                const dateB = new Date(b.data);
                if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                if (a.hora !== b.hora) return a.hora - b.hora;
                return a.minuto - b.minuto;
            });

            const slicedData = sortedData.slice(-numPoints);
            chartData[league] = slicedData;

            const candlestickData = slicedData.map((match, index) => {
                const ftScore = match.ft || '0 x 0';
                const ftParts = ftScore.split(' x ').map(num => parseInt(num, 10));
                const totalGols = ftParts[0] + ftParts[1];
                
                // Casa venceu = verde (alta), Fora venceu ou empate = vermelho (baixa)
                const isGreen = ftParts[0] > ftParts[1];
                
                // Open e Close baseados no resultado
                const open = index > 0 ? slicedData[index - 1].ft.split(' x ').reduce((a, b) => parseInt(a) + parseInt(b), 0) : 0;
                const close = totalGols;
                
                // High é o máximo de gols (total)
                const high = Math.max(totalGols, open);
                
                // Low é o mínimo
                const low = Math.min(totalGols, open);

                return {
                    x: index,
                    o: open,
                    h: high,
                    l: low,
                    c: close,
                    label: `${match.hora}:${match.minuto.toString().padStart(2, '0')}`,
                    ftScore: ftScore,
                    isGreen: isGreen
                };
            });

            return candlestickData;
        }

        function createCandlestickChart(ctx, data, league) {
            return new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'Gols',
                        data: data,
                        borderColor: function(context) {
                            const point = context.raw;
                            return point.isGreen ? '#00ff00' : '#ff0000';
                        },
                        backgroundColor: function(context) {
                            const point = context.raw;
                            return point.isGreen ? 'rgba(0, 255, 0, 0.5)' : 'rgba(255, 0, 0, 0.5)';
                        },
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#1fad8b',
                            bodyColor: '#e0e0e0',
                            borderColor: '#1fad8b',
                            borderWidth: 1,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].raw.label;
                                },
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `Placar: ${point.ftScore}`,
                                        `Total Gols: ${point.c}`,
                                        `Max: ${point.h}`,
                                        `Min: ${point.l}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Jogos',
                                color: '#1fad8b'
                            },
                            ticks: {
                                color: '#b0b0b0',
                                callback: function(value) {
                                    const match = chartData[league][value];
                                    return match ? `${match.hora}:${match.minuto.toString().padStart(2, '0')}` : '';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [5, 5]
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Quantidade de Gols',
                                color: '#1fad8b'
                            },
                            ticks: {
                                color: '#b0b0b0',
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                borderDash: [5, 5]
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            const timestamp = new Date().getTime();
            const leagueUrls = {
                'CopaAmerica': 'https://betstat.site/resultados/Copa%20Am%C3%A9rica',
                'TacaGloria': 'https://betstat.site/resultados/Ta%C3%A7a%20Gl%C3%B3ria%20eterna',
                'Euro': 'https://betstat.site/resultados/Euro',
                'CampeonatoItaliano': 'https://betstat.site/resultados/Campeonato%20Italiano',
                'CopaEstrelas': 'https://betstat.site/resultados/Copa%20das%20estrelas',
                'brasileirao': 'https://betstat.site/resultados/Brasileir%C3%A3o%20Betano',
            };

            leagues.forEach(league => {
                const apiUrl = `${leagueUrls[league]}?timestamp=${timestamp}`;
                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        const processedData = processApiData(data, league);
                        const chartId = `${league.toLowerCase()}Chart`;
                        const canvasElement = document.getElementById(chartId);
                        
                        if (!canvasElement) {
                            console.error(`Canvas com ID '${chartId}' não encontrado`);
                            return;
                        }

                        if (chartInstances[league]) {
                            chartInstances[league].destroy();
                        }

                        const ctx = canvasElement.getContext('2d');
                        chartInstances[league] = createCandlestickChart(ctx, processedData, league);
                    })
                    .catch(error => console.error(`Erro ao buscar dados para ${league}:`, error));
            });
        }

        // Accordion toggle
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                content.classList.toggle('active');
            });
        });

        // Points selector
        document.getElementById('pointsSelector').addEventListener('change', function(event) {
            numPoints = parseInt(event.target.value, 10);
            updateCharts();
        });

        // Initial load
        window.onload = updateCharts;
        setInterval(updateCharts, 3000);
    </script>
</body>
</html>