<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4WT805FFHQ"></script>
    <title>BetStat</title>
    <meta name="description" content="Transforme suas apostas com BetStat - a única plataforma especializada em futebol virtual Betano. Análises precisas, estatísticas confiáveis e resultados comprovados para investimentos inteligentes." />
    <meta name="keywords" content="BetStat, apostas esportivas, futebol virtual, Betano, estatísticas apostas, análise apostas, investimentos esportivos" />
    <meta property="og:title" content="BetStat | Plataforma de Análise para Apostas Esportivas" />
    <meta property="og:description" content="Transforme suas apostas com análises precisas e estatísticas confiáveis. A única plataforma especializada em futebol virtual Betano." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.betstat.site/payment.html" />
    <meta property="og:site_name" content="BetStat" />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="BetStat" />
    <meta name="canonical" href="https://www.betstat.site/payment.html" />
    <script type="module" src="js/firebase-auth.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "G-4WT805FFHQ");
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />

    <style>
      :root {
        --background-color: #1c1f26;
        --primary-color: #252830;
        --secondary-color: #2f323a;
        --accent-color: #1fad8b;
        --text-color: #d5d7db;
        --table-header: #2f323a;
        --border-color: #3a3e47;
        --tooltip-bg: #333842;
        --tooltip-text: #e0e2e6;
        --percentage-green: #1fad8b;
        --percentage-yellow: #f1c40f;
        --percentage-orange: #e67e22;
        --percentage-red: #e74c3c;
        --lta-color: #4ea8de;
        --ltb-color: #e06c75;
        --surface-3: #2a2e38;
        --muted: #6b7080;
        --font-mono: 'JetBrains Mono', monospace;
      }

      *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: "Roboto", Arial, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        min-height: 100vh;
        padding-top: 80px;
      }

      /* Legacy compatibility */
      .logo2 { width: 60px; height: auto; }
      .espaco { width: 50px; height: 50px; }
      .logo { height: 30px; }
      .selectors-container { display: flex; align-items: center; gap: 10px; }
      .nav-seletor { display: flex; align-items: center; color: #fff; font-weight: 500; }
      .nav-seletor select { padding: 0.5rem; border-radius: 6px; background-color: var(--background-color); color: var(--text-color); border: 1px solid #ffffff9f; cursor: pointer; }

      .logout-btn {
        background-color: var(--background-color);
        color: white; padding: 8px 10px; font-size: 14px;
        border-radius: 5px; cursor: pointer; border: 1px solid var(--border-color);
      }
      .logout-btn:hover { background-color: #720000; }

      button {
        background-color: var(--background-color); color: #fff;
        font-family: "Roboto", Arial, sans-serif; border: none;
        padding: 5px 8px; border-radius: 5px; cursor: pointer;
        font-size: 16px; transition: background-color 0.3s; margin: 0;
      }
      button:hover { background-color: #0f1013; }

      option { background-color: var(--background-color); color: #fff; }

      select {
        width: 100%; padding: 7px 32px 7px 10px;
        border-radius: 4px; background-color: var(--surface-3);
        color: #fff; font-family: "Roboto", Arial, sans-serif;
        font-size: 13px; cursor: pointer; border: 1px solid var(--border-color);
        transition: border-color 0.2s; appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='7' viewBox='0 0 11 7'%3E%3Cpath d='M1 1l4.5 4.5L10 1' stroke='%236b7080' stroke-width='1.4' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat; background-position: right 0.65rem center;
      }
      select:focus { outline: none; border-color: var(--accent-color); }

      label {
        font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
        letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 0;
      }

      /* PAGE WRAPPER */
      .page-wrapper {
        max-width: 1800px; margin: 0 auto; padding: 1.5rem 1.5rem 4rem;
      }

      /* PAGE HEADER */
      .page-header {
        display: flex; align-items: center; justify-content: space-between;
        flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;
        padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
      }

      .page-title {
        font-family: var(--font-mono); font-size: 0.78rem; font-weight: 600;
        letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted);
      }
      .page-title span { color: var(--accent-color); }

      .live-indicator {
        display: inline-flex; align-items: center; gap: 0.45rem;
        font-family: var(--font-mono); font-size: 0.62rem; font-weight: 600;
        letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent-color);
        background: rgba(31,173,139,0.08); border: 1px solid rgba(31,173,139,0.22);
        padding: 0.28rem 0.65rem; border-radius: 3px;
      }
      .live-dot {
        width: 5px; height: 5px; border-radius: 50%;
        background: var(--accent-color); animation: blink 2s ease infinite;
      }
      @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

      /* FILTERS */
      .filters {
        background: var(--primary-color); padding: 1.2rem 1.5rem;
        border-radius: 6px; display: flex; flex-wrap: wrap;
        gap: 1.2rem; align-items: flex-end; margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
      }

      .filter-group {
        display: flex; flex-direction: column; gap: 0.4rem;
        flex: 1; min-width: 110px;
      }

      .custom-button {
        font-family: var(--font-mono); font-size: 0.68rem; font-weight: 600;
        letter-spacing: 0.08em; text-transform: uppercase;
        padding: 0.52rem 1.4rem; border: 1px solid var(--accent-color);
        border-radius: 4px; background: var(--accent-color);
        color: #0d1f1a; cursor: pointer; transition: opacity 0.2s; margin: 0;
      }
      .custom-button:hover { opacity: 0.85; background: var(--accent-color); }
      .custom-button:active { transform: translateY(1px); }

      /* STATUS CARDS */
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(185px, 1fr));
        gap: 1rem; margin-bottom: 1.5rem;
      }

      .stat-card {
        background: var(--primary-color); border: 1px solid var(--border-color);
        border-radius: 6px; padding: 1rem 1.1rem;
        position: relative; overflow: hidden;
      }
      .stat-card::after {
        content: ''; position: absolute; top: 0; left: 0;
        width: 3px; height: 100%;
        background: var(--accent-color);
      }
      .stat-card.card-lta::after  { background: var(--lta-color); }
      .stat-card.card-ltb::after  { background: var(--ltb-color); }
      .stat-card.card-warn::after { background: var(--percentage-yellow); }
      .stat-card.card-red::after  { background: var(--percentage-red); }

      .card-label {
        font-family: var(--font-mono); font-size: 0.57rem; font-weight: 600;
        letter-spacing: 0.12em; text-transform: uppercase;
        color: var(--muted); margin-bottom: 0.45rem;
      }
      .card-value {
        font-family: var(--font-mono); font-size: 1.55rem; font-weight: 700;
        color: var(--text-color); line-height: 1; margin-bottom: 0.25rem;
      }
      .card-value.v-green  { color: var(--percentage-green); }
      .card-value.v-yellow { color: var(--percentage-yellow); }
      .card-value.v-orange { color: var(--percentage-orange); }
      .card-value.v-red    { color: var(--percentage-red); }
      .card-value.v-blue   { color: var(--lta-color); }
      .card-value.v-pink   { color: var(--ltb-color); }
      .card-sub { font-size: 0.71rem; color: var(--muted); line-height: 1.4; }

      /* ANALYSIS PANEL */
      .analysis-panel {
        background: var(--primary-color); border: 1px solid var(--border-color);
        border-radius: 6px; margin-bottom: 1.5rem; overflow: hidden;
      }
      .panel-header {
        background: var(--secondary-color); border-bottom: 1px solid var(--border-color);
        padding: 0.65rem 1.25rem; display: flex; align-items: center; gap: 0.55rem;
      }
      .panel-dot {
        width: 5px; height: 5px; border-radius: 50%;
        background: var(--accent-color); flex-shrink: 0;
      }
      .panel-header span {
        font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
        letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted);
      }

      .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1px; background: var(--border-color);
      }
      .analysis-block { background: var(--primary-color); padding: 1rem 1.25rem; }
      .block-label {
        font-family: var(--font-mono); font-size: 0.57rem; font-weight: 600;
        letter-spacing: 0.12em; text-transform: uppercase;
        color: var(--muted); margin-bottom: 0.5rem;
      }
      .block-content { font-size: 0.84rem; color: var(--text-color); line-height: 1.55; }

      .badge {
        display: inline-block; font-family: var(--font-mono); font-size: 0.58rem;
        font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
        padding: 0.17rem 0.48rem; border-radius: 2px; margin-bottom: 0.38rem;
      }
      .b-green  { background:rgba(31,173,139,0.14);  color:var(--percentage-green);  border:1px solid rgba(31,173,139,0.3); }
      .b-yellow { background:rgba(241,196,15,0.12);  color:var(--percentage-yellow); border:1px solid rgba(241,196,15,0.3); }
      .b-orange { background:rgba(230,126,34,0.12);  color:var(--percentage-orange); border:1px solid rgba(230,126,34,0.3); }
      .b-red    { background:rgba(231,76,60,0.12);   color:var(--percentage-red);    border:1px solid rgba(231,76,60,0.3); }
      .b-blue   { background:rgba(78,168,222,0.12);  color:var(--lta-color);          border:1px solid rgba(78,168,222,0.3); }
      .b-pink   { background:rgba(224,108,117,0.12); color:var(--ltb-color);          border:1px solid rgba(224,108,117,0.3); }
      .b-gray   { background:rgba(107,112,128,0.12); color:#7c8199;                   border:1px solid rgba(107,112,128,0.3); }

      .block-desc {
        display: block; margin-top: 0.28rem;
        font-size: 0.77rem; color: var(--muted); line-height: 1.5;
      }

      /* TABLE */
      .table-wrapper {
        background: var(--primary-color); border: 1px solid var(--border-color);
        border-radius: 6px; overflow: hidden;
      }
      .table-topbar {
        background: var(--secondary-color); border-bottom: 1px solid var(--border-color);
        padding: 0.65rem 1.25rem; display: flex; align-items: center;
        justify-content: space-between; gap: 1rem; flex-wrap: wrap;
      }
      .tbar-title {
        font-family: var(--font-mono); font-size: 0.6rem; font-weight: 600;
        letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted);
      }
      .tbar-count { font-family: var(--font-mono); font-size: 0.6rem; color: #4e536b; }

      table { width: 100%; border-collapse: collapse; background: var(--primary-color); }

      th, td { padding: 0.7rem 1rem; text-align: left; font-size: 0.875rem; }

      th {
        background-color: var(--secondary-color); color: var(--muted);
        font-family: var(--font-mono); font-weight: 600;
        text-transform: uppercase; font-size: 0.58rem; letter-spacing: 0.1em;
        cursor: pointer; user-select: none; border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
      }
      th:hover { color: var(--accent-color); }

      td { color: var(--text-color); border-bottom: 1px solid var(--border-color); }
      tbody tr:last-child td { border-bottom: none; }
      tbody tr { transition: background 0.15s; cursor: pointer; }
      tbody tr:hover { background: var(--secondary-color); }

      .percentage-green  { color: var(--percentage-green)  !important; font-weight: 600; }
      .percentage-yellow { color: var(--percentage-yellow) !important; font-weight: 600; }
      .percentage-orange { color: var(--percentage-orange) !important; font-weight: 600; }
      .percentage-red    { color: var(--percentage-red)    !important; font-weight: 600; }

      .bar-wrap { display: flex; align-items: center; gap: 0.5rem; }
      .mini-bar {
        height: 3px; background: var(--border-color); border-radius: 2px;
        flex: 1; max-width: 70px; overflow: hidden;
      }
      .mini-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

      /* Tooltip */
      .tooltip { position: relative; }
      #currentPercentage { display: none; }

      /* Responsive */
      @media (max-width: 640px) {
        .page-wrapper { padding: 1rem 1rem 3rem; }
        .filters { flex-direction: column; }
        .filter-group { min-width: 100%; }
        th, td { padding: 0.55rem 0.7rem; font-size: 0.8rem; }
        .status-grid { grid-template-columns: 1fr 1fr; }
      }
    </style>
  </head>

  <body>
    <div id="header"></div>

    <div class="page-wrapper">

      <div class="page-header">
        <div class="page-title">Radar de <span>Mercados</span></div>
        <div class="live-indicator">
          <div class="live-dot"></div>
          Atualizacao automatica
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label for="selectedLeague">Liga</label>
          <select id="selectedLeague">
            <option value="all">Todas as Ligas</option>
            <option value="Copa%20Am%C3%A9rica">Copa America</option>
            <option value="Ta%C3%A7a%20Gl%C3%B3ria%20eterna">Classicos da America</option>
            <option value="Euro">Euro</option>
            <option value="Campeonato%20Italiano">Campeonato Italiano</option>
            <option value="Copa%20das%20estrelas">Copa das Estrelas</option>
            <option value="Brasileir%C3%A3o%20Betano">Brasileirao Betano</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="searchedMarket">Mercado</label>
          <select id="searchedMarket">
            <option value="ambasSim">Ambas Sim</option>
            <option value="ambasNao">Ambas Nao</option>
            <option value="casaVence">Casa Vence</option>
            <option value="foraVence">Fora Vence</option>
            <option value="over1.5">Over 1.5</option>
            <option value="over2.5">Over 2.5</option>
            <option value="over3.5">Over 3.5</option>
            <option value="under1.5">Under 1.5</option>
            <option value="under2.5">Under 2.5</option>
            <option value="under3.5">Under 3.5</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="timeRange">Janela de Tempo</label>
          <select id="timeRange">
            <option value="3" data-games="60">3 Horas</option>
            <option value="6" data-games="120" selected>6 Horas</option>
            <option value="12" data-games="240">12 Horas</option>
            <option value="24" data-games="480">24 Horas</option>
            <option value="48" data-games="960">48 Horas</option>
            <option value="72" data-games="1444">72 Horas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="linesToSum">Base de Calculo</label>
          <select id="linesToSum">
            <option value="20">20</option>
            <option value="40">40</option>
            <option value="60">60</option>
            <option value="80">80</option>
            <option value="100">100</option>
            <option value="120">120</option>
            <option value="140">140</option>
            <option value="160">160</option>
            <option value="180">180</option>
            <option value="200">200</option>
            <option value="220">220</option>
            <option value="240">240</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="verifyLines">Gales</label>
          <select id="verifyLines">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="filter-group" style="flex:0;min-width:auto;">
          <label style="visibility:hidden;">x</label>
          <button id="toggleTeamsBtn" onclick="calculateOccurrencesAndRank()" class="custom-button">
            Calcular
          </button>
        </div>
      </div>

      <div id="currentPercentage"></div>

      <!-- STATUS CARDS -->
      <div class="status-grid">
        <div class="stat-card" id="cardAtual">
          <div class="card-label">Porcentagem Atual</div>
          <div class="card-value" id="cardAtualVal">--</div>
          <div class="card-sub" id="cardAtualSub">Aguardando calculo</div>
        </div>
        <div class="stat-card" id="cardStreak">
          <div class="card-label">Sequencia Atual</div>
          <div class="card-value" id="cardStreakVal">--</div>
          <div class="card-sub" id="cardStreakSub">Aguardando calculo</div>
        </div>
        <div class="stat-card card-lta" id="cardLTA">
          <div class="card-label">LTA — Tendencia de Alta</div>
          <div class="card-value v-blue" id="cardLTAVal">--</div>
          <div class="card-sub" id="cardLTASub">Aguardando calculo</div>
        </div>
        <div class="stat-card card-ltb" id="cardLTB">
          <div class="card-label">LTB — Tendencia de Baixa</div>
          <div class="card-value v-pink" id="cardLTBVal">--</div>
          <div class="card-sub" id="cardLTBSub">Aguardando calculo</div>
        </div>
        <div class="stat-card" id="cardMedia">
          <div class="card-label">Media Geral</div>
          <div class="card-value" id="cardMediaVal">--</div>
          <div class="card-sub" id="cardMediaSub">Aguardando calculo</div>
        </div>
        <div class="stat-card" id="cardVol">
          <div class="card-label">Volatilidade</div>
          <div class="card-value" id="cardVolVal">--</div>
          <div class="card-sub" id="cardVolSub">Aguardando calculo</div>
        </div>
      </div>

      <!-- ANALYSIS PANEL -->
      <div class="analysis-panel" id="analysisPanel" style="display:none;">
        <div class="panel-header">
          <div class="panel-dot"></div>
          <span>Analise de Condicao e Indicacao Operacional</span>
        </div>
        <div class="analysis-grid">
          <div class="analysis-block">
            <div class="block-label">Condicao de Tendencia</div>
            <div class="block-content" id="aTrend">--</div>
          </div>
          <div class="analysis-block">
            <div class="block-label">Indicacao Operacional</div>
            <div class="block-content" id="aSignal">--</div>
          </div>
          <div class="analysis-block">
            <div class="block-label">Pressao Recente — Ultimos 10</div>
            <div class="block-content" id="aPressure">--</div>
          </div>
          <div class="analysis-block">
            <div class="block-label">Nivel de Confianca</div>
            <div class="block-content" id="aConfidence">--</div>
          </div>
          <div class="analysis-block">
            <div class="block-label">Pico e Vale Observados</div>
            <div class="block-content" id="aPeak">--</div>
          </div>
          <div class="analysis-block">
            <div class="block-label">Melhor Zona Historica</div>
            <div class="block-content" id="aZones">--</div>
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-wrapper">
        <div class="table-topbar">
          <span class="tbar-title">Ranking de Mercados</span>
          <span class="tbar-count" id="rowCount">-- registros</span>
        </div>
        <table id="rankingTable">
          <thead>
            <tr>
              <th onclick="sortTable(0)">Mercado / Base %</th>
              <th onclick="sortTable(1)">Ocorrencias</th>
              <th onclick="sortTable(2)">Greens</th>
              <th onclick="sortTable(3)">Green %</th>
              <th>Distribuicao</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div><!-- end page-wrapper -->

    <script>
      const leagues = [
        'Copa%20Am%C3%A9rica',
        'Ta%C3%A7a%20Gl%C3%B3ria%20eterna',
        'Euro',
        'Campeonato%20Italiano',
        'Copa%20das%20estrelas',
        'British%20Derbies',
        'Liga%20Espanhola',
        'Scudetto%20Italiano'
      ];

      const apiBaseUrl = 'https://betstat.site/resultados';
      let currentRankingData = [];
      let autoUpdateInterval = null;

      function parseApiData(data, league) {
        return data.map(item => {
          const [homeGoals, awayGoals] = item.ft.split(' x ').map(Number);
          const totalGoals = homeGoals + awayGoals;
          const time = `${item.hora.toString().padStart(2,'0')}:${item.minuto.toString().padStart(2,'0')}`;
          return { league: league.toLowerCase(), homeGoals, awayGoals, homeTeam: item.time_a, awayTeam: item.time_b, totalGoals, marketGoals: totalGoals, time };
        });
      }

      function formatMarketName(market) {
        const m = { ambasSim:'Ambas Sim', ambasNao:'Ambas Nao', casaVence:'Casa Vence', foraVence:'Fora Vence', empate:'Empate', 'over1.5':'Over 1.5', 'over2.5':'Over 2.5', 'over3.5':'Over 3.5', 'under1.5':'Under 1.5', 'under2.5':'Under 2.5', 'under3.5':'Under 3.5', umGolExato:'1 Gol Exato', doisGolsExatos:'2 Gols Exatos', tresGolsExatos:'3 Gols Exatos', quatroGolsExatos:'4 Gols Exatos', cincoOuMaisGols:'5 ou Mais Gols' };
        return m[market] || market;
      }

      function checkMarket(market, h, a, t) {
        switch (market) {
          case 'ambasSim':   return h > 0 && a > 0 ? 1 : 0;
          case 'ambasNao':   return h === 0 || a === 0 ? 1 : 0;
          case 'casaVence':  return h > a ? 1 : 0;
          case 'foraVence':  return a > h ? 1 : 0;
          case 'empate':     return h === a ? 1 : 0;
          case 'over1.5':    return t > 1.5 ? 1 : 0;
          case 'over2.5':    return t > 2.5 ? 1 : 0;
          case 'over3.5':    return t > 3.5 ? 1 : 0;
          case 'under1.5':   return t < 1.5 ? 1 : 0;
          case 'under2.5':   return t < 2.5 ? 1 : 0;
          case 'under3.5':   return t < 3.5 ? 1 : 0;
          case 'umGolExato': return t === 1 ? 1 : 0;
          case 'doisGolsExatos': return t === 2 ? 1 : 0;
          case 'tresGolsExatos': return t === 3 ? 1 : 0;
          case 'quatroGolsExatos': return t === 4 ? 1 : 0;
          case 'cincoOuMaisGols': return t >= 5 ? 1 : 0;
          default: return 0;
        }
      }

      function getPctClass(pct) {
        pct = parseFloat(pct);
        if (pct >= 75) return 'percentage-green';
        if (pct >= 50) return 'percentage-yellow';
        if (pct >= 25) return 'percentage-orange';
        return 'percentage-red';
      }

      function getBarColor(pct) {
        pct = parseFloat(pct);
        if (pct >= 75) return '#1fad8b';
        if (pct >= 50) return '#f1c40f';
        if (pct >= 25) return '#e67e22';
        return '#e74c3c';
      }

      /* ---- TREND ENGINE ---- */
      function computeTrends(series, linesToSum) {
        if (!series || series.length < linesToSum + 6) return null;

        const rolling = [];
        for (let i = linesToSum - 1; i < series.length; i++) {
          const sl = series.slice(i - linesToSum + 1, i + 1);
          rolling.push(sl.reduce((a, b) => a + b, 0) / linesToSum * 100);
        }

        if (rolling.length < 6) return null;

        function linReg(arr) {
          const n = arr.length;
          let sx=0, sy=0, sxy=0, sx2=0;
          arr.forEach((y, x) => { sx+=x; sy+=y; sxy+=x*y; sx2+=x*x; });
          return (n*sxy - sx*sy) / (n*sx2 - sx*sx);
        }

        const slope = linReg(rolling);
        const recentSlice = rolling.slice(Math.floor(rolling.length * 0.65));
        const recentSlope = linReg(recentSlice);

        const ltaActive = slope > 0.25 && recentSlope > 0;
        const ltbActive = slope < -0.25 && recentSlope < 0;

        const mean = rolling.reduce((a,b)=>a+b,0) / rolling.length;
        const variance = rolling.reduce((s,v)=>s+(v-mean)**2,0) / rolling.length;
        const stdDev = Math.sqrt(variance);
        const peak = Math.max(...rolling);
        const valley = Math.min(...rolling);
        const currentPct = rolling[rolling.length - 1];

        const last = series[series.length - 1];
        let streak = 0;
        for (let i = series.length - 1; i >= 0; i--) {
          if (series[i] === last) streak++; else break;
        }

        const recent10 = series.slice(-10).reduce((a,b)=>a+b, 0);

        // Best historical zone
        const zones = {};
        for (let i = linesToSum - 1; i < series.length - 1; i++) {
          const sl = series.slice(i - linesToSum + 1, i + 1);
          const bucket = Math.round(sl.reduce((a,b)=>a+b,0) / linesToSum * 100 / 5) * 5;
          if (!zones[bucket]) zones[bucket] = { total:0, hits:0 };
          zones[bucket].total++;
          if (series[i+1] === 1) zones[bucket].hits++;
        }
        const bestZone = Object.entries(zones)
          .filter(([,v]) => v.total >= 5)
          .sort(([,a],[,b]) => (b.hits/b.total)-(a.hits/a.total))[0];

        return {
          slope: slope.toFixed(3), recentSlope: recentSlope.toFixed(3),
          ltaActive, ltbActive,
          mean: mean.toFixed(1), stdDev: stdDev.toFixed(1),
          peak: peak.toFixed(1), valley: valley.toFixed(1),
          currentPct: currentPct.toFixed(1),
          streak, streakType: last, recent10,
          bestZone: bestZone
            ? { pct: bestZone[0], rate: (bestZone[1].hits/bestZone[1].total*100).toFixed(0), total: bestZone[1].total }
            : null,
          totalSeries: series.length
        };
      }

      function renderDashboard(tr, market, linesToSum) {
        if (!tr) return;
        document.getElementById('analysisPanel').style.display = '';
        const mkt = formatMarketName(market);
        const pct = parseFloat(tr.currentPct);
        const pctVClass = pct>=75?'v-green':pct>=50?'v-yellow':pct>=25?'v-orange':'v-red';

        // Card: Atual
        document.getElementById('cardAtualVal').textContent = tr.currentPct + '%';
        document.getElementById('cardAtualVal').className = 'card-value ' + pctVClass;
        document.getElementById('cardAtualSub').textContent = 'Base de ' + linesToSum + ' jogos';
        document.getElementById('cardAtual').className = 'stat-card ' + (pct>=75?'':(pct>=50?'card-warn':'card-red'));

        // Card: Streak
        const sLabel = tr.streakType===1 ? 'Green consecutivo' : 'Red consecutivo';
        document.getElementById('cardStreakVal').textContent = tr.streak + 'x';
        document.getElementById('cardStreakVal').className = 'card-value ' + (tr.streakType===1?'v-green':'v-red');
        document.getElementById('cardStreakSub').textContent = sLabel;
        document.getElementById('cardStreak').className = 'stat-card ' + (tr.streakType===1?'':'card-ltb');

        // Card: LTA
        document.getElementById('cardLTAVal').textContent = tr.ltaActive ? 'Ativa' : 'Inativa';
        document.getElementById('cardLTASub').textContent = 'Inclinacao: ' + tr.slope + ' pp/ciclo';

        // Card: LTB
        document.getElementById('cardLTBVal').textContent = tr.ltbActive ? 'Ativa' : 'Inativa';
        document.getElementById('cardLTBSub').textContent = tr.ltbActive ? 'Mercado em queda — cautela' : 'Sem pressao de baixa detectada';

        // Card: Media
        const mediaClass = parseFloat(tr.mean)>=75?'v-green':parseFloat(tr.mean)>=50?'v-yellow':'';
        document.getElementById('cardMediaVal').textContent = tr.mean + '%';
        document.getElementById('cardMediaVal').className = 'card-value ' + mediaClass;
        document.getElementById('cardMediaSub').textContent = 'Media historica da janela';

        // Card: Volatilidade
        const vol = parseFloat(tr.stdDev);
        const vLabel = vol<8?'Baixa':vol<16?'Moderada':'Alta';
        const vClass = vol<8?'v-green':vol<16?'v-yellow':'v-red';
        document.getElementById('cardVolVal').textContent = tr.stdDev + ' pp';
        document.getElementById('cardVolVal').className = 'card-value ' + vClass;
        document.getElementById('cardVolSub').textContent = 'Volatilidade ' + vLabel.toLowerCase() + ' — desvio padrao';
        document.getElementById('cardVol').className = 'stat-card ' + (vol<8?'':(vol<16?'card-warn':'card-red'));

        // Analysis: Tendencia
        let tB, tD;
        if (tr.ltaActive && !tr.ltbActive) {
          tB='<span class="badge b-blue">LTA Ativa</span>';
          tD='Tendencia de alta confirmada. Inclinacao positiva indica que o mercado de '+mkt+' vem ganhando consistencia nos ciclos recentes.';
        } else if (tr.ltbActive && !tr.ltaActive) {
          tB='<span class="badge b-pink">LTB Ativa</span>';
          tD='Tendencia de baixa confirmada. O mercado perdeu forca e apresenta inclinacao negativa nos periodos observados.';
        } else if (tr.ltaActive && tr.ltbActive) {
          tB='<span class="badge b-yellow">Conflito</span>';
          tD='Sinais contraditorios entre LTA e LTB. Mercado em zona de transicao — aguardar definicao antes de operar.';
        } else {
          tB='<span class="badge b-gray">Lateral</span>';
          tD='Mercado sem tendencia definida. Oscilacao dentro de zona neutra com volatilidade controlada.';
        }
        document.getElementById('aTrend').innerHTML = tB+'<span class="block-desc">'+tD+'</span>';

        // Analysis: Indicacao
        let sB, sD;
        if (tr.ltaActive && pct>=60 && tr.streakType===1 && tr.streak>=2) {
          sB='<span class="badge b-green">Entrada</span>';
          sD='Condicoes favoraveis alinhadas: LTA ativa, porcentagem elevada e sequencia positiva. Momento propenso a entrada.';
        } else if (tr.ltbActive || pct<38) {
          sB='<span class="badge b-red">Aguardar</span>';
          sD='Condicoes desfavoraveis. Recomendado aguardar estabilizacao do mercado antes de qualquer entrada.';
        } else if (!tr.ltbActive && pct>=50) {
          sB='<span class="badge b-yellow">Monitorar</span>';
          sD='Mercado em zona neutra-positiva. Acompanhar os proximos ciclos para confirmar direcao antes de operar.';
        } else {
          sB='<span class="badge b-gray">Neutro</span>';
          sD='Sem sinal operacional claro. Observar evolucao da porcentagem nos proximos periodos.';
        }
        document.getElementById('aSignal').innerHTML = sB+'<span class="block-desc">'+sD+'</span>';

        // Analysis: Pressao
        const r10 = tr.recent10;
        const rB = r10>=7?'b-green':r10>=5?'b-yellow':'b-red';
        const rD = r10>=7?'Pressao positiva forte. Alta frequencia de greens no periodo mais recente.'
          :r10>=5?'Pressao moderada. Equilibrio entre greens e reds nos ultimos 10 jogos.'
          :'Pressao negativa. Predominancia de reds recentes — mercado sob correcao.';
        document.getElementById('aPressure').innerHTML = '<span class="badge '+rB+'">'+r10+' de 10</span><span class="block-desc">'+rD+'</span>';

        // Analysis: Confianca
        const n = tr.totalSeries;
        let cB, cD;
        if (n>=500 && vol<10) { cB='<span class="badge b-green">Alta</span>'; cD='Amostra ampla ('+n+' jogos) com baixa volatilidade. Resultados estatisticamente robustos.'; }
        else if (n>=200) { cB='<span class="badge b-yellow">Media</span>'; cD='Amostra adequada ('+n+' jogos). Para maior precisao, considere ampliar a janela de tempo.'; }
        else { cB='<span class="badge b-red">Baixa</span>'; cD='Amostra insuficiente ('+n+' jogos). Amplie a janela ou base de calculo para resultados mais confiaveis.'; }
        document.getElementById('aConfidence').innerHTML = cB+'<span class="block-desc">'+cD+'</span>';

        // Analysis: Pico e Vale
        const amp = (parseFloat(tr.peak)-parseFloat(tr.valley)).toFixed(1);
        document.getElementById('aPeak').innerHTML =
          '<span style="color:var(--lta-color);font-family:var(--font-mono);">Max '+tr.peak+'%</span>&nbsp;&nbsp;'+
          '<span style="color:var(--ltb-color);font-family:var(--font-mono);">Min '+tr.valley+'%</span>'+
          '<span class="block-desc">Amplitude de '+amp+' pp na janela observada. '+(parseFloat(amp)>30?'Amplitude elevada indica mercado instavel.':'Amplitude dentro do esperado para o periodo.')+'</span>';

        // Analysis: Zona
        if (tr.bestZone) {
          const zB = parseInt(tr.bestZone.rate)>=70?'b-green':parseInt(tr.bestZone.rate)>=50?'b-yellow':'b-orange';
          document.getElementById('aZones').innerHTML =
            '<span class="badge '+zB+'">~'+tr.bestZone.pct+'% de base</span>'+
            '<span class="block-desc">A zona de '+tr.bestZone.pct+'% apresentou taxa de green de '+tr.bestZone.rate+'% em '+tr.bestZone.total+' ocorrencias. Melhor desempenho historico para este mercado.</span>';
        } else {
          document.getElementById('aZones').innerHTML = '<span class="badge b-gray">Insuficiente</span><span class="block-desc">Amostra insuficiente para identificar zonas de entrada com confiabilidade estatistica.</span>';
        }
      }

      /* ---- MAIN FUNCTION ---- */
      async function calculateOccurrencesAndRank(autoUpdate = false) {
        const selectedLeague = document.getElementById("selectedLeague").value;
        const searchedMarket = document.getElementById("searchedMarket").value;
        const timeRange = document.getElementById("timeRange");
        const numberOfGames = parseInt(timeRange.options[timeRange.selectedIndex].getAttribute('data-games'));
        const linesToSum = parseInt(document.getElementById("linesToSum").value);
        const verifyLines = parseInt(document.getElementById("verifyLines").value);

        const tbodyRanking = document.getElementById("rankingTable").getElementsByTagName("tbody")[0];
        const leaguesToFetch = selectedLeague === 'all' ? leagues : [selectedLeague];
        let combinedData = [];

        for (const league of leaguesToFetch) {
          try {
            const response = await fetch(`${apiBaseUrl}/${league}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            if (!data.length) continue;
            const parsedData = parseApiData(data, league).slice(-numberOfGames);
            combinedData = combinedData.concat(parsedData.map(item => [
              item.time, item.homeGoals, item.awayGoals, item.homeTeam, item.awayTeam, item.totalGoals, item.league
            ]));
          } catch (error) {
            console.error(`Erro ao buscar dados da liga ${league}:`, error);
          }
        }

        if (combinedData.length === 0) {
          if (!autoUpdate) alert("Nenhum dado disponivel. Verifique se a API esta funcionando e retornando dados.");
          return;
        }

        // Build binary series
        const binarySeries = combinedData.map(row => checkMarket(searchedMarket, row[1], row[2], row[5]));
        const trends = computeTrends(binarySeries, linesToSum);
        if (trends) renderDashboard(trends, searchedMarket, linesToSum);

        // Legacy compat
        const recentGames = combinedData.slice(-linesToSum);
        const currentMarketCount = recentGames.reduce((sum, row) => sum + checkMarket(searchedMarket, row[1], row[2], row[5]), 0);
        const currentPercentage = (currentMarketCount / linesToSum * 100).toFixed(0);
        document.getElementById("currentPercentage").textContent = `Porcentagem Atual: ${formatMarketName(searchedMarket)} ${currentPercentage}%`;

        // Ranking
        const marketGroups = {};
        combinedData.forEach((row, i) => {
          if (i >= linesToSum - 1) {
            const sumMarket = combinedData.slice(i - linesToSum + 1, i + 1).reduce((sum, r) => sum + checkMarket(searchedMarket, r[1], r[2], r[5]), 0);
            const marketPercentage = Math.round(sumMarket / linesToSum * 100);
            let result = "red", greens = 0, reds = 0;
            if (i + verifyLines <= combinedData.length) {
              const nextRows = combinedData.slice(i + 1, i + 1 + verifyLines);
              greens = nextRows.filter(r => checkMarket(searchedMarket, r[1], r[2], r[5]) === 1).length;
              reds = verifyLines - greens;
              if (nextRows.some(r => checkMarket(searchedMarket, r[1], r[2], r[5]) === 1)) result = "green";
            }
            const mg = `${formatMarketName(searchedMarket)} ${marketPercentage}%`;
            if (!marketGroups[mg]) marketGroups[mg] = { occurrences:0, greens:0, reds:0, totalGreens:0, totalReds:0 };
            marketGroups[mg].occurrences++;
            if (result === "green") marketGroups[mg].greens++;
            else marketGroups[mg].reds++;
            marketGroups[mg].totalGreens = greens;
            marketGroups[mg].totalReds = reds;
          }
        });

        const sortedGroups = Object.keys(marketGroups).map(key => {
          const g = marketGroups[key];
          const greenPercentage = (g.greens / g.occurrences * 100).toFixed(2);
          const pNum = parseFloat(greenPercentage);
          const analysis = pNum > 75 ? 'Alta chance de acerto' : pNum > 50 ? 'Moderada chance' : pNum > 25 ? 'Risco elevado' : 'Alta chance de falha';
          const parts = key.split(' ');
          return {
            marketGroup: key,
            marketPercentage: parseFloat(parts[parts.length - 1]),
            occurrences: g.occurrences, greens: g.greens, reds: g.reds,
            greenPercentage, totalGreens: g.totalGreens, totalReds: g.totalReds, analysis
          };
        }).sort((a, b) => b.greenPercentage - a.greenPercentage || b.greens - a.greens).slice(0, 100);

        currentRankingData = sortedGroups;
        document.getElementById('rowCount').textContent = sortedGroups.length + ' registros';

        function mkName(group) {
          const parts = group.marketGroup.split(' ');
          return parts.slice(0, parts.length - 1).join(' ');
        }
        function mkTooltip(g) {
          return `${g.marketGroup}\nOcorrencias: ${g.occurrences}\nGreens: ${g.greens}\nReds: ${g.reds}\nUltimos ${verifyLines} jogos:\nGreens: ${g.totalGreens}, Reds: ${g.totalReds}\nAnalise: ${g.analysis}`;
        }
        function mkBar(gPct) {
          const p = parseFloat(gPct);
          return `<div class="bar-wrap"><span>${p.toFixed(1)}%</span><div class="mini-bar"><div class="mini-bar-fill" style="width:${Math.min(p,100)}%;background:${getBarColor(p)};"></div></div></div>`;
        }

        if (tbodyRanking.rows.length === 0) {
          sortedGroups.forEach(group => {
            const row = tbodyRanking.insertRow();
            row.insertCell(0).innerHTML = `${mkName(group)} <span class="${getPctClass(group.marketPercentage)}">${group.marketPercentage}%</span>`;
            row.insertCell(1).textContent = group.occurrences;
            row.insertCell(2).textContent = group.greens;
            const c3 = row.insertCell(3);
            c3.className = 'tooltip ' + getPctClass(group.greenPercentage);
            c3.textContent = group.greenPercentage + '%';
            c3.setAttribute('data-tooltip', mkTooltip(group));
            row.insertCell(4).innerHTML = mkBar(group.greenPercentage);
          });
        } else {
          sortedGroups.forEach((group, idx) => {
            let row = tbodyRanking.rows[idx];
            if (!row) { row = tbodyRanking.insertRow(); for (let j=0;j<5;j++) row.insertCell(j); }
            row.cells[0].innerHTML = `${mkName(group)} <span class="${getPctClass(group.marketPercentage)}">${group.marketPercentage}%</span>`;
            row.cells[1].textContent = group.occurrences;
            row.cells[2].textContent = group.greens;
            row.cells[3].className = 'tooltip ' + getPctClass(group.greenPercentage);
            row.cells[3].textContent = group.greenPercentage + '%';
            row.cells[3].setAttribute('data-tooltip', mkTooltip(group));
            row.cells[4].innerHTML = mkBar(group.greenPercentage);
          });
          while (tbodyRanking.rows.length > sortedGroups.length) tbodyRanking.deleteRow(tbodyRanking.rows.length - 1);
        }
      }

      function sortTable(columnIndex) {
        const table = document.getElementById("rankingTable");
        const tbody = table.getElementsByTagName("tbody")[0];
        if (!currentRankingData.length) return;

        const isAsc = table.rows[0].cells[columnIndex].getAttribute("data-asc") !== "false";
        currentRankingData.sort((a, b) => {
          let vA, vB;
          if (columnIndex===0) { vA=a.marketPercentage; vB=b.marketPercentage; }
          else if (columnIndex===1) { vA=a.occurrences; vB=b.occurrences; }
          else if (columnIndex===2) { vA=a.greens; vB=b.greens; }
          else { vA=parseFloat(a.greenPercentage); vB=parseFloat(b.greenPercentage); }
          return isAsc ? vA-vB : vB-vA;
        });

        currentRankingData.forEach((group, idx) => {
          const row = tbody.rows[idx];
          const parts = group.marketGroup.split(' ');
          const mName = parts.slice(0, parts.length-1).join(' ');
          row.cells[0].innerHTML = `${mName} <span class="${getPctClass(group.marketPercentage)}">${group.marketPercentage}%</span>`;
          row.cells[1].textContent = group.occurrences;
          row.cells[2].textContent = group.greens;
          row.cells[3].className = 'tooltip ' + getPctClass(group.greenPercentage);
          row.cells[3].textContent = group.greenPercentage + '%';
          row.cells[3].setAttribute('data-tooltip',
            `${group.marketGroup}\nOcorrencias: ${group.occurrences}\nGreens: ${group.greens}\nReds: ${group.reds}\nUltimos ${document.getElementById("verifyLines").value} jogos:\nGreens: ${group.totalGreens}, Reds: ${group.totalReds}\nAnalise: ${group.analysis}`
          );
          const p = parseFloat(group.greenPercentage);
          row.cells[4].innerHTML = `<div class="bar-wrap"><span>${p.toFixed(1)}%</span><div class="mini-bar"><div class="mini-bar-fill" style="width:${Math.min(p,100)}%;background:${getBarColor(p)};"></div></div></div>`;
        });

        table.rows[0].cells[columnIndex].setAttribute("data-asc", !isAsc);
      }

      // Tooltip handler
      document.addEventListener('mouseover', function(e) {
        const target = e.target.closest && e.target.closest('.tooltip');
        if (!target || !target.getAttribute('data-tooltip')) return;
        const rect = target.getBoundingClientRect();
        const el = document.createElement('div');
        el.style.cssText = 'position:fixed;background:var(--tooltip-bg);color:var(--tooltip-text);padding:0.65rem 0.85rem;border-radius:5px;font-size:0.73rem;font-family:var(--font-mono);white-space:pre-wrap;z-index:9999;border:1px solid var(--border-color);max-width:210px;line-height:1.6;box-shadow:0 6px 20px rgba(0,0,0,0.4);pointer-events:none;';
        el.textContent = target.getAttribute('data-tooltip');
        document.body.appendChild(el);
        const tH = el.offsetHeight, tW = el.offsetWidth;
        const spaceAbove = rect.top, spaceBelow = window.innerHeight - rect.bottom;
        if (spaceAbove > tH + 12) { el.style.top=(rect.top-tH-8)+'px'; el.style.left=Math.max(8, rect.left+rect.width/2-tW/2)+'px'; }
        else if (spaceBelow > tH + 12) { el.style.top=(rect.bottom+8)+'px'; el.style.left=Math.max(8, rect.left+rect.width/2-tW/2)+'px'; }
        else { el.style.top=Math.max(8,rect.top-tH/2)+'px'; el.style.left=(rect.right+8)+'px'; }
        target.addEventListener('mouseout', function h() { el.remove(); target.removeEventListener('mouseout', h); });
      });

      function startAutoUpdate() {
        if (autoUpdateInterval) clearInterval(autoUpdateInterval);
        calculateOccurrencesAndRank(true);
        autoUpdateInterval = setInterval(() => calculateOccurrencesAndRank(true), 10000);
      }

      window.onload = startAutoUpdate;
      document.getElementById("selectedLeague").addEventListener('change', startAutoUpdate);
      document.getElementById("searchedMarket").addEventListener('change', startAutoUpdate);
      document.getElementById("timeRange").addEventListener('change', startAutoUpdate);
      document.getElementById("linesToSum").addEventListener('change', startAutoUpdate);
      document.getElementById("verifyLines").addEventListener('change', startAutoUpdate);
    </script>

    <script>
      fetch('header.html')
        .then(r => r.text())
        .then(data => { document.getElementById('header').innerHTML = data; });
    </script>
    <script src="redirecionar.js"></script>

    <script>
      document.addEventListener("contextmenu", function(e) { e.preventDefault(); });
      document.addEventListener("keydown", function(e) {
        if (e.key === "F12") e.preventDefault();
        if (e.ctrlKey && e.shiftKey && e.key === "I") e.preventDefault();
        if (e.ctrlKey && e.key === "u") e.preventDefault();
        if (e.ctrlKey && e.shiftKey && e.key === "J") e.preventDefault();
        if (e.ctrlKey && e.shiftKey && e.key === "C") e.preventDefault();
        if (e.ctrlKey && e.key === "s") e.preventDefault();
        if (e.ctrlKey && e.key === "p") e.preventDefault();
      });

      const devtools = { open: false };
      const element = new Image();
      Object.defineProperty(element, 'id', { get: function() { devtools.open = true; } });
      (function() {
        const threshold = 160;
        const check = function() {
          if ((window.outerWidth - window.innerWidth) > threshold || (window.outerHeight - window.innerHeight) > threshold) devtools.open = true;
        };
        window.addEventListener('resize', check);
        setInterval(check, 500);
      })();
      console.log('%c', element);
      setInterval(function() {
        if (devtools.open) { document.body.innerHTML = '<h1>Acesso nao autorizado detectado</h1>'; devtools.open = false; }
      }, 1000);
      document.addEventListener('selectstart', function(e) { e.preventDefault(); });
      document.addEventListener('dragstart', function(e) { e.preventDefault(); });
      console.log = function() {};
      console.debug = function() {};
      console.info = function() {};
    </script>
  </body>
</html>