<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BetStat</title>
  <style>
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="errorMessage" class="error-message" style="display: none;"></div>
  <div class="seletor-container">
    <div class="seletor-mostrar-times">
      <select id="mostrarTimes">
        <option value="nao" selected>Ver Times:N√£o</option>
        <option value="sim">Ver Times:Sim</option>
      </select>
    </div>

    <div class="seletor-mostrar-ht">
      <select id="mostrarHT">
        <option value="nao" selected>Ver HT:N√£o</option>
        <option value="sim">Ver HT:Sim</option>
      </select>
    </div>

    <div class="seletor-horas">
      <select id="seletorHoras">
        <option value="3">Horas:3</option>
        <option value="6">Horas:6</option>
        <option value="12" selected>Horas:12</option>
        <option value="24">Horas:24</option>
        <option value="48">Horas:48</option>
        <option value="72">Horas:72</option>
      </select>
    </div>

    <div class="seletor-resultado">
      <select id="seletorResultado">
        <option value="ambasMarcam" selected>Ambas Sim</option>
        <option value="ambasNaoMarcam">Ambas N√£o</option>
        <option value="casaVence">Casa vence</option>
        <option value="foraVence">Fora vence</option>
        <option value="empate">Empate</option>
        <option value="over1.5">Over 1.5</option>
        <option value="under1.5">Under 1.5</option>
        <option value="over2.5">Over 2.5</option>
        <option value="under2.5">Under 2.5</option>
        <option value="over3.5">Over 3.5</option>
        <option value="under3.5">Under 3.5</option>
        <option value="over5">Over 5+</option>
      </select>
    </div>

    <div class="seletor-ver-odds">
      <select id="mostrarOdds">
        <option value="nao" selected>Ver Odds:N√£o</option>
        <option value="sim">Ver Odds:Sim</option>
      </select>
    </div>

    <div class="seletor-tipo-placar">
      <select id="seletorTipoPlacar">
        <option value="ft" selected>Resultado:FT</option>
        <option value="ht">Resultado:HT</option>
      </select>
    </div>

    <div id="resultDisplay">
      <div id="totalGols">0</div>
      <div id="mediaGolsHora">0</div>
      <h4 class="custom-color">Ta√ßa Gl√≥ria Eterna</h4>
    </div>

    <div id="resultDisplay">
      <div id="greenPercentage">Greens: 32.5%</div>
      <div id="redPercentage">Reds: 67.5%</div>
    </div>
  </div>

  <table id="tabelaResultados">
    <thead>
      <div class="minutofixo-header">
        <div id="market-percentages"></div>
      </div>
      <tr id="linhaPercentual">
        <th>üìä</th>
      </tr>
      <tr id="linhaTotalGols">
        <th>‚öΩ</th>
      </tr>
      <tr id="linhaAcertosMercado">
        <th>‚úîÔ∏è</th>
      </tr>
      <tr>
        <th>H/M</th>
        <th class="minute-header">1</th>
        <th class="minute-header">4</th>
        <th class="minute-header">7</th>
        <th class="minute-header">10</th>
        <th class="minute-header">13</th>
        <th class="minute-header">16</th>
        <th class="minute-header">19</th>
        <th class="minute-header">22</th>
        <th class="minute-header">25</th>
        <th class="minute-header">28</th>
        <th class="minute-header">31</th>
        <th class="minute-header">34</th>
        <th class="minute-header">37</th>
        <th class="minute-header">40</th>
        <th class="minute-header">43</th>
        <th class="minute-header">46</th>
        <th class="minute-header">49</th>
        <th class="minute-header">52</th>
        <th class="minute-header">55</th>
        <th class="minute-header">58</th>
        <th>‚öΩÔ∏è</th>
        <th>‚úîÔ∏è</th>
        <th>üìä</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot></tfoot>
  </table>

  <div class="betstat-footer">
    <div class="betstat-footer-line">
      <span class="betstat-footer-text">BetStat¬Æ</span>
    </div>
  </div>

  <script>
    const minutosFixos = [
      1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34, 37, 40, 43, 46, 49, 52, 55, 58,
    ];

    let placarSelecionado = localStorage.getItem("placarSelecionado");
    let timeSelecionado = localStorage.getItem("timeSelecionado");
    let oddSelecionada = localStorage.getItem("oddSelecionada");

    function showErrorMessage(message) {
      const errorMessageDiv = document.getElementById("errorMessage");
      errorMessageDiv.textContent = message;
      errorMessageDiv.style.display = "block";
    }

    function hideErrorMessage() {
      const errorMessageDiv = document.getElementById("errorMessage");
      errorMessageDiv.textContent = "";
      errorMessageDiv.style.display = "none";
    }

    function selecionarPlacaresIguais(placarAlvo) {
      const placares = document.querySelectorAll(".placar");
      placares.forEach((placar) => {
        const texto = placar.querySelector(".placar-texto").textContent.trim();
        if (placarAlvo && texto.includes(placarAlvo)) {
          placar.classList.add("placar-selecionado");
        } else {
          placar.classList.remove("placar-selecionado");
        }
      });
    }

    function selecionarJogosPorTime(timeAlvo) {
      const placares = document.querySelectorAll(".placar");
      if (!timeAlvo || document.querySelector("#mostrarTimes").value !== "sim") {
        placares.forEach((placar) => {
          placar.classList.remove("time-selecionado");
        });
        return;
      }
      placares.forEach((placar) => {
        const timeA = placar.getAttribute("data-time-a");
        const timeB = placar.getAttribute("data-time-b");
        if (timeA === timeAlvo || timeB === timeAlvo) {
          placar.classList.add("time-selecionado");
        } else {
          placar.classList.remove("time-selecionado");
        }
      });
    }

    function selecionarOddsIguais(oddAlvo) {
      const oddsElements = document.querySelectorAll(".odds");
      oddsElements.forEach((oddElement) => {
        const oddTexto = oddElement.textContent.trim();
        if (oddAlvo && oddTexto === oddAlvo) {
          oddElement.classList.add("odd-selecionada");
        } else {
          oddElement.classList.remove("odd-selecionada");
        }
      });
    }

    function calculateGoalStats(todasLinhas) {
      const totalGols = todasLinhas.reduce(
        (acc, row) =>
          acc + parseInt(row.children[row.children.length - 3].textContent),
        0
      );
      const totalHorasJogadas = todasLinhas.length;
      const mediaGolsHora =
        totalHorasJogadas > 0
          ? (totalGols / totalHorasJogadas).toFixed(2)
          : 0;

      return {
        totalGols,
        mediaGolsHora,
      };
    }

    async function fetchOdds() {
      try {
        const response = await fetch("http://localhost:5001/odds/Ta%C3%A7a%20Gl%C3%B3ria%20Eterna");
        if (!response.ok) {
          throw new Error(`Erro ao buscar odds: ${response.status} ${response.statusText}`);
        }
        const oddsData = await response.json();
        console.log("Odds fetched:", oddsData);
        console.log("Odds teams:", oddsData.map(odd => `${odd.time_casa} vs ${odd.time_visitante}`));
        return oddsData;
      } catch (error) {
        console.error("Erro ao buscar odds:", error);
        return [];
      }
    }

    function normalizeString(str) {
      return str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function formatDateToDDMMYYYY(dateStr) {
      let date;
      if (dateStr.includes("T")) {
        date = new Date(dateStr); // ISO format: "2025-06-12T03:00:00.000Z"
      } else {
        const [day, month, year] = dateStr.split("/");
        date = new Date(`${year}-${month}-${day}`);
      }
      if (isNaN(date)) return null;
      const day = date.getDate().toString().padStart(2, "0");
      const month = (date.getMonth() + 1).toString().padStart(2, "0");
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function findOddsForMatch(match, oddsData) {
      const matchDate = formatDateToDDMMYYYY(match.data); // e.g., "12/06/2025"
      const matchTime = `${match.hora.toString().padStart(2, "0")}:${match.minuto.toString().padStart(2, "0")}`; // e.g., "07:43"
      const teamMapping = {
        "peixe": "boca",
        // Add other mappings as needed
      };
      const matchTimeA = normalizeString(teamMapping[match.time_a.toLowerCase()] || match.time_a);
      const matchTimeB = normalizeString(teamMapping[match.time_b.toLowerCase()] || match.time_b);

      console.log(`Searching odds for match: ${matchTimeA} vs ${matchTimeB} on ${matchDate} at ${matchTime}`);

      // Primary match: full criteria
      let matchedOdd = oddsData.find(odd => {
        const oddDate = odd.data_captura; // e.g., "13/08/2025"
        const oddTime = odd.horario; // e.g., "07:43"
        const oddTimeCasa = normalizeString(odd.time_casa);
        const oddTimeVisitante = normalizeString(odd.time_visitante);

        const isMatch =
          oddTimeCasa === matchTimeA &&
          oddTimeVisitante === matchTimeB &&
          oddDate === matchDate &&
          oddTime === matchTime;

        if (isMatch) {
          console.log(`Found odds by full match:`, odd);
        }
        return isMatch;
      });

      // Fallback: match by one team and time
      if (!matchedOdd) {
        matchedOdd = oddsData.find(odd => {
          const oddTime = odd.horario;
          const oddTimeCasa = normalizeString(odd.time_casa);
          const oddTimeVisitante = normalizeString(odd.time_visitante);
          const isTeamMatch =
            (oddTimeCasa === matchTimeA || oddTimeVisitante === matchTimeA || 
             oddTimeCasa === matchTimeB || oddTimeVisitante === matchTimeB) &&
            oddTime === matchTime;
          if (isTeamMatch) {
            console.log(`Found odds by team and time:`, odd);
          }
          return isTeamMatch;
        });
      }

      if (!matchedOdd) {
        console.log(`No odds found for ${matchTimeA} vs ${matchTimeB} on ${matchDate} at ${matchTime}`);
      }

      return matchedOdd;
    }

    function getOddValue(odds, resultado) {
      const oddMap = {
        ambasMarcam: "odds_ambas_marcam_sim",
        ambasNaoMarcam: "odds_ambas_marcam_nao",
        casaVence: "odds_casa_vence",
        foraVence: "odds_visitante_vence",
        empate: "odds_empate",
        "over1.5": "odds_mais_1_5",
        "under1.5": "odds_menos_1_5",
        "over2.5": "odds_mais_2_5",
        "under2.5": "odds_menos_2_5",
        "over3.5": "odds_mais_3_5",
        "under3.5": "odds_menos_3_5",
        over5: "odds_mais_5_gols",
      };
      const oddValue = odds ? odds[oddMap[resultado]] || "N/A" : "N/A";
      return oddValue;
    }

    function criarTabela(dados, oddsData) {
      const tabelaBody = document.querySelector("#tabelaResultados tbody");
      const linhaPercentual = document.getElementById("linhaPercentual");
      const linhaTotalGols = document.getElementById("linhaTotalGols");
      const linhaAcertosMercado = document.getElementById("linhaAcertosMercado");
      if (!tabelaBody || !linhaPercentual || !linhaTotalGols || !linhaAcertosMercado) {
        console.error("Elementos tabelaResultados, linhaPercentual, linhaTotalGols ou linhaAcertosMercado n√£o encontrados!");
        showErrorMessage("Erro interno: Estrutura da tabela n√£o encontrada.");
        return;
      }

      linhaPercentual.innerHTML = "<th>üìä</th>";
      linhaTotalGols.innerHTML = "<th>‚öΩ</th>";
      linhaAcertosMercado.innerHTML = "<th>‚úîÔ∏è</th>";
      tabelaBody.innerHTML = "";

      const seletorHoras = document.querySelector("#seletorHoras");
      const seletorResultado = document.querySelector("#seletorResultado");
      const seletorTipoPlacar = document.querySelector("#seletorTipoPlacar");
      const mostrarTimesSelect = document.querySelector("#mostrarTimes");
      const mostrarHTSelect = document.querySelector("#mostrarHT");
      const mostrarOddsSelect = document.querySelector("#mostrarOdds");
      const mostrarTimes = mostrarTimesSelect ? mostrarTimesSelect.value === "sim" : false;
      const mostrarOdds = mostrarOddsSelect ? mostrarOddsSelect.value === "sim" : false;
      const mostrarHT = mostrarHTSelect ? mostrarHTSelect.value === "sim" : false;

      if (
        !seletorHoras ||
        !seletorResultado ||
        !seletorTipoPlacar ||
        !mostrarTimesSelect ||
        !mostrarHTSelect ||
        !mostrarOddsSelect
      ) {
        console.error("Um ou mais seletores n√£o foram encontrados no HTML!");
        showErrorMessage("Erro interno: Seletores do formul√°rio n√£o encontrados.");
        return;
      }

      const horasSelecionadas = parseInt(seletorHoras.value) || 12;

      dados.sort((a, b) => {
        const dataHoraA = new Date(
          `${a.data}T${a.hora.toString().padStart(2, "0")}:${a.minuto.toString().padStart(2, "0")}:00`
        ).getTime();
        const dataHoraB = new Date(
          `${b.data}T${b.hora.toString().padStart(2, "0")}:${b.minuto.toString().padStart(2, "0")}:00`
        ).getTime();
        return dataHoraA - dataHoraB;
      });

      console.log("Resultados teams:", dados.map(d => `${d.time_a} vs ${d.time_b}`));

      const chavesJaProcessadas = new Set();
      const mapeamentoChaveLinha = {};
      let contagemLinhas = 0;

      dados.reverse().forEach((dado) => {
        if (contagemLinhas >= horasSelecionadas) return;

        const dataHora = new Date(dado.data);
        const hora = dado.hora;
        const chave = `${dataHora.toISOString().split("T")[0]}-${hora}`;

        if (!chavesJaProcessadas.has(chave)) {
          const novaLinha = document.createElement("tr");
          novaLinha.setAttribute("data-chave", chave);

          const colunaHora = document.createElement("td");
          colunaHora.textContent = hora.toString().padStart(2, "0");
          novaLinha.appendChild(colunaHora);

          minutosFixos.forEach(() => {
            novaLinha.appendChild(document.createElement("td"));
          });

          const contagemMercadosCelula = document.createElement("td");
          contagemMercadosCelula.textContent = 0;
          novaLinha.appendChild(contagemMercadosCelula);

          const totalGolsCelula = document.createElement("td");
          totalGolsCelula.textContent = 0;
          novaLinha.appendChild(totalGolsCelula);

          const porcentagemCelula = document.createElement("td");
          porcentagemCelula.textContent = "0%";
          novaLinha.appendChild(porcentagemCelula);

          tabelaBody.appendChild(novaLinha);
          chavesJaProcessadas.add(chave);
          mapeamentoChaveLinha[chave] = novaLinha;
          contagemLinhas++;
        }
      });

      function handlePlacarClick(event) {
        // Only handle clicks on placar-texto when mostrarTimes is "nao"
        if (mostrarTimes) return;
        if (!event.target.closest(".placar-texto")) return;
        const placarClicado = event.currentTarget.querySelector(".placar-texto").textContent.trim();
        if (placarSelecionado === placarClicado) {
          placarSelecionado = null;
          localStorage.removeItem("placarSelecionado");
          selecionarPlacaresIguais(null);
        } else {
          placarSelecionado = placarClicado;
          localStorage.setItem("placarSelecionado", placarClicado);
          selecionarPlacaresIguais(placarClicado);
        }
      }

      function handleTimeClick(event) {
        if (!mostrarTimes) return;
        const timeElement = event.target;
        const timeClicado = timeElement.getAttribute("data-full-time");
        if (!timeClicado) return;
        if (timeSelecionado === timeClicado) {
          timeSelecionado = null;
          localStorage.removeItem("timeSelecionado");
          selecionarJogosPorTime(null);
        } else {
          timeSelecionado = timeClicado;
          localStorage.setItem("timeSelecionado", timeClicado);
          selecionarJogosPorTime(timeClicado);
        }
      }

      function handleOddClick(event) {
        event.stopPropagation(); // Prevent click from bubbling to placar
        const oddClicada = event.currentTarget.textContent.trim();
        if (oddSelecionada === oddClicada) {
          oddSelecionada = null;
          localStorage.removeItem("oddSelecionada");
          selecionarOddsIguais(null);
        } else {
          oddSelecionada = oddClicada;
          localStorage.setItem("oddSelecionada", oddClicada);
          selecionarOddsIguais(oddClicada);
        }
      }

      const totalGolsPorColuna = Array(minutosFixos.length).fill(0);
      const totalAcertosPorColuna = Array(minutosFixos.length).fill(0);

      dados.forEach((dado) => {
        const dataHora = new Date(dado.data);
        const hora = dado.hora;
        const chave = `${dataHora.toISOString().split("T")[0]}-${hora}`;
        const linha = mapeamentoChaveLinha[chave];

        if (linha) {
          const indexMinuto = minutosFixos.indexOf(dado.minuto);
          if (indexMinuto !== -1) {
            const colunaMinuto = linha.children[1 + indexMinuto];

            if (!colunaMinuto.querySelector(".placar")) {
              const placar = document.createElement("div");
              placar.className = "placar";
              placar.setAttribute("data-time-a", dado.time_a);
              placar.setAttribute("data-time-b", dado.time_b);

              const tipoPlacar = seletorTipoPlacar.value;
              const placarFT = dado.ft;
              const placarHT = dado.ht;

              const placarTexto = document.createElement("div");
              placarTexto.className = "placar-texto";

              let primaryScore = tipoPlacar === "ft" ? placarFT : placarHT;
              let secondaryScore = tipoPlacar === "ft" ? placarHT : placarFT;

              if (mostrarTimes) {
                const timeA = dado.time_a.length > 10 ? dado.time_a.slice(0, 10) + "..." : dado.time_a;
                const timeB = dado.time_b.length > 10 ? dado.time_b.slice(0, 10) + "..." : dado.time_b;
                let textoPlacar = `<span class="time-casa" style="cursor: pointer;" data-full-time="${dado.time_a}">${timeA}</span>`;
                textoPlacar += `<span>${primaryScore}</span>`;
                if (mostrarHT) {
                  textoPlacar += `<span>(${secondaryScore})</span>`;
                }
                textoPlacar += `<span class="time-fora" style="cursor: pointer;" data-full-time="${dado.time_b}">${timeB}</span>`;
                placarTexto.innerHTML = textoPlacar;
              } else {
                let textoPlacar = `<span>${primaryScore}</span>`;
                if (mostrarHT) {
                  textoPlacar += `<span>(${secondaryScore})</span>`;
                }
                placarTexto.innerHTML = textoPlacar;
              }
              placar.appendChild(placarTexto);

              if (mostrarOdds) {
                const odds = findOddsForMatch(dado, oddsData);
                const oddValue = getOddValue(odds, seletorResultado.value);
                const oddsElement = document.createElement("div");
                oddsElement.className = "odds";
                oddsElement.textContent = `@${oddValue}`;
                oddsElement.addEventListener("click", handleOddClick);
                placar.appendChild(oddsElement);
              }

              placar.addEventListener("click", handlePlacarClick);
              if (mostrarTimes) {
                const timeCasa = placar.querySelector(".time-casa");
                const timeFora = placar.querySelector(".time-fora");
                if (timeCasa) timeCasa.addEventListener("click", handleTimeClick);
                if (timeFora) timeFora.addEventListener("click", handleTimeClick);
              }

              const tooltip = document.createElement("span");
              tooltip.className = "tooltip";
              tooltip.innerHTML = `
                <span class="times">${dado.time_a} vs ${dado.time_b}</span>
                <span class="placares">${placarFT} <span class="placarHT">(${placarHT})</span></span>
              `;
              placar.appendChild(tooltip);

              colunaMinuto.appendChild(placar);

              if (placarSelecionado && !mostrarTimes && placarTexto.textContent.includes(placarSelecionado)) {
                placar.classList.add("placar-selecionado");
              }
              if (timeSelecionado && mostrarTimes && (dado.time_a === timeSelecionado || dado.time_b === timeSelecionado)) {
                placar.classList.add("time-selecionado");
              }
              if (oddSelecionada && mostrarOdds) {
                const oddElement = placar.querySelector(".odds");
                if (oddElement && oddElement.textContent === oddSelecionada) {
                  oddElement.classList.add("odd-selecionada");
                }
              }

              const selecaoResultado = seletorResultado.value;
              let acerto = false;
              const placarAtual = tipoPlacar === "ft" ? placarFT : placarHT;
              const [resultadoA, resultadoB] = placarAtual.split(" x ").map(num => parseInt(num) || 0);

              if (selecaoResultado === "ambasMarcam") {
                acerto = resultadoA > 0 && resultadoB > 0;
              } else if (selecaoResultado === "ambasNaoMarcam") {
                acerto = resultadoA === 0 || resultadoB === 0;
              } else if (selecaoResultado === "over1.5") {
                acerto = resultadoA + resultadoB > 1.5;
              } else if (selecaoResultado === "under1.5") {
                acerto = resultadoA + resultadoB <= 1.5;
              } else if (selecaoResultado === "over2.5") {
                acerto = resultadoA + resultadoB > 2.5;
              } else if (selecaoResultado === "under2.5") {
                acerto = resultadoA + resultadoB <= 2.5;
              } else if (selecaoResultado === "over3.5") {
                acerto = resultadoA + resultadoB > 3.5;
              } else if (selecaoResultado === "under3.5") {
                acerto = resultadoA + resultadoB <= 3.5;
              } else if (selecaoResultado === "over5") {
                acerto = resultadoA + resultadoB >= 5;
              } else if (selecaoResultado === "casaVence") {
                acerto = resultadoA > resultadoB;
              } else if (selecaoResultado === "foraVence") {
                acerto = resultadoB > resultadoA;
              } else if (selecaoResultado === "empate") {
                acerto = resultadoA === resultadoB;
              }

              colunaMinuto.style.backgroundColor = acerto ? "#018b06" : "#be0e02";

              if (acerto) {
                linha.children[linha.children.length - 2].textContent =
                  parseInt(linha.children[linha.children.length - 2].textContent) + 1;
                totalAcertosPorColuna[indexMinuto]++;
              }

              const totalGolsCelula = linha.children[linha.children.length - 3];
              const totalGols = resultadoA + resultadoB;
              totalGolsCelula.textContent = parseInt(totalGolsCelula.textContent) + totalGols;

              totalGolsPorColuna[indexMinuto] += totalGols;
            }
          }
        }
      });

      // Populate total goals row
      totalGolsPorColuna.forEach((total, index) => {
        const cell = document.createElement("td");
        cell.className = "total-goals";
        cell.textContent = total;
        linhaTotalGols.appendChild(cell);
      });

      // Populate market hits row
      totalAcertosPorColuna.forEach((total, index) => {
        const cell = document.createElement("td");
        cell.className = "market-hits";
        cell.textContent = total;
        linhaAcertosMercado.appendChild(cell);
      });

      // Fill remaining cells in total goals and market hits rows
      for (let i = 0; i < 3; i++) {
        const emptyCellGols = document.createElement("td");
        emptyCellGols.textContent = "";
        linhaTotalGols.appendChild(emptyCellGols);

        const emptyCellMercados = document.createElement("td");
        emptyCellMercados.textContent = "";
        linhaAcertosMercado.appendChild(emptyCellMercados);
      }

      const todasLinhas = Array.from(tabelaBody.querySelectorAll("tr"));
      todasLinhas.forEach((row) => {
        const totalCelsProcessadas = Array.from(row.cells)
          .slice(1, -3)
          .filter((cell) => cell.querySelector(".placar")).length;
        const celsMercado = parseInt(
          row.children[row.children.length - 2].textContent
        );

        const porcentagem =
          totalCelsProcessadas > 0
            ? Math.floor((celsMercado / totalCelsProcessadas) * 100)
            : 0;
        const porcentagemCell = row.children[row.children.length - 1];
        porcentagemCell.textContent = `${porcentagem}%`;

        if (porcentagem >= 50) {
          porcentagemCell.classList.add("porcentagem-verde");
          porcentagemCell.classList.remove("porcentagem-branca");
        } else {
          porcentagemCell.classList.add("porcentagem-branca");
          porcentagemCell.classList.remove("porcentagem-verde");
        }
      });

      const totalColunas = minutosFixos.length;
      const totalMercadosPorColuna = Array(totalColunas).fill(0);

      todasLinhas.forEach((row) => {
        Array.from(row.cells)
          .slice(1, -3)
          .forEach((cell, index) => {
            if (cell.querySelector(".placar")) {
              totalMercadosPorColuna[index]++;
            }
          });
      });

      linhaPercentual.innerHTML = "<th>üìà</th>";

      totalMercadosPorColuna.forEach((totalMercados, index) => {
        const cell = document.createElement("td");
        const porcentagemVertical =
          totalMercados > 0
            ? Math.floor((totalAcertosPorColuna[index] / totalMercados) * 100)
            : 0;
        cell.textContent = `${porcentagemVertical}%`;

        if (porcentagemVertical > 49) {
          cell.classList.add("porcentagem-verde");
          cell.classList.remove("porcentagem-branca");
        } else {
          cell.classList.add("porcentagem-branca");
          cell.classList.remove("porcentagem-verde");
        }

        linhaPercentual.appendChild(cell);
      });

      for (let i = 0; i < 3; i++) {
        const emptyCell = document.createElement("td");
        emptyCell.textContent = "";
        linhaPercentual.appendChild(emptyCell);
      }

      // Apply background color to minute header cells
      const minuteHeaders = document.querySelectorAll("#tabelaResultados thead tr:last-child th.minute-header");
      minuteHeaders.forEach(header => {
        header.style.backgroundColor = "#2c303b";
      });

      const stats = calculateGoalStats(todasLinhas);
      document.getElementById("totalGols").textContent = `Gols: ${stats.totalGols}`;
      document.getElementById("mediaGolsHora").textContent = `M√©dias: ${stats.mediaGolsHora}`;

      if (placarSelecionado && !mostrarTimes) {
        selecionarPlacaresIguais(placarSelecionado);
      }
      if (timeSelecionado && mostrarTimes) {
        selecionarJogosPorTime(timeSelecionado);
      }
      if (oddSelecionada && mostrarOdds) {
        selecionarOddsIguais(oddSelecionada);
      }
    }

    async function buscarDados() {
      hideErrorMessage();
      let dados = [];
      let oddsData = [];
      try {
        const resultadosResponse = await fetch("http://localhost:5001/resultados/Ta%C3%A7a%20Gl%C3%B3ria%20eterna");
        if (!resultadosResponse.ok) {
          throw new Error(`Erro ao buscar resultados: ${resultadosResponse.status} ${resultadosResponse.statusText}`);
        }
        dados = await resultadosResponse.json();
        console.log("Resultados fetched:", dados);
      } catch (error) {
        console.error("Erro ao buscar resultados:", error);
        showErrorMessage(`Erro ao carregar resultados: ${error.message}`);
      }

      try {
        oddsData = await fetchOdds();
      } catch (error) {
        console.error("Erro ao buscar odds (continuando sem odds):", error);
        showErrorMessage(`Erro ao carregar odds: ${error.message}. Exibindo tabela sem odds.`);
      }

      if (dados.length > 0) {
        criarTabela(dados, oddsData);
      } else {
        showErrorMessage("Nenhum dado de resultados dispon√≠vel. Verifique a conex√£o com o servidor.");
      }
    }

    buscarDados();
    setInterval(buscarDados, 10000);

    const seletorHoras = document.querySelector("#seletorHoras");
    const seletorResultado = document.querySelector("#seletorResultado");
    const seletorTipoPlacar = document.querySelector("#seletorTipoPlacar");
    const mostrarTimesSelect = document.querySelector("#mostrarTimes");
    const mostrarHTSelect = document.querySelector("#mostrarHT");
    const mostrarOddsSelect = document.querySelector("#mostrarOdds");

    if (seletorHoras) seletorHoras.addEventListener("change", buscarDados);
    if (seletorResultado) seletorResultado.addEventListener("change", buscarDados);
    if (seletorTipoPlacar) seletorTipoPlacar.addEventListener("change", buscarDados);
    if (mostrarTimesSelect) {
      mostrarTimesSelect.addEventListener("change", () => {
        if (mostrarTimesSelect.value !== "sim") {
          placarSelecionado = null;
          timeSelecionado = null;
          localStorage.removeItem("placarSelecionado");
          localStorage.removeItem("timeSelecionado");
          selecionarPlacaresIguais(null);
          selecionarJogosPorTime(null);
        }
        buscarDados();
      });
    }
    if (mostrarHTSelect) mostrarHTSelect.addEventListener("change", buscarDados);
    if (mostrarOddsSelect) {
      mostrarOddsSelect.addEventListener("change", () => {
        if (mostrarOddsSelect.value !== "sim") {
          oddSelecionada = null;
          localStorage.removeItem("oddSelecionada");
          selecionarOddsIguais(null);
        }
        buscarDados();
      });
    }
  </script>
</body>
</html>