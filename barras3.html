<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
  <title>Analisador de Mercados - BetStat</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      color: #3dcf9b;
      margin-bottom: 20px;
    }

    .container {
      max-width: 1600px;
      margin: auto;
    }

    .controls {
      background-color: #1d1d1d;
      padding: 15px;
      border: 1px solid #333;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .controls-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    label {
      font-size: 13px;
      color: #3dcf9b;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }

    select, button {
      background-color: #2a2a2a;
      color: #fff;
      border: 1px solid #3dcf9b;
      border-radius: 5px;
      padding: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    button {
      background-color: #3dcf9b;
      color: #000;
      font-weight: bold;
    }

    button:hover {
      background-color: #2fa97e;
    }

    .indicators {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .indicator-btn {
      background-color: #2a2a2a;
      border: 1px solid #3dcf9b;
      color: #fff;
      padding: 8px 14px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }

    .indicator-btn.active {
      background-color: #3dcf9b;
      color: #000;
    }

    .chart-section {
      background-color: #1d1d1d;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .chart-container {
      position: relative;
      height: 500px;
      width: 100%;
    }

    .prediction {
      margin-top: 15px;
      text-align: center;
      font-size: 16px;
      padding: 10px;
      background-color: #2a2a2a;
      border: 1px solid #3dcf9b;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Analisador de Mercados - BetStat</h1>

    <div class="controls">
      <div class="controls-row">
        <div>
          <label for="liga">Liga</label>
          <select id="liga" onchange="atualizarTudo()">
            <option value="Euro" selected>Euro</option>
            <option value="Copa%20América">Copa América</option>
          </select>
        </div>
        <div>
          <label for="mercado">Mercado</label>
          <select id="mercado" onchange="atualizarTudo()">
            <option value="over2.5" selected>Over 2.5</option>
            <option value="under2.5">Under 2.5</option>
          </select>
        </div>
        <div>
          <label for="periodo">Período (Horas)</label>
          <select id="periodo" onchange="atualizarTudo()">
            <option value="240">12h</option>
            <option value="480" selected>24h</option>
            <option value="960">48h</option>
          </select>
        </div>
      </div>

      <div class="indicators">
        <button class="indicator-btn active" onclick="toggleIndicator('mercado')" id="btn-mercado">Mercado Principal</button>
        <button class="indicator-btn active" onclick="toggleIndicator('sma')" id="btn-sma">Média Móvel (3)</button>
        <button class="indicator-btn" onclick="toggleIndicator('rsi')" id="btn-rsi">RSI</button>
        <button class="indicator-btn" onclick="toggleIndicator('trend')" id="btn-trend">Tendência</button>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-container">
        <canvas id="macroChart"></canvas>
      </div>
      <div id="prediction" class="prediction"></div>
    </div>
  </div>

  <script>
    let macroChart = null;
    let activeIndicators = { mercado: true, sma: true, rsi: false, trend: false };

    function calcularSMA(data, period) {
      const sma = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) sma.push(null);
        else {
          const slice = data.slice(i - period + 1, i + 1);
          sma.push(slice.reduce((a, b) => a + b, 0) / slice.length);
        }
      }
      return sma;
    }

    function calcularRSI(data, period = 14) {
      const rsi = [null];
      let gains = 0, losses = 0;
      for (let i = 1; i < data.length; i++) {
        const diff = data[i] - data[i - 1];
        if (diff > 0) gains += diff; else losses -= diff;
        if (i >= period) {
          const avgGain = gains / period;
          const avgLoss = losses / period;
          const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
          rsi.push(100 - (100 / (1 + rs)));
          const diffOld = data[i - period + 1] - data[i - period];
          if (diffOld > 0) gains -= diffOld; else losses += diffOld;
        } else {
          rsi.push(null);
        }
      }
      return rsi;
    }

    function calcularTendencia(data) {
      const n = data.length;
      const x = [...Array(n).keys()];
      const meanX = x.reduce((a,b)=>a+b)/n;
      const meanY = data.reduce((a,b)=>a+b)/n;
      const num = x.reduce((acc,i)=>acc+(x[i]-meanX)*(data[i]-meanY),0);
      const den = x.reduce((acc,i)=>acc+Math.pow(x[i]-meanX,2),0);
      const b = num/den;
      const a = meanY - b*meanX;
      return x.map(i => a + b*i);
    }

    async function carregarDados() {
      const liga = document.getElementById("liga").value;
      const periodo = parseInt(document.getElementById("periodo").value);
      const mercado = document.getElementById("mercado").value;

      const resp = await fetch(`https://betstat.site/resultados/${liga}`);
      const dados = await resp.json();
      const dadosLimitados = dados.slice(-periodo);

      const percentuais = dadosLimitados.map(j => {
        const ft = j.ft.split(" x ").map(Number);
        const total = ft[0] + ft[1];
        return mercado === "over2.5" ? (total > 2.5 ? 100 : 0) : (total < 2.5 ? 100 : 0);
      });

      const labels = dadosLimitados.map((j, i) => i + 1);
      const media = percentuais.reduce((a, b) => a + b, 0) / percentuais.length;

      criarGrafico(labels, percentuais, media);
    }

    function criarGrafico(labels, data, media) {
      const ctx = document.getElementById("macroChart");
      if (macroChart) macroChart.destroy();

      const datasets = [];
      if (activeIndicators.mercado) {
        datasets.push({
          label: "Percentual",
          data: data,
          borderColor: "#3dcf9b",
          borderWidth: 2,
          fill: false,
          tension: 0.2,
          yAxisID: "y1"
        });
      }

      if (activeIndicators.sma) {
        datasets.push({
          label: "Média Móvel (3)",
          data: calcularSMA(data, 3),
          borderColor: "#f2c94c",
          borderDash: [5, 5],
          fill: false,
          tension: 0.1,
          yAxisID: "y1"
        });
      }

      if (activeIndicators.rsi) {
        datasets.push({
          label: "RSI",
          data: calcularRSI(data, 14),
          borderColor: "#56ccf2",
          fill: false,
          tension: 0.1,
          yAxisID: "y2"
        });
      }

      if (activeIndicators.trend) {
        datasets.push({
          label: "Tendência Linear",
          data: calcularTendencia(data),
          borderColor: "#bb6bd9",
          borderDash: [4, 4],
          fill: false,
          tension: 0.1,
          yAxisID: "y1"
        });
      }

      datasets.push({
        label: "Média Geral",
        data: new Array(data.length).fill(media),
        borderColor: "#f2994a",
        borderDash: [6, 4],
        fill: false,
        yAxisID: "y1"
      });

      macroChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              labels: { color: "#fff" }
            },
            tooltip: {
              backgroundColor: "#000",
              titleColor: "#3dcf9b",
              bodyColor: "#fff"
            }
          },
          scales: {
            y1: {
              type: "linear",
              position: "left",
              ticks: { color: "#3dcf9b" },
              min: 0,
              max: 100
            },
            y2: {
              type: "linear",
              position: "right",
              ticks: { color: "#56ccf2" },
              min: 0,
              max: 100,
              grid: { drawOnChartArea: false }
            },
            x: {
              ticks: { color: "#ccc" }
            }
          }
        }
      });

      const last = data.slice(-3);
      const lastAvg = last.reduce((a,b)=>a+b,0)/last.length;
      const msg = lastAvg > media ? "Tendência de alta detectada" : "Tendência de baixa detectada";
      document.getElementById("prediction").innerText = msg;
    }

    function toggleIndicator(ind) {
      activeIndicators[ind] = !activeIndicators[ind];
      document.getElementById(`btn-${ind}`).classList.toggle("active");
      carregarDados();
    }

    function atualizarTudo() {
      carregarDados();
    }

    window.onload = carregarDados;
  </script>
</body>
</html>
