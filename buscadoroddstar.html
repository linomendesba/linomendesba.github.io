<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4WT805FFHQ"></script>
    <title>BetStat</title>
    <meta name="description" content="Transforme suas apostas com BetStat - a única plataforma especializada em futebol virtual Betano. Análises precisas, estatísticas confiáveis e resultados comprovados para investimentos inteligentes." />
    <meta name="keywords" content="BetStat, apostas esportivas, futebol virtual, Betano, estatísticas apostas, análise apostas, investimentos esportivos" />
    <meta property="og:title" content="BetStat | Plataforma de Análise para Apostas Esportivas" />
    <meta property="og:description" content="Transforme suas apostas com análises precisas e estatísticas confiáveis. A única plataforma especializada em futebol virtual Betano." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.betstat.site/payment.html" />
    <meta property="og:site_name" content="BetStat" />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="BetStat" />
    <meta name="canonical" href="https://www.betstat.site/payment.html" />
    <script type="module" src="js/firebase-auth.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "G-4WT805FFHQ");
    </script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />

    <style>
      :root {
        --bg-primary: #111318;
        --bg-secondary: #181c23;
        --bg-card: #1e232d;
        --bg-card-hover: #242a36;
        --bg-top: #0d2018;
        --border: #2a3040;
        --border-accent: #1a5c3e;
        --accent: #1fad8b;
        --accent-dim: #147a62;
        --text-primary: #e4e8f0;
        --text-secondary: #7a8499;
        --text-accent: #1fad8b;
        --green: #2ecc71;
        --red: #e74c3c;
        --red-bg: #1a0d0d;
        --green-bg: #0a1f16;
        --odd-color: #e6a817;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: "DM Sans", sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
      }

      #header { position: sticky; top: 0; z-index: 100; }

      .page-wrapper {
        max-width: 1600px;
        margin: 0 auto;
        padding: 28px 24px 60px;
      }

      .section-title {
        font-size: 0.7rem;
        font-family: "DM Mono", monospace;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--text-accent);
        margin-bottom: 12px;
      }

      /* ── PRÓXIMOS JOGOS ── */
      .upcoming-section {
        margin-bottom: 24px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 20px 24px;
      }

      .games-table {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      .game-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px 14px;
        min-width: 200px;
        flex: 1;
        max-width: 280px;
      }

      .game-card.top-match {
        background: var(--bg-top);
        border-color: var(--border-accent);
      }

      .game-card .gc-time {
        font-family: "DM Mono", monospace;
        font-size: 1rem;
        color: var(--accent);
        margin-bottom: 6px;
        font-weight: 500;
      }

      .game-card .gc-teams {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .game-card .gc-team { color: var(--text-primary); font-weight: 500; }
      .game-card .gc-team.top-team { color: var(--accent); }
      .game-card .gc-vs { color: var(--text-secondary); font-size: 0.7rem; }

      /* Odd unica do mercado selecionado */
      .gc-market-odd {
        text-align: center;
        background: rgba(31,173,139,0.08);
        border: 1px solid var(--border-accent);
        border-radius: 6px;
        padding: 6px 10px;
      }

      .gc-market-odd .gmo-label {
        font-size: 0.55rem;
        font-family: "DM Mono", monospace;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 2px;
      }

      .gc-market-odd .gmo-value {
        font-size: 1.05rem;
        font-family: "DM Mono", monospace;
        font-weight: 600;
        color: var(--accent);
      }

      .gc-market-odd.is-top .gmo-value {
        color: var(--odd-color);
      }

      /* ── FILTERS ── */
      .filter-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 20px 24px;
        margin-bottom: 24px;
      }

      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
      }

      .filter-group label {
        display: block;
        font-size: 0.68rem;
        font-family: "DM Mono", monospace;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-accent);
        margin-bottom: 6px;
      }

      .filter-group select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        background: var(--bg-card);
        color: var(--text-primary);
        font-family: "DM Sans", sans-serif;
        font-size: 0.85rem;
        border: 1px solid var(--border);
        cursor: pointer;
        outline: none;
        transition: border-color 0.2s;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%237a8499' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 28px;
      }

      .filter-group select:focus { border-color: var(--accent); }
      .filter-group select option { background: #1e232d; }

      /* ── STATS BAR ── */
      .stats-bar {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 24px;
      }

      .stat-pill {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px 20px;
        flex: 1;
        min-width: 130px;
        text-align: center;
      }

      .stat-pill .pill-label {
        font-size: 0.65rem;
        font-family: "DM Mono", monospace;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }

      .stat-pill .pill-value {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-primary);
        font-family: "DM Mono", monospace;
      }

      .stat-pill .pill-value.accent { color: var(--accent); }
      .stat-pill .pill-value.green { color: var(--green); }
      .stat-pill .pill-value.odd-color { color: var(--odd-color); }

      /* ── ODD CARDS ── */
      .cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }

      .team-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 18px 16px;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
        position: relative;
      }

      .team-card:hover {
        border-color: var(--accent-dim);
        background: var(--bg-card-hover);
      }

      .team-card.top-rank {
        background: var(--bg-top);
        border-color: var(--border-accent);
      }

      .team-card.selected {
        border-color: var(--accent);
        background: var(--bg-card-hover);
      }

      .rank-badge {
        position: absolute;
        top: -1px;
        left: -1px;
        background: var(--accent);
        color: #000;
        font-size: 0.65rem;
        font-family: "DM Mono", monospace;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 9px 0 6px 0;
        letter-spacing: 0.04em;
      }

      .odd-display {
        text-align: center;
        margin-bottom: 14px;
        padding-top: 6px;
      }

      .odd-display .odd-at {
        font-size: 0.65rem;
        font-family: "DM Mono", monospace;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 2px;
      }

      .odd-display .odd-value {
        font-size: 1.8rem;
        font-weight: 600;
        font-family: "DM Mono", monospace;
        color: var(--odd-color);
      }

      .card-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }

      .card-stat {
        text-align: center;
        background: var(--bg-primary);
        border-radius: 6px;
        padding: 6px 4px;
      }

      .card-stat .cs-label {
        font-size: 0.6rem;
        font-family: "DM Mono", monospace;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 3px;
      }

      .card-stat .cs-value {
        font-size: 1rem;
        font-weight: 600;
        font-family: "DM Mono", monospace;
        color: var(--text-primary);
      }

      .pct-bar-wrap { margin-top: 2px; }

      .pct-label {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 5px;
      }

      .pct-label span:first-child {
        font-size: 0.62rem;
        font-family: "DM Mono", monospace;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-secondary);
      }

      .pct-label span:last-child {
        font-size: 1.4rem;
        font-weight: 600;
        font-family: "DM Mono", monospace;
      }

      .pct-bar {
        height: 4px;
        background: var(--bg-primary);
        border-radius: 2px;
        overflow: hidden;
      }

      .pct-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.4s ease;
      }

      /* ── MATCH DETAILS ── */
      #match-details {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 24px;
        margin-top: 8px;
      }

      #match-details h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      #match-details ul {
        list-style: none;
        display: grid;
        gap: 8px;
      }

      #match-details li {
        padding: 10px 14px;
        border-radius: 7px;
        font-size: 0.82rem;
        background: var(--bg-card);
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        border: 1px solid var(--border);
      }

      #match-details li.highlight-green {
        background: var(--green-bg);
        border-color: var(--border-accent);
      }

      #match-details li.highlight-red {
        background: var(--red-bg);
        border-color: #4a1a1a;
      }

      .detail-date {
        font-family: "DM Mono", monospace;
        font-size: 0.75rem;
        color: var(--accent);
        min-width: 40px;
      }

      .detail-teams {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      .detail-team { color: var(--text-primary); font-weight: 500; }

      .detail-score {
        font-family: "DM Mono", monospace;
        font-weight: 600;
        color: var(--text-primary);
        background: var(--bg-primary);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
      }

      .detail-odd {
        font-family: "DM Mono", monospace;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--odd-color);
        background: rgba(230,168,23,0.1);
        border: 1px solid rgba(230,168,23,0.2);
        padding: 2px 8px;
        border-radius: 4px;
      }

      .status-badge {
        font-size: 0.68rem;
        font-family: "DM Mono", monospace;
        font-weight: 500;
        padding: 3px 10px;
        border-radius: 4px;
        letter-spacing: 0.06em;
      }

      .status-badge.green { background: rgba(46,204,113,0.15); color: var(--green); border: 1px solid rgba(46,204,113,0.25); }
      .status-badge.red { background: rgba(231,76,60,0.15); color: var(--red); border: 1px solid rgba(231,76,60,0.25); }

      /* ── SCROLLBAR ── */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: var(--bg-primary); }
      ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

      /* ── RESPONSIVE ── */
      @media (max-width: 768px) {
        .page-wrapper { padding: 16px 14px 40px; }
        .filter-grid { grid-template-columns: 1fr 1fr; }
        .games-table { flex-direction: column; }
        .game-card { max-width: 100%; }
        .cards-container { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
      }

      /* Legacy compat */
      .logo2 { width: 60px; height: auto; }
      .logout-btn {
        background-color: var(--bg-secondary);
        color: white; padding: 8px 10px;
        font-size: 14px; border-radius: 5px;
        cursor: pointer; border: 1px solid var(--border);
      }
      .logout-btn:hover { background-color: #720000; }
      button {
        background-color: var(--bg-secondary); color: #fff;
        font-family: "DM Sans", sans-serif; border: none;
        padding: 5px 8px; border-radius: 5px;
        cursor: pointer; font-size: 16px;
        transition: background-color 0.3s; margin: 10px;
      }
      button:hover { background-color: #0f1013; }
    </style>
  </head>

  <body>
    <div id="header"></div>
    <br><br>

    <div class="page-wrapper">

      <!-- Próximos Jogos com Odds -->
      <div class="upcoming-section">
        <div class="section-title">Proximos Jogos — Odds ao Vivo</div>
        <div class="games-table" id="lista-proximos-jogos"></div>
      </div>

      <!-- Filtros -->
      <div class="filter-section">
        <div class="section-title">Parametros de Analise — Por Odd</div>
        <div class="filter-grid">
          <div class="filter-group">
            <label for="league-select">Liga</label>
            <select id="league-select">
 <option value="Copa do Mundo|https://betstat.site/resultados/estrela/Copa%20do%20Mundo|https://betstat.site/odds/estrela/Copa%20do%20Mundo|https://betstat.site/proximos/estrela/Copa%20do%20Mundo" selected>Copa do Mundo</option>
<option value="Ligas dos Campeões|https://betstat.site/resultados/estrela/Ligas%20dos%20Campe%C3%B5es|https://betstat.site/odds/estrela/Ligas%20dos%20Campe%C3%B5es|https://betstat.site/proximos/estrela/Ligas%20dos%20Campe%C3%B5es">Ligas dos Campeões</option>
<option value="América Latina|https://betstat.site/resultados/estrela/Am%C3%A9rica%20Latina|https://betstat.site/odds/estrela/Am%C3%A9rica%20Latina|https://betstat.site/proximos/estrela/Am%C3%A9rica%20Latina">América Latina</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="lines-select">Janela de Tempo</label>
            <select id="lines-select">
              <option value="60">3 horas</option>
              <option value="120" selected>6 horas</option>
              <option value="240">12 horas</option>
              <option value="480">24 horas</option>
              <option value="960">48 horas</option>
              <option value="1440">72 horas</option>
              <option value="1920">96 horas</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-select">Mercado</label>
            <select id="filter-select">
              <option value="casavence">Casa Vence</option>
              <option value="empate">Empate</option>
              <option value="foravence">Fora Vence</option>
              <option value="bothscoreunder" selected>Ambas Sim</option>
              <option value="ambnao">Ambas Nao</option>
              <option value="over1.5">Over 1.5</option>
              <option value="over2.5">Over 2.5</option>
              <option value="over3.5">Over 3.5</option>
              <option value="under1.5">Under 1.5</option>
              <option value="under2.5">Under 2.5</option>
              <option value="under3.5">Under 3.5</option>
              <option value="exact0">0 Gol Exato</option>
              <option value="exact1">1 Gol Exato</option>
              <option value="exact2">2 Gols Exatos</option>
              <option value="exact3">3 Gols Exatos</option>
              <option value="exact4">4 Gols Exatos</option>
              <option value="5plus">5 Gols ou Mais</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="offset-select">Gales</label>
            <select id="offset-select">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="offset-select2">1 tiro</label>
            <select id="offset-select2">
              <option value="-1" selected>Antes</option>
              <option value="0">Odd</option>
              <option value="1">Depois</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Stats Bar -->
      <div class="stats-bar">
        <div class="stat-pill">
          <div class="pill-label">Odds Analisadas</div>
          <div class="pill-value accent" id="total-odds">—</div>
        </div>
        <div class="stat-pill">
          <div class="pill-label">Total de Jogos</div>
          <div class="pill-value" id="total-games">—</div>
        </div>
        <div class="stat-pill">
          <div class="pill-label">Media Green</div>
          <div class="pill-value green" id="avg-green">—</div>
        </div>
        <div class="stat-pill">
          <div class="pill-label">Melhor Odd</div>
          <div class="pill-value odd-color" id="best-odd">—</div>
        </div>
        <div class="stat-pill">
          <div class="pill-label">Mercado</div>
          <div class="pill-value" id="current-market" style="font-size:0.85rem;padding-top:4px;">—</div>
        </div>
      </div>

      <!-- Odd Cards -->
      <div class="section-title">Ranking por Odd</div>
      <div class="cards-container" id="team-cards"></div>

      <!-- Match Details -->
      <div id="match-details" style="display: none;">
        <div id="match-details-content"></div>
      </div>
    </div>

    <script>
      let oddStats = {};
      let matchDetails = {};
      let selectedOdd = null;
      let currentOddsData = [];
      let currentMarket = 'bothscoreunder';

      const MARKET_LABELS = {
        casavence: 'Casa Vence', empate: 'Empate', foravence: 'Fora Vence',
        bothscoreunder: 'Ambas Sim', ambnao: 'Ambas Nao',
        'over1.5': 'Over 1.5', 'over2.5': 'Over 2.5', 'over3.5': 'Over 3.5',
        'under1.5': 'Under 1.5', 'under2.5': 'Under 2.5', 'under3.5': 'Under 3.5',
        exact0: '0 Gol Exato', exact1: '1 Gol Exato', exact2: '2 Gols Exatos',
        exact3: '3 Gols Exatos', exact4: '4 Gols Exatos', '5plus': '5 Gols ou Mais',
      };

      const marketToOdd = {
        bothscoreunder: 'odds_ambas_marcam_sim',
        ambnao: 'odds_ambas_marcam_nao',
        casavence: 'odds_casa_vence',
        foravence: 'odds_visitante_vence',
        empate: 'odds_empate',
        'over1.5': 'odds_mais_1_5',
        'under1.5': 'odds_menos_1_5',
        'over2.5': 'odds_mais_2_5',
        'under2.5': 'odds_menos_2_5',
        'over3.5': 'odds_mais_3_5',
        'under3.5': 'odds_menos_3_5',
        '5plus': 'odds_mais_5_gols',
        exact0: 'odds_0_gols', exact1: 'odds_1_gol',
        exact2: 'odds_2_gols', exact3: 'odds_3_gols', exact4: 'odds_4_gols',
      };

      document.addEventListener('DOMContentLoaded', () => {
        loadData();
        setInterval(updateDynamicData, 60000);
      });

      ['league-select', 'lines-select', 'filter-select', 'offset-select', 'offset-select2'].forEach(id => {
        document.getElementById(id).addEventListener('change', loadData);
      });

      async function loadData() {
        oddStats = {};
        matchDetails = {};
        const parts = document.getElementById('league-select').value.split('|');
        const resultsUrl = parts[1];
        const oddsUrl    = parts[2];
        const proximosUrl = parts[3];
        const lines = parseInt(document.getElementById('lines-select').value);
        currentMarket = document.getElementById('filter-select').value;
        const offsetLimit = parseInt(document.getElementById('offset-select').value);
        const offsetStart = parseInt(document.getElementById('offset-select2').value);

        try {
          // Busca resultados e odds em paralelo; proximos é opcional (não falha se der erro)
          const [resResults, resOdds] = await Promise.all([fetch(resultsUrl), fetch(oddsUrl)]);
          if (!resResults.ok || !resOdds.ok) throw new Error('HTTP error');
          const resultsData = await resResults.json();
          const oddsData = await resOdds.json();

          // Tenta buscar proximos jogos; se falhar usa array vazio
          let proximosData = [];
          try {
            const resProximos = await fetch(proximosUrl);
            if (resProximos.ok) proximosData = await resProximos.json();
          } catch(e) {
            console.warn('Proximos jogos indisponivel:', e);
          }

          const resultsMap = buildResultsMap(resultsData);
          oddsData.sort((a, b) => parseCaptureDate(a) - parseCaptureDate(b));
          currentOddsData = oddsData;

          const recentMatches = oddsData.slice(-lines);
          processMatchData(recentMatches, offsetLimit, offsetStart, currentMarket, resultsMap);
          renderOddCards(currentMarket);
          updateStatsBar(currentMarket);

          // Passa proximos + oddsData para cruzamento de odds
          renderProximosJogos(proximosData, oddsData, currentMarket);

          document.getElementById('match-details').style.display = 'none';
          selectedOdd = null;
        } catch (error) {
          console.error('Erro ao carregar os dados:', error);
        }
      }

      async function updateDynamicData() {
        await loadData();
      }

      // ── buildResultsMap: tripla indexação para garantir o cruzamento ──
      // Chaves geradas: "home|away|YYYY-MM-DD" (exato), "home|away" (sem data), "away|home" (invertido)
      function buildResultsMap(resultsData) {
        // map principal: chave -> ft
        // mapByTeams: "home|away" -> array de { dateKey, ft } (todos os jogos desses times)
        const map = {};
        const mapByTeams = {};

        resultsData.forEach(result => {
          // Extrai o placar de múltiplos formatos possíveis
          const ftRaw = result.ft || result.placar || result.score || '';
          const ft    = parseFt(ftRaw);

          // Nomes dos times — tenta vários campos
          const homeRaw = result.time_a  || result.time_casa      || result.home  || result.team_home  || '';
          const awayRaw = result.time_b  || result.time_visitante  || result.away  || result.team_visit || '';
          const homeN   = normalizeTeamName(homeRaw);
          const awayN   = normalizeTeamName(awayRaw);

          // Data do resultado — suporta "DD/MM/YYYY, HH:MM", "DD/MM/YYYY", ISO e timestamp
          let dateKey = '';
          try {
            const rawData = result.data || result.data_jogo || result.date || '';
            if (rawData.includes('/')) {
              // "DD/MM/YYYY, HH:MM" ou "DD/MM/YYYY"
              const datePart = rawData.split(',')[0].trim();
              const [d, m, y] = datePart.split('/');
              dateKey = y + '-' + m.padStart(2,'0') + '-' + d.padStart(2,'0');
            } else if (rawData.includes('T') || rawData.includes('-')) {
              // ISO "2025-08-21T12:31:00.000Z" — extrai só a data sem conversão TZ
              dateKey = rawData.split('T')[0].substring(0,10);
            }
          } catch(e) {}

          // Índice 1: exato com data
          if (dateKey) {
            map[homeN + '|' + awayN + '|' + dateKey] = ft;
            map[awayN + '|' + homeN + '|' + dateKey] = ft; // invertido (segurança)
          }

          // Índice 2: só por times (sem data) — para fallback
          const teamKey = homeN + '|' + awayN;
          if (!mapByTeams[teamKey]) mapByTeams[teamKey] = [];
          mapByTeams[teamKey].push({ dateKey, ft });

          const teamKeyInv = awayN + '|' + homeN;
          if (!mapByTeams[teamKeyInv]) mapByTeams[teamKeyInv] = [];
          mapByTeams[teamKeyInv].push({ dateKey, ft });
        });

        // Expõe mapByTeams como propriedade do map para uso no lookup
        map.__byTeams = mapByTeams;
        return map;
      }

      // Normaliza o placar para "G x G" independente do formato original
      function parseFt(ft) {
        if (!ft) return null;
        ft = String(ft).trim();
        // "1 x 0", "1x0", "1-0", "1:0", "1 - 0"
        const m = ft.match(/(\d+)\s*[x\-:]\s*(\d+)/);
        if (m) return m[1] + ' x ' + m[2];
        return ft; // devolve como está se não reconhecer
      }

      // Lookup robusto: exato com data → ±1 dia → só times (mais recente) → null
      function lookupResult(resultsMap, homeTeam, awayTeam, dateKey) {
        const homeN = normalizeTeamName(homeTeam);
        const awayN = normalizeTeamName(awayTeam);

        // 1. Exato
        const exact = resultsMap[homeN + '|' + awayN + '|' + dateKey];
        if (exact) return exact;

        // 2. Invertido (segurança — times trocados entre endpoints)
        const inv = resultsMap[awayN + '|' + homeN + '|' + dateKey];
        if (inv) return inv;

        // 3. ±1 dia (diferença de fuso)
        try {
          const base = new Date(dateKey + 'T12:00:00');
          for (const delta of [-1, 1]) {
            const d2 = new Date(base);
            d2.setDate(d2.getDate() + delta);
            const dk2 = d2.getFullYear() + '-' +
                        (d2.getMonth()+1).toString().padStart(2,'0') + '-' +
                        d2.getDate().toString().padStart(2,'0');
            const r = resultsMap[homeN + '|' + awayN + '|' + dk2]
                   || resultsMap[awayN + '|' + homeN + '|' + dk2];
            if (r) return r;
          }
        } catch(e) {}

        // 4. Só por times, sem data — pega o mais recente disponível
        const byTeams = resultsMap.__byTeams || {};
        const candidates = byTeams[homeN + '|' + awayN] || byTeams[awayN + '|' + homeN] || [];
        if (candidates.length > 0) {
          // ordena pelo dateKey mais próximo da data do jogo
          const sorted = candidates.slice().sort((a, b) => {
            const da = Math.abs(new Date(a.dateKey) - new Date(dateKey));
            const db = Math.abs(new Date(b.dateKey) - new Date(dateKey));
            return da - db;
          });
          if (sorted[0].ft) return sorted[0].ft;
        }

        return null; // não encontrou
      }

      function parseCaptureDate(match) {
        try {
          const [day, month, year] = match.data_captura.split('/');
          const [hour, minute] = match.horario.split(':');
          return new Date(year, month - 1, day, hour, minute);
        } catch(e) { return new Date(0); }
      }

      function parseGameDate(str) {
        try {
          const [datePart, timePart] = str.split(', ');
          const [day, month, year] = datePart.split('/');
          const [hour, minute] = timePart.split(':');
          return new Date(year, month - 1, day, hour, minute);
        } catch(e) { return new Date(0); }
      }

      function processMatchData(matches, offsetLimit, offsetStart, market, resultsMap) {
        matches.forEach((match, index) => {
          const oddField = marketToOdd[market];
          const oddValue = parseFloat(match[oddField]);
          if (!isNaN(oddValue)) {
            const key = oddValue.toFixed(2);
            processOdd(key, matches, index, offsetLimit, offsetStart, market, resultsMap);
          }
        });
      }

      function processOdd(key, matches, currentIndex, offsetLimit, offsetStart, market, resultsMap) {
        if (!oddStats[key]) oddStats[key] = { games: 0, greens: 0 };
        oddStats[key].games++;
        if (!matchDetails[key]) matchDetails[key] = [];

        const matchData = [];
        let hasGreen  = false;
        let hasResult = false; // ao menos um resultado encontrado

        for (let offset = offsetStart; offset < offsetStart + offsetLimit; offset++) {
          const index = currentIndex + offset;
          if (index >= 0 && index < matches.length) {
            const match    = matches[index];
            const gameStart = parseGameDate(match.inicio_jogo);

            const year  = gameStart.getFullYear();
            const month = (gameStart.getMonth() + 1).toString().padStart(2, '0');
            const day   = gameStart.getDate().toString().padStart(2, '0');
            const formattedDate = day + '/' + month;
            const dateKey = year + '-' + month + '-' + day;

            // Lookup robusto em 4 camadas
            const ftFound = lookupResult(resultsMap, match.time_casa, match.time_visitante, dateKey);

            // Só computa se encontrou resultado real
            let gameStatus = 'N/A';
            let ftDisplay  = '?';
            if (ftFound) {
              hasResult  = true;
              ftDisplay  = ftFound;
              const parts = ftFound.split(' x ').map(Number);
              const goalsHome  = isNaN(parts[0]) ? 0 : parts[0];
              const goalsAway  = isNaN(parts[1]) ? 0 : parts[1];
              const totalGoals = goalsHome + goalsAway;
              const isGreen = checkMarketCondition(goalsHome, goalsAway, totalGoals, market);
              gameStatus = isGreen ? 'Green' : 'Red';
              if (isGreen) hasGreen = true;
            }

            const oddField = marketToOdd[market];
            const oddValue = match[oddField] || 'N/A';
            matchData.push(formattedDate + '|' + match.time_casa + '|' + ftDisplay + '|' + match.time_visitante + '|' + oddValue + '|' + gameStatus);
          }
        }

        // Só conta greens se ao menos um resultado foi encontrado (evita falso Red)
        const className = hasGreen ? 'highlight-green' : hasResult ? 'highlight-red' : '';
        matchDetails[key].push({ data: matchData.join('||'), className });
        if (hasGreen) oddStats[key].greens++;

        // Se nenhum resultado encontrado, não incrementa games (descarta entrada sem dados)
        if (!hasResult) oddStats[key].games--;
      }

      function getSortedOdds() {
        return Object.entries(oddStats)
          .map(([key, stats]) => ({
            key,
            games: stats.games,
            greens: stats.greens,
            percentage: (stats.greens / stats.games * 100).toFixed(0),
          }))
          .sort((a, b) => parseInt(b.percentage) === parseInt(a.percentage) ? b.games - a.games : parseInt(b.percentage) - parseInt(a.percentage))
          .slice(0, 21);
      }

      function getPctColor(pct) {
        if (pct >= 80) return '#2ecc71';
        if (pct >= 60) return '#1fad8b';
        if (pct >= 40) return '#e6a817';
        return '#e74c3c';
      }

      function updateStatsBar(market) {
        const sorted = getSortedOdds();
        const totalGames = sorted.reduce((s, t) => s + t.games, 0);
        const avgGreen = sorted.length > 0
          ? (sorted.reduce((s, t) => s + parseInt(t.percentage), 0) / sorted.length).toFixed(0) + '%'
          : '—';
        document.getElementById('total-odds').textContent = sorted.length;
        document.getElementById('total-games').textContent = totalGames;
        document.getElementById('avg-green').textContent = avgGreen;
        document.getElementById('best-odd').textContent = sorted.length > 0 ? '@' + sorted[0].key : '—';
        document.getElementById('current-market').textContent = MARKET_LABELS[market] || market;
      }

      function renderOddCards(market) {
        const cardsContainer = document.getElementById('team-cards');
        cardsContainer.innerHTML = '';
        const sortedOdds = getSortedOdds();

        sortedOdds.forEach((oddData, index) => {
          const pct = parseInt(oddData.percentage);
          const card = document.createElement('div');
          card.className = `team-card ${index < 5 ? 'top-rank' : ''}`;
          card.dataset.key = oddData.key;
          const rankLabel = index < 5 ? `<div class="rank-badge">#${index + 1}</div>` : '';
          card.innerHTML = `
            ${rankLabel}
            <div class="odd-display">
              <div class="odd-at">Odd</div>
              <div class="odd-value">@${oddData.key}</div>
            </div>
            <div class="card-stats">
              <div class="card-stat">
                <div class="cs-label">Jogos</div>
                <div class="cs-value">${oddData.games}</div>
              </div>
              <div class="card-stat">
                <div class="cs-label">Green</div>
                <div class="cs-value" style="color:var(--green)">${oddData.greens}</div>
              </div>
            </div>
            <div class="pct-bar-wrap">
              <div class="pct-label">
                <span>Taxa Green</span>
                <span style="color:${getPctColor(pct)}">${oddData.percentage}%</span>
              </div>
              <div class="pct-bar">
                <div class="pct-fill" style="width:${oddData.percentage}%; background:${getPctColor(pct)}"></div>
              </div>
            </div>
          `;
          card.addEventListener('click', () => toggleMatchDetails(oddData.key, card));
          cardsContainer.appendChild(card);
        });
      }

      function toggleMatchDetails(key, cardEl) {
        const detailsDiv = document.getElementById('match-details');
        document.querySelectorAll('.team-card').forEach(c => c.classList.remove('selected'));
        if (selectedOdd === key && detailsDiv.style.display === 'block') {
          detailsDiv.style.display = 'none';
          selectedOdd = null;
        } else {
          if (cardEl) cardEl.classList.add('selected');
          showMatchDetails(key);
          selectedOdd = key;
        }
      }

      function showMatchDetails(key) {
        const detailsDiv = document.getElementById('match-details');
        const detailsContent = document.getElementById('match-details-content');
        detailsContent.innerHTML = '';

        const title = document.createElement('h2');
        title.textContent = `Historico — Odd @${key}`;
        detailsContent.appendChild(title);

        if (matchDetails[key] && matchDetails[key].length > 0) {
          const greenCount = matchDetails[key].filter(d => d.className === 'highlight-green').length;
          const total = matchDetails[key].length;
          const pct = total > 0 ? ((greenCount / total) * 100).toFixed(0) : 0;

          const summary = document.createElement('div');
          summary.style.cssText = 'display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap';
          summary.innerHTML = `
            <div class="stat-pill" style="min-width:120px;flex:0">
              <div class="pill-label">Entradas</div>
              <div class="pill-value">${total}</div>
            </div>
            <div class="stat-pill" style="min-width:120px;flex:0">
              <div class="pill-label">Greens</div>
              <div class="pill-value green">${greenCount}</div>
            </div>
            <div class="stat-pill" style="min-width:120px;flex:0">
              <div class="pill-label">Taxa</div>
              <div class="pill-value" style="color:${getPctColor(parseInt(pct))}">${pct}%</div>
            </div>
          `;
          detailsContent.appendChild(summary);

          const ul = document.createElement('ul');
          matchDetails[key].forEach(detail => {
            const li = document.createElement('li');
            li.className = detail.className;
            const entries = detail.data.split('||');
            entries.forEach(entry => {
              const [date, homeTeam, ft, awayTeam, oddVal, status] = entry.split('|');
              const scoreMatch = ft.match(/(\d+ x \d+)/);
              const score = scoreMatch ? scoreMatch[0] : ft;
              const matchDiv = document.createElement('div');
              matchDiv.style.cssText = 'display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex:1';
              matchDiv.innerHTML = `
                <span class="detail-date">${date}</span>
                <span class="detail-teams">
                  <span class="detail-team">${homeTeam}</span>
                  <span class="detail-score">${score}</span>
                  <span class="detail-team">${awayTeam}</span>
                </span>
                <span class="detail-odd">@${oddVal}</span>
                <span class="status-badge ${status === 'Green' ? 'green' : 'red'}">${status}</span>
              `;
              li.appendChild(matchDiv);
            });
            ul.appendChild(li);
          });
          detailsContent.appendChild(ul);
        } else {
          const noData = document.createElement('p');
          noData.textContent = 'Nenhum jogo encontrado.';
          noData.style.color = 'var(--text-secondary)';
          detailsContent.appendChild(noData);
        }

        detailsDiv.style.display = 'block';
        detailsDiv.scrollIntoView({ behavior: 'smooth' });
      }

      // ── PROXIMOS JOGOS — exibe apenas a odd do mercado selecionado ──
      // ── PROXIMOS JOGOS ──
      // Cruza o endpoint /proximos (team_home, team_visit, start_time)
      // com o histórico de odds para obter a odd do mercado selecionado.
      function renderProximosJogos(proximosData, oddsData, market) {
        const lista = document.getElementById('lista-proximos-jogos');
        lista.innerHTML = '';

        if (!proximosData || proximosData.length === 0) {
          lista.innerHTML = '<div class="game-card" style="color:var(--text-secondary);font-size:0.8rem;">Nenhum proximo jogo disponivel</div>';
          return;
        }

        const oddField    = marketToOdd[market];
        const marketLabel = MARKET_LABELS[market] || market;

        // 1. Monta índice de odds: "normalHome|normalAway|YYYY-MM-DD" -> registro
        // Percorre de trás para frente para ficar com o mais recente em caso de duplicata
        const oddsIndex = {};
        for (let i = oddsData.length - 1; i >= 0; i--) {
          const o = oddsData[i];
          const gd = parseGameDate(o.inicio_jogo);
          if (!gd || isNaN(gd)) continue;
          const yr  = gd.getFullYear();
          const mo  = (gd.getMonth() + 1).toString().padStart(2, '0');
          const dy  = gd.getDate().toString().padStart(2, '0');
          const dk  = yr + '-' + mo + '-' + dy;
          const ik  = normalizeTeamName(o.time_casa) + '|' + normalizeTeamName(o.time_visitante) + '|' + dk;
          if (!oddsIndex[ik]) oddsIndex[ik] = o;
        }

        // 2. Top 5 odds do ranking para destacar jogos relevantes
        const sortedOdds = getSortedOdds();
        const topOddKeys = sortedOdds.slice(0, 5).map(o => o.key);

        // 3. Renderiza cada próximo jogo
        proximosData.forEach(function(jogo) {
          // Horario
          var time = jogo.time || '--:--';
          if (!jogo.time && jogo.start_time) {
            try {
              var ds = new Date(jogo.start_time);
              time = ds.getHours().toString().padStart(2,'0') + ':' + ds.getMinutes().toString().padStart(2,'0');
            } catch(e) {}
          }

          var homeTeam = jogo.team_home  || jogo.time_casa      || '';
          var awayTeam = jogo.team_visit || jogo.time_visitante  || '';

          // Data do jogo para o cruzamento
          var yr2, mo2, dy2;
          if (jogo.start_time) {
            var d2 = new Date(jogo.start_time);
            yr2 = d2.getFullYear();
            mo2 = (d2.getMonth() + 1).toString().padStart(2, '0');
            dy2 = d2.getDate().toString().padStart(2, '0');
          } else if (jogo.captured_date) {
            var parts2 = jogo.captured_date.split('/');
            dy2 = parts2[0]; mo2 = parts2[1]; yr2 = parts2[2];
          }
          var dateKey2 = yr2 + '-' + mo2 + '-' + dy2;

          // Cruzamento exato por times + data
          var oddsEntry = null;
          var exactKey = normalizeTeamName(homeTeam) + '|' + normalizeTeamName(awayTeam) + '|' + dateKey2;
          if (oddsIndex[exactKey]) {
            oddsEntry = oddsIndex[exactKey];
          } else {
            // Fallback: só por times (ignora data), pega o mais recente
            var partialKey = normalizeTeamName(homeTeam) + '|' + normalizeTeamName(awayTeam) + '|';
            var foundKey = Object.keys(oddsIndex).find(function(k) { return k.indexOf(partialKey) === 0; });
            if (foundKey) oddsEntry = oddsIndex[foundKey];
          }

          var marketOddRaw   = oddsEntry ? parseFloat(oddsEntry[oddField]) : NaN;
          var marketOddValue = !isNaN(marketOddRaw) ? marketOddRaw.toFixed(2) : null;
          var isTopMatch     = marketOddValue && topOddKeys.includes(marketOddValue);

          var card = document.createElement('div');
          card.className = 'game-card' + (isTopMatch ? ' top-match' : '');
          card.innerHTML =
            '<div class="gc-time">' + time + '</div>' +
            '<div class="gc-teams">' +
              '<span class="gc-team' + (isTopMatch ? ' top-team' : '') + '">' + homeTeam + '</span>' +
              '<span class="gc-vs">x</span>' +
              '<span class="gc-team' + (isTopMatch ? ' top-team' : '') + '">' + awayTeam + '</span>' +
            '</div>' +
            '<div class="gc-market-odd' + (isTopMatch ? ' is-top' : '') + '">' +
              '<div class="gmo-label">' + marketLabel + '</div>' +
              '<div class="gmo-value">' + (marketOddValue ? '@' + marketOddValue : '—') + '</div>' +
            '</div>';
          lista.appendChild(card);
        });
      }

      function checkMarketCondition(goalsHome, goalsAway, goals, market) {
        switch (market) {
          case '5plus':      return goals >= 5;
          case 'over3.5':    return goals > 3.5;
          case 'over2.5':    return goals > 2.5;
          case 'over1.5':    return goals > 1.5;
          case 'under1.5':   return goals < 1.5;
          case 'under2.5':   return goals < 2.5;
          case 'under3.5':   return goals < 3.5;
          case 'exact0':     return goals === 0;
          case 'exact1':     return goals === 1;
          case 'exact2':     return goals === 2;
          case 'exact3':     return goals === 3;
          case 'exact4':     return goals === 4;
          case 'bothscoreunder': return (goalsHome > 0 && goalsAway > 0);
          case 'ambnao':     return (goalsHome === 0 || goalsAway === 0);
          case 'casavence':  return (goalsHome > goalsAway);
          case 'foravence':  return (goalsHome < goalsAway);
          case 'empate':     return (goalsHome === goalsAway);
          default: return false;
        }
      }

      function normalizeTeamName(teamName) {
        if (!teamName) return '';
        return teamName.trim().replace(/\s+/g, ' ').toLowerCase();
      }
    </script>

    <script>
      fetch('header.html')
        .then(r => r.text())
        .then(d => { document.getElementById('header').innerHTML = d; });
    </script>
    <script src="redirecionar.js"></script>

    <script>
      document.addEventListener("contextmenu", e => e.preventDefault());
      document.addEventListener("keydown", function(e) {
        if (e.key === "F12") e.preventDefault();
        if (e.ctrlKey && e.shiftKey && ["I","J","C"].includes(e.key)) e.preventDefault();
        if (e.ctrlKey && ["u","s","p"].includes(e.key)) e.preventDefault();
      });
      const devtools = { open: false };
      const element = new Image();
      Object.defineProperty(element, 'id', { get: function() { devtools.open = true; } });
      (function() {
        const threshold = 160;
        const checkDevTools = function() {
          if ((window.outerWidth - window.innerWidth) > threshold || (window.outerHeight - window.innerHeight) > threshold)
            devtools.open = true;
        };
        window.addEventListener('resize', checkDevTools);
        setInterval(checkDevTools, 500);
      })();
      console.log('%c', element);
      setInterval(function() {
        if (devtools.open) {
          document.body.innerHTML = '<h1>Acesso nao autorizado detectado</h1>';
          devtools.open = false;
        }
      }, 1000);
      document.addEventListener('selectstart', e => e.preventDefault());
      document.addEventListener('dragstart', e => e.preventDefault());
      console.log = function() {};
      console.debug = function() {};
      console.info = function() {};
    </script>
  </body>
</html>