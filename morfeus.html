<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4WT805FFHQ"></script>
    <title>BetStat</title>

    <meta name="description" content="Transforme suas apostas com BetStat - a √∫nica plataforma especializada em futebol virtual Betano. An√°lises precisas, estat√≠sticas confi√°veis e resultados comprovados para investimentos inteligentes." />
    <meta name="keywords" content="BetStat, apostas esportivas, futebol virtual, Betano, estat√≠sticas apostas, an√°lise apostas, investimentos esportivos" />
    <meta property="og:title" content="BetStat | Plataforma de An√°lise para Apostas Esportivas" />
    <meta property="og:description" content="Transforme suas apostas com an√°lises precisas e estat√≠sticas confi√°veis. A √∫nica plataforma especializada em futebol virtual Betano." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.betstat.site/payment.html" />
    <meta property="og:site_name" content="BetStat" />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="BetStat" />
    <meta name="canonical" href="https://www.betstat.site/payment.html" />
    
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-4WT805FFHQ");
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
  </head>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --primary-color: #1fac89;
  --primary-hover: #189976;
  --primary-dark: #01684f;
  --bg-color: #1c1f26;
  --text-color: #ffffff;
  --text-muted: #9ca3af;
  --container-bg: #2a2f3a;
  --border-color: rgba(31, 172, 137, 0.2);
  --border-muted: rgba(255, 255, 255, 0.1);
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.25);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  max-width: 1500px;
  margin: 0 auto;
  padding: 3rem 2rem;
}

.header {
  text-align: center;
  margin-bottom: 3.5rem;
  animation: fadeInDown 0.6s ease-out;
}

.title {
  font-size: 3rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 0.75rem;
  letter-spacing: -0.5px;
}

.subtitle {
  font-size: 1.125rem;
  color: var(--text-muted);
  font-weight: 400;
  letter-spacing: 0.3px;
}

.analysis-card {
  background: var(--container-bg);
  border: 1px solid var(--border-muted);
  border-radius: 16px;
  padding: 2.5rem;
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(10px);
  animation: fadeInUp 0.6s ease-out;
  transition: var(--transition);
}

.analysis-card:hover {
  border-color: var(--border-color);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
}

.section {
  margin-bottom: 2.5rem;
}

.section:last-child {
  margin-bottom: 0;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 1.25rem;
  letter-spacing: 0.3px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-title::before {
  content: '';
  width: 4px;
  height: 20px;
  background: linear-gradient(180deg, var(--primary-color), var(--primary-hover));
  border-radius: 2px;
}

.btn-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0.875rem;
}

.btn {
  background: var(--bg-color);
  color: var(--text-muted);
  border: 1.5px solid var(--border-muted);
  padding: 0.875rem 1.25rem;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  font-family: inherit;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(31, 172, 137, 0.1), transparent);
  transition: left 0.5s ease;
}

.btn:hover::before {
  left: 100%;
}

.btn:hover {
  color: var(--text-color);
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(31, 172, 137, 0.2);
}

.btn.active {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
  color: var(--text-color);
  border-color: var(--primary-color);
  box-shadow: 0 4px 16px rgba(31, 172, 137, 0.3);
  transform: translateY(-1px);
}

.textarea-container {
  position: relative;
}

.textarea {
  width: 100%;
  min-height: 120px;
  background: var(--bg-color);
  border: 1.5px solid var(--border-muted);
  border-radius: 12px;
  color: var(--text-color);
  padding: 1.25rem;
  font-family: inherit;
  font-size: 0.95rem;
  line-height: 1.7;
  resize: vertical;
  transition: var(--transition);
}

.textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(31, 172, 137, 0.1);
}

.textarea::placeholder {
  color: var(--text-muted);
  opacity: 0.7;
}

.image-upload {
  margin-top: 1.25rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.image-upload input[type="file"] {
  display: none;
}

.image-upload .image-status {
  color: var(--primary-color);
  font-weight: 500;
  font-size: 0.9rem;
}

.image-preview {
  max-width: 100%;
  max-height: 250px;
  margin-top: 1.25rem;
  border-radius: 12px;
  display: none;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-muted);
}

.actions {
  display: flex;
  gap: 1rem;
  margin-top: 2.5rem;
}

.action-btn {
  flex: 1;
  padding: 1.125rem 2rem;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-transform: uppercase;
  letter-spacing: 1px;
  font-family: inherit;
  position: relative;
  overflow: hidden;
}

.action-btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.action-btn:active::after {
  width: 300px;
  height: 300px;
}

.btn-clear {
  background: transparent;
  color: var(--text-muted);
  border: 2px solid var(--border-muted);
}

.btn-clear:hover {
  background: var(--container-bg);
  color: var(--text-color);
  border-color: var(--text-color);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.btn-generate {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
  color: var(--text-color);
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(31, 172, 137, 0.3);
}

.btn-generate:hover {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(31, 172, 137, 0.4);
}

.btn-generate:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.result-container {
  margin-top: 2.5rem;
  background: var(--container-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 2.5rem;
  display: none;
  animation: fadeInUp 0.6s ease-out;
  box-shadow: var(--shadow-lg);
}

.result-title {
  font-size: 1.5rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1.75rem;
  display: flex;
  align-items: center;
  gap: 0.875rem;
  letter-spacing: -0.3px;
}

.result-content {
  color: var(--text-color);
  line-height: 1.8;
  white-space: pre-wrap;
  font-size: 1rem;
}

.loading {
  display: flex;
  align-items: center;
  gap: 0.875rem;
  color: var(--primary-color);
  font-weight: 500;
}

.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid rgba(31, 172, 137, 0.2);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

.error {
  background: rgba(239, 68, 68, 0.1);
  border: 1.5px solid rgba(239, 68, 68, 0.4);
  color: #ef4444;
  padding: 1.5rem;
  border-radius: 12px;
  margin-top: 1.25rem;
  font-weight: 500;
  animation: shake 0.5s ease-in-out;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

@media (max-width: 768px) {
  .container {
    padding: 1.5rem 1rem;
  }
  
  .title {
    font-size: 2.25rem;
  }
  
  .analysis-card {
    padding: 1.75rem;
    border-radius: 12px;
  }
  
  .actions {
    flex-direction: column;
  }
  
  .btn-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
  }
  
  .result-container {
    padding: 1.75rem;
  }
}

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>

  <body>
      <div id="header"></div>

      <br>
      <br>

    <div class="container">
      <div class="analysis-card">
        <div class="section">
          <h2 class="section-title">Casa de Aposta</h2>
          <div class="btn-grid" id="casas-group">
            <button class="btn" data-value="betano">Betano</button>
            <button class="btn" data-value="kiron">Kiron</button>
            <button class="btn" data-value="estrela">Estrelabet</button>
            <button class="btn" data-value="bet365">Bet365</button>
          </div>
        </div>

        <div class="section" id="liga-section" style="display: none;">
          <h2 class="section-title">Liga</h2>
          <div class="btn-grid" id="ligas-group"></div>
        </div>

        <div class="section">
          <h2 class="section-title">Mercado da An√°lise</h2>
          <div class="btn-grid" id="mercados-group">
            <button class="btn" data-value="casaVence">Casa Vence</button>
            <button class="btn" data-value="foraVence">Fora Vence</button>
            <button class="btn" data-value="empate">Empate</button>
            <button class="btn" data-value="over1.5">Over 1.5</button>
            <button class="btn" data-value="over2.5">Over 2.5</button>
            <button class="btn" data-value="over3.5">Over 3.5</button>
            <button class="btn" data-value="under1.5">Under 1.5</button>
            <button class="btn" data-value="under2.5">Under 2.5</button>
            <button class="btn" data-value="under3.5">Under 3.5</button>
            <button class="btn" data-value="ambasMarcam">Ambas Sim</button>
            <button class="btn" data-value="ambasNaoMarcam">Ambas N√£o</button>
            <button class="btn" data-value="over5">5+ Gols</button>
            <button class="btn" data-value="exact1">1 Gol Exato</button>
            <button class="btn" data-value="exact2">2 Gols Exatos</button>
            <button class="btn" data-value="exact3">3 Gols Exatos</button>
            <button class="btn" data-value="exact4">4 Gols Exatos</button>
          </div>
        </div>

        <div class="section">
          <h2 class="section-title">Estrat√©gia Martingale</h2>
          <div class="btn-grid" id="martingale-group">
            <button class="btn" data-value="0">Nenhum</button>
            <button class="btn" data-value="1">1 Cobertura</button>
            <button class="btn" data-value="2">2 Coberturas</button>
            <button class="btn" data-value="3">3 Coberturas</button>
          </div>
        </div>

        <div class="section">
          <h2 class="section-title">Per√≠odo de An√°lise</h2>
          <div class="btn-grid" id="periodo-group">
            <button class="btn" data-value="120">6 Horas</button>
            <button class="btn" data-value="240">12 Horas</button>
            <button class="btn" data-value="480">24 Horas</button>
            <button class="btn" data-value="960">48 Horas</button>
            <button class="btn" data-value="1440">72 Horas</button>
          </div>
        </div>

        <div class="section">
          <h2 class="section-title">Observa√ß√µes Adicionais</h2>
          <div class="textarea-container">
            <textarea class="textarea" id="observacao" placeholder="Ex: Priorizar determinados hor√°rios, evitar confrontos diretos entre times fortes, etc..." rows="4"></textarea>
          </div>
        </div>

        <div class="section">
          <h2 class="section-title">Imagem para An√°lise (Opcional)</h2>
          <div class="image-upload">
            <label for="image-upload" class="action-btn btn-generate">Selecionar Imagem</label>
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
            <span id="image-status" class="image-status">Nenhum arquivo selecionado</span>
          </div>
          <img id="image-preview" class="image-preview" alt="Pr√©-visualiza√ß√£o da imagem">
        </div>

        <div class="actions">
          <button class="action-btn btn-clear" onclick="limparAnalise()">Nova An√°lise</button>
          <button class="action-btn btn-generate" onclick="gerarAnalise()">Gerar An√°lise IA</button>
        </div>

        <div class="result-container" id="result-container">
          <h3 class="result-title" id="result-title">
            <div class="success-indicator"></div>
            An√°lise Conclu√≠da
          </h3>
          <div class="result-content" id="result-content"></div>
        </div>
      </div>
    </div>

    <script>
/* =====================================================
   CONFIGURA√á√ÉO DAS CASAS DE APOSTAS
   ===================================================== */
const casasConfig = {
  'betano': {
    name: 'Betano',
    ligas: [
      { name: 'Cl√°ssicos da Am√©rica', value: 'Ta√ßa Gl√≥ria Eterna' },
      'Copa Am√©rica',
      'Euro',
      'Campeonato Italiano',
      'Copa das Estrelas',
      'Brasileir√£o Betano'
    ]
  },
  'kiron': {
    name: 'Kiron',
    ligas: ['England', 'Italy', 'Spain'],
    path: 'kiron'
  },
  'estrela': {
    name: 'Estrelabet',
    ligas: ['Copa do Mundo', 'Ligas dos Campe√µes', 'Am√©rica Latina'],
    path: 'estrela'
  },
  'bet365': {
    name: 'Bet365',
    ligas: ['Copa', 'Euro', 'Super', 'Premier'],
    path: 'bet365'
  }
};

/* =====================================================
   CACHE DE API ‚Äî evita rebuscar dados id√™nticos
   TTL: 3 minutos por chave
   ===================================================== */
const _apiCache = new Map();
const CACHE_TTL_MS = 3 * 60 * 1000;

async function fetchComCache(url) {
  const cached = _apiCache.get(url);
  if (cached && Date.now() - cached.ts < CACHE_TTL_MS) return cached.data;
  const data = await fetch(url).then(r => r.json());
  _apiCache.set(url, { ts: Date.now(), data });
  return data;
}

/* =====================================================
   GERENCIAMENTO DE BOT√ïES E UI
   ===================================================== */
document.querySelectorAll('.btn-grid').forEach(group => {
  group.addEventListener('click', event => {
    if (event.target.classList.contains('btn')) {
      const currentActive = group.querySelector('.btn.active');
      if (currentActive) currentActive.classList.remove('active');
      event.target.classList.add('active');
      if (group.id === 'casas-group') mostrarLigas(event.target.dataset.value);
    }
  });
});

function mostrarLigas(casa) {
  const ligaSection = document.getElementById('liga-section');
  const ligasGroup  = document.getElementById('ligas-group');
  if (!casasConfig[casa]) { ligaSection.style.display = 'none'; return; }
  ligasGroup.innerHTML = '';
  casasConfig[casa].ligas.forEach(ligaItem => {
    const btn = document.createElement('button');
    btn.className = 'btn';
    if (typeof ligaItem === 'object') {
      btn.dataset.value = ligaItem.value;
      btn.textContent   = ligaItem.name;
    } else {
      btn.dataset.value = ligaItem;
      btn.textContent   = ligaItem;
    }
    ligasGroup.appendChild(btn);
  });
  ligaSection.style.display = 'block';
}

function getSelectedValue(groupId) {
  const group = document.getElementById(groupId);
  const btn   = group ? group.querySelector('.btn.active') : null;
  return btn ? btn.dataset.value : null;
}

function getSelectedText(groupId) {
  const group = document.getElementById(groupId);
  const btn   = group ? group.querySelector('.btn.active') : null;
  return btn ? btn.innerText : null;
}

function limparAnalise() {
  document.querySelectorAll('.btn.active').forEach(b => b.classList.remove('active'));
  document.getElementById('observacao').value = '';
  document.getElementById('image-upload').value = '';
  document.getElementById('image-status').textContent = 'Nenhum arquivo selecionado';
  document.getElementById('image-preview').style.display = 'none';
  document.getElementById('result-container').style.display = 'none';
  document.getElementById('liga-section').style.display = 'none';
}

/* Atualiza o contador de an√°lises restantes no dia no HTML (se existir) */
function atualizarContadorUI() {
  const el = document.getElementById('analises-restantes');
  if (!el) return;
  const MAX = 6;
  const hoje = new Date().toISOString().split('T')[0];
  const usage = JSON.parse(localStorage.getItem('analysisUsage')) || {};
  const usadas = usage.date === hoje ? (usage.count || 0) : 0;
  const restantes = Math.max(0, MAX - usadas);
  el.textContent = `${restantes} an√°lise(s) restante(s) hoje`;
  el.style.color = restantes <= 1 ? '#ff6b6b' : restantes <= 3 ? '#ffd93d' : '#00ff88';
}
document.addEventListener('DOMContentLoaded', atualizarContadorUI);

/* =====================================================
   BUSCA DE DADOS DA API
   Estrutura confirmada:
   Resultados: { time_a, time_b, ft, hora (int), minuto (int) }
   Pr√≥ximos:   { team_home, team_visit, time "HH:MM" }
   Odds:       { time_casa, time_visitante, horario "HH:MM",
                 odds_casa_vence, odds_visitante_vence, odds_empate,
                 odds_ambas_marcam_sim, odds_ambas_marcam_nao,
                 odds_mais_1_5, odds_menos_1_5, odds_mais_2_5,
                 odds_menos_2_5, odds_mais_3_5, odds_menos_3_5,
                 odds_mais_5_gols }
   ===================================================== */
async function buscarDadosAPI(casa, liga, numJogos) {
  const config = casasConfig[casa];
  if (!config) throw new Error(`Casa ${casa} n√£o encontrada`);

  const dadosCompletos = { casa: config.name, liga, totalJogos: 0, dadosCru: [] };
  try {
    const ligaEncoded = encodeURIComponent(liga);
    const base   = 'https://betstat.site';
    const prefix = config.path ? `/${config.path}` : '';

    const [resultados, proximos, oddsRaw] = await Promise.all([
      fetchComCache(`${base}/resultados${prefix}/${ligaEncoded}`),
      fetchComCache(`${base}/proximos${prefix}/${ligaEncoded}`),
      fetchComCache(`${base}/odds${prefix}/${ligaEncoded}`).catch(() => [])
    ]);

    /* ---- RESULTADOS ---- */
    resultados.slice(-numJogos).forEach(jogo => {
      const parts = (jogo.ft || 'x').split('x').map(s => parseInt(s.trim(), 10));
      const a = parts[0], b = parts[1];
      if (Number.isFinite(a) && Number.isFinite(b)) {
        dadosCompletos.dadosCru.push([
          a, b, a + b,
          (jogo.time_a || '').trim(),
          (jogo.time_b || '').trim(),
          jogo.hora,
          jogo.minuto
        ]);
      }
    });

    /* ---- PR√ìXIMOS JOGOS ---- */
    dadosCompletos.proximos = proximos.slice(0, 8).map(j => {
      const timeStr = j.time || '';
      let hora = 0, minuto = 0;
      if (timeStr.includes(':')) {
        const pts = timeStr.split(':');
        hora   = parseInt(pts[0], 10) || 0;
        minuto = parseInt(pts[1], 10) || 0;
      }
      return {
        time_a:   (j.team_home  || '').trim(),
        time_b:   (j.team_visit || '').trim(),
        horario:  timeStr,
        hora, minuto,
        liga:     j.league || liga,
        id:       j.id,
        event_id: j.event_id
      };
    });

    /* ---- ODDS ---- */
    const oddsIndex = {};
    if (Array.isArray(oddsRaw)) {
      oddsRaw.forEach(o => {
        const key = `${(o.time_casa||'').trim().toLowerCase()}|${(o.time_visitante||'').trim().toLowerCase()}`;
        oddsIndex[key] = {
          horario:        o.horario || '',
          time_casa:      (o.time_casa || '').trim(),
          time_visitante: (o.time_visitante || '').trim(),
          casaVence:      parseFloat(o.odds_casa_vence)       || null,
          visitanteVence: parseFloat(o.odds_visitante_vence)  || null,
          empate:         parseFloat(o.odds_empate)           || null,
          ambasSim:       parseFloat(o.odds_ambas_marcam_sim) || null,
          ambasNao:       parseFloat(o.odds_ambas_marcam_nao) || null,
          over1_5:        parseFloat(o.odds_mais_1_5)         || null,
          under1_5:       parseFloat(o.odds_menos_1_5)        || null,
          over2_5:        parseFloat(o.odds_mais_2_5)         || null,
          under2_5:       parseFloat(o.odds_menos_2_5)        || null,
          over3_5:        parseFloat(o.odds_mais_3_5)         || null,
          under3_5:       parseFloat(o.odds_menos_3_5)        || null,
          over5:          parseFloat(o.odds_mais_5_gols)      || null
        };
      });
    }

    dadosCompletos.oddsIndex       = oddsIndex;
    dadosCompletos.oddsRaw         = Array.isArray(oddsRaw) ? oddsRaw : [];
    dadosCompletos.oddsDisponiveis = Object.keys(oddsIndex).length > 0;
    dadosCompletos.totalJogos      = dadosCompletos.dadosCru.length;
    return dadosCompletos;

  } catch (error) {
    throw new Error(`Falha ao conectar com a API: ${error.message}`);
  }
}

/* =====================================================
   RANKING DE TIMES
   ===================================================== */
function calcularRankingTimes(games, mercado) {
  const stats = {};
  games.forEach(({ time_a, time_b, ft }) => {
    if (!ft || !ft.includes(' x ')) return;
    const [golsA, golsB] = ft.split(' x ').map(Number);
    const total = golsA + golsB;
    [time_a, time_b].forEach(t => {
      if (!stats[t]) stats[t] = { name: t, totalGames: 0, marketCount: 0 };
    });
    stats[time_a].totalGames++;
    stats[time_b].totalGames++;
    if (isGreenForMercado(mercado, golsA, golsB, total)) {
      stats[time_a].marketCount++;
      stats[time_b].marketCount++;
    }
  });
  return Object.values(stats)
    .map(t => ({ ...t, percentage: t.totalGames > 0 ? ((t.marketCount / t.totalGames) * 100).toFixed(1) : '0.0' }))
    .sort((a, b) => b.marketCount - a.marketCount || parseFloat(b.percentage) - parseFloat(a.percentage));
}

/* =====================================================
   STREAK ATUAL DO MERCADO
   Conta quantos jogos CONSECUTIVOS est√£o no mesmo estado
   (green ou red) nos √∫ltimos resultados.
   ===================================================== */
function calcularStreak(dadosCru, mercado) {
  if (!dadosCru || dadosCru.length === 0) return { tipo: 'neutro', contagem: 0 };

  const ultimo = dadosCru[dadosCru.length - 1];
  const tipoUltimo = isGreenForMercado(mercado, ultimo[0], ultimo[1], ultimo[2]) ? 'green' : 'red';

  let contagem = 1;
  for (let i = dadosCru.length - 2; i >= 0; i--) {
    const [a, b, t] = dadosCru[i];
    const tipo = isGreenForMercado(mercado, a, b, t) ? 'green' : 'red';
    if (tipo === tipoUltimo) contagem++;
    else break;
  }

  return { tipo: tipoUltimo, contagem };
}

/* =====================================================
   SCORE DE CONFIAN√áA COMPOSTO (0‚Äì100)
   Pondera 4 dimens√µes em pesos diferentes:
   - Acerto do melhor padr√£o  40%
   - Temperatura do mercado   25%
   - Odd no top 5             20%
   - Volume de padr√µes bons   15%
   ===================================================== */
function calcularScoreConfianca(maiorAcerto, pctMercado, temOddTop5, qtdPadroesBons, totalPadroes) {
  const p1 = Math.min(maiorAcerto, 100) * 0.40;
  const p2 = Math.min(pctMercado, 100)  * 0.25;
  const p3 = temOddTop5 ? 20 : 0;
  const volPct = totalPadroes > 0 ? (qtdPadroesBons / totalPadroes) * 100 : 0;
  const p4 = Math.min(volPct, 100) * 0.15;
  const score = Math.round(p1 + p2 + p3 + p4);

  let label, emoji;
  if (score >= 80) { label = 'ALT√çSSIMA';  emoji = 'üü¢üü¢üü¢'; }
  else if (score >= 65) { label = 'ALTA';  emoji = 'üü¢üü¢'; }
  else if (score >= 50) { label = 'MODERADA'; emoji = 'üü°'; }
  else if (score >= 35) { label = 'BAIXA';  emoji = 'üü†'; }
  else { label = 'MUITO BAIXA'; emoji = 'üî¥'; }

  return { score, label, emoji };
}

/* =====================================================
   RANKING DE ODDS POR FAIXA
   Agrupa as odds em faixas (ex: 1.30‚Äì1.50) em vez de valor
   exato, gerando muito mais volume estat√≠stico e precis√£o.
   ===================================================== */
const FAIXAS_ODDS = [
  { label: '1.01‚Äì1.30', min: 1.01, max: 1.30 },
  { label: '1.31‚Äì1.50', min: 1.31, max: 1.50 },
  { label: '1.51‚Äì1.70', min: 1.51, max: 1.70 },
  { label: '1.71‚Äì1.90', min: 1.71, max: 1.90 },
  { label: '1.91‚Äì2.10', min: 1.91, max: 2.10 },
  { label: '2.11‚Äì2.30', min: 2.11, max: 2.30 },
  { label: '2.31‚Äì2.60', min: 2.31, max: 2.60 },
  { label: '2.61‚Äì3.00', min: 2.61, max: 3.00 },
  { label: '3.01‚Äì3.50', min: 3.01, max: 3.50 },
  { label: '3.51‚Äì4.50', min: 3.51, max: 4.50 },
  { label: '4.51‚Äì9.99', min: 4.51, max: 9.99 },
  { label: '10.00+',    min: 10.0, max: Infinity }
];

function getFaixaOdd(odd) {
  return FAIXAS_ODDS.find(f => odd >= f.min && odd <= f.max) || null;
}

function getOddFieldName(mercadoValue) {
  return ({
    'ambasMarcam':    'ambasSim',
    'ambasNaoMarcam': 'ambasNao',
    'casaVence':      'casaVence',
    'foraVence':      'visitanteVence',
    'empate':         'empate',
    'over1.5':        'over1_5',
    'under1.5':       'under1_5',
    'over2.5':        'over2_5',
    'under2.5':       'under2_5',
    'over3.5':        'over3_5',
    'under3.5':       'under3_5',
    'over5':          'over5'
  })[mercadoValue] || null;
}

function oddFieldToRawKey(oddField) {
  return ({
    'casaVence':      'casa_vence',
    'visitanteVence': 'visitante_vence',
    'empate':         'empate',
    'ambasSim':       'ambas_marcam_sim',
    'ambasNao':       'ambas_marcam_nao',
    'over1_5':        'mais_1_5',
    'under1_5':       'menos_1_5',
    'over2_5':        'mais_2_5',
    'under2_5':       'menos_2_5',
    'over3_5':        'mais_3_5',
    'under3_5':       'menos_3_5',
    'over5':          'mais_5_gols'
  })[oddField] || oddField;
}

function isGreenForMercado(mercado, a, b, total) {
  switch (mercado) {
    case 'ambasMarcam':    return a > 0 && b > 0;
    case 'ambasNaoMarcam': return a === 0 || b === 0;
    case 'casaVence':      return a > b;
    case 'foraVence':      return b > a;
    case 'empate':         return a === b;
    case 'over1.5':        return total >= 2;
    case 'under1.5':       return total < 2;
    case 'over2.5':        return total >= 3;
    case 'under2.5':       return total < 3;
    case 'over3.5':        return total >= 4;
    case 'under3.5':       return total < 4;
    case 'over5':          return total >= 5;
    case 'exact1':         return total === 1;
    case 'exact2':         return total === 2;
    case 'exact3':         return total === 3;
    case 'exact4':         return total === 4;
    default: return false;
  }
}

function calcularRankingOdds(dados, mercadoValue) {
  const { dadosCru, oddsRaw, oddsIndex } = dados;
  const oddField = getOddFieldName(mercadoValue);
  if (!oddField || !oddsRaw || oddsRaw.length === 0) return { rankingExato: [], rankingFaixas: [], top5Odds: new Set(), top3Faixas: new Set() };

  const rawKey = `odds_${oddFieldToRawKey(oddField)}`;

  /* ---- RANKING EXATO (valor exato da odd) ---- */
  const oddStats = {};
  oddsRaw.forEach(o => {
    const odd = parseFloat(o[rawKey] || 0);
    if (!odd || odd <= 0) return;
    const oddKey = odd.toFixed(2);
    const taKey  = (o.time_casa || '').trim().toLowerCase();
    const tbKey  = (o.time_visitante || '').trim().toLowerCase();

    // Cruza com resultado hist√≥rico
    const resultado = dadosCru.find(j => {
      const jA = (j[3]||'').toLowerCase().trim();
      const jB = (j[4]||'').toLowerCase().trim();
      return (jA===taKey && jB===tbKey) || (jA===tbKey && jB===taKey);
    });

    if (!oddStats[oddKey]) oddStats[oddKey] = { odd, jogos: 0, greens: 0 };
    oddStats[oddKey].jogos++;
    if (resultado && isGreenForMercado(mercadoValue, resultado[0], resultado[1], resultado[2])) {
      oddStats[oddKey].greens++;
    }
  });

  /* Fallback: se n√£o cruzou, usa todos os resultados com a mediana das odds */
  const temCruzamento = Object.values(oddStats).some(s => s.greens > 0 || s.jogos > 1);
  if (!temCruzamento) {
    const oddsDisp = oddsRaw.map(o => parseFloat(o[rawKey])).filter(v => v > 0);
    if (oddsDisp.length > 0) {
      oddsDisp.sort((a,b) => a-b);
      const mediana = oddsDisp[Math.floor(oddsDisp.length / 2)];
      const key = mediana.toFixed(2);
      dadosCru.forEach(j => {
        const [a, b, t] = j;
        if (!oddStats[key]) oddStats[key] = { odd: mediana, jogos: 0, greens: 0 };
        oddStats[key].jogos++;
        if (isGreenForMercado(mercadoValue, a, b, t)) oddStats[key].greens++;
      });
    }
  }

  const rankingExato = Object.values(oddStats)
    .filter(s => s.jogos >= 1)
    .map(s => ({ odd: s.odd, jogos: s.jogos, greens: s.greens, pct: ((s.greens/s.jogos)*100).toFixed(0) }))
    .sort((a,b) => parseFloat(b.pct)-parseFloat(a.pct) || b.greens-a.greens || b.jogos-a.jogos);

  const top5Odds = new Set(rankingExato.slice(0,5).map(r => r.odd.toFixed(2)));

  /* ---- RANKING POR FAIXAS (maior volume estat√≠stico) ---- */
  const faixaStats = {};
  FAIXAS_ODDS.forEach(f => { faixaStats[f.label] = { label: f.label, min: f.min, max: f.max, jogos: 0, greens: 0 }; });

  oddsRaw.forEach(o => {
    const odd = parseFloat(o[rawKey] || 0);
    if (!odd || odd <= 0) return;
    const faixa = getFaixaOdd(odd);
    if (!faixa) return;
    const taKey = (o.time_casa || '').trim().toLowerCase();
    const tbKey = (o.time_visitante || '').trim().toLowerCase();
    const resultado = dadosCru.find(j => {
      const jA = (j[3]||'').toLowerCase().trim();
      const jB = (j[4]||'').toLowerCase().trim();
      return (jA===taKey && jB===tbKey) || (jA===tbKey && jB===taKey);
    });
    faixaStats[faixa.label].jogos++;
    if (resultado && isGreenForMercado(mercadoValue, resultado[0], resultado[1], resultado[2])) {
      faixaStats[faixa.label].greens++;
    }
  });

  const rankingFaixas = Object.values(faixaStats)
    .filter(f => f.jogos >= 1)
    .map(f => ({ ...f, pct: ((f.greens/f.jogos)*100).toFixed(0) }))
    .sort((a,b) => parseFloat(b.pct)-parseFloat(a.pct) || b.greens-a.greens);

  const top3Faixas = new Set(rankingFaixas.slice(0,3).map(r => r.label));

  return { rankingExato: rankingExato.slice(0,20), rankingFaixas, top5Odds, top3Faixas };
}

/* Verifica se a odd de um jogo est√° em faixa favor√°vel */
function getOddNaFaixaTop(odd, top3Faixas) {
  if (!odd || !top3Faixas) return false;
  const faixa = getFaixaOdd(odd);
  return faixa ? top3Faixas.has(faixa.label) : false;
}

/* =====================================================
   WEB WORKER ‚Äî AN√ÅLISE DE PADR√ïES
   ===================================================== */
const ANALYZE_WORKER_SRC = `
  self.onmessage = (e) => {
    const p = e.data;
    if (!p || p.cmd !== 'analyze') return;
    self.postMessage({ ok: true, id: p.id, result: analyzeAll(p.payload) });
  };
  function enumerateCombos(tok){
    if(tok.length===1) return tok[0].map(t=>[t]);
    if(tok.length===2){ const o=[];for(const a of tok[0])for(const b of tok[1])o.push([a,b]);return o; }
    if(tok.length===3){ const o=[];for(const a of tok[0])for(const b of tok[1])for(const c of tok[2])o.push([a,b,c]);return o; }
    const out=[],cur=[];
    (function rec(i){ if(i===tok.length){out.push(cur.slice());return;}for(const t of tok[i]){cur.push(t);rec(i+1);cur.pop();} })(0);
    return out;
  }
  function getOffsets(t){
    if(t==='1')return[0];if(t==='2')return[0,1];if(t==='3')return[0,1,2];
    if(t==='1_pula_1')return[0,2];if(t==='1_pula_1_pula_1')return[0,2,4];return[0,1];
  }
  function tokens(a,b,total,man,vis){
    const t=new Set();
    t.add(\`\${a}-\${b}\`);
    t.add(a>0&&b>0?'ambasMarcam':'ambasNaoMarcam');
    t.add(a>b?'casaVence':a<b?'foraVence':'empate');
    if(total>=2)t.add('over1.5');if(total<2)t.add('under1.5');
    if(total>=3)t.add('over2.5');if(total<3)t.add('under2.5');
    if(total>=4)t.add('over3.5');if(total<4)t.add('under3.5');
    if(total>=5)t.add('over5');
    if(total===1)t.add('exact1');if(total===2)t.add('exact2');
    if(total===3)t.add('exact3');if(total===4)t.add('exact4');
    if(man)t.add(man.toLowerCase());if(vis)t.add(vis.toLowerCase());
    return Array.from(t);
  }
  function isGreen(m,a,b,total){
    if(m==='ambasMarcam')return a>0&&b>0;if(m==='ambasNaoMarcam')return a===0||b===0;
    if(m==='casaVence')return a>b;if(m==='foraVence')return a<b;if(m==='empate')return a===b;
    if(m==='over1.5')return total>=2;if(m==='under1.5')return total<2;
    if(m==='over2.5')return total>=3;if(m==='under2.5')return total<3;
    if(m==='over3.5')return total>=4;if(m==='under3.5')return total<4;
    if(m==='over5')return total>=5;
    if(m==='exact1')return total===1;if(m==='exact2')return total===2;
    if(m==='exact3')return total===3;if(m==='exact4')return total===4;
    return false;
  }
  function analisar(dados,tipo,tiros,market,ini,fim){
    const res=[];const offs=getOffsets(tipo);const last=offs[offs.length-1];
    for(let p=ini;p<=fim;p++){
      const comb={};const need=(last+1)+p+tiros;if(dados.length<need)continue;
      for(let i=0;i<=dados.length-need;i++){
        const tok=[];
        for(const o of offs){const[a,b,t,man,vis]=dados[i+o];tok.push(tokens(a,b,t,man,vis));}
        const combos=enumerateCombos(tok);let green=false;
        const st=i+last+1+p,end=st+tiros;
        for(let j=st;j<end&&j<dados.length;j++){const[a,b,s]=dados[j];if(isGreen(market,a,b,s)){green=true;break;}}
        for(const seq of combos){
          const key=seq.join(' | ');if(!comb[key])comb[key]={ocorrencias:0,greens:0};
          comb[key].ocorrencias++;if(green)comb[key].greens++;
        }
      }
      for(const k in comb){
        const s=comb[k];if(s.ocorrencias>=3)
          res.push({padrao:k,pular_jogos:p,ocorrencias:s.ocorrencias,greens:s.greens,
            percentual:((s.greens/s.ocorrencias)*100).toFixed(1)});
      }
    }
    res.sort((a,b)=>parseFloat(b.percentual)-parseFloat(a.percentual)||b.ocorrencias-a.ocorrencias);
    return res.slice(0,15);
  }
  function analyzeAll(payload){
    const{dados,tiros,market,combinado}=payload;
    const tipos=combinado?['2','3','1_pula_1','1_pula_1_pula_1']:['2'];
    let todos=[];
    for(const t of tipos){const r=analisar(dados,t,tiros,market,1,10);r.forEach(x=>x.tipo_padrao=t);todos=todos.concat(r);}
    todos.sort((a,b)=>parseFloat(b.percentual)-parseFloat(a.percentual)||b.ocorrencias-a.ocorrencias);
    return{resultados:todos.slice(0,15)};
  }
`;
let ANALYZE_WORKER = null;
function getAnalyzeWorker() {
  if (!ANALYZE_WORKER) {
    const blob = new Blob([ANALYZE_WORKER_SRC], { type: 'application/javascript' });
    ANALYZE_WORKER = new Worker(URL.createObjectURL(blob));
  }
  return ANALYZE_WORKER;
}
function analyzeInWorker(dados, opts) {
  return new Promise((resolve, reject) => {
    const w  = getAnalyzeWorker();
    const id = Math.random().toString(36).slice(2);
    const fn = ev => {
      const msg = ev.data;
      if (!msg || msg.id !== id) return;
      w.removeEventListener('message', fn);
      msg.ok ? resolve(msg.result) : reject(msg.error || 'Erro no worker');
    };
    w.addEventListener('message', fn);
    w.postMessage({ cmd: 'analyze', id, payload: { dados, ...opts } });
  });
}

/* =====================================================
   AN√ÅLISE DE MERCADO (GR√ÅFICO)
   ===================================================== */
function mapMercado(v) {
  return ({
    ambasMarcam:'ambasSim', ambasNaoMarcam:'ambasNao', casaVence:'casaVence',
    foraVence:'foraVence', empate:'empate', 'over1.5':'over1.5', 'over2.5':'over2.5',
    'over3.5':'over3.5', 'under1.5':'under1.5', 'under2.5':'under2.5', 'under3.5':'under3.5',
    exact1:'umGolExato', exact2:'doisGolsExatos', exact3:'tresGolsExatos',
    exact4:'quatroGolsExatos', over5:'cincoOuMaisGols'
  })[v] || v;
}
function checkMarket(m, hg, ag, tg) {
  switch(m) {
    case 'ambasSim':         return hg>0&&ag>0?1:0;
    case 'ambasNao':         return hg===0||ag===0?1:0;
    case 'casaVence':        return hg>ag?1:0;
    case 'foraVence':        return ag>hg?1:0;
    case 'empate':           return hg===ag?1:0;
    case 'over1.5':          return tg>1.5?1:0;
    case 'over2.5':          return tg>2.5?1:0;
    case 'over3.5':          return tg>3.5?1:0;
    case 'under1.5':         return tg<1.5?1:0;
    case 'under2.5':         return tg<2.5?1:0;
    case 'under3.5':         return tg<3.5?1:0;
    case 'umGolExato':       return tg===1?1:0;
    case 'doisGolsExatos':   return tg===2?1:0;
    case 'tresGolsExatos':   return tg===3?1:0;
    case 'quatroGolsExatos': return tg===4?1:0;
    case 'cincoOuMaisGols':  return tg>=5?1:0;
    default: return 0;
  }
}
function calculateMarketAnalysis(dados, sm, numJogos, linesToSum, verifyLines) {
  const cd = dados.dadosCru.map(i => [
    `${String(i[5]).padStart(2,'0')}:${String(i[6]).padStart(2,'0')}`,
    i[0], i[1], i[3], i[4], i[2], dados.liga.toLowerCase()
  ]).slice(-numJogos);
  if (!cd.length) return { currentPercentage: 0, top5: [] };
  const recent = cd.slice(-linesToSum);
  const curCount = recent.reduce((s,r) => s+checkMarket(sm,r[1],r[2],r[5]), 0);
  const currentPercentage = (curCount/linesToSum*100).toFixed(0);
  const groups = {};
  cd.forEach((row, i) => {
    if (i < linesToSum-1) return;
    const sum = cd.slice(i-linesToSum+1, i+1).reduce((s,r)=>s+checkMarket(sm,r[1],r[2],r[5]),0);
    const pct = Math.round(sum/linesToSum*100);
    let result = 'red';
    if (i+verifyLines <= cd.length) {
      const next = cd.slice(i+1, i+1+verifyLines);
      if (next.some(r => checkMarket(sm,r[1],r[2],r[5])===1)) result = 'green';
    }
    const key = `${sm} ${pct}%`;
    if (!groups[key]) groups[key] = { occurrences:0, greens:0, reds:0 };
    groups[key].occurrences++;
    result==='green' ? groups[key].greens++ : groups[key].reds++;
  });
  const sorted = Object.keys(groups).map(key => {
    const g = groups[key];
    const gp = (g.greens/g.occurrences*100).toFixed(2);
    const pn = parseFloat(gp);
    return { marketGroup:key, marketPercentage:parseFloat(key.split(' ')[1]),
      occurrences:g.occurrences, greens:g.greens, reds:g.reds, greenPercentage:gp,
      analysis: pn>75?'Alta chance de acerto':pn>50?'Moderada chance':pn>25?'Risco elevado':'Alta chance de falha' };
  }).sort((a,b)=>b.greenPercentage-a.greenPercentage||b.greens-a.greens);
  return { currentPercentage, top5: sorted.slice(0,5) };
}

/* =====================================================
   HELPERS ‚Äî ODDS
   ===================================================== */
function getOddDoMercado(oddsJogo, mercadoValue) {
  if (!oddsJogo) return null;
  const f = getOddFieldName(mercadoValue);
  return f ? (oddsJogo[f] || null) : null;
}
function avaliarOdd(odd) {
  if (!odd) return '';
  if (odd <= 1.40) return '(favorito forte)';
  if (odd <= 1.80) return '(bom valor)';
  if (odd <= 2.50) return '(risco moderado)';
  return '(odd alta)';
}
function buscarOddsJogo(oddsIndex, timeA, timeB) {
  if (!oddsIndex) return null;
  const kf = `${timeA.toLowerCase()}|${timeB.toLowerCase()}`;
  const kr = `${timeB.toLowerCase()}|${timeA.toLowerCase()}`;
  return oddsIndex[kf] || oddsIndex[kr] || null;
}

/* =====================================================
   MOTOR DE AN√ÅLISE LOCAL ‚Äî 100% INDEPENDENTE
   ===================================================== */
function gerarAnaliseLocal(dados, parametros) {
  const { mercado, mercadoValue, liga, martingale, observacao } = parametros;
  const { ranking, padroesEncontrados, proximos, marketAnalysis,
          totalJogos, oddsIndex, oddsDisponiveis,
          rankingExato, rankingFaixas, top5Odds, top3Faixas,
          streak } = dados;
  const L = [];

  const melhorPadrao      = padroesEncontrados[0];
  const maiorAcerto       = melhorPadrao ? parseFloat(melhorPadrao.percentual) : 0;
  const pct               = parseInt(marketAnalysis.currentPercentage, 10);
  const padroesBons       = padroesEncontrados.filter(p => parseFloat(p.percentual) >= 70);
  const padroesExcelentes = padroesEncontrados.filter(p => parseFloat(p.percentual) >= 90);
  const martMap           = { 'Nenhum':1, '1 Cobertura':2, '2 Coberturas':3, '3 Coberturas':4 };
  const qtd               = martMap[martingale] || 1;

  /* ‚îÄ‚îÄ CABE√áALHO COM TIMESTAMP ‚îÄ‚îÄ */
  const agora = new Date();
  const horaAnalise = `${String(agora.getHours()).padStart(2,'0')}:${String(agora.getMinutes()).padStart(2,'0')}`;
  L.push(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
  L.push(`  AN√ÅLISE GERADA: ${horaAnalise}  |  Liga: ${liga}  |  Mercado: ${mercado}`);
  L.push(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
  L.push('');

  /* ‚îÄ‚îÄ SCORE DE CONFIAN√áA ‚îÄ‚îÄ */
  const temOddTop5NosProximos = (proximos||[]).some(j => {
    const o = buscarOddsJogo(oddsIndex, j.time_a||'', j.time_b||'');
    const odd = getOddDoMercado(o, mercadoValue);
    return odd && top5Odds && top5Odds.has(odd.toFixed(2));
  });
  const { score, label, emoji } = calcularScoreConfianca(maiorAcerto, pct, temOddTop5NosProximos, padroesBons.length, padroesEncontrados.length);
  L.push(`üéØ SCORE DE CONFIAN√áA: ${score}/100 ‚Äî ${label} ${emoji}`);
  L.push(`   Padr√µes (${maiorAcerto}% acerto) √ó Mercado (${pct}%) √ó Odds Top5 (${temOddTop5NosProximos?'Sim':'N√£o'}) √ó Volume (${padroesBons.length}/${padroesEncontrados.length} padr√µes bons)`);
  L.push('');

  /* ‚îÄ‚îÄ STREAK ATUAL ‚îÄ‚îÄ */
  if (streak && streak.contagem > 0) {
    const streakEmoji = streak.tipo === 'green' ? '‚úÖ' : '‚ùå';
    const streakAlerta = streak.tipo === 'red' && streak.contagem >= 3
      ? ' ‚ö†Ô∏è  ATEN√á√ÉO: sequ√™ncia longa de reds ‚Äî poss√≠vel revers√£o pr√≥xima.'
      : streak.tipo === 'green' && streak.contagem >= 4
      ? ' ‚ÑπÔ∏è  Sequ√™ncia longa de greens ‚Äî mercado aquecido, mas fique atento a corre√ß√£o.'
      : '';
    L.push(`üî• STREAK ATUAL: ${streak.contagem}x ${streak.tipo.toUpperCase()} consecutivo(s) ${streakEmoji}${streakAlerta}`);
    L.push('');
  }

  /* ‚îÄ‚îÄ AN√ÅLISE ESTAT√çSTICA ‚îÄ‚îÄ */
  L.push('üìä AN√ÅLISE ESTAT√çSTICA');
  const topTimes = ranking.slice(0,5);
  if (topTimes.length > 0) {
    L.push('Times com maior hist√≥rico positivo:');
    L.push('  ' + topTimes.map(t => `${t.name} (${t.percentage}% / ${t.totalGames}j)`).join('  ¬∑  '));
  } else {
    L.push('Dados insuficientes de times para este mercado.');
  }
  L.push('');
  if (padroesEncontrados.length === 0) {
    L.push(`${totalJogos} jogos analisados ‚Äî nenhum padr√£o recorrente encontrado. Amplie o per√≠odo.`);
  } else {
    L.push(`${totalJogos} jogos analisados ‚Äî ${padroesBons.length} padr√£o(√µes) acima de 70%` +
      (padroesExcelentes.length > 0 ? `, sendo ${padroesExcelentes.length} acima de 90% ‚≠ê` : '.'));
  }
  L.push('');

  /* ‚îÄ‚îÄ PADR√ïES RELEVANTES ‚îÄ‚îÄ */
  L.push('üîé PADR√ïES RELEVANTES');
  if (padroesEncontrados.length === 0) {
    L.push('  Nenhum padr√£o encontrado com ocorr√™ncias suficientes.');
  } else {
    padroesEncontrados.slice(0,3).forEach((p, i) => {
      const nivel = parseFloat(p.percentual) >= 90 ? 'EXCELENTE ‚≠ê' : parseFloat(p.percentual) >= 70 ? 'FORTE ‚úÖ' : 'MODERADO üü°';
      const conf  = p.ocorrencias >= 10 ? 'alta confiabilidade' : p.ocorrencias >= 5 ? 'confiabilidade razo√°vel' : 'baixo volume';
      L.push(`  ${i+1}. "${p.padrao}"`);
      L.push(`     Acerto: ${p.percentual}% | ${p.greens}/${p.ocorrencias} ocorr√™ncias | ${nivel} | ${conf} | Saltos: ${p.pular_jogos}j`);
    });
  }
  L.push('');

  /* ‚îÄ‚îÄ RANKING DE ODDS POR FAIXA ‚îÄ‚îÄ */
  if (oddsDisponiveis && rankingFaixas && rankingFaixas.filter(f=>f.jogos>0).length > 0) {
    L.push(`üí∞ RANKING DE ODDS POR FAIXA ‚Äî "${mercado}"`);
    L.push('  (‚≠ê = faixa no top 3 de greens)');
    L.push('');
    L.push('  Faixa de Odd   | Jogos | Greens | %    |');
    L.push('  ---------------|-------|--------|------|');
    rankingFaixas.filter(f => f.jogos > 0).forEach(f => {
      const isTop = top3Faixas && top3Faixas.has(f.label);
      const barra = parseInt(f.pct)>=80?'‚ñà‚ñà‚ñà‚ñà':parseInt(f.pct)>=60?'‚ñà‚ñà‚ñà':parseInt(f.pct)>=40?'‚ñà‚ñà':'‚ñà';
      const mark  = isTop ? ' ‚≠ê' : '  ';
      L.push(`${mark} ${f.label.padEnd(14)} | ${String(f.jogos).padEnd(5)} | ${String(f.greens).padEnd(6)} | ${String(f.pct).padStart(3)}% | ${barra}`);
    });

    /* Ranking exato ‚Äî apenas os top 10 */
    if (rankingExato && rankingExato.length > 0) {
      L.push('');
      L.push('  Top 10 odds por valor exato:');
      L.push('  Odd    | Jogos | Greens | %');
      L.push('  -------|-------|--------|------');
      rankingExato.slice(0,10).forEach(r => {
        const mark = top5Odds && top5Odds.has(r.odd.toFixed(2)) ? '‚≠ê' : '  ';
        L.push(`  ${mark}${String(r.odd.toFixed(2)).padEnd(5)} | ${String(r.jogos).padEnd(5)} | ${String(r.greens).padEnd(6)} | ${r.pct}%`);
      });
    }
    L.push('');
  }

  /* ‚îÄ‚îÄ GR√ÅFICO DE MERCADO ‚îÄ‚îÄ */
  L.push('üìà TEMPERATURA DO MERCADO');
  const tend = pct>=70 ? 'üî• Mercado aquecido ‚Äî alta frequ√™ncia de greens recentes.'
    : pct>=50 ? 'üü° Frequ√™ncia moderada. Aten√ß√£o ao contexto antes de entrar.'
    : pct>=30 ? 'üü† Momento desfavor√°vel. Frequ√™ncia recente est√° baixa.'
    : '‚ùÑÔ∏è  Mercado frio. Frequ√™ncia muito baixa ‚Äî risco elevado.';
  L.push(`Porcentagem atual "${mercado}": ${pct}% ‚Äî ${tend}`);
  if (marketAnalysis.top5.length > 0) {
    L.push('');
    L.push('  Top 5 faixas de porcentagem com maior acerto p√≥s-entrada:');
    marketAnalysis.top5.forEach((item, i) => {
      L.push(`  ${i+1}. "${item.marketGroup}" ‚Üí ${item.greenPercentage}% acerto | ${item.occurrences}x | ‚úÖ${item.greens} ‚ùå${item.reds} ‚Äî ${item.analysis}`);
    });
  }
  L.push('');

  /* ‚îÄ‚îÄ PR√ìXIMAS OPORTUNIDADES ‚îÄ‚îÄ */
  L.push('‚ö° PR√ìXIMAS OPORTUNIDADES');
  const timesTop = new Set(ranking.slice(0,8).map(t => t.name.toLowerCase().trim()));
  const jogosBons = (proximos||[]).filter(j =>
    timesTop.has((j.time_a||'').toLowerCase().trim()) ||
    timesTop.has((j.time_b||'').toLowerCase().trim())
  );

  if (!melhorPadrao || maiorAcerto < 55) {
    L.push('  Nenhuma oportunidade clara identificada neste momento.');
    L.push(`  Acerto m√°ximo (${maiorAcerto}%) abaixo do m√≠nimo de 55%. Aguarde ou amplie o per√≠odo.`);
  } else {
    const candidatos = (jogosBons.length > 0 ? jogosBons : (proximos||[])).slice(0, qtd);
    if (candidatos.length === 0) {
      L.push('  N√£o h√° confrontos pr√≥ximos dispon√≠veis.');
    } else {
      L.push(`  Liga: ${liga}  |  Mercado: ${mercado}  |  Martingale: ${martingale}`);
      L.push('');
      L.push(`  ‚è∞ Hor√°rios: ${candidatos.map(j => j.horario).join(' ‚ñ∏ ')}`);
      L.push('');
      candidatos.forEach((j, i) => {
        const ta  = j.time_a || '‚Äî';
        const tb  = j.time_b || '‚Äî';
        const hr  = j.horario;
        const pre = i===0 ? '‚ñ∂ [Principal]  ' : `  [Cobertura ${i}]`;
        const oddsJogo = buscarOddsJogo(oddsIndex, ta, tb);
        const odd = getOddDoMercado(oddsJogo, mercadoValue);
        const oddStr = odd ? ` | Odd: ${odd.toFixed(2)} ${avaliarOdd(odd)}` : '';
        const oddKey = odd ? odd.toFixed(2) : null;
        const isExato = oddKey && top5Odds && top5Odds.has(oddKey);
        const isFaixa = odd && top3Faixas && getOddNaFaixaTop(odd, top3Faixas);
        const topStr  = isExato ? ' ‚≠ê ODD EXATA NO TOP 5!' : isFaixa ? ' ‚úÖ Faixa favor√°vel' : '';
        L.push(`  ${pre} ${hr} ‚Äî ${ta} x ${tb}${oddStr}${topStr}`);
      });
      L.push('');
      const justBase = jogosBons.length > 0
        ? 'Times com bom hist√≥rico no mercado detectados. '
        : 'Sele√ß√£o cronol√≥gica (nenhum time top nos pr√≥ximos). ';
      L.push(`  Justificativa: ${justBase}Padr√£o "${melhorPadrao.padrao}" ‚Üí ${melhorPadrao.percentual}% de acerto em ${melhorPadrao.ocorrencias} ocorr√™ncias.`);
    }
  }
  L.push('');

  /* ‚îÄ‚îÄ TODOS OS PR√ìXIMOS JOGOS COM ODD ‚îÄ‚îÄ */
  if (oddsDisponiveis && proximos && proximos.length > 0) {
    L.push(`üìã PR√ìXIMOS JOGOS ‚Äî ODD "${mercado}"`);
    L.push('  (‚≠ê = valor exato no top 5 | ‚úÖ = faixa no top 3)');
    L.push('');
    proximos.forEach(j => {
      const ta = j.time_a || '‚Äî';
      const tb = j.time_b || '‚Äî';
      const hr = j.horario;
      const oddsJogo = buscarOddsJogo(oddsIndex, ta, tb);
      const odd = getOddDoMercado(oddsJogo, mercadoValue);
      if (!odd) {
        L.push(`  ${hr} ‚Äî ${ta} x ${tb}  (odd n√£o dispon√≠vel)`);
        return;
      }
      const oddKey  = odd.toFixed(2);
      const isExato = top5Odds && top5Odds.has(oddKey);
      const isFaixa = top3Faixas && getOddNaFaixaTop(odd, top3Faixas);
      const mark    = isExato ? '‚≠ê' : isFaixa ? '‚úÖ' : '  ';
      L.push(`  ${mark} ${hr} ‚Äî ${ta} x ${tb}  | Odd: ${oddKey}`);
    });
    L.push('');
  }

  /* ‚îÄ‚îÄ ESTRAT√âGIA MARTINGALE ‚îÄ‚îÄ */
  L.push('üé≤ ESTRAT√âGIA MARTINGALE');
  const coberturas = qtd - 1;
  let aval;
  if (martingale === 'Nenhum') {
    aval = maiorAcerto>=70
      ? `Entrada simples sem cobertura. Com ${maiorAcerto}% de acerto, o risco √© controlado.`
      : `Entrada simples. Acerto m√°ximo: ${maiorAcerto}% ‚Äî proceda com cautela.`;
  } else {
    aval = maiorAcerto>=80
      ? `${coberturas} cobertura(s) bem embasada(s) (padr√£o ${maiorAcerto}%). Bom suporte estat√≠stico.`
      : maiorAcerto>=60
        ? `${coberturas} cobertura(s) razo√°vel (${maiorAcerto}% de acerto). Gerencie o tamanho das apostas.`
        : `${coberturas} cobertura(s) com risco elevado (${maiorAcerto}%). Aguarde padr√µes mais fortes.`;
  }
  L.push(`  ${aval}`);
  L.push('');

  /* ‚îÄ‚îÄ RECOMENDA√á√ÉO FINAL ‚îÄ‚îÄ */
  L.push('üí° RECOMENDA√á√ÉO FINAL');
  const melhorGrupo = marketAnalysis.top5[0];
  let rec;
  if (score >= 80) {
    rec = `‚úÖ ENTRADA FORTE (Score ${score}/100). Conflu√™ncia tripla detectada ‚Äî padr√µes, mercado e odds todos favor√°veis.`;
    if (melhorGrupo) rec += ` Faixa "${melhorGrupo.marketGroup}" ‚Üí ${melhorGrupo.greenPercentage}% de acerto p√≥s-entrada.`;
  } else if (score >= 65) {
    rec = `üü° ENTRADA (Score ${score}/100). Sinais positivos mas sem conflu√™ncia total. Gerencie a banca com disciplina.`;
    if (temOddTop5NosProximos) rec += ' Ponto positivo: odd dos pr√≥ximos jogos no top 5 hist√≥rico.';
  } else if (score >= 50) {
    rec = `üü† ENTRADA COM CAUTELA (Score ${score}/100). Indicadores moderados ‚Äî padr√µes: ${maiorAcerto}%, mercado: ${pct}%. Risco existe.`;
  } else {
    rec = `üî¥ AGUARDAR (Score ${score}/100). Indicadores abaixo do m√≠nimo de seguran√ßa. Monitore a pr√≥xima janela.`;
  }

  /* Alerta de streak adverso */
  if (streak && streak.tipo === 'red' && streak.contagem >= 4) {
    rec += ` ‚ö†Ô∏è Streak de ${streak.contagem}x red ‚Äî momento de alta revers√£o potencial, mas tamb√©m de alto risco acumulado.`;
  }

  if (observacao && observacao.trim()) rec += ` | Obs: "${observacao.trim()}"`;
  L.push(`  ${rec}`);
  L.push('');
  L.push(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);

  return L.join('\n');
}

/* =====================================================
   FUN√á√ÉO PRINCIPAL
   ===================================================== */
async function gerarAnalise() {
  const MAX_ANALYSES_PER_DAY = 6;
  const COOLDOWN_MINUTES     = 3;
  const now   = new Date();
  const today = now.toISOString().split('T')[0];

  let usageData = JSON.parse(localStorage.getItem('analysisUsage')) || {};
  if (usageData.date !== today) usageData = { date: today, count: 0, lastAnalysis: null };

  if (usageData.count >= MAX_ANALYSES_PER_DAY) {
    alert('Voc√™ atingiu o limite de 6 an√°lises por dia. Por favor, volte amanh√£.');
    return;
  }
  if (usageData.lastAnalysis) {
    const diff = (now - new Date(usageData.lastAnalysis)) / 60000;
    if (diff < COOLDOWN_MINUTES) {
      alert(`Aguarde ${Math.ceil(COOLDOWN_MINUTES - diff)} minuto(s) antes de uma nova an√°lise.`);
      return;
    }
  }

  const casa         = getSelectedValue('casas-group');
  const liga         = getSelectedValue('ligas-group');
  const mercadoValue = getSelectedValue('mercados-group');
  const mercadoText  = getSelectedText('mercados-group');
  const martCob      = parseInt(getSelectedValue('martingale-group') || '0', 10);
  const martText     = getSelectedText('martingale-group');
  const periodo      = getSelectedValue('periodo-group');
  const observacao   = document.getElementById('observacao').value;
  const imagem       = document.getElementById('image-upload').files[0];

  if (!casa || !liga || !mercadoValue || !periodo) {
    alert('Por favor, selecione Casa, Liga, Mercado e Per√≠odo de An√°lise.');
    return;
  }

  const generateBtn     = document.querySelector('.btn-generate');
  const resultContainer = document.getElementById('result-container');
  const resultTitle     = document.getElementById('result-title');
  const resultContent   = document.getElementById('result-content');

  generateBtn.disabled  = true;
  generateBtn.innerHTML = '<div class="spinner"></div> Processando...';
  resultContainer.style.display = 'block';
  resultContent.innerHTML = '';

  try {
    resultTitle.innerHTML = `<div class="loading"><div class="spinner"></div>Coletando ${periodo} jogos...</div>`;
    const dados = await buscarDadosAPI(casa, liga, parseInt(periodo));

    dados.ranking = calcularRankingTimes(
      dados.dadosCru.map(j => ({ time_a: j[3], time_b: j[4], ft: `${j[0]} x ${j[1]}` })),
      mercadoValue
    );

    // Streak atual
    dados.streak = calcularStreak(dados.dadosCru, mercadoValue);

    resultTitle.innerHTML = '<div class="loading"><div class="spinner"></div>Analisando padr√µes e odds...</div>';

    const tiros = martCob + 1;
    const workerResult = await analyzeInWorker(dados.dadosCru, { tiros, market: mercadoValue, combinado: true });
    dados.padroesEncontrados = workerResult.resultados;

    // Ranking de odds (exato + faixas)
    const { rankingExato, rankingFaixas, top5Odds, top3Faixas } = calcularRankingOdds(dados, mercadoValue);
    dados.rankingExato  = rankingExato;
    dados.rankingFaixas = rankingFaixas;
    dados.top5Odds      = top5Odds;
    dados.top3Faixas    = top3Faixas;

    const sm         = mapMercado(mercadoValue);
    const linesToSum = casa === 'kiron' ? 30 : 20;
    dados.marketAnalysis = calculateMarketAnalysis(dados, sm, dados.totalJogos, linesToSum, martCob + 1);

    resultTitle.innerHTML = '<div class="loading"><div class="spinner"></div>Gerando an√°lise...</div>';

    const analise = gerarAnaliseLocal(dados, {
      mercado:      mercadoText,
      mercadoValue,
      liga,
      martingale:   martText || 'Nenhum',
      periodo:      periodo + ' jogos',
      observacao,
      imagem:       !!imagem
    });

    resultTitle.innerHTML = `‚úì An√°lise Conclu√≠da ‚Äî ${casasConfig[casa].name} (${liga})`;
    resultContent.textContent = analise;

    usageData.count++;
    usageData.lastAnalysis = now.toISOString();
    localStorage.setItem('analysisUsage', JSON.stringify(usageData));
    atualizarContadorUI();

  } catch (error) {
    resultTitle.innerHTML = '‚úñ Erro na An√°lise';
    resultContent.innerHTML = `<div class="error">
      <strong>Erro:</strong> ${error.message}<br><br>
      Atualize a p√°gina e tente novamente.
    </div>`;
  } finally {
    generateBtn.disabled  = false;
    generateBtn.innerHTML = 'Gerar An√°lise';
  }
}

/* =====================================================
   UPLOAD DE IMAGEM
   ===================================================== */
document.getElementById('image-upload').addEventListener('change', function(event) {
  const file    = event.target.files[0];
  const preview = document.getElementById('image-preview');
  const status  = document.getElementById('image-status');
  if (file) {
    const reader = new FileReader();
    reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
    reader.readAsDataURL(file);
    status.textContent = file.name;
  } else {
    preview.style.display = 'none';
    status.textContent = 'Nenhum arquivo selecionado';
  }
});

/* =====================================================
   PROTE√á√ÉO ANTI-DEVTOOLS
   ===================================================== */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (e.key==='F12'||
     (e.ctrlKey&&e.shiftKey&&['I','J','C'].includes(e.key))||
     (e.ctrlKey&&['u','s','p'].includes(e.key))) e.preventDefault();
});
const devtools = { open: false };
const _el = new Image();
Object.defineProperty(_el, 'id', { get() { devtools.open = true; } });
(function() {
  const check = () => {
    if ((window.outerWidth-window.innerWidth)>160||(window.outerHeight-window.innerHeight)>160)
      devtools.open = true;
  };
  window.addEventListener('resize', check);
  setInterval(check, 500);
})();
console.log('%c', _el);
setInterval(() => {
  if (devtools.open) { document.body.innerHTML='<h1>Acesso n√£o autorizado detectado</h1>'; devtools.open=false; }
}, 1000);
document.addEventListener('selectstart', e => e.preventDefault());
document.addEventListener('dragstart',   e => e.preventDefault());
console.log=console.debug=console.info=()=>{};
    </script>

<script>
  fetch('header.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('header').innerHTML = data;
    });
</script>
<script src="redirecionar.js"></script>
  </body>
</html>