<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4WT805FFHQ"></script>
    <title>BetStat</title>
    <meta name="description" content="Transforme suas apostas com BetStat - a única plataforma especializada em futebol virtual Betano. Análises precisas, estatísticas confiáveis e resultados comprovados para investimentos inteligentes.">
    <meta name="keywords" content="BetStat, apostas esportivas, futebol virtual, Betano, estatísticas apostas, análise apostas, investimentos esportivos">
    <meta property="og:title" content="BetStat | Plataforma de Análise para Apostas Esportivas">
    <meta property="og:description" content="Transforme suas apostas com análises precisas e estatísticas confiáveis. A única plataforma especializada em futebol virtual Betano.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.betstat.site/payment.html">
    <meta property="og:site_name" content="BetStat">
    <meta name="robots" content="index, follow">
    <meta name="author" content="BetStat">
    <meta name="canonical" href="https://www.betstat.site/payment.html">
    <script type="module" src="js/firebase-auth.js"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4WT805FFHQ');
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet" />

    <style>
    body { font-family: "Roboto", Arial, sans-serif; margin: 30px; background-color: #1c1f26; color: #ffffff; }
    .logo2 { width: 60px; height: auto; }
    .espaco { width: 50px; height: 50px; }
    option:hover { background-color: #ff8000; color: #ffffff; }
    canvas { cursor: pointer; }
    button { background-color: #1c1f26; color: rgb(255, 255, 255); font-family: "Roboto", Arial, sans-serif; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; margin: 10px; }
    button:hover { background-color: #0f1013; }
    option { background-color: #1c1f26; color: #ffffff; }
    select { width: 100%; padding: 5px; border-radius: 5px; background-color: #1c1f26; color: #ffffff; font-family: "Roboto", Arial, sans-serif; font-size: 14px; cursor: pointer; transition: border-color 0.3s; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    .logo { height: 30px; }
    .selectors-container { display: flex; align-items: center; gap: 10px; }
    .nav-seletor { display: flex; align-items: center; color: #ffffff; font-weight: 500; }
    .nav-seletor select { padding: 0.5rem; border-radius: 6px; background-color: #1c1f26; color: var(--text-color); border: 1px solid #ffffff9f; cursor: pointer; transition: all 0.3s ease; }
    .logout-btn { background-color: #1c1f26; color: white; padding: 8px 10px; font-size: 14px; border-radius: 5px; cursor: pointer; border: 1px solid #ffffff81; }
    .logout-btn:hover { background-color: #720000; }
    h1, h2, label { color: #1fad8b; }
    h1 { font-size: 24px; margin-bottom: 20px; text-align: center; }
    .control-panel { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    select { padding: 8px 12px; background-color: #292d36; color: #e0e0e0; border: 1px solid #1fad8b; border-radius: 4px; font-size: 14px; cursor: pointer; transition: border-color 0.3s; }
    select:hover { border-color: #34d8ab; }
    select:focus { outline: none; border-color: #1fad8b; }
    .chart-container { background-color: #292d36; border-radius: 8px; padding: 15px; margin-bottom: 40px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
    .chart-container h2 { font-size: 18px; margin-bottom: 10px; text-align: center; }
    canvas { border-radius: 4px; }
    .checkbox-container { display: flex; align-items: center; gap: 8px; }
    input[type="checkbox"] { cursor: pointer; }
    .accordion { margin-bottom: 10px; }
    .accordion-header { background-color: #292d36; color: #1fad8b; padding: 10px; cursor: pointer; border: 1px solid #1fad8b; border-radius: 4px; font-size: 18px; text-align: center; }
    .accordion-header:hover { background-color: #34383f; }
    .accordion-content { display: none; padding: 10px; }
    .accordion-content.active { display: block; }
    </style>
</head>

<body>
    <div id="header"></div>
    <br><br><br>

    <div class="control-panel">
        <div>
            <label for="pointsSelector">Horas</label>
            <select id="pointsSelector">
                <option value="20">1 Hora</option>
                <option value="40">2 Horas</option>
                <option value="60">3 Horas</option>
                <option value="80">4 Horas</option>
                <option value="100">5 Horas</option>
                <option value="120">6 Horas</option>
                <option value="140">7 Horas</option>
                <option value="160">8 Horas</option>
                <option value="180">9 Horas</option>
                <option value="200">10 Horas</option>
                <option value="220">11 Horas</option>
                <option value="240">12 Horas</option>
                <option value="480">24 Horas</option>
                <option value="960">48 Horas</option>
            </select>
        </div>
        <div>
            <label for="averageSelector">Base</label>
            <select id="averageSelector">
                <option value="29">Base 30</option>
                <option value="59">Base 60</option>
                <option value="79">Base 80</option>
            </select>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="fibonacciToggle">
            <label for="fibonacciToggle">Ativar Fibonacci</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="dataLabelsToggle">
            <label for="dataLabelsToggle">Ativar Rótulos</label>
        </div>
    </div>

    <div class="accordion">
        <div class="accordion-header">England</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>England</h2>
                <canvas id="EnglandChart" width="400" height="130"></canvas>
            </div>
        </div>
    </div>
    <div class="accordion">
        <div class="accordion-header">Italy</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Italy</h2>
                <canvas id="ItalyChart" width="400" height="130"></canvas>
            </div>
        </div>
    </div>
    <div class="accordion">
        <div class="accordion-header">Spain</div>
        <div class="accordion-content">
            <div class="chart-container">
                <h2>Spain</h2>
                <canvas id="SpainChart" width="400" height="130"></canvas>
            </div>
        </div>
    </div>

    <script>
        fetch('header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header').innerHTML = data;
            });
    </script>
    <script src="redirecionar.js"></script>

    <script>
        let EnglandChart, ItalyChart, SpainChart;
        let numPoints = 20; // Valor inicial do seletor
        let averagePoints = 29; // Valor inicial do seletor
        let showFibonacciLines = false;
        let showDataLabels = false;
        const leagues = ['England', 'Italy', 'Spain'];
        const chartInstances = {};
        let chartData = {};

        const statsChartVisibleDatasets = { 'Gols FT': false, 'Casa Vence': false, 'Empate': false, 'Fora Vence': false, 'Ambas Sim': true, 'Ambas Não': false, 'Over 1.5': false, 'Over 2.5': false, 'Over 3.5': false, 'Under 1.5': false, 'Under 2.5': false, 'Under 3.5': false, '0 Gol Exato': false, '1 Gol Exato': false, '2 Gols Exatos': false, '3 Gols Exatos': false, '4 Gols Exatos': false, '5 Gols Exatos': false };

        function formatHtResult(ht) {
            if (ht === 'OUT') return 'OUT';
            if (ht && ht.includes(' x ')) {
                const parts = ht.split(' x ');
                if (parts.length === 2) return `${parts[0]}-${parts[1]}`;
            }
            return ht;
        }
        
        function updateStatsChart(chart, newData) {
            if (chart) {
                chart.data.labels = newData.labels;
                chart.data.datasets.forEach((dataset, index) => {
                    const key = Object.keys(newData)[index + 1]; // +1 to skip 'labels'
                    dataset.data = newData[key];
                });
                chart.update('none');
            }
        }

        function processApiData(data, league) {
            // LÓGICA DE ORDENAÇÃO E FILTRAGEM RESTAURADA
            const sortedData = [...data].sort((a, b) => {
                const dateA = new Date(a.data);
                const dateB = new Date(b.data);
                if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                if (a.hora !== b.hora) return a.hora - b.hora;
                return a.minuto - b.minuto;
            });

            const slicedData = sortedData.slice(-numPoints - averagePoints);
            chartData[league] = slicedData;

            let labels = [];
            let golsFT = [], casaVence = [], empate = [], foraVence = [], ambasSim = [], ambasNao = [], over15 = [], over25 = [], over35 = [], under15 = [], under25 = [], under35 = [], gol0 = [], gol1 = [], gol2 = [], gol3 = [], gol4 = [], gol5 = [];

            // Função para verificar se há lacuna entre dois jogos
            function hasGap(prevMatch, currMatch) {
                if (!prevMatch || !currMatch) return false;
                const prevTime = new Date(`${prevMatch.data}T${String(prevMatch.hora).padStart(2, '0')}:${String(prevMatch.minuto).padStart(2, '0')}:00`);
                const currTime = new Date(`${currMatch.data}T${String(currMatch.hora).padStart(2, '0')}:${String(currMatch.minuto).padStart(2, '0')}:00`);
                const diffMinutes = (currTime - prevTime) / (1000 * 60);
                return diffMinutes > 5; // Considera lacuna se a diferença for maior que 5 minutos
            }
            
            // LÓGICA DE CÁLCULO DA MÉDIA MÓVEL RESTAURADA
            for (let i = averagePoints; i < slicedData.length; i++) {
                const currentMatch = slicedData[i];
                const prevMatch = slicedData[i - 1];

                labels.push(`${currentMatch.hora}:${String(currentMatch.minuto).padStart(2, '0')}`);
                
                // LÓGICA DE GAP MELHORADA: se houver lacuna, insere null e pula para o próximo ponto
                if (hasGap(prevMatch, currentMatch)) {
                    [golsFT, casaVence, empate, foraVence, ambasSim, ambasNao, over15, over25, over35, under15, under25, under35, gol0, gol1, gol2, gol3, gol4, gol5].forEach(arr => arr.push(null));
                    continue;
                }

                let golsFTSum = 0, casaVenceSum = 0, empateSum = 0, foraVenceSum = 0, ambasSimSum = 0, ambasNaoSum = 0, over15Sum = 0, over25Sum = 0, over35Sum = 0, under15Sum = 0, under25Sum = 0, under35Sum = 0, gol0Sum = 0, gol1Sum = 0, gol2Sum = 0, gol3Sum = 0, gol4Sum = 0, gol5Sum = 0;
                let validMatchesInWindow = 0;

                // Loop interno para calcular a média móvel sobre a "base"
                for (let j = i - averagePoints; j <= i; j++) {
                    const match = slicedData[j];
                    if (!match || !match.ft) continue;

                    let ftScoreParts = [0, 0];
                    if (match.ft.includes(' x ')) {
                        ftScoreParts = match.ft.split(' x ').map(num => parseInt(num, 10));
                    }
                    const totalGolsFT = ftScoreParts[0] + ftScoreParts[1];

                    golsFTSum += totalGolsFT;
                    casaVenceSum += ftScoreParts[0] > ftScoreParts[1] ? 1 : 0;
                    empateSum += ftScoreParts[0] === ftScoreParts[1] ? 1 : 0;
                    foraVenceSum += ftScoreParts[0] < ftScoreParts[1] ? 1 : 0;
                    ambasSimSum += ftScoreParts[0] > 0 && ftScoreParts[1] > 0 ? 1 : 0;
                    ambasNaoSum += ftScoreParts[0] === 0 || ftScoreParts[1] === 0 ? 1 : 0;
                    over15Sum += totalGolsFT > 1.5 ? 1 : 0;
                    over25Sum += totalGolsFT > 2.5 ? 1 : 0;
                    over35Sum += totalGolsFT > 3.5 ? 1 : 0;
                    under15Sum += totalGolsFT < 1.5 ? 1 : 0;
                    under25Sum += totalGolsFT < 2.5 ? 1 : 0;
                    under35Sum += totalGolsFT < 3.5 ? 1 : 0;
                    gol0Sum += totalGolsFT === 0 ? 1 : 0;
                    gol1Sum += totalGolsFT === 1 ? 1 : 0;
                    gol2Sum += totalGolsFT === 2 ? 1 : 0;
                    gol3Sum += totalGolsFT === 3 ? 1 : 0;
                    gol4Sum += totalGolsFT === 4 ? 1 : 0;
                    gol5Sum += totalGolsFT === 5 ? 1 : 0;
                    validMatchesInWindow++;
                }
                
                const avg = validMatchesInWindow || 1;
                golsFT.push(golsFTSum / avg); // Média de Gols
                casaVence.push(casaVenceSum / avg * 100);
                empate.push(empateSum / avg * 100);
                foraVence.push(foraVenceSum / avg * 100);
                ambasSim.push(ambasSimSum / avg * 100);
                ambasNao.push(ambasNaoSum / avg * 100);
                over15.push(over15Sum / avg * 100);
                over25.push(over25Sum / avg * 100);
                over35.push(over35Sum / avg * 100);
                under15.push(under15Sum / avg * 100);
                under25.push(under25Sum / avg * 100);
                under35.push(under35Sum / avg * 100);
                gol0.push(gol0Sum / avg * 100);
                gol1.push(gol1Sum / avg * 100);
                gol2.push(gol2Sum / avg * 100);
                gol3.push(gol3Sum / avg * 100);
                gol4.push(gol4Sum / avg * 100);
                gol5.push(gol5Sum / avg * 100);
            }
            return { labels, golsFT, casaVence, empate, foraVence, ambasSim, ambasNao, over15, over25, over35, under15, under25, under35, gol0, gol1, gol2, gol3, gol4, gol5 };
        }

        Chart.register(ChartDataLabels);

        const fibonacciLinesPlugin = { /* ... sem alterações ... */ };
        
        function createStatsChart(ctx, labels, data, league) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Gols FT', data: data.golsFT, borderColor: '#1E88E5', backgroundColor: '#1E88E5', hidden: !statsChartVisibleDatasets['Gols FT'], yAxisID: 'yGoals' },
                        { label: 'Casa Vence', data: data.casaVence, borderColor: '#AB47BC', backgroundColor: '#AB47BC', hidden: !statsChartVisibleDatasets['Casa Vence'], yAxisID: 'yPercentage' },
                        { label: 'Empate', data: data.empate, borderColor: '#78909C', backgroundColor: '#78909C', hidden: !statsChartVisibleDatasets['Empate'], yAxisID: 'yPercentage' },
                        { label: 'Fora Vence', data: data.foraVence, borderColor: '#2196F3', backgroundColor: '#2196F3', hidden: !statsChartVisibleDatasets['Fora Vence'], yAxisID: 'yPercentage' },
                        { label: 'Ambas Sim', data: data.ambasSim, borderColor: '#B0BEC5', backgroundColor: '#B0BEC5', hidden: !statsChartVisibleDatasets['Ambas Sim'], yAxisID: 'yPercentage' },
                        { label: 'Ambas Não', data: data.ambasNao, borderColor: '#F44336', backgroundColor: '#F44336', hidden: !statsChartVisibleDatasets['Ambas Não'], yAxisID: 'yPercentage' },
                        { label: 'Over 1.5', data: data.over15, borderColor: '#26A69A', backgroundColor: '#26A69A', hidden: !statsChartVisibleDatasets['Over 1.5'], yAxisID: 'yPercentage' },
                        { label: 'Over 2.5', data: data.over25, borderColor: '#FFEB3B', backgroundColor: '#FFEB3B', hidden: !statsChartVisibleDatasets['Over 2.5'], yAxisID: 'yPercentage' },
                        { label: 'Over 3.5', data: data.over35, borderColor: '#00BCD4', backgroundColor: '#00BCD4', hidden: !statsChartVisibleDatasets['Over 3.5'], yAxisID: 'yPercentage' },
                        { label: 'Under 1.5', data: data.under15, borderColor: '#388E3C', backgroundColor: '#388E3C', hidden: !statsChartVisibleDatasets['Under 1.5'], yAxisID: 'yPercentage' },
                        { label: 'Under 2.5', data: data.under25, borderColor: '#FF9800', backgroundColor: '#FF9800', hidden: !statsChartVisibleDatasets['Under 2.5'], yAxisID: 'yPercentage' },
                        { label: 'Under 3.5', data: data.under35, borderColor: '#F06292', backgroundColor: '#F06292', hidden: !statsChartVisibleDatasets['Under 3.5'], yAxisID: 'yPercentage' },
                        { label: '0 Gol Exato', data: data.gol0, borderColor: '#D81B60', backgroundColor: '#D81B60', hidden: !statsChartVisibleDatasets['0 Gol Exato'], yAxisID: 'yPercentage' },
                        { label: '1 Gol Exato', data: data.gol1, borderColor: '#8E24AA', backgroundColor: '#8E24AA', hidden: !statsChartVisibleDatasets['1 Gol Exato'], yAxisID: 'yPercentage' },
                        { label: '2 Gols Exatos', data: data.gol2, borderColor: '#A0522D', backgroundColor: '#A0522D', hidden: !statsChartVisibleDatasets['2 Gols Exatos'], yAxisID: 'yPercentage' },
                        { label: '3 Gols Exatos', data: data.gol3, borderColor: '#546E7A', backgroundColor: '#546E7A', hidden: !statsChartVisibleDatasets['3 Gols Exatos'], yAxisID: 'yPercentage' },
                        { label: '4 Gols Exatos', data: data.gol4, borderColor: '#FFB300', backgroundColor: '#FFB300', hidden: !statsChartVisibleDatasets['4 Gols Exatos'], yAxisID: 'yPercentage' },
                        { label: '5 Gols Exatos', data: data.gol5, borderColor: '#00897B', backgroundColor: '#00897B', hidden: !statsChartVisibleDatasets['5 Gols Exatos'], yAxisID: 'yPercentage' }
                    ].map(dataset => ({ ...dataset, borderWidth: 2, pointRadius: 4, pointBackgroundColor: dataset.borderColor, fill: false, spanGaps: true }))
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true, labels: { color: '#e0e0e0', font: { size: 12 } },
                            onClick: (e, legendItem, legend) => { const index = legendItem.datasetIndex; const ci = legend.chart; ci.isDatasetVisible(index) ? ci.hide(index) : ci.show(index); statsChartVisibleDatasets[legendItem.text] = ci.isDatasetVisible(index); }
                        },
                        datalabels: { display: showDataLabels, color: '#e0e0e0', font: { size: 10 }, formatter: (value) => Math.round(value * 10) / 10, anchor: 'end', align: 'top' },
                        tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)', titleColor: '#1fad8b', bodyColor: '#e0e0e0', callbacks: { /* ... */ } }
                    },
                    scales: {
                        x: { ticks: { color: '#b0b0b0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        yPercentage: { type: 'linear', position: 'left', min: 0, max: 100, title: { display: true, text: 'Percentual (%)', color: '#1fad8b' }, ticks: { color: '#b0b0b0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        yGoals: { type: 'linear', position: 'right', beginAtZero: true, title: { display: true, text: 'Média de Gols', color: '#1fad8b' }, ticks: { color: '#b0b0b0' }, grid: { drawOnChartArea: false } }
                    }
                },
                plugins: [ChartDataLabels, fibonacciLinesPlugin]
            });
        }

        function updateCharts() {
            const timestamp = new Date().getTime();
            const leagueUrls = {
                'England': `https://betstat.site/resultados/kiron/England?t=${timestamp}`,
                'Italy': `https://betstat.site/resultados/kiron/Italy?t=${timestamp}`,
                'Spain': `https://betstat.site/resultados/kiron/Spain?t=${timestamp}`,
            };

            leagues.forEach(league => {
                fetch(leagueUrls[league])
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        const processedData = processApiData(data, league);
                        
                        // AQUI ESTÁ A CORREÇÃO DO BUG ORIGINAL
                        const chartId = `${league}Chart`;
                        
                        const canvasElement = document.getElementById(chartId);
                        if (!canvasElement) {
                            console.error(`Canvas com ID '${chartId}' não encontrado.`);
                            return;
                        }

                        if (!chartInstances[league]) {
                            const ctx = canvasElement.getContext('2d');
                            chartInstances[league] = createStatsChart(ctx, processedData.labels, processedData, league);
                        } else {
                            updateStatsChart(chartInstances[league], processedData);
                        }
                    })
                    .catch(error => console.error(`Erro ao buscar dados para ${league}:`, error));
            });
        }

        // --- Event Listeners ---
        document.querySelectorAll('.accordion-header').forEach(header => { header.addEventListener('click', () => { header.nextElementSibling.classList.toggle('active'); }); });
        document.getElementById('pointsSelector').addEventListener('change', function (event) { numPoints = parseInt(event.target.value, 10); updateCharts(); });
        document.getElementById('averageSelector').addEventListener('change', function (event) { averagePoints = parseInt(event.target.value, 10); updateCharts(); });
        document.getElementById('fibonacciToggle').addEventListener('change', () => { showFibonacciLines = !showFibonacciLines; leagues.forEach(l => chartInstances[l]?.update()); });
        document.getElementById('dataLabelsToggle').addEventListener('change', () => { showDataLabels = !showDataLabels; leagues.forEach(l => { if (chartInstances[l]) { chartInstances[l].options.plugins.datalabels.display = showDataLabels; chartInstances[l].update(); } }); });

        window.onload = updateCharts;
        setInterval(updateCharts, 60000); // Recomendo um intervalo maior, como 1 minuto (60000 ms), para não sobrecarregar a API
    </script>

</body>
</html>