<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BetStat</title>
  <style>
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="errorMessage" class="error-message" style="display: none;"></div>
  <div class="seletor-container">
    <div class="seletor-mostrar-times">
      <select id="mostrarTimes">
        <option value="nao" selected>Ver Times:N√£o</option>
        <option value="sim">Ver Times:Sim</option>
      </select>
    </div>

    <div class="seletor-mostrar-ht">
      <select id="mostrarHT">
        <option value="nao" selected>Ver HT:N√£o</option>
        <option value="sim">Ver HT:Sim</option>
      </select>
    </div>

    <div class="seletor-horas">
      <select id="seletorHoras">
        <option value="3">Horas:3</option>
        <option value="6">Horas:6</option>
        <option value="12" selected>Horas:12</option>
        <option value="24">Horas:24</option>
        <option value="48">Horas:48</option>
        <option value="72">Horas:72</option>
      </select>
    </div>

    <div class="seletor-resultado">
      <select id="seletorResultado">
        <option value="ambasMarcam" selected>Ambas Sim</option>
        <option value="ambasNaoMarcam">Ambas N√£o</option>
        <option value="casaVence">Casa vence</option>
        <option value="foraVence">Fora vence</option>
        <option value="empate">Empate</option>
        <option value="over1.5">Over 1.5</option>
        <option value="under1.5">Under 1.5</option>
        <option value="over2.5">Over 2.5</option>
        <option value="under2.5">Under 2.5</option>
        <option value="over3.5">Over 3.5</option>
        <option value="under3.5">Under 3.5</option>
        <option value="over5">Over 5+</option>
      </select>
    </div>

    <div class="seletor-ver-odds">
      <select id="mostrarOdds">
        <option value="nao" selected>Ver Odds:N√£o</option>
        <option value="sim">Ver Odds:Sim</option>
      </select>
    </div>

    <div class="seletor-tipo-placar">
      <select id="seletorTipoPlacar">
        <option value="ft" selected>Resultado:FT</option>
        <option value="ht">Resultado:HT</option>
      </select>
    </div>

    <div id="resultDisplay">
      <div id="totalGols">0</div>
      <div id="mediaGolsHora">0</div>
      <h4 class="custom-color">Ta√ßa Gl√≥ria Eterna</h4>
    </div>

    <div id="resultDisplay">
      <div id="greenPercentage">Greens: 32.5%</div>
      <div id="redPercentage">Reds: 67.5%</div>
    </div>
  </div>

  <table id="tabelaResultados">
    <thead>
      <div class="minutofixo-header">
        <div id="market-percentages"></div>
      </div>
      <tr id="linhaPercentual">
        <th>üìä</th>
      </tr>
      <tr id="linhaTotalGols">
        <th>‚öΩ</th>
      </tr>
      <tr id="linhaAcertosMercado">
        <th>‚úîÔ∏è</th>
      </tr>
      <tr>
        <th>H/M</th>
        <th class="minute-header">1</th>
        <th class="minute-header">4</th>
        <th class="minute-header">7</th>
        <th class="minute-header">10</th>
        <th class="minute-header">13</th>
        <th class="minute-header">16</th>
        <th class="minute-header">19</th>
        <th class="minute-header">22</th>
        <th class="minute-header">25</th>
        <th class="minute-header">28</th>
        <th class="minute-header">31</th>
        <th class="minute-header">34</th>
        <th class="minute-header">37</th>
        <th class="minute-header">40</th>
        <th class="minute-header">43</th>
        <th class="minute-header">46</th>
        <th class="minute-header">49</th>
        <th class="minute-header">52</th>
        <th class="minute-header">55</th>
        <th class="minute-header">58</th>
        <th>‚öΩÔ∏è</th>
        <th>‚úîÔ∏è</th>
        <th>üìä</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot></tfoot>
  </table>

  <div class="betstat-footer">
    <div class="betstat-footer-line">
      <span class="betstat-footer-text">BetStat¬Æ</span>
    </div>
  </div>

<script>
    const minutosFixos = [
      1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34, 37, 40, 43, 46, 49, 52, 55, 58,
    ];

    let placarSelecionado = localStorage.getItem("placarSelecionado");
    let timeSelecionado = localStorage.getItem("timeSelecionado");
    let oddSelecionada = localStorage.getItem("oddSelecionada");

    function showErrorMessage(message) {
      const errorMessageDiv = document.getElementById("errorMessage");
      errorMessageDiv.textContent = message;
      errorMessageDiv.style.display = "block";
    }

    function hideErrorMessage() {
      const errorMessageDiv = document.getElementById("errorMessage");
      errorMessageDiv.textContent = "";
      errorMessageDiv.style.display = "none";
    }

    function selecionarPlacaresIguais(placarAlvo) {
      const placares = document.querySelectorAll(".placar");
      placares.forEach((placar) => {
        const texto = placar.querySelector(".placar-texto")?.textContent.trim() || placar.textContent.trim();
        if (placarAlvo && texto.includes(placarAlvo)) {
          placar.classList.add("placar-selecionado");
        } else {
          placar.classList.remove("placar-selecionado");
        }
      });
    }

    function selecionarJogosPorTime(timeAlvo) {
      const placares = document.querySelectorAll(".placar");
      if (!timeAlvo || document.querySelector("#mostrarTimes").value !== "sim") {
        placares.forEach((placar) => {
          placar.classList.remove("time-selecionado");
        });
        return;
      }
      placares.forEach((placar) => {
        const timeA = placar.getAttribute("data-time-a");
        const timeB = placar.getAttribute("data-time-b");
        if (timeA === timeAlvo || timeB === timeAlvo) {
          placar.classList.add("time-selecionado");
        } else {
          placar.classList.remove("time-selecionado");
        }
      });
    }

    function selecionarOddsIguais(oddAlvo) {
      const oddsElements = document.querySelectorAll(".odds");
      oddsElements.forEach((oddElement) => {
        const oddTexto = oddElement.textContent.trim();
        if (oddAlvo && oddTexto === oddAlvo) {
          oddElement.classList.add("odd-selecionada");
        } else {
          oddElement.classList.remove("odd-selecionada");
        }
      });
    }

    function calculateGoalStats(todasLinhas) {
      const totalGols = todasLinhas.reduce(
        (acc, row) =>
          acc + parseInt(row.children[row.children.length - 3].textContent || 0),
        0
      );
      const totalHorasJogadas = todasLinhas.length;
      const mediaGolsHora =
        totalHorasJogadas > 0
          ? (totalGols / totalHorasJogadas).toFixed(2)
          : 0;

      return {
        totalGols,
        mediaGolsHora,
      };
    }

    async function fetchOdds() {
      try {
        const response = await fetch("http://localhost:5001/odds/Ta%C3%A7a%20Gl%C3%B3ria%20Eterna");
        if (!response.ok) {
          throw new Error(`Erro ao buscar odds: ${response.status} ${response.statusText}`);
        }
        const oddsData = await response.json();
        console.log("Odds fetched:", oddsData);
        return oddsData;
      } catch (error) {
        console.error("Erro ao buscar odds:", error);
        return [];
      }
    }

    async function fetchProximosJogos() {
      try {
        const response = await fetch("http://localhost:5001/proximos/Ta%C3%A7a%20Gl%C3%B3ria%20Eterna");
        if (!response.ok) {
          throw new Error(`Erro ao buscar pr√≥ximos jogos: ${response.status} ${response.statusText}`);
        }
        const jogos = await response.json();
        console.log("Pr√≥ximos jogos fetched:", jogos);
        return jogos.sort((a, b) => new Date(a.start_time) - new Date(b.start_time)).slice(0, 6);
      } catch (error) {
        console.error("Erro ao buscar pr√≥ximos jogos:", error);
        showErrorMessage(`Erro ao carregar pr√≥ximos jogos: ${error.message}`);
        return [];
      }
    }

    function normalizeString(str) {
      if (!str) return "";
      return str
        .trim()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, ""); // Remove caracteres especiais, espa√ßos e h√≠fens
    }

    function formatDateToDDMMYYYY(dateStr) {
      let date;
      if (dateStr.includes("T")) {
        date = new Date(dateStr);
        date = new Date(date.getTime() - 3 * 60 * 60 * 1000); // Ajustar para -03:00
      } else {
        const [day, month, year] = dateStr.split("/");
        date = new Date(`${year}-${month}-${day}T00:00:00-03:00`);
      }
      if (isNaN(date)) return null;
      const day = date.getDate().toString().padStart(2, "0");
      const month = (date.getMonth() + 1).toString().padStart(2, "0");
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function findOddsForMatch(match, oddsData) {
      const matchDate = formatDateToDDMMYYYY(match.data || match.start_time || match.captured_date);
      const matchTime = match.hora
        ? `${match.hora.toString().padStart(2, "0")}:${match.minuto.toString().padStart(2, "0")}`
        : match.time || "00:00";
      const teamMapping = {
        peixe: "boca",
      };
      const matchTimeA = normalizeString(
        teamMapping[match.time_a?.toLowerCase() || match.team_home.toLowerCase()] ||
          match.time_a ||
          match.team_home
      );
      const matchTimeB = normalizeString(
        teamMapping[match.time_b?.toLowerCase() || match.team_visit.toLowerCase()] ||
          match.time_b ||
          match.team_visit
      );

      console.log(
        `Buscando odds para: ${matchTimeA} vs ${matchTimeB} em ${matchDate} ${matchTime}`
      );

      // Correspond√™ncia exata por data, hor√°rio e times
      let matchedOdd = oddsData.find((odd) => {
        const oddDate = odd.data_captura;
        const oddTime = odd.horario || "00:00";
        const oddTimeCasa = normalizeString(odd.time_casa);
        const oddTimeVisitante = normalizeString(odd.time_visitante);

        const isMatch =
          oddTimeCasa === matchTimeA &&
          oddTimeVisitante === matchTimeB &&
          oddDate === matchDate &&
          oddTime === matchTime;

        console.log(
          `Tentativa exata: ${oddTimeCasa} vs ${oddTimeVisitante} (${oddDate} ${oddTime}) == ${matchTimeA} vs ${matchTimeB} (${matchDate} ${matchTime}) -> ${isMatch}`
        );
        return isMatch;
      });

      // Correspond√™ncia alternativa por data e times, com toler√¢ncia no hor√°rio
      if (!matchedOdd) {
        matchedOdd = oddsData.find((odd) => {
          const oddDate = odd.data_captura;
          const oddTimeCasa = normalizeString(odd.time_casa);
          const oddTimeVisitante = normalizeString(odd.time_visitante);

          const isTeamMatch =
            (oddTimeCasa === matchTimeA && oddTimeVisitante === matchTimeB) ||
            (oddTimeCasa === matchTimeB && oddTimeVisitante === matchTimeA);
          const isDateMatch = oddDate === matchDate;

          // Toler√¢ncia de ¬±1 hora
          const matchDateTime = new Date(
            `${matchDate.split("/").reverse().join("-")}T${matchTime}:00-03:00`
          );
          const oddDateTime = new Date(
            `${oddDate.split("/").reverse().join("-")}T${odd.horario || "00:00"}:00-03:00`
          );
          const timeDiff = Math.abs(matchDateTime - oddDateTime) / (1000 * 60 * 60);
          const isTimeClose = timeDiff <= 1;

          const isMatch = isTeamMatch && isDateMatch && isTimeClose;
          console.log(
            `Tentativa alternativa: ${oddTimeCasa} vs ${oddTimeVisitante} (${oddDate}) -> Times: ${isTeamMatch}, Data: ${isDateMatch}, Hor√°rio pr√≥ximo: ${isTimeClose} -> ${isMatch}`
          );
          return isMatch;
        });
      }

      // Correspond√™ncia parcial por times (como √∫ltima tentativa)
      if (!matchedOdd) {
        matchedOdd = oddsData.find((odd) => {
          const oddTimeCasa = normalizeString(odd.time_casa);
          const oddTimeVisitante = normalizeString(odd.time_visitante);
          const isPartialMatch =
            (oddTimeCasa.includes(matchTimeA) && oddTimeVisitante.includes(matchTimeB)) ||
            (oddTimeCasa.includes(matchTimeB) && oddTimeVisitante.includes(matchTimeA));
          console.log(
            `Tentativa parcial: ${oddTimeCasa} vs ${oddTimeVisitante} cont√©m ${matchTimeA} vs ${matchTimeB} -> ${isPartialMatch}`
          );
          return isPartialMatch;
        });
      }

      console.log(`Odd encontrada para ${matchTimeA} vs ${matchTimeB}:`, matchedOdd || "Nenhuma");
      return matchedOdd;
    }

    function getOddValue(odds, resultado) {
      const oddMap = {
        ambasMarcam: "odds_ambas_marcam_sim",
        ambasNaoMarcam: "odds_ambas_marcam_nao",
        casaVence: "odds_casa_vence",
        foraVence: "odds_visitante_vence",
        empate: "odds_empate",
        "over1.5": "odds_mais_1_5",
        "under1.5": "odds_menos_1_5",
        "over2.5": "odds_mais_2_5",
        "under2.5": "odds_menos_2_5",
        "over3.5": "odds_mais_3_5",
        "under3.5": "odds_menos_3_5",
        over5: "odds_mais_5_gols",
      };
      return odds ? odds[oddMap[resultado]] || "N/A" : "N/A";
    }

    function extractTimeFromDateTime(dateTimeStr) {
      if (!dateTimeStr || isNaN(new Date(dateTimeStr))) {
        console.warn(`Data/hora inv√°lida: ${dateTimeStr}`);
        return { time: "00:00", date: null, hour: 0, minute: null };
      }
      const date = new Date(dateTimeStr);
      const offsetDate = new Date(date.getTime() - 3 * 60 * 60 * 1000); // Subtrair 3 horas
      const hour = offsetDate.getHours();
      const minute = offsetDate.getMinutes();
      const time = `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}`;
      const closestMinute = minutosFixos.reduce((prev, curr) =>
        Math.abs(curr - minute) < Math.abs(prev - minute) ? curr : prev
      );
      console.log(
        `Parsed time: ${dateTimeStr} -> local time: ${offsetDate.toISOString()} -> hour: ${hour}, minute: ${minute}, closestMinute: ${closestMinute}`
      );
      return { time, date: offsetDate, hour, minute: closestMinute };
    }

    function abbreviateTeamName(teamName) {
      if (!teamName) return "";
      const words = teamName.trim().split(" ");
      if (words.length > 1) {
        return words.map((word) => word.charAt(0).toUpperCase()).join("") + words[words.length - 1].slice(0, 3).toLowerCase();
      }
      return teamName.length > 5 ? teamName.slice(0, 5).toUpperCase() : teamName.toUpperCase();
    }

    function criarTabela(dados, oddsData, proximosJogos) {
      const tabelaBody = document.querySelector("#tabelaResultados tbody");
      const linhaPercentual = document.getElementById("linhaPercentual");
      const linhaTotalGols = document.getElementById("linhaTotalGols");
      const linhaAcertosMercado = document.getElementById("linhaAcertosMercado");
      if (!tabelaBody || !linhaPercentual || !linhaTotalGols || !linhaAcertosMercado) {
        console.error("Elementos da tabela n√£o encontrados!");
        showErrorMessage("Erro interno: Estrutura da tabela n√£o encontrada.");
        return;
      }

      linhaPercentual.innerHTML = "<th>üìä</th>";
      linhaTotalGols.innerHTML = "<th>‚öΩ</th>";
      linhaAcertosMercado.innerHTML = "<th>‚úîÔ∏è</th>";
      tabelaBody.innerHTML = "";

      const seletorHoras = document.querySelector("#seletorHoras");
      const seletorResultado = document.querySelector("#seletorResultado");
      const seletorTipoPlacar = document.querySelector("#seletorTipoPlacar");
      const mostrarTimesSelect = document.querySelector("#mostrarTimes");
      const mostrarHTSelect = document.querySelector("#mostrarHT");
      const mostrarOddsSelect = document.querySelector("#mostrarOdds");
      const mostrarTimes = mostrarTimesSelect ? mostrarTimesSelect.value === "sim" : false;
      const mostrarOdds = mostrarOddsSelect ? mostrarOddsSelect.value === "sim" : false;
      const mostrarHT = mostrarHTSelect ? mostrarHTSelect.value === "sim" : false;

      if (!seletorHoras || !seletorResultado || !seletorTipoPlacar || !mostrarTimesSelect || !mostrarHTSelect || !mostrarOddsSelect) {
        console.error("Seletores n√£o encontrados!");
        showErrorMessage("Erro interno: Seletores do formul√°rio n√£o encontrados.");
        return;
      }

      const horasSelecionadas = parseInt(seletorHoras.value) || 12;

      dados.sort((a, b) => {
        const dataHoraA = new Date(
          `${a.data}T${a.hora.toString().padStart(2, "0")}:${a.minuto.toString().padStart(2, "0")}:00`
        ).getTime();
        const dataHoraB = new Date(
          `${b.data}T${b.hora.toString().padStart(2, "0")}:${b.minuto.toString().padStart(2, "0")}:00`
        ).getTime();
        return dataHoraA - dataHoraB;
      });

      const proximosJogosComHoras = proximosJogos.map((jogo) => {
        const { time, date, hour, minute } = extractTimeFromDateTime(jogo.start_time);
        return { ...jogo, time, date, hora: hour, minuto: minute, team_visitante: jogo.team_visit };
      }).sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
      console.log("Pr√≥ximos jogos processados:", proximosJogosComHoras);

      const chavesJaProcessadas = new Set();
      const mapeamentoChaveLinha = {};
      let contagemLinhas = 0;

      const now = new Date();
      proximosJogosComHoras.forEach((jogo) => {
        const hora = jogo.hora !== null ? jogo.hora : 0;
        const dataStr = jogo.date ? jogo.date.toISOString().split("T")[0] : jogo.captured_date.split("/").reverse().join("-");
        const chave = `${dataStr}-${hora.toString().padStart(2, "0")}`;
        if (!chavesJaProcessadas.has(chave)) {
          const jogoDateTime = new Date(jogo.start_time);
          const localJogoDateTime = new Date(jogoDateTime.getTime() - 3 * 60 * 60 * 1000);
          if (localJogoDateTime > now) {
            const novaLinha = document.createElement("tr");
            novaLinha.setAttribute("data-chave", chave);
            const colunaHora = document.createElement("td");
            colunaHora.textContent = hora.toString().padStart(2, "0");
            novaLinha.appendChild(colunaHora);
            minutosFixos.forEach(() => novaLinha.appendChild(document.createElement("td")));
            novaLinha.appendChild(document.createElement("td")).textContent = "0";
            novaLinha.appendChild(document.createElement("td")).textContent = "0";
            novaLinha.appendChild(document.createElement("td")).textContent = "0%";
            tabelaBody.insertBefore(novaLinha, tabelaBody.firstChild);
            chavesJaProcessadas.add(chave);
            mapeamentoChaveLinha[chave] = novaLinha;
            contagemLinhas++;
            console.log(`Criada linha para hora futura (topo): ${chave}`);
          }
        }
      });

      dados.reverse().forEach((dado) => {
        if (contagemLinhas >= horasSelecionadas) return;
        const dataHora = new Date(dado.data);
        const hora = dado.hora;
        const chave = `${dataHora.toISOString().split("T")[0]}-${hora.toString().padStart(2, "0")}`;
        if (!chavesJaProcessadas.has(chave)) {
          const novaLinha = document.createElement("tr");
          novaLinha.setAttribute("data-chave", chave);
          const colunaHora = document.createElement("td");
          colunaHora.textContent = hora.toString().padStart(2, "0");
          novaLinha.appendChild(colunaHora);
          minutosFixos.forEach(() => novaLinha.appendChild(document.createElement("td")));
          novaLinha.appendChild(document.createElement("td")).textContent = "0";
          novaLinha.appendChild(document.createElement("td")).textContent = "0";
          novaLinha.appendChild(document.createElement("td")).textContent = "0%";
          tabelaBody.appendChild(novaLinha);
          chavesJaProcessadas.add(chave);
          mapeamentoChaveLinha[chave] = novaLinha;
          contagemLinhas++;
          console.log(`Criada linha para dados passados: ${chave}`);
        }
      });

      function handlePlacarClick(event) {
        if (mostrarTimes) return;
        const placarElement = event.currentTarget.querySelector(".placar-texto") || event.currentTarget;
        const placarClicado = placarElement.textContent.trim();
        if (placarSelecionado === placarClicado) {
          placarSelecionado = null;
          localStorage.removeItem("placarSelecionado");
          selecionarPlacaresIguais(null);
        } else {
          placarSelecionado = placarClicado;
          localStorage.setItem("placarSelecionado", placarClicado);
          selecionarPlacaresIguais(placarClicado);
        }
      }

      function handleTimeClick(event) {
        if (!mostrarTimes) return;
        const timeElement = event.target;
        const timeClicado = timeElement.getAttribute("data-full-time");
        if (!timeClicado) return;
        if (timeSelecionado === timeClicado) {
          timeSelecionado = null;
          localStorage.removeItem("timeSelecionado");
          selecionarJogosPorTime(null);
        } else {
          timeSelecionado = timeClicado;
          localStorage.setItem("timeSelecionado", timeClicado);
          selecionarJogosPorTime(timeClicado);
        }
      }

      function handleOddClick(event) {
        event.stopPropagation();
        const oddClicada = event.currentTarget.textContent.trim();
        if (oddSelecionada === oddClicada) {
          oddSelecionada = null;
          localStorage.removeItem("oddSelecionada");
          selecionarOddsIguais(null);
        } else {
          oddSelecionada = oddClicada;
          localStorage.setItem("oddSelecionada", oddClicada);
          selecionarOddsIguais(oddClicada);
        }
      }

      const totalGolsPorColuna = Array(minutosFixos.length).fill(0);
      const totalAcertosPorColuna = Array(minutosFixos.length).fill(0);
      const totalMercadosPorColuna = Array(minutosFixos.length).fill(0);
      const processedMatches = new Set();

      dados.forEach((dado) => {
        const dataHora = new Date(dado.data);
        const hora = dado.hora;
        const chave = `${dataHora.toISOString().split("T")[0]}-${hora.toString().padStart(2, "0")}`;
        const linha = mapeamentoChaveLinha[chave];
        const matchKey = `${dado.time_a}-${dado.time_b}-${chave}-${dado.minuto}`;

        if (linha && !processedMatches.has(matchKey)) {
          const indexMinuto = minutosFixos.indexOf(dado.minuto);
          if (indexMinuto !== -1) {
            const colunaMinuto = linha.children[1 + indexMinuto];

            if (!colunaMinuto.querySelector(".placar")) {
              const placar = document.createElement("div");
              placar.className = "placar";
              placar.setAttribute("data-time-a", dado.time_a);
              placar.setAttribute("data-time-b", dado.time_b);

              const tipoPlacar = seletorTipoPlacar.value;
              const placarFT = dado.ft;
              const placarHT = dado.ht;

              const placarTexto = document.createElement("div");
              placarTexto.className = "placar-texto";

              let primaryScore = tipoPlacar === "ft" ? placarFT : placarHT;
              let secondaryScore = tipoPlacar === "ft" ? placarHT : placarFT;

              if (mostrarTimes) {
                const timeA = abbreviateTeamName(dado.time_a);
                const timeB = abbreviateTeamName(dado.time_b);
                let textoPlacar = `<span class="time-casa" style="cursor: pointer;" data-full-time="${dado.time_a}">${timeA}</span>`;
                textoPlacar += `<span>${primaryScore}</span>`;
                if (mostrarHT) {
                  textoPlacar += `<span>(${secondaryScore})</span>`;
                }
                textoPlacar += `<span class="time-fora" style="cursor: pointer;" data-full-time="${dado.time_b}">${timeB}</span>`;
                placarTexto.innerHTML = textoPlacar;
              } else {
                let textoPlacar = `<span>${primaryScore}</span>`;
                if (mostrarHT) {
                  textoPlacar += `<span>(${secondaryScore})</span>`;
                }
                placarTexto.innerHTML = textoPlacar;
              }
              placar.appendChild(placarTexto);

              if (mostrarOdds) {
                const odds = findOddsForMatch(dado, oddsData);
                const oddValue = getOddValue(odds, seletorResultado.value);
                const oddsElement = document.createElement("div");
                oddsElement.className = "odds";
                oddsElement.textContent = `@${oddValue}`;
                oddsElement.addEventListener("click", handleOddClick);
                placar.appendChild(oddsElement);
              }

              placar.addEventListener("click", handlePlacarClick);
              if (mostrarTimes) {
                const timeCasa = placar.querySelector(".time-casa");
                const timeFora = placar.querySelector(".time-fora");
                if (timeCasa) timeCasa.addEventListener("click", handleTimeClick);
                if (timeFora) timeFora.addEventListener("click", handleTimeClick);
              }

              const tooltip = document.createElement("span");
              tooltip.className = "tooltip";
              tooltip.innerHTML = `
                <span class="times">${dado.time_a} vs ${dado.time_b}</span>
                <span class="placares">${placarFT} <span class="placarHT">(${placarHT})</span></span>
              `;
              placar.appendChild(tooltip);

              colunaMinuto.appendChild(placar);
              processedMatches.add(matchKey);
              console.log(
                `Adicionado resultado passado: ${dado.time_a} vs ${dado.time_b} em ${chave} minuto ${dado.minuto}`
              );

              if (placarSelecionado && !mostrarTimes && placarTexto.textContent.includes(placarSelecionado)) {
                placar.classList.add("placar-selecionado");
              }
              if (timeSelecionado && mostrarTimes && (dado.time_a === timeSelecionado || dado.time_b === timeSelecionado)) {
                placar.classList.add("time-selecionado");
              }
              if (oddSelecionada && mostrarOdds) {
                const oddElement = placar.querySelector(".odds");
                if (oddElement && oddElement.textContent === oddSelecionada) {
                  oddElement.classList.add("odd-selecionada");
                }
              }

              const selecaoResultado = seletorResultado.value;
              let acerto = false;
              const placarAtual = tipoPlacar === "ft" ? placarFT : placarHT;
              const [resultadoA, resultadoB] = placarAtual.split(" x ").map((num) => parseInt(num) || 0);

              if (selecaoResultado === "ambasMarcam") {
                acerto = resultadoA > 0 && resultadoB > 0;
              } else if (selecaoResultado === "ambasNaoMarcam") {
                acerto = resultadoA === 0 || resultadoB === 0;
              } else if (selecaoResultado === "over1.5") {
                acerto = resultadoA + resultadoB > 1.5;
              } else if (selecaoResultado === "under1.5") {
                acerto = resultadoA + resultadoB <= 1.5;
              } else if (selecaoResultado === "over2.5") {
                acerto = resultadoA + resultadoB > 2.5;
              } else if (selecaoResultado === "under2.5") {
                acerto = resultadoA + resultadoB <= 2.5;
              } else if (selecaoResultado === "over3.5") {
                acerto = resultadoA + resultadoB > 3.5;
              } else if (selecaoResultado === "under3.5") {
                acerto = resultadoA + resultadoB <= 3.5;
              } else if (selecaoResultado === "over5") {
                acerto = resultadoA + resultadoB >= 5;
              } else if (selecaoResultado === "casaVence") {
                acerto = resultadoA > resultadoB;
              } else if (selecaoResultado === "foraVence") {
                acerto = resultadoB > resultadoA;
              } else if (selecaoResultado === "empate") {
                acerto = resultadoA === resultadoB;
              }

              if (acerto) {
                const totalAcertosCelula = linha.children[linha.children.length - 2];
                totalAcertosCelula.textContent = parseInt(totalAcertosCelula.textContent || 0) + 1;
                totalAcertosPorColuna[indexMinuto]++;
              }

              totalMercadosPorColuna[indexMinuto]++;

              const totalGolsCelula = linha.children[linha.children.length - 3];
              const totalGols = resultadoA + resultadoB;
              totalGolsCelula.textContent = parseInt(totalGolsCelula.textContent || 0) + totalGols;

              totalGolsPorColuna[indexMinuto] += totalGols;

              colunaMinuto.style.backgroundColor = acerto ? "#018b06" : "#be0e02";
            }
          }
        }
      });

      proximosJogosComHoras.forEach((jogo) => {
        const dataStr = jogo.date
          ? jogo.date.toISOString().split("T")[0]
          : jogo.captured_date.split("/").reverse().join("-");
        const hora = jogo.hora !== null ? jogo.hora : 0;
        const chave = `${dataStr}-${hora.toString().padStart(2, "0")}`;
        const linha = mapeamentoChaveLinha[chave];
        const matchKey = `${jogo.team_home}-${jogo.team_visit}-${chave}-${jogo.minuto}`;

        if (linha && jogo.minuto !== null && !processedMatches.has(matchKey)) {
          const indexMinuto = minutosFixos.indexOf(jogo.minuto);
          if (indexMinuto !== -1) {
            const colunaMinuto = linha.children[1 + indexMinuto];
            if (!colunaMinuto.querySelector(".placar")) {
              console.log(
                `Adicionando jogo futuro: ${jogo.team_home} vs ${jogo.team_visit} em ${chave} minuto ${jogo.minuto}`
              );
              const placar = document.createElement("div");
              placar.className = "placar placar-futuro";
              placar.setAttribute("data-time-a", jogo.team_home);
              placar.setAttribute("data-time-b", jogo.team_visit);

              const placarTexto = document.createElement("div");
              placarTexto.className = "placar-texto";

              if (mostrarTimes) {
                const timeA = abbreviateTeamName(jogo.team_home);
                const timeB = abbreviateTeamName(jogo.team_visit);
                placarTexto.innerHTML = `
                  <span class="time-casa" style="cursor: pointer;" data-full-time="${jogo.team_home}">${timeA}</span><br>
                  <span>vs</span><br>
                  <span class="time-fora" style="cursor: pointer;" data-full-time="${jogo.team_visit}">${timeB}</span>
                `;
              } else {
                const timeA = abbreviateTeamName(jogo.team_home);
                const timeB = abbreviateTeamName(jogo.team_visit);
                placarTexto.innerHTML = `${timeA}<br>vs<br>${timeB}`;
              }
              placar.appendChild(placarTexto);

              if (mostrarOdds) {
                const odds = findOddsForMatch(jogo, oddsData);
                const oddValue = getOddValue(odds, seletorResultado.value);
                const oddsElement = document.createElement("div");
                oddsElement.className = "odds";
                oddsElement.textContent = `@${oddValue}`;
                oddsElement.addEventListener("click", handleOddClick);
                placar.appendChild(oddsElement);
              }

              placar.addEventListener("click", handlePlacarClick);
              if (mostrarTimes) {
                const timeCasa = placar.querySelector(".time-casa");
                const timeFora = placar.querySelector(".time-fora");
                if (timeCasa) timeCasa.addEventListener("click", handleTimeClick);
                if (timeFora) timeFora.addEventListener("click", handleTimeClick);
              }

              const tooltip = document.createElement("span");
              tooltip.className = "tooltip";
              tooltip.innerHTML = `<span class="times">${jogo.team_home} vs ${jogo.team_visit}</span>`;
              placar.appendChild(tooltip);

              colunaMinuto.appendChild(placar);
              processedMatches.add(matchKey);

              if (timeSelecionado && mostrarTimes && (jogo.team_home === timeSelecionado || jogo.team_visit === timeSelecionado)) {
                placar.classList.add("time-selecionado");
              }
              if (oddSelecionada && mostrarOdds) {
                const oddElement = placar.querySelector(".odds");
                if (oddElement && oddElement.textContent === oddSelecionada) {
                  oddElement.classList.add("odd-selecionada");
                }
              }
            }
          } else {
            console.warn(
              `Minuto ${jogo.minuto} n√£o encontrado em minutosFixos para jogo ${jogo.team_home} vs ${jogo.team_visit}`
            );
          }
        } else {
          console.warn(
            `Linha n√£o encontrada para chave ${chave} ou minuto nulo para jogo ${jogo.team_home} vs ${jogo.team_visit}`
          );
        }
      });

      totalGolsPorColuna.forEach((total, index) => {
        const cell = document.createElement("td");
        cell.className = "total-goals";
        cell.textContent = total;
        linhaTotalGols.appendChild(cell);
      });

      totalAcertosPorColuna.forEach((total, index) => {
        const cell = document.createElement("td");
        cell.className = "market-hits";
        cell.textContent = total;
        linhaAcertosMercado.appendChild(cell);
      });

      for (let i = 0; i < 3; i++) {
        const emptyCellGols = document.createElement("td");
        emptyCellGols.textContent = "";
        linhaTotalGols.appendChild(emptyCellGols);

        const emptyCellMercados = document.createElement("td");
        emptyCellMercados.textContent = "";
        linhaAcertosMercado.appendChild(emptyCellMercados);
      }

      const todasLinhas = Array.from(tabelaBody.querySelectorAll("tr"));
      todasLinhas.forEach((row) => {
        const totalCelsProcessadas = Array.from(row.cells)
          .slice(1, -3)
          .filter((cell) => cell.querySelector(".placar:not(.placar-futuro)")).length;
        const celsMercado = parseInt(row.children[row.children.length - 2].textContent || 0);

        const porcentagem =
          totalCelsProcessadas > 0
            ? Math.round((celsMercado / totalCelsProcessadas) * 100)
            : 0;
        const porcentagemCell = row.children[row.children.length - 1];
        porcentagemCell.textContent = `${porcentagem}%`;

        if (porcentagem >= 50) {
          porcentagemCell.classList.add("porcentagem-verde");
          porcentagemCell.classList.remove("porcentagem-branca");
        } else {
          porcentagemCell.classList.add("porcentagem-branca");
          porcentagemCell.classList.remove("porcentagem-verde");
        }
      });

      linhaPercentual.innerHTML = "<th>üìà</th>";
      totalMercadosPorColuna.forEach((totalMercados, index) => {
        const cell = document.createElement("td");
        const porcentagemVertical =
          totalMercados > 0
            ? Math.round((totalAcertosPorColuna[index] / totalMercados) * 100)
            : 0;
        cell.textContent = `${porcentagemVertical}%`;

        if (porcentagemVertical >= 50) {
          cell.classList.add("porcentagem-verde");
          cell.classList.remove("porcentagem-branca");
        } else {
          cell.classList.add("porcentagem-branca");
          cell.classList.remove("porcentagem-verde");
        }

        linhaPercentual.appendChild(cell);
      });

      for (let i = 0; i < 3; i++) {
        const emptyCell = document.createElement("td");
        emptyCell.textContent = "";
        linhaPercentual.appendChild(emptyCell);
      }

      const minuteHeaders = document.querySelectorAll("#tabelaResultados thead tr:last-child th.minute-header");
      minuteHeaders.forEach((header) => {
        header.style.backgroundColor = "#2c303b";
      });

      const stats = calculateGoalStats(todasLinhas);
      document.getElementById("totalGols").textContent = `Gols: ${stats.totalGols}`;
      document.getElementById("mediaGolsHora").textContent = `M√©dias: ${stats.mediaGolsHora}`;

      if (placarSelecionado && !mostrarTimes) {
        selecionarPlacaresIguais(placarSelecionado);
      }
      if (timeSelecionado && mostrarTimes) {
        selecionarJogosPorTime(timeSelecionado);
      }
      if (oddSelecionada && mostrarOdds) {
        selecionarOddsIguais(oddSelecionada);
      }
    }

    async function buscarDados() {
      hideErrorMessage();
      let dados = [];
      let oddsData = [];
      let proximosJogos = [];

      try {
        const resultadosResponse = await fetch("http://localhost:5001/resultados/Ta%C3%A7a%20Gl%C3%B3ria%20eterna");
        if (!resultadosResponse.ok) {
          throw new Error(`Erro ao buscar resultados: ${resultadosResponse.status} ${resultadosResponse.statusText}`);
        }
        dados = await resultadosResponse.json();
        console.log("Resultados fetched:", dados);
      } catch (error) {
        console.error("Erro ao buscar resultados:", error);
        showErrorMessage(`Erro ao carregar resultados: ${error.message}`);
      }

      try {
        oddsData = await fetchOdds();
      } catch (error) {
        console.error("Erro ao buscar odds:", error);
        showErrorMessage(`Erro ao carregar odds: ${error.message}. Exibindo tabela sem odds.`);
      }

      try {
        proximosJogos = await fetchProximosJogos();
      } catch (error) {
        console.error("Erro ao buscar pr√≥ximos jogos:", error);
        showErrorMessage(`Erro ao carregar pr√≥ximos jogos: ${error.message}. Exibindo tabela sem jogos futuros.`);
      }

      if (dados.length > 0 || proximosJogos.length > 0) {
        criarTabela(dados, oddsData, proximosJogos);
      } else {
        showErrorMessage("Nenhum dado dispon√≠vel. Verifique a conex√£o com o servidor.");
      }
    }

    buscarDados();
    setInterval(buscarDados, 10000);

    const seletorHoras = document.querySelector("#seletorHoras");
    const seletorResultado = document.querySelector("#seletorResultado");
    const seletorTipoPlacar = document.querySelector("#seletorTipoPlacar");
    const mostrarTimesSelect = document.querySelector("#mostrarTimes");
    const mostrarHTSelect = document.querySelector("#mostrarHT");
    const mostrarOddsSelect = document.querySelector("#mostrarOdds");

    if (seletorHoras) seletorHoras.addEventListener("change", buscarDados);
    if (seletorResultado) seletorResultado.addEventListener("change", buscarDados);
    if (seletorTipoPlacar) seletorTipoPlacar.addEventListener("change", buscarDados);
    if (mostrarTimesSelect) {
      mostrarTimesSelect.addEventListener("change", () => {
        if (mostrarTimesSelect.value !== "sim") {
          placarSelecionado = null;
          timeSelecionado = null;
          localStorage.removeItem("placarSelecionado");
          localStorage.removeItem("timeSelecionado");
          selecionarPlacaresIguais(null);
          selecionarJogosPorTime(null);
        }
        buscarDados();
      });
    }
    if (mostrarHTSelect) mostrarHTSelect.addEventListener("change", buscarDados);
    if (mostrarOddsSelect) {
      mostrarOddsSelect.addEventListener("change", () => {
        if (mostrarOddsSelect.value !== "sim") {
          oddSelecionada = null;
          localStorage.removeItem("oddSelecionada");
          selecionarOddsIguais(null);
        }
        buscarDados();
      });
    }
</script>

</body>
</html>