<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-4WT805FFHQ"
    ></script>
    <title>BetStat</title>
    <!-- Meta tags SEO principais -->
    <meta
      name="description"
      content="Transforme suas apostas com BetStat - a única plataforma especializada em futebol virtual Betano. Análises precisas, estatísticas confiáveis e resultados comprovados para investimentos inteligentes."
    />
    <meta
      name="keywords"
      content="BetStat, apostas esportivas, futebol virtual, Betano, estatísticas apostas, análise apostas, investimentos esportivos"
    />

    <!-- Open Graph meta tags para redes sociais -->
    <meta
      property="og:title"
      content="BetStat | Plataforma de Análise para Apostas Esportivas"
    />
    <meta
      property="og:description"
      content="Transforme suas apostas com análises precisas e estatísticas confiáveis. A única plataforma especializada em futebol virtual Betano."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.betstat.site/payment.html" />
    <meta property="og:site_name" content="BetStat" />

    <!-- Meta tags adicionais -->
    <meta name="robots" content="index, follow" />
    <meta name="author" content="BetStat" />
    <meta name="canonical" href="https://www.betstat.site/payment.html" />
    <script type="module" src="js/firebase-auth.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-4WT805FFHQ");
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
  </head>

  <style>
    /* ===== VARIÁVEIS ===== */
    :root {
      --bg-primary: #1c1f26;
      --bg-secondary: #2a2e35;
      --bg-tertiary: #3a3f47;
      --accent: #1fac89;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0a0;
      --border: #3a3f47;
      --green: #1f8f3a;
      --red: #b43232;
      --grey: #5a5f67;
      --shadow: rgba(0, 0, 0, 0.2);
    }

    /* ===== RESET E BASE ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== LAYOUT ===== */
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ===== HEADER ===== */
    .header {
      background: var(--bg-secondary);
      padding: 16px 24px;
      margin-bottom: 24px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .logo {
      height: 32px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .select-wrapper select {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .select-wrapper select:hover,
    .select-wrapper select:focus {
      border-color: var(--accent);
      outline: none;
    }

    .logout-btn {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: var(--red);
      border-color: var(--red);
    }

    /* ===== FILTROS ===== */
    .filters-section {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .filter-group select:hover,
    .filter-group select:focus,
    .filter-group input:hover,
    .filter-group input:focus {
      border-color: var(--accent);
      outline: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    /* ===== CHECKBOX GROUP ===== */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-top: 16px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-primary);
    }

    .checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* ===== AUTO UPDATE ===== */
    .auto-update {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      font-size: 14px;
    }

    .auto-update input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .countdown {
      color: var(--accent);
      font-weight: 600;
    }

    /* ===== TABLES ===== */
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 6px;
      margin-bottom: 12px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--bg-secondary);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    thead {
      background: var(--bg-tertiary);
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 12px 16px;
      font-size: 14px;
      border-top: 1px solid var(--border);
    }

    tr:hover td {
      background: var(--bg-tertiary);
    }

    .sortable {
      cursor: pointer;
      user-select: none;
    }

    .sortable:after {
      content: "⇅";
      margin-left: 6px;
      opacity: 0.4;
      font-size: 10px;
    }

    .sortable.asc:after {
      content: "↑";
      opacity: 1;
    }

    .sortable.desc:after {
      content: "↓";
      opacity: 1;
    }

    /* ===== CELLS ===== */
    .cell {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 64px;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      gap: 2px;
    }

    .cell-green {
      background: var(--green);
      color: white;
    }

    .cell-red {
      background: var(--red);
      color: white;
    }

    .cell-grey {
      background: var(--grey);
      color: white;
    }

    .cell-neutral {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .cell .team {
      font-size: 11px;
      opacity: 0.9;
    }

    .cell .score {
      font-size: 14px;
      font-weight: 700;
    }

    .cell .time {
      font-size: 10px;
      opacity: 0.8;
    }

    /* ===== LOADING ===== */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-box {
      background: var(--bg-secondary);
      padding: 24px 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .header-actions {
        flex-direction: column;
      }

      th, td {
        padding: 8px 12px;
        font-size: 13px;
      }
    }

  </style>


  <body>
    <body>
      <div id="header"></div>

      <br>
      <br>
       <br>
      <br>

<!-- CONTAINER PRINCIPAL -->
  <div class="container">
    
    <!-- SEÇÃO DE FILTROS -->
    <div class="filters-section">
      <div class="filters-grid">
        
        <div class="filter-group">
          <label>Mercado 01</label>
          <select id="mercado1">
            <option value="ambasMarcam" selected>Ambas Sim</option>
            <option value="ambasNaoMarcam">Ambas Não</option>
            <option value="casaVence">Casa vence</option>
            <option value="foraVence">Fora vence</option>
            <option value="empate">Empate</option>
            <option value="over1.5">Over 1.5</option>
            <option value="under1.5">Under 1.5</option>
            <option value="over2.5">Over 2.5</option>
            <option value="under2.5">Under 2.5</option>
            <option value="over3.5">Over 3.5</option>
            <option value="under3.5">Under 3.5</option>
            <option value="over5">Over 5+</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Mercado 02</label>
          <select id="mercado2">
            <option value="" selected>Desativado</option>
            <option value="ambasMarcam">Ambas Sim</option>
            <option value="ambasNaoMarcam">Ambas Não</option>
            <option value="casaVence">Casa vence</option>
            <option value="foraVence">Fora vence</option>
            <option value="empate">Empate</option>
            <option value="over1.5">Over 1.5</option>
            <option value="under1.5">Under 1.5</option>
            <option value="over2.5">Over 2.5</option>
            <option value="under2.5">Under 2.5</option>
            <option value="over3.5">Over 3.5</option>
            <option value="under3.5">Under 3.5</option>
            <option value="over5">Over 5+</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Mercado 03</label>
          <select id="mercado3">
            <option value="" selected>Desativado</option>
            <option value="ambasMarcam">Ambas Sim</option>
            <option value="ambasNaoMarcam">Ambas Não</option>
            <option value="casaVence">Casa vence</option>
            <option value="foraVence">Fora vence</option>
            <option value="empate">Empate</option>
            <option value="over1.5">Over 1.5</option>
            <option value="under1.5">Under 1.5</option>
            <option value="over2.5">Over 2.5</option>
            <option value="under2.5">Under 2.5</option>
            <option value="over3.5">Over 3.5</option>
            <option value="under3.5">Under 3.5</option>
            <option value="over5">Over 5+</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Padrões</label>
          <select id="placar_jogos">
            <option value="1">Padrão 01</option>
            <option value="2">Padrão 02</option>
            <option value="3">Padrão 03</option>
            <option value="1_pula_1">Padrão 04</option>
            <option value="1_pula_1_pula_1">Padrão 05</option>
            <option value="combinado" selected>Todos os Padrões</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Gales</label>
          <select id="tiros">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Horas</label>
          <select id="linhas">
            <option value="60">3 Horas</option>
            <option value="120" selected>6 Horas</option>
            <option value="240">12 Horas</option>
            <option value="480">24 Horas</option>
            <option value="960">48 Horas</option>
            <option value="1440">72 Horas</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Jogos Pular</label>
          <select id="intervalo_jogos">
            <option value="mesma_linha" selected>(1-10)</option>
            <option value="mesma_linha2">(11-20)</option>
            <option value="linha_acima">(21-30)</option>
            <option value="2_linhas_acima">(41-50)</option>
            <option value="3_linhas_acima">(61-70)</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Configuração</label>
          <select id="modo-padrao">
            <option value="todos" selected>Todas as opções</option>
            <option value="equipes">Somente equipes</option>
            <option value="mercados">Somente mercados</option>
            <option value="placares">Somente placares</option>
            <option value="placares_equipes">Placares e equipes</option>
            <option value="placares_mercados">Placares e mercados</option>
            <option value="equipes_mercados">Equipes e mercados</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Sincronizar</label>
          <button id="togglestats" class="btn-primary">Buscar Dados</button>
        </div>

        <div class="filter-group">
          <label>&nbsp;</label>
          <div class="auto-update">
            <input type="checkbox" id="auto-atualizar" checked>
            <span>Auto-atualizar</span>
            <span class="countdown" id="contador">180</span>s
          </div>
        </div>

      </div>

      <!-- CHECKBOXES DE LIGAS -->
      <div class="checkbox-group">
        <label>
          <input type="checkbox" value="https://betstat.site/resultados/Copa%20Am%C3%A9rica" checked>
          Copa América
        </label>
        <label>
          <input type="checkbox" value="https://betstat.site/resultados/Ta%C3%A7a%20Gl%C3%B3ria%20eterna">
          Clássicos da América
        </label>
        <label>
          <input type="checkbox" value="https://betstat.site/resultados/Euro">
          Euro
        </label>
        <label>
          <input type="checkbox" value="https://betstat.site/resultados/Campeonato%20Italiano">
          Campeonato Italiano
        </label>
        <label>
          <input type="checkbox" value="https://betstat.site/resultados/Copa%20das%20estrelas">
          Copa das Estrelas
        </label>
        <label>
          <input type="checkbox" value="https://betstat.site/resultados/Brasileir%C3%A3o%20Betano">
          Brasileirão Betano
        </label>
      </div>
    </div>

    <!-- RESULTADOS -->
    <div id="resultados"></div>

  </div>

  <!-- LOADING OVERLAY -->
  <div id="busy" class="loading-overlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <span id="busy-text">Calculando os padrões…</span>
    </div>
  </div>

<script>

      /* ===== Estado ===== */
      let intervaloAtualizacao,
        contadorSegundos = 180;

      const PALETA = [
        "#38bdf8",
        "#22c55e",
        "#f59e0b",
        "#ef4444",
        "#a78bfa",
        "#14b8a6",
        "#e879f9",
        "#f97316",
        "#84cc16",
        "#06b6d4",
        "#e11d48",
        "#10b981",
      ];

      /* ★ Estado (equipes + modo de padrão) */
      let equipesFiltro = [];
      let modoPadrao = "todos";
      let incPlacares = true,
        incMercados = true,
        incEquipes = true;

      /* ===== Busy UI ===== */
      function showBusy(text = "Calculando os padrões…") {
        const o = document.getElementById("busy");
        if (!o) return;
        const t = o.querySelector("#busy-text");
        if (t) t.textContent = text;
        o.style.display = "flex";
      }
      function hideBusy() {
        const o = document.getElementById("busy");
        if (o) o.style.display = "none";
      }

      function buildFutureBarHTML(count = 6) {
        const cells = Array.from(
          { length: count },
          () => `<span class="cell cell-grey"></span>`
        ).join("");
        return `<div class="recent-caption">Próximos ${count}</div>
          <div class="recent-bar future-bar">${cells}</div>`;
      }

      function reexibir() {
        if (window.ULTIMO_PAC && Array.isArray(window.ULTIMO_PAC)) {
          exibirResultados(
            window.ULTIMO_PAC,
            !!window.ULTIMO_COMBINADO,
            window.ULTIMO_ACTIVE_MARKETS || []
          );
        }
      }

      /* ===== Cache de arquivos ===== */
      window.CACHE_ARQUIVOS = window.CACHE_ARQUIVOS || {};

      /* Converte o JSON cru em dados */
      function parseJSONToDados(rawJson, numLinhas) {
        let jsonData = [];
        try {
          jsonData = JSON.parse(rawJson);
          if (!Array.isArray(jsonData)) {
            console.error("Os dados JSON não são um array:", jsonData);
            return { dados: [] };
          }
        } catch (e) {
          console.error("Erro ao analisar JSON:", e);
          return { dados: [] };
        }

        // Assume que a API retorna os jogos em ordem cronológica (do mais antigo para o mais novo)
        const jogosRecentes = jsonData.slice(-numLinhas);

        const dados = [];
        for (const jogo of jogosRecentes) {
          const ftScore = (jogo.ft || "x")
            .split("x")
            .map((s) => parseInt(s.trim(), 10));
          const htScoreRaw = (jogo.ht || "x")
            .split("x")
            .map((s) => s.trim())
            .join("-");

          const a = ftScore[0];
          const b = ftScore[1];
          const mandante = (jogo.time_a || "").trim();
          const visitante = (jogo.time_b || "").trim();
          const horario = `${String(jogo.hora).padStart(2, "0")}:${String(
            jogo.minuto
          ).padStart(2, "0")}`;
          const ht = normalizarHT(htScoreRaw);

          if (Number.isFinite(a) && Number.isFinite(b)) {
            dados.push([a, b, a + b, mandante, visitante, horario, ht]);
          }
        }
        return { dados };
      }

      function aplicarModoPadrao() {
        incPlacares =
          modoPadrao === "placares" ||
          modoPadrao === "placares_equipes" ||
          modoPadrao === "placares_mercados" ||
          modoPadrao === "todos";
        incMercados =
          modoPadrao === "mercados" ||
          modoPadrao === "placares_mercados" ||
          modoPadrao === "equipes_mercados" ||
          modoPadrao === "todos";
        incEquipes =
          modoPadrao === "equipes" ||
          modoPadrao === "placares_equipes" ||
          modoPadrao === "equipes_mercados" ||
          modoPadrao === "todos";
      }

      function getRecentCountByInterval() {
        const v = document.getElementById("intervalo_jogos").value;
        if (v === "mesma_linha") return 20;
        if (v === "mesma_linha2") return 40;
        if (v === "linha_acima") return 40;
        if (v === "2_linhas_acima") return 60;
        if (v === "3_linhas_acima") return 80;
        return 30;
      }

      /* ===== Util ===== */
      function tokensDoJogo(a, b, total, mandante, visitante, ht) {
        const t = new Set();

        if (incPlacares) {
          t.add(`${a}-${b}`);
        }

        if (incMercados) {
          t.add(a > 0 && b > 0 ? "ambasMarcam" : "ambasNaoMarcam");
          t.add(a > b ? "casaVence" : a < b ? "foraVence" : "empate");
          if (total >= 2) t.add("over1.5");
          if (total < 2) t.add("under1.5");
          if (total >= 3) t.add("over2.5");
          if (total < 3) t.add("under2.5");
          if (total >= 4) t.add("over3.5");
          if (total < 4) t.add("under3.5");
          if (total >= 5) t.add("over5");
        }

        if (incEquipes) {
          if (mandante) t.add(mandante.toLowerCase());
          if (visitante) t.add(visitante.toLowerCase());
        }
        return Array.from(t);
      }

      /* GREEN por mercado */
      function isGreenForMarket(m, a, b, total, ht) {
        if (m === "ambasMarcam") return a > 0 && b > 0;
        if (m === "ambasNaoMarcam") return a === 0 || b === 0;
        if (m === "casaVence") return a > b;
        if (m === "foraVence") return a < b;
        if (m === "empate") return a === b;
        if (m === "over1.5") return total >= 2;
        if (m === "under1.5") return total < 2;
        if (m === "over2.5") return total >= 3;
        if (m === "under2.5") return total < 3;
        if (m === "over3.5") return total >= 4;
        if (m === "under3.5") return total < 4;
        if (m === "over5") return total >= 5;
        return false;
      }

      function marketLabel(v) {
        const M = {
          ambasMarcam: "Ambas Sim",
          ambasNaoMarcam: "Ambas Não",
          casaVence: "Casa Vence",
          foraVence: "Fora Vence",
          empate: "Empate",
          "over1.5": "Over 1.5",
          "under1.5": "Under 1.5",
          "over2.5": "Over 2.5",
          "under2.5": "Under 2.5",
          "over3.5": "Over 3.5",
          "under3.5": "Under 3.5",
          over5: "Over 5+",
        };
        return v ? M[v] || v : "Desativado";
      }

      function normalizarHT(s) {
        const t = (s || "").replace(/\s/g, "").replace(":", "-").toUpperCase();
        const whitelist = new Set(["0-0", "0-1", "1-0", "1-1", "0-2", "2-0"]);
        if (whitelist.has(t)) return t;
        if (!t) return "";
        return "OUT";
      }

      /* auto-atualização */
      function iniciarAnalise() {
        carregarDados(true);
        const auto = document.getElementById("auto-atualizar");
        const status = document.getElementById("status-atualizacao");

        if (intervaloAtualizacao) clearInterval(intervaloAtualizacao);

        if (auto && auto.checked) {
          contadorSegundos = 180;
          atualizarContador();
          intervaloAtualizacao = setInterval(atualizarContador, 1000);
          if (status) status.style.display = "block";
        } else if (status) {
          status.style.display = "none";
        }
      }
      function atualizarContador() {
        contadorSegundos--;
        const el = document.getElementById("contador");
        if (el) el.textContent = contadorSegundos;
        if (contadorSegundos <= 0) {
          contadorSegundos = 180;
          carregarDados(true);
        }
      }

      /* filtros */
      function definirEquipesEModo() {
        const raw = (document.getElementById("equipes")?.value || "").trim();
        equipesFiltro = raw
          ? raw
              .split(",")
              .map((s) => s.trim().toLowerCase())
              .filter(Boolean)
          : [];
        const sel = document.getElementById("modo-padrao");
        modoPadrao = sel ? sel.value : "todos";
        aplicarModoPadrao();
      }

      /* Download JSON cru */
      async function baixarArquivoRaw(url) {
        // Adiciona um parâmetro para evitar cache do navegador
        const urlComTimestamp = `${url}?t=${Date.now()}`;
        const resp = await fetch(urlComTimestamp);
        if (!resp.ok) {
          throw new Error(`Falha ao baixar ${url}: HTTP ${resp.status}`);
        }
        const raw = await resp.text();
        window.CACHE_ARQUIVOS[url] = {
          raw,
          lastFetched: Date.now(),
        };
        return raw;
      }

      /* Garante cache (ou força novo download) */
      async function garantirCacheArquivo(url, { forceFresh = false } = {}) {
        if (forceFresh || !window.CACHE_ARQUIVOS[url]) {
          await baixarArquivoRaw(url);
        }
        return window.CACHE_ARQUIVOS[url];
      }

      /* filtro equipes p/ janelas */
      function janelaContemEquipe(jogos) {
        if (equipesFiltro.length === 0) return true;
        for (const j of jogos) {
          const m = (j[3] || "").toLowerCase(),
            v = (j[4] || "").toLowerCase();
          for (const alvo of equipesFiltro) {
            if (m.includes(alvo) || v.includes(alvo)) return true;
          }
        }
        return false;
      }

      /* === (as rotinas pesadas agora vão para o Worker) === */

      function obterIntervalo() {
        const v = document.getElementById("intervalo_jogos").value;
        if (v === "mesma_linha2") return { inicio: 11, fim: 20 };
        if (v === "linha_acima") return { inicio: 21, fim: 30 };
        if (v === "2_linhas_acima") return { inicio: 41, fim: 50 };
        if (v === "3_linhas_acima") return { inicio: 61, fim: 70 };
        return { inicio: 1, fim: 10 };
      }
      function getOffsetsByTipo(t) {
        if (t === "1") return [0];
        if (t === "2") return [0, 1];
        if (t === "3") return [0, 1, 2];
        if (t === "1_pula_1") return [0, 2];
        if (t === "1_pula_1_pula_1") return [0, 2, 4];
        return [0, 1]; // Default
      }

      /* Barra últimos N */
      function buildRecentResultsBarHTML(
        dados,
        count = 80,
        indexColorMap = new Map(),
        maxPerLine = 20,
        marketForPaint = "over2.5"
      ) {
        const total = dados.length;
        const start = Math.max(0, total - count);
        const ultimos = dados.slice(start);
        const cells = [];

        for (let i = 0; i < ultimos.length; i++) {
          const item = ultimos[i];
          const idx = start + i;
          const [a, b, sum, mand, vis, horario, ht] = item;

          const green = isGreenForMarket(marketForPaint, a, b, sum, ht);
          const hitColor = indexColorMap.get(idx);

          const title =
            mand || vis
              ? `${horario ? horario + " · " : ""}${mand} ${a}x${b} ${vis}`
              : `${horario ? horario + " · " : ""}${a}x${b}`;

          let base = `
      <span class="time">${horario || ""}</span>
      <span class="team">${mand || ""}</span>
      <span class="score">${a}x${b}</span>
      <span class="team">${vis || ""}</span>
    `;

          if (hitColor) {
            cells.push(
              `<span class="cell ${
                green ? "cell-green" : "cell-red"
              } cell-hit" data-base-hit="1" data-idx="${idx}" title="${title}" style="--hit:${hitColor}">${base}</span>`
            );
          } else {
            cells.push(
              `<span class="cell ${
                green ? "cell-green" : "cell-red"
              }" data-idx="${idx}" title="${title}">${base}</span>`
            );
          }

          if (
            maxPerLine > 0 &&
            (i + 1) % maxPerLine === 0 &&
            i < ultimos.length - 1
          ) {
            cells.push('<i class="breaker"></i>');
          }
        }

        return `<div class="recent-caption">Últimos ${
          ultimos.length
        } resultados (antigo ➜ recente)</div><div class="recent-bar">${cells.join(
          ""
        )}</div>`;
      }

      /* sort (Pular, Ocorrências, Percentual) */
      function attachSortingHandlers(tabela) {
        const ths = [...tabela.querySelectorAll("th")];
        const idxP = ths.findIndex((th) =>
          th.textContent.trim().toLowerCase().startsWith("pular")
        );
        const idxO = ths.findIndex((th) =>
          th.textContent.trim().toLowerCase().startsWith("ocorr")
        );
        const idxPerc = ths.findIndex((th) =>
          th.textContent.trim().toLowerCase().startsWith("percentual")
        );
        [idxP, idxO, idxPerc].forEach((idx) => {
          if (idx >= 0) {
            const th = ths[idx];
            th.classList.add("sortable");
            th.addEventListener("click", () => {
              const dir = th.classList.contains("asc") ? "desc" : "asc";
              ths.forEach((x) => x.classList.remove("asc", "desc"));
              th.classList.add(dir);
              const rows = [...tabela.querySelectorAll("tr")].slice(1);
              rows.sort((A, B) => {
                const a = A.children[idx].textContent.trim(),
                  b = B.children[idx].textContent.trim();
                const na =
                  parseFloat(a.replace("%", "").replace(",", ".")) ||
                  parseInt(a) ||
                  0;
                const nb =
                  parseFloat(b.replace("%", "").replace(",", ".")) ||
                  parseInt(b) ||
                  0;
                return dir === "asc" ? na - nb : nb - na;
              });
              rows.forEach((r) => tabela.appendChild(r));
            });
          }
        });
      }

      function renderProximosJogos(futureBar, proximosJogos) {
        if (!futureBar || !proximosJogos || !Array.isArray(proximosJogos))
          return;
        // Salva os dados para re-renderização posterior
        futureBar.dataset.proximos = JSON.stringify(proximosJogos);
        const cells = futureBar.querySelectorAll(".cell");

        // Limpa células antigas
        cells.forEach((cell) => {
          cell.innerHTML = "";
          cell.className = "cell cell-grey";
        });

        // Preenche com os novos jogos
        proximosJogos.slice(0, cells.length).forEach((jogo, index) => {
          const cell = cells[index];
          if (cell) {
            cell.innerHTML = `
                <span class="time">${jogo.time || ""}</span>
                <span class="team">${jogo.team_home || ""}</span>
                <span class="score">VS</span>
                <span class="team">${jogo.team_visit || ""}</span>
            `;
            cell.title = `${jogo.time} · ${jogo.team_home} vs ${jogo.team_visit}`;
          }
        });
      }

      /* render principal */
      function exibirResultados(conjuntos, combinado, activeMarkets = []) {
        window.recentCountByLeague = window.recentCountByLeague || {};

        const root = document.getElementById("resultados");
        root.innerHTML = "";

        if (equipesFiltro.length > 0) {
          const tag = document.createElement("div");
          tag.style.marginBottom = "14px";
          const comp =
            {
              todos: "placares, mercados e equipes",
              equipes: "apenas equipes",
              mercados: "apenas mercados",
              placares: "apenas placares",
              placares_equipes: "placares e equipes",
              placares_mercados: "placares e mercados",
              equipes_mercados: "equipes e mercados",
            }[modoPadrao] || "todas as opções";
          tag.innerHTML = `<strong>Filtro de equipes:</strong> ${equipesFiltro.join(
            ", "
          )} — <em>composição do padrão: ${comp}</em>`;
          root.appendChild(tag);
        }

        if (activeMarkets.length === 0) {
          const m1Only = document.getElementById("mercado1").value;
          activeMarkets = [{ val: m1Only, idx: 0 }];
        }

        for (const conjunto of conjuntos) {
          const {
            liga: nomeLiga,
            resultadosPorAtivo,
            dadosCru,
            proximosJogos,
          } = conjunto;
          const indexColorMap = new Map();

          const header = document.createElement("div");
          header.style.display = "flex";
          header.style.alignItems = "center";
          header.style.gap = "10px";
          header.style.justifyContent = "center";

          const h2 = document.createElement("h2");
          h2.textContent = nomeLiga;
          const sel = document.createElement("select");
          [10, 20, 30, 40, 60, 80].forEach((n) => {
            const o = document.createElement("option");
            o.value = n;
            o.textContent = `Mostrar ${n}`;
            sel.appendChild(o);
          });
          const defaultCount =
            window.recentCountByLeague[nomeLiga] ?? getRecentCountByInterval();
          sel.value = defaultCount;
          sel.addEventListener("change", () => {
            window.recentCountByLeague[nomeLiga] = parseInt(sel.value, 10);
            reexibir();
          });

          header.appendChild(h2);
          header.appendChild(sel);
          root.appendChild(header);

          const futureWrap = document.createElement("div");
          futureWrap.className = "recent-wrap";
          futureWrap.innerHTML = buildFutureBarHTML(6);
          const futureBar = futureWrap.querySelector(".future-bar");
          root.appendChild(futureWrap);

          renderProximosJogos(futureBar, proximosJogos);

          function clearFutureBar() {
            if (!futureBar) return;
            futureBar
              .querySelectorAll(".entry-badge")
              .forEach((b) => b.remove());
            futureBar.querySelectorAll(".cell").forEach((c) => {
              c.classList.remove("cell-hit", "cell-focus");
              c.style.removeProperty("--hit");
            });
          }

          function addMarkerToFutureSlot(f, color, label) {
            if (!futureBar) return;
            if (f < 0 || f >= 6) return;
            const c = futureBar.querySelectorAll(".cell")[f];
            if (!c) return;

            if (!c.classList.contains("cell-hit")) {
              c.classList.add("cell-hit");
              c.style.setProperty("--hit", color);
            }
            const badge = document.createElement("span");
            badge.className = "entry-badge";
            badge.textContent = label;
            badge.setAttribute("data-e-label", label);
            badge.style.background = color;
            badge.style.color = "#fff";
            c.appendChild(badge);
          }

          const recent = document.createElement("div");
          recent.className = "recent-wrap";

          const qtd =
            window.recentCountByLeague[nomeLiga] ?? getRecentCountByInterval();
          const lookback = qtd;
          const maxPerLine = 20;

          const wrapTables = document.createElement("div");
          wrapTables.className = "tables-3col";

          const allLineGroups = [];
          const marketOffsets = [0, 4, 8];

          resultadosPorAtivo.forEach(
            ({ marketIndex, marketValue, resultados }, posAtivo) => {
              const colorBaseOffset =
                marketOffsets[posAtivo % marketOffsets.length];
              const linhasInfo = [];
              const tabela = document.createElement("table");
              const cap = document.createElement("div");
              cap.className = "market-caption";
              cap.textContent = `M${posAtivo + 1}: ${marketLabel(marketValue)}`;
              tabela.innerHTML = `<tr>
        <th>Padrão (mosaico)</th>
        <th>Pular Jogos</th>
        <th>Ocorrências</th>
        <th>Greens</th>
        <th>Percentual</th>
      </tr>`;

              resultados.forEach((r, i) => {
                const offsets = r.offsets?.length
                  ? r.offsets
                  : getOffsetsByTipo(r.tipo_padrao || modo);
                const color = PALETA[(colorBaseOffset + i) % PALETA.length];

                const hits = findPatternHitsInLast(
                  dadosCru,
                  r.padrao,
                  offsets,
                  lookback
                );
                const hitSet = new Set();
                hits.forEach((arr) =>
                  arr.forEach((ix) => {
                    if (!indexColorMap.has(ix)) indexColorMap.set(ix, color);
                    hitSet.add(ix);
                  })
                );

                const tr = document.createElement("tr");
                tr.className = "row-colored";
                tr.style.setProperty("--hit", color);

                tr.innerHTML = `
          <td>${buildPatternMosaicHTML(r.padrao, offsets)}</td>
          <td>${r.pular_jogos}</td>
          <td>${r.ocorrencias}</td>
          <td>${r.greens}</td>
          <td>${r.percentual}%</td>
        `;
                tabela.appendChild(tr);
                linhasInfo.push({
                  tr,
                  color,
                  hitSet,
                  hits,
                  offsets,
                  pular: r.pular_jogos,
                  lastOffset: offsets[offsets.length - 1],
                  marketDisplayIndex: posAtivo,
                });
              });

              attachSortingHandlers(tabela);

              const holder = document.createElement("div");
              holder.appendChild(cap);
              holder.appendChild(tabela);
              wrapTables.appendChild(holder);

              allLineGroups.push(linhasInfo);
            }
          );

          const paintMarket =
            resultadosPorAtivo[0]?.marketValue ||
            activeMarkets[0]?.val ||
            document.getElementById("mercado1").value;
          recent.innerHTML = buildRecentResultsBarHTML(
            dadosCru,
            qtd,
            indexColorMap,
            maxPerLine,
            paintMarket
          );
          const recentBar = recent.querySelector(".recent-bar");

          root.appendChild(recent);
          root.appendChild(wrapTables);

          let activeRow = null;

          function setActiveRow(row) {
            if (activeRow && activeRow !== row) {
              activeRow.classList.remove("row-active");
              activeRow.style.removeProperty("box-shadow");
            }
            activeRow = row;
            if (row) {
              row.classList.add("row-active");
              row.style.boxShadow = "inset 0 0 0 2px var(--hit)";
            }
          }

          function clearSelectionAll() {
            if (!recentBar) return;
            recentBar.classList.remove("focus");
            recentBar.querySelectorAll(".cell").forEach((c) => {
              c.classList.remove("cell-focus");
            });
            recentBar.querySelectorAll(".cell.cell-hit").forEach((c) => {
              if (!c.hasAttribute("data-base-hit")) {
                c.classList.remove("cell-hit");
                c.style.removeProperty("--hit");
              }
            });
            if (activeRow) {
              activeRow.classList.remove("row-active");
              activeRow.style.removeProperty("box-shadow");
              activeRow = null;
            }
            renderProximosJogos(futureBar, proximosJogos);
            markInitialFutureEntries();
          }

          function applyPatternSelection(lineInfo) {
            clearSelectionAll();
            const { hitSet, color } = lineInfo;
            if (!recentBar) return;
            recentBar.classList.add("focus");
            recentBar.querySelectorAll(".cell").forEach((c) => {
              const idx = parseInt(c.getAttribute("data-idx"));
              if (hitSet.has(idx)) {
                c.classList.add("cell-focus", "cell-hit");
                c.style.setProperty("--hit", color);
              }
            });
          }

          function applyOccurrenceSelection(lineInfo, arr) {
            clearSelectionAll();
            setActiveRow(lineInfo.tr);
            if (!recentBar) return;
            recentBar.classList.add("focus");
            arr.forEach((idx) => {
              const c = recentBar.querySelector(`.cell[data-idx="${idx}"]`);
              if (c) {
                c.classList.add("cell-focus", "cell-hit");
                c.style.setProperty("--hit", lineInfo.color);
              }
            });
          }

          const futureSlotMap = new Map();

          function markFutureEntriesForLine(lineInfo) {
            const {
              hits,
              offsets,
              pular,
              lastOffset,
              color,
              marketDisplayIndex,
            } = lineInfo;
            const futureBase = dadosCru.length;
            clearFutureBar();
            renderProximosJogos(futureBar, proximosJogos);
            hits.forEach((arr) => {
              const iBase = arr[0] - offsets[0];
              const entrada = iBase + lastOffset + 1 + pular;
              const f = entrada - futureBase;
              if (f >= 0 && f < 6) {
                if (!futureSlotMap.has(f)) futureSlotMap.set(f, []);
                futureSlotMap
                  .get(f)
                  .push({ lineInfo, arr, marketDisplayIndex });
                addMarkerToFutureSlot(f, color, `E${marketDisplayIndex + 1}`);
              }
            });
          }

          function markInitialFutureEntries() {
            const futureBase = dadosCru.length;
            clearFutureBar();
            renderProximosJogos(futureBar, proximosJogos);
            futureSlotMap.clear();

            allLineGroups.forEach((linhasInfo) => {
              for (const li of linhasInfo) {
                const {
                  hits,
                  offsets,
                  pular,
                  lastOffset,
                  color,
                  marketDisplayIndex,
                } = li;
                for (const arr of hits) {
                  const iBase = arr[0] - offsets[0];
                  const entrada = iBase + lastOffset + 1 + pular;
                  const f = entrada - futureBase;
                  if (f >= 0 && f < 6) {
                    if (!futureSlotMap.has(f)) futureSlotMap.set(f, []);
                    const already = futureSlotMap
                      .get(f)
                      .some((x) => x.lineInfo === li);
                    if (!already) {
                      futureSlotMap
                        .get(f)
                        .push({ lineInfo: li, arr, marketDisplayIndex });
                      addMarkerToFutureSlot(
                        f,
                        color,
                        `E${marketDisplayIndex + 1}`
                      );
                    }
                  }
                }
              }
            });
          }

          markInitialFutureEntries();

          allLineGroups.flat().forEach((li) => {
            const { tr } = li;
            tr.addEventListener("click", () => {
              if (activeRow === tr) {
                return;
              }
              applyPatternSelection(li);
              setActiveRow(tr);
              markFutureEntriesForLine(li);
              tr.scrollIntoView({ behavior: "smooth", block: "nearest" });
            });
          });

          recentBar.addEventListener("click", (e) => {
            const cell = e.target.closest(".cell");
            if (!cell) {
              clearSelectionAll();
              return;
            }
            const idx = parseInt(cell.getAttribute("data-idx"));
            const match = allLineGroups.flat().find((li) => li.hitSet.has(idx));
            if (!match) {
              clearSelectionAll();
              return;
            }

            applyPatternSelection(match);
            setActiveRow(match.tr);

            const {
              hits,
              offsets,
              pular,
              lastOffset,
              color,
              marketDisplayIndex,
            } = match;
            const futureBase = dadosCru.length;
            clearFutureBar();
            renderProximosJogos(futureBar, proximosJogos);
            hits.forEach((arr) => {
              if (!arr.includes(idx)) return;
              const k = arr.findIndex((v) => v === idx);
              const base = arr[k] - offsets[k];
              const entrada = base + lastOffset + 1 + pular;
              const f = entrada - futureBase;
              if (f >= 0 && f < 6) {
                if (!futureSlotMap.has(f)) futureSlotMap.set(f, []);
                futureSlotMap
                  .get(f)
                  .push({ lineInfo: match, arr, marketDisplayIndex });
                addMarkerToFutureSlot(f, color, `E${marketDisplayIndex + 1}`);
              }
            });
            match.tr.scrollIntoView({ behavior: "smooth", block: "nearest" });
          });

          futureBar.addEventListener("click", (e) => {
            const span = e.target.closest(".entry-badge");
            const cell = e.target.closest(".cell");
            if (!cell) return;
            const f = [...futureBar.querySelectorAll(".cell")].indexOf(cell);
            if (f < 0) return;

            if (!futureSlotMap.has(f)) return;
            const arrList = futureSlotMap.get(f);

            let chosen = null;
            if (span && span.dataset.eLabel) {
              const mk = parseInt(span.dataset.eLabel.replace("E", "")) - 1;
              chosen =
                arrList.find((x) => x.marketDisplayIndex === mk) || arrList[0];
            } else {
              chosen = arrList[0];
            }
            if (!chosen) return;

            const { lineInfo, arr, marketDisplayIndex } = chosen;

            applyOccurrenceSelection(lineInfo, arr);
            setActiveRow(lineInfo.tr);

            clearFutureBar();
            renderProximosJogos(futureBar, proximosJogos);
            addMarkerToFutureSlot(
              f,
              lineInfo.color,
              `E${marketDisplayIndex + 1}`
            );
            lineInfo.tr.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
            });
          });
        }
      }

      /* Mosaico */
      function buildPatternMosaicHTML(padraoStr, offsets) {
        const tokens = padraoStr.split(" | ");
        const last = offsets[offsets.length - 1];
        let k = 0;
        const cells = [];

        for (let i = 0; i <= last; i++) {
          if (offsets.includes(i)) {
            const token = tokens[k++] || "";
            cells.push(
              `<span class="cell cell-neutral" title="${token}">${token}</span>`
            );
          } else {
            cells.push(`<span class="cell cell-grey">Pula</span>`);
          }
        }
        return `<div class="mosaic">${cells.join("")}</div>`;
      }

      /* hits do padrão nos últimos N */
      function findPatternHitsInLast(dados, padraoStr, offsets, lookback = 60) {
        const req = padraoStr.split(" | "),
          last = offsets[offsets.length - 1];
        const start = Math.max(0, dados.length - lookback - last),
          end = dados.length - last;
        const hits = [];
        for (let i = start; i < end; i++) {
          let ok = true;
          for (let k = 0; k < offsets.length; k++) {
            const [a, b, t, mandante, visitante, horario, ht] =
              dados[i + offsets[k]];
            if (
              !tokensDoJogo(a, b, t, mandante, visitante, ht).includes(req[k])
            ) {
              ok = false;
              break;
            }
          }
          if (ok && equipesFiltro.length > 0) {
            const janela = offsets.map((o) => dados[i + o]);
            if (!janelaContemEquipe(janela)) ok = false;
          }
          if (ok) hits.push(offsets.map((o) => i + o));
        }
        return hits;
      }

      /* ======= Worker inline (análise pesada) + helpers ======= */
      const ANALYZE_WORKER_SRC = `
self.onmessage = (e) => {
  const p = e.data;
  if (!p || p.cmd !== 'analyze') return;
  const res = analyzeAll(p.payload);
  self.postMessage({ ok: true, id: p.id, result: res });
};

function enumerateCombos(tok){
  if(tok.length===1) return tok[0].map(t=>[t]);
  if(tok.length===2){ const out=[]; for(const a of tok[0]) for(const b of tok[1]) out.push([a,b]); return out; }
  if(tok.length===3){ const out=[]; for(const a of tok[0]) for(const b of tok[1]) for(const c of tok[2]) out.push([a,b,c]); return out; }
  const out=[],cur=[];
  (function rec(i){ if(i===tok.length){ out.push(cur.slice()); return; } for(const t of tok[i]){ cur.push(t); rec(i+1); cur.pop(); } })(0);
  return out;
}
function getOffsetsByTipo(t){
  if(t==='1') return [0];
  if(t==='2') return [0,1];
  if(t==='3') return [0,1,2];
  if(t==='1_pula_1') return [0,2];
  if(t==='1_pula_1_pula_1') return [0,2,4];
  return [0,1];
}
function janelaContemEquipe(jogos, equipesFiltro){
  if(!equipesFiltro || equipesFiltro.length===0) return true;
  for(const j of jogos){
    const m=(j[3]||'').toLowerCase(), v=(j[4]||'').toLowerCase();
    for(const alvo of equipesFiltro){ if(m.includes(alvo)||v.includes(alvo)) return true; }
  }
  return false;
}
function tokensDoJogo(a,b,total, mandante, visitante, ht, incFlags){
    const t = new Set();
    if (incFlags.incPlacares) { t.add(\`\${a}-\${b}\`); }

    if (incFlags.incMercados) {
        t.add(a > 0 && b > 0 ? 'ambasMarcam' : 'ambasNaoMarcam');
        t.add(a > b ? 'casaVence' : (a < b ? 'foraVence' : 'empate'));
        if (total >= 2) t.add('over1.5');
        if (total < 2) t.add('under1.5');
        if (total >= 3) t.add('over2.5');
        if (total < 3) t.add('under2.5');
        if (total >= 4) t.add('over3.5');
        if (total < 4) t.add('under3.5');
        if (total >= 5) t.add('over5');
    }

    if (incFlags.incEquipes) {
        if (mandante) t.add(mandante.toLowerCase());
        if (visitante) t.add(visitante.toLowerCase());
    }
    return Array.from(t);
}
function isGreenForMarket(m,a,b,total,ht){
    if (m === 'ambasMarcam') return a > 0 && b > 0;
    if (m === 'ambasNaoMarcam') return a === 0 || b === 0;
    if (m === 'casaVence') return a > b;
    if (m === 'foraVence') return a < b;
    if (m === 'empate') return a === b;
    if (m === 'over1.5') return total >= 2;
    if (m === 'under1.5') return total < 2;
    if (m === 'over2.5') return total >= 3;
    if (m === 'under2.5') return total < 3;
    if (m === 'over3.5') return total >= 4;
    if (m === 'under3.5') return total < 4;
    if (m === 'over5') return total >= 5;
    return false;
}
function analisarAutoPadroes(dados,tipo,tiros,market,incFlags,equipesFiltro,inicio,fim){
  const res=[]; const offs=getOffsetsByTipo(tipo); const last=offs[offs.length-1];
  for(let p=inicio;p<=fim;p++){
    const comb={}, ex={}; const need=(last+1)+p+tiros; if(dados.length<need) continue;
    for(let i=0;i<=dados.length-need;i++){
      const jogosPadrao = offs.map(o => dados[i+o]);
      const ini=i+last+1+p, fimA=ini+tiros;
      const jogosTiro = dados.slice(ini, Math.min(fimA, dados.length));

      if(!janelaContemEquipe([...jogosPadrao, ...jogosTiro], equipesFiltro)) continue;

      const tok=[], plac=[];
      for(const o of offs){
        const [a,b,t,mandante,visitante,horario,ht]=dados[i+o];
        tok.push(tokensDoJogo(a,b,t, mandante, visitante, ht, incFlags));
        plac.push(\`\${a}x\${b}¦\${mandante}¦\${visitante}\`);
      }
      const combos=enumerateCombos(tok);
      let green=false;
      for(let j=ini;j<fimA&&j<dados.length;j++){
        const [a,b,sum,_m,_v,_h,ht]=dados[j];
        if(isGreenForMarket(market, a,b,sum,ht)){ green=true; break; }
      }
      const placStr=plac.join(' | ');
      for(const seq of combos){
        const key=seq.join(' | ');
        if(!comb[key]){ comb[key]={ocorrencias:0,greens:0,offsets:offs.slice()}; ex[key]=placStr; }
        comb[key].ocorrencias++; if(green) comb[key].greens++;
      }
    }
    for(const k in comb){
      const st=comb[k]; if(st.ocorrencias>=3){
        res.push({ padrao:k, placares:ex[k], pular_jogos:p, offsets:st.offsets, ocorrencias:st.ocorrencias, greens:st.greens, percentual:((st.greens/st.ocorrencias)*100).toFixed(2) });
      }
    }
  }
  res.sort((a,b)=>parseFloat(b.percentual)-parseFloat(a.percentual)||b.ocorrencias-a.ocorrencias);
  return res.slice(0,15);
}
function analyzeAll(payload){
  const { dados, tipoPadrao, tiros, markets, incFlags, equipesFiltro, intervalo, combinado } = payload;
  const tipos = combinado ? ['2','3','1_pula_1','1_pula_1_pula_1'] : [tipoPadrao];
  const resultadosPorAtivo = [];

  for(const mk of markets){
    let todos=[];
    for(const t of tipos){
      const r = analisarAutoPadroes(dados, t, tiros, mk.val, incFlags, equipesFiltro, intervalo.inicio, intervalo.fim);
      r.forEach(x=>x.tipo_padrao=t);
      todos = todos.concat(r);
    }
    todos.sort((a,b)=>parseFloat(b.percentual)-parseFloat(a.percentual)||b.ocorrencias-a.ocorrencias);
    resultadosPorAtivo.push({ marketIndex: mk.idx, marketValue: mk.val, resultados: todos.slice(0,15) });
  }
  return { resultadosPorAtivo };
}
`;
      let ANALYZE_WORKER = null;
      function getAnalyzeWorker() {
        if (!ANALYZE_WORKER) {
          const blob = new Blob([ANALYZE_WORKER_SRC], {
            type: "application/javascript",
          });
          ANALYZE_WORKER = new Worker(URL.createObjectURL(blob));
        }
        return ANALYZE_WORKER;
      }
      function analyzeInWorker(dados, opts) {
        return new Promise((resolve, reject) => {
          const w = getAnalyzeWorker();
          const id = Math.random().toString(36).slice(2);
          const onMsg = (ev) => {
            const msg = ev.data;
            if (!msg || msg.id !== id) return;
            w.removeEventListener("message", onMsg);
            if (msg.ok) resolve(msg.result);
            else reject(msg.error || "erro");
          };
          w.addEventListener("message", onMsg);
          w.postMessage({ cmd: "analyze", id, payload: { dados, ...opts } });
        });
      }

      /* ===== Listeners ===== */

      document.addEventListener(
        "click",
        (ev) => {
          const t = ev.target;
          const insideFuture = t.closest(".future-bar");
          const insideRecent = t.closest(".recent-bar");
          const insideRow = t.closest("tr.row-colored");
          const isBadge = t.closest(".entry-badge");

          if (!insideFuture && !insideRecent && !insideRow && !isBadge) {
            const rs = document.querySelectorAll(".recent-wrap .recent-bar");
            rs.forEach((bar) => {
              bar.classList.remove("focus");
              bar.querySelectorAll(".cell").forEach((c) => {
                c.classList.remove("cell-focus");
              });
            });
            document
              .querySelectorAll("tr.row-colored.row-active")
              .forEach((tr) => {
                tr.classList.remove("row-active");
                tr.style.removeProperty("box-shadow");
              });
            const futureBars = document.querySelectorAll(".future-bar");
            futureBars.forEach((fb) => {
              const proximos = JSON.parse(fb.dataset.proximos || "[]");
              renderProximosJogos(fb, proximos);
            });
          }
        },
        true
      );

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("togglestats")
          ?.addEventListener("click", iniciarAnalise);

        const auto = document.getElementById("auto-atualizar");
        const status = document.getElementById("status-atualizacao");
        if (auto) {
          auto.addEventListener("change", function () {
            if (this.checked) {
              if (!intervaloAtualizacao) {
                contadorSegundos = 180;
                atualizarContador();
                intervaloAtualizacao = setInterval(atualizarContador, 1000);
              }
              if (status) status.style.display = "block";
            } else {
              if (intervaloAtualizacao) {
                clearInterval(intervaloAtualizacao);
                intervaloAtualizacao = null;
              }
              if (status) status.style.display = "none";
            }
          });
        }

        const selModo = document.getElementById("modo-padrao");
        if (selModo) {
          selModo.addEventListener("change", () => {
            definirEquipesEModo();
            reprocessarComCache();
          });
        }

        [
          "mercado1",
          "mercado2",
          "mercado3",
          "placar_jogos",
          "tiros",
          "linhas",
          "intervalo_jogos",
          "equipes",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("change", () => {
            reprocessarComCache();
          });
          if (el.tagName === "INPUT" && el.type === "text") {
            el.addEventListener("blur", reprocessarComCache);
            el.addEventListener("keyup", (ev) => {
              if (ev.key === "Enter") reprocessarComCache();
            });
          }
        });
      });

      async function reprocessarComCache() {
        showBusy("Calculando os padrões…");
        try {
          window.recentCountByLeague = window.recentCountByLeague || {};
          window.ULTIMO_PAC = window.ULTIMO_PAC || [];
          window.ULTIMO_COMBINADO = !!window.ULTIMO_COMBINADO;

          definirEquipesEModo();

          const tipoPadrao = document.getElementById("placar_jogos").value;
          const tiros = parseInt(document.getElementById("tiros").value, 10);
          const numLinhas = parseInt(
            document.getElementById("linhas").value,
            10
          );

          const m1 = document.getElementById("mercado1").value;
          const m2 = document.getElementById("mercado2").value;
          const m3 = document.getElementById("mercado3").value;

          const rawMarkets = [m1, m2, m3];
          let activeMarkets = rawMarkets
            .map((val, idx) => ({ val, idx }))
            .filter((x) => x.idx === 0 || (x.val && x.val !== ""));

          const ligas = [];
          document
            .querySelectorAll('input[type="checkbox"]:checked')
            .forEach((cb) => {
              if (cb.value && cb.value !== "on") {
                const labelText = cb.parentElement.textContent.trim();
                ligas.push({ url: cb.value, name: labelText });
              }
            });
          if (ligas.length === 0) {
            alert("Por favor, selecione pelo menos uma liga.");
            hideBusy();
            return;
          }

          const pac = [];

          for (const liga of ligas) {
            try {
              const arq = liga.url;
              const cached = window.CACHE_ARQUIVOS[arq];
              const cachedProximos =
                window.CACHE_ARQUIVOS[
                  arq.replace("/resultados/", "/proximos/")
                ];

              if (!cached || !cachedProximos) {
                console.warn(
                  `Dados para ${liga.name} não estão em cache. Clique em "Carregar Dados".`
                );
                continue;
              }
              const { dados } = parseJSONToDados(cached.raw, numLinhas);
              const proximosJogos = JSON.parse(cachedProximos.raw);

              if (activeMarkets.length === 0) {
                activeMarkets = [{ val: m1, idx: 0 }];
              }

              const intervalCfg = obterIntervalo();
              const incFlags = { incPlacares, incMercados, incEquipes };
              const { resultadosPorAtivo } = await analyzeInWorker(dados, {
                tipoPadrao,
                tiros,
                markets: activeMarkets,
                incFlags,
                equipesFiltro,
                intervalo: intervalCfg,
                combinado: tipoPadrao === "combinado",
              });

              pac.push({
                liga: liga.name,
                resultadosPorAtivo,
                dadosCru: dados,
                proximosJogos,
              });
            } catch (e) {
              console.error(e);
              alert(`Erro ao processar ${liga.name} do cache`);
            }
          }

          window.ULTIMO_PAC = pac;
          window.ULTIMO_COMBINADO = tipoPadrao === "combinado";
          window.ULTIMO_ACTIVE_MARKETS = activeMarkets.slice();

          exibirResultados(pac, window.ULTIMO_COMBINADO, activeMarkets);
        } finally {
          hideBusy();
        }
      }

      async function carregarDados(forceFresh = false) {
        window.recentCountByLeague = window.recentCountByLeague || {};
        window.ULTIMO_PAC = window.ULTIMO_PAC || [];
        window.ULTIMO_COMBINADO = !!window.ULTIMO_COMBINADO;

        definirEquipesEModo();

        const tipoPadrao = document.getElementById("placar_jogos").value;
        const tiros = parseInt(document.getElementById("tiros").value, 10);
        const numLinhas = parseInt(document.getElementById("linhas").value, 10);

        const m1 = document.getElementById("mercado1").value;
        const m2 = document.getElementById("mercado2").value;
        const m3 = document.getElementById("mercado3").value;

        const rawMarkets = [m1, m2, m3];
        let activeMarkets = rawMarkets
          .map((val, idx) => ({ val, idx }))
          .filter((x) => x.idx === 0 || (x.val && x.val !== ""));

        const ligas = [];
        document
          .querySelectorAll('input[type="checkbox"]:checked')
          .forEach((cb) => {
            if (cb.value && cb.value !== "on") {
              const labelText = cb.parentElement.textContent.trim();
              ligas.push({ url: cb.value, name: labelText });
            }
          });

        if (ligas.length === 0) {
          alert("Por favor, selecione pelo menos uma liga.");
          return;
        }

        showBusy("Baixando dados das ligas…");
        const promises = ligas.map((liga) => {
          const resultadosUrl = liga.url;
          const proximosUrl = liga.url.replace("/resultados/", "/proximos/");
          return Promise.all([
            garantirCacheArquivo(resultadosUrl, { forceFresh }),
            baixarArquivoRaw(proximosUrl), // Sempre busca os próximos jogos mais recentes
          ]).catch((e) => {
            console.error(`Falha ao carregar dados para ${liga.name}:`, e);
            alert(`Erro ao baixar dados para a liga: ${liga.name}`);
            return null; // Retorna null em caso de erro para não quebrar o loop
          });
        });

        await Promise.all(promises);

        showBusy("Calculando os padrões…");
        try {
          const pac = [];
          for (const liga of ligas) {
            const resultadosUrl = liga.url;
            const proximosUrl = liga.url.replace("/resultados/", "/proximos/");

            const cachedResultados = window.CACHE_ARQUIVOS[resultadosUrl];
            const cachedProximos = window.CACHE_ARQUIVOS[proximosUrl];

            if (!cachedResultados || !cachedProximos) continue;

            const { dados } = parseJSONToDados(cachedResultados.raw, numLinhas);
            const proximosJogos = JSON.parse(cachedProximos.raw);

            if (activeMarkets.length === 0) {
              activeMarkets = [{ val: m1, idx: 0 }];
            }

            const intervalCfg = obterIntervalo();
            const incFlags = { incPlacares, incMercados, incEquipes };
            const { resultadosPorAtivo } = await analyzeInWorker(dados, {
              tipoPadrao,
              tiros,
              markets: activeMarkets,
              incFlags,
              equipesFiltro,
              intervalo: intervalCfg,
              combinado: tipoPadrao === "combinado",
            });

            pac.push({
              liga: liga.name,
              resultadosPorAtivo,
              dadosCru: dados,
              proximosJogos,
            });
          }

          window.ULTIMO_PAC = pac;
          window.ULTIMO_COMBINADO = tipoPadrao === "combinado";
          window.ULTIMO_ACTIVE_MARKETS = activeMarkets.slice();

          exibirResultados(pac, window.ULTIMO_COMBINADO, activeMarkets);
        } finally {
          hideBusy();
        }
      }
</script>

    <script>
      // Bloqueia o menu de contexto (clique direito)
      document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
});

// Bloqueia atalhos de teclado comuns para ferramentas de desenvolvimento
document.addEventListener("keydown", function(e) {
    // F12
    if (e.key === "F12") {
        e.preventDefault();
    }
    
    // Ctrl + Shift + I
    if (e.ctrlKey && e.shiftKey && e.key === "I") {
        e.preventDefault();
    }
    
    // Ctrl + U (ver código fonte)
    if (e.ctrlKey && e.key === "u") {
        e.preventDefault();
    }
    
    // Ctrl + Shift + J (console)
    if (e.ctrlKey && e.shiftKey && e.key === "J") {
        e.preventDefault();
    }
    
    // Ctrl + Shift + C (inspeção de elementos)
    if (e.ctrlKey && e.shiftKey && e.key === "C") {
        e.preventDefault();
    }
    
    // Ctrl + S (salvar página)
    if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
    }
    
    // Ctrl + P (imprimir)
    if (e.ctrlKey && e.key === "p") {
        e.preventDefault();
    }
});

// Detecta abertura de ferramentas de desenvolvimento
const devtools = { open: false };
const element = new Image();
Object.defineProperty(element, 'id', {
    get: function () {
        devtools.open = true;
    }
});

// Adiciona detecção alternativa de devtools
(function() {
    const threshold = 160;
    const checkDevTools = function() {
        if ((window.outerWidth - window.innerWidth) > threshold || 
            (window.outerHeight - window.innerHeight) > threshold) {
            devtools.open = true;
        }
    };
    
    window.addEventListener('resize', checkDevTools);
    setInterval(checkDevTools, 500);
})();

// Monitoramento contínuo
console.log('%c', element);
setInterval(function() {
    if (devtools.open) {
        document.body.innerHTML = '<h1>Acesso não autorizado detectado</h1>';
        // Ou redirecionar:
        // window.location.href = 'about:blank';
        devtools.open = false;
    }
}, 1000);

// Impede seleção de texto
document.addEventListener('selectstart', function(e) {
    e.preventDefault();
});

// Impede arrastar e soltar
document.addEventListener('dragstart', function(e) {
    e.preventDefault();
});

// Ofusca console
console.log = function() {};
console.debug = function() {};
console.info = function() {};
    </script>

<script>
  fetch('header.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('header').innerHTML = data;
    });
</script>

<script src="redirecionar.js"></script>

    <script></script>
  </body>
</html>
